/* jshint ignore:start */
/*
 * The copyright in this software module is being made available under the BSD License, included below. This software module may be subject to other third party and/or contributor rights, including patent rights, and no such rights are granted under this license.
 * The whole software resulting from the execution of this software module together with its external dependent software modules from dash.js project may be subject to Orange and/or other third party rights, including patent rights, and no such rights are granted under this license.
 *
 * Copyright (c) 2014, Orange
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:
 * •  Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.
 * •  Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.
 * •  Neither the name of the Orange nor the names of its contributors may be used to endorse or promote products derived from this software module without specific prior written permission.
 *
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS “AS IS” AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

/* Last build : 2017-11-9_16:48:44 / git revision : 78c018d */

!function(e,t){"function"==typeof define&&define.amd?define([],function(){return e.MediaPlayer=t()}):"object"==typeof exports?module.exports=t():e.MediaPlayer=t()}(this,function(){function e(e,t,i){function n(e){var t=e.localName;return null==t&&(t=e.baseName),null!=t&&""!=t||(t=e.nodeName),t}function r(e){return"string"==typeof e?e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;"):e}function o(r){if(r.nodeType==m.DOCUMENT_NODE){var s,a,l=r.firstChild;for(s=0,a=r.childNodes.length;s<a;s+=1)if(r.childNodes[s].nodeType!==m.COMMENT_NODE){l=r.childNodes[s];break}if(i)d=o(l);else{(d={})[h=n(l)]=o(l)}return d}if(r.nodeType==m.ELEMENT_NODE){var d;(d=new Object).__cnt=0;for(var u=r.childNodes,c=0;c<u.length;c++){var h=n(l=u.item(c));if(d.__cnt++,null==d[h])d[h]=o(l),d[h+"_asArray"]=new Array(1),d[h+"_asArray"][0]=d[h];else{if(null!=d[h]&&!(d[h]instanceof Array)){var p=d[h];d[h]=new Array,d[h][0]=p,d[h+"_asArray"]=d[h]}for(var g=0;null!=d[h][g];)g++;d[h][g]=o(l)}}for(var y=0;y<r.attributes.length;y++){var _=r.attributes.item(y);d.__cnt++;for(var E=_.value,b=0,v=e.length;b<v;b++){var x=e[b];x.test.call(this,_.value)&&(E=x.converter.call(this,_.value))}d[t+_.name]=E}var T=function(e){return e.prefix}(r);return null!=T&&""!=T&&(d.__cnt++,d.__prefix=T),1==d.__cnt&&null!=d["#text"]&&(d=d["#text"]),null!=d["#text"]&&(d.__text=d["#text"],f&&(d.__text=function(e){return e.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#x27;/g,"'").replace(/&#x2F;/g,"/")}(d.__text)),delete d["#text"],delete d["#text_asArray"]),null!=d["#cdata-section"]&&(d.__cdata=d["#cdata-section"],delete d["#cdata-section"],delete d["#cdata-section_asArray"]),null==d.__text&&null==d.__cdata||(d.toString=function(){return(null!=this.__text?this.__text:"")+(null!=this.__cdata?this.__cdata:"")}),d}return r.nodeType==m.TEXT_NODE||r.nodeType==m.CDATA_SECTION_NODE?r.nodeValue:r.nodeType==m.COMMENT_NODE?null:void 0}function s(e,t,i,n){var r="<"+(null!=e&&null!=e.__prefix?e.__prefix+":":"")+t;if(null!=i)for(var o=0;o<i.length;o++){var s=i[o],a=e[s];r+=" "+s.substr(1)+"='"+a+"'"}return r+=n?"/>":">"}function a(e,t){return"</"+(null!=e.__prefix?e.__prefix+":":"")+t+">"}function l(e,t){return!!(function(e,t){return-1!==e.indexOf(t,e.length-t.length)}(t.toString(),"_asArray")||0==t.toString().indexOf("_")||e[t]instanceof Function)}function d(e){var t=0;if(e instanceof Object)for(var i in e)l(e,i)||t++;return t}function u(e){var t=[];if(e instanceof Object)for(var i in e)-1==i.toString().indexOf("__")&&0==i.toString().indexOf("_")&&t.push(i);return t}function c(e){var t="";return e instanceof Object?t+=function(e){var t="";return null!=e.__cdata&&(t+="<![CDATA["+e.__cdata+"]]>"),null!=e.__text&&(t+=f?r(e.__text):e.__text),t}(e):null!=e&&(t+=f?r(e):e),t}function h(e,t,i){var n="";if(0==e.length)n+=s(e,t,i,!0);else for(var r=0;r<e.length;r++)n+=s(e[r],t,u(e[r]),!1),n+=p(e[r]),n+=a(e[r],t);return n}function p(e){var t="";if(d(e)>0)for(var i in e)if(!l(e,i)){var n=e[i],r=u(n);if(null==n||void 0==n)t+=s(n,i,r,!0);else if(n instanceof Object)if(n instanceof Array)t+=h(n,i,r);else{d(n)>0||null!=n.__text||null!=n.__cdata?(t+=s(n,i,r,!1),t+=p(n),t+=a(n,i)):t+=s(n,i,r,!0)}else t+=s(n,i,r,!1),t+=c(n),t+=a(n,i)}return t+=c(e)}null!==t&&void 0!==t||(t="_"),null!==i&&void 0!==i||(i=!1);var f=!1,m={ELEMENT_NODE:1,TEXT_NODE:3,CDATA_SECTION_NODE:4,COMMENT_NODE:8,DOCUMENT_NODE:9};this.parseXmlString=function(e){var t;if(window.DOMParser)try{if((t=(new window.DOMParser).parseFromString(e,"text/xml")).getElementsByTagName("parsererror").length>0)throw new Error("Error parsing XML")}catch(e){return null}return t},this.xml2json=function(e){return o(e)},this.xml_str2json=function(e){var t=this.parseXmlString(e);return null===t?t:this.xml2json(t)},this.json2xml_str=function(e){return p(e)},this.json2xml=function(e){var t=this.json2xml_str(e);return this.parseXmlString(t)},this.getVersion=function(){return"1.0.11"},this.escapeMode=function(e){f=e}}function t(){"use strict";var e,t,i;try{e=navigator.userAgent.toLowerCase(),/msie (\d+\.\d+);/.test(e)?(i=Number(RegExp.$1),e.indexOf("trident/6")>-1&&(i=10),e.indexOf("trident/5")>-1&&(i=9),e.indexOf("trident/4")>-1&&(i=8),t="Internet Explorer"):e.indexOf("trident/7")>-1?(i=11,t="Internet Explorer"):/edge[\/\s](\d+\.\d+)/.test(e)?(i=Number(RegExp.$1),t="Edge"):/firefox[\/\s](\d+\.\d+)/.test(e)?(i=Number(RegExp.$1),t="Firefox"):/opera[\/\s](\d+\.\d+)/.test(e)?(i=Number(RegExp.$1),t="Opera"):/chrome[\/\s](\d+\.\d+)/.test(e)?(i=Number(RegExp.$1),t="Chrome"):/version[\/\s](\d+\.\d+)/.test(e)?(i=Number(RegExp.$1),t="Safari"):/rv[\/\s](\d+\.\d+)/.test(e)?(i=Number(RegExp.$1),t="Mozilla"):/mozilla[\/\s](\d+\.\d+)/.test(e)?(i=Number(RegExp.$1),t="Mozilla"):/binget[\/\s](\d+\.\d+)/.test(e)?(i=Number(RegExp.$1),t="Library (BinGet)"):/curl[\/\s](\d+\.\d+)/.test(e)?(i=Number(RegExp.$1),t="Library (cURL)"):/java[\/\s](\d+\.\d+)/.test(e)?(i=Number(RegExp.$1),t="Library (Java)"):/libwww-perl[\/\s](\d+\.\d+)/.test(e)?(i=Number(RegExp.$1),t="Library (libwww-perl)"):/microsoft url control -[\s](\d+\.\d+)/.test(e)?(i=Number(RegExp.$1),t="Library (Microsoft URL Control)"):/peach[\/\s](\d+\.\d+)/.test(e)?(i=Number(RegExp.$1),t="Library (Peach)"):/php[\/\s](\d+\.\d+)/.test(e)?(i=Number(RegExp.$1),t="Library (PHP)"):/pxyscand[\/\s](\d+\.\d+)/.test(e)?(i=Number(RegExp.$1),t="Library (pxyscand)"):/pycurl[\/\s](\d+\.\d+)/.test(e)?(i=Number(RegExp.$1),t="Library (PycURL)"):/python-urllib[\/\s](\d+\.\d+)/.test(e)?(i=Number(RegExp.$1),t="Library (Python URLlib)"):/appengine-google/.test(e)?(i=Number(RegExp.$1),t="Cloud (Google AppEngine)"):/trident/.test(e)?(i=Number(RegExp.$1),t="Trident"):/adventurer/.test(e)?(i=Number(RegExp.$1),t="Adventurer"):(i="unknown",t="unknown")}catch(e){t="error",i="error"}return{name:t.replace(/\s+/g,""),version:i}}var n,r,o,l={},d={},u={},c={};(c=function(){var e,i=new c.di.Context,r=new o.System,s=!1,a=null,l=null,d=null,u=[],h=[],p=null,f=null,m="und",g="und",y=!1,_={video:-1,audio:-1},E=null,b=!1,v=!1,x=!0,T=null,S=!1,D="Safari"===t().name,I={},M=function(){if(!s)throw new Error("MediaPlayer not initialized !!!")},L=function(){var t,i=[],o=[];if(M(),function(){if(!e.getElement())throw new Error("MediaPlayer.play(): Video element not attached to MediaPlayer")}(),function(){if(!T)throw new Error("MediaPlayer.play(): Source not attached to MediaPlayer")}(),D&&"HLS"===T.protocol||c.hasMediaSourceExtension()){for(var s in I)i.push(I[s].deferInit.promise);n.all(i).then(function(){for(var i in I)(t=I[i]).deferLoad=n.defer(),o.push(t.deferLoad.promise),t.load(T,function(){this.deferLoad.resolve()}.bind(t));n.all(o).then(function(){v=!0,this.metricsModel.addSession(null,T.url,e.getElement().loop,null,"MediaPlayer.js_"+this.getVersion()),this.debug.log("[MediaPlayer] Version: "+this.getVersionFull()+" - "+this.getBuildDate()),this.debug.log("[MediaPlayer] user-agent: "+navigator.userAgent),this.debug.log("[MediaPlayer] Load stream:\n",JSON.stringify(T,null,"  ")),E||((E=r.getObject("streamController")).setVideoModel(e),E.setAutoPlay(x)),E.setDefaultAudioLang(m),E.setDefaultSubtitleLang(g),E.enableSubtitles(y),E.load(T),r.mapValue("scheduleWhilePaused",S),r.mapOutlet("scheduleWhilePaused","stream")}.bind(this))}.bind(this))}else this.errHandler.sendError(c.dependencies.ErrorHandler.prototype.CAPABILITY_ERR_MEDIASOURCE,"MediaSource extension not supported by the browser")},R=function(){return s&&e.getElement()&&T&&!b},A=function(){R()&&L.call(this)},P=function(t,i){var n=document.createEvent("CustomEvent");n.initCustomEvent(t,!1,!1,{type:i.streamType,bitrate:i.switchedQuality,representationId:i.representationId,time:e.getCurrentTime(),width:i.width,height:i.height}),e.getElement().dispatchEvent(n)},w=function(t){var i=e.getCurrentTime(),n=null,r=[],o=0;for(o=0;o<t.length;o+=1)i>=(n=t[o]).mediaStartTime&&(P("play_bitrate",n),this.debug.log("[MediaPlayer]["+n.streamType+"] send play_bitrate - b="+n.switchedQuality+", t="+n.mediaStartTime+"("+e.getPlaybackRate()+")"),r.push(o));!function(e,t){var i=0;for(i=t.length-1;i>=0;i-=1)e.splice(i,1)}(t,r)},N=function(){this.addEventListener("metricAdded",function(t){var i;switch(t.data.metric){case"ManifestReady":M(),this.debug.log("[MediaPlayer] ManifestReady"),l=this.metricsExt.getBitratesForType("video"),this.debug.log("[MediaPlayer] video bitrates: "+JSON.stringify(l)),(i=document.createEvent("CustomEvent")).initCustomEvent("manifest_loaded",!1,!1,{}),e.getElement().dispatchEvent(i);break;case"RepresentationSwitch":M(),"video"==t.data.stream?(l=this.metricsExt.getBitratesForType(t.data.stream))&&(P("download_bitrate",{streamType:t.data.stream,switchedQuality:l[t.data.value.lto],representationId:t.data.value.to,width:this.metricsExt.getVideoWidthForRepresentation(t.data.value.to),height:this.metricsExt.getVideoHeightForRepresentation(t.data.value.to)}),this.debug.log("[MediaPlayer]["+t.data.stream+"] send download_bitrate - b="+l[t.data.value.lto])):"audio"==t.data.stream&&(d=this.metricsExt.getBitratesForType(t.data.stream))&&(P("download_bitrate",{streamType:t.data.stream,switchedQuality:d[t.data.value.lto],representationId:t.data.value.to,width:this.metricsExt.getVideoWidthForRepresentation(t.data.value.to),height:this.metricsExt.getVideoHeightForRepresentation(t.data.value.to)}),this.debug.log("[MediaPlayer]["+t.data.stream+"] send download_bitrate - b="+l[t.data.value.lto]));break;case"BufferedSwitch":M(),"video"==t.data.stream?u.push({streamType:t.data.stream,mediaStartTime:t.data.value.mt,switchedQuality:l[t.data.value.lto],representationId:t.data.value.to,width:this.metricsExt.getVideoWidthForRepresentation(t.data.value.to),height:this.metricsExt.getVideoHeightForRepresentation(t.data.value.to)}):"audio"==t.data.stream&&h.push({streamType:t.data.stream,mediaStartTime:t.data.value.mt,switchedQuality:d[t.data.value.lto],representationId:t.data.value.to,width:this.metricsExt.getVideoWidthForRepresentation(t.data.value.to),height:this.metricsExt.getVideoHeightForRepresentation(t.data.value.to)});break;case"BufferLevel":(i=document.createEvent("CustomEvent")).initCustomEvent("bufferLevel_updated",!1,!1,{type:t.data.stream,level:t.data.value.level}),e.getElement().dispatchEvent(i);break;case"State":(i=document.createEvent("CustomEvent")).initCustomEvent("state_changed",!1,!1,{type:t.data.stream,state:t.data.value.current}),e.getElement().dispatchEvent(i)}}.bind(this)),this.addEventListener("error",function(e){p=e.data,this.reset(2)}.bind(this)),this.addEventListener("warning",function(e){f=e.data}.bind(this)),this.addEventListener("timeupdate",function(){0!==e.getPlaybackRate()&&(w.call(this,u),w.call(this,h))}.bind(this))},B=function(e){if(v&&E){if(!b){b=!0;var t={};t[c.dependencies.StreamController.eventList.ENAME_TEARDOWN_COMPLETE]=function(){for(var e in I)I[e].reset();E=null,v=!1,b=!1,this.debug.log("[MediaPlayer] Player is stopped"),R.call(this)&&A.call(this)}.bind(this),E.subscribe(c.dependencies.StreamController.eventList.ENAME_TEARDOWN_COMPLETE,t,void 0,!0),E.reset(e)}}else R.call(this)&&A.call(this)},F=function(e){if(!e)return null;var t={};return e.id&&(t.id=e.id),e.lang&&(t.lang=e.lang),e.subType&&(t.subType=e.subType),t},C=function(e){if(!E)return null;switch(e){case c.TRACKS_TYPE.AUDIO:return E.getAudioTracks();case c.TRACKS_TYPE.TEXT:return E.getSubtitleTracks()}return null},O=function(e){if(!E)return null;switch(e){case c.TRACKS_TYPE.AUDIO:return E.getSelectedAudioTrack();case c.TRACKS_TYPE.TEXT:return E.getSelectedSubtitleTrack()}return null},U=function(e,t){if(!E)return null;switch(e){case c.TRACKS_TYPE.AUDIO:E.setAudioTrack(t);break;case c.TRACKS_TYPE.TEXT:E.setSubtitleTrack(t)}return null},k=function(e,t){return!e&&!t||e===t},H=function(e,t){return k(e.id,t.id)&&k(e.lang,t.lang)&&k(e.subType,t.subType)},K=function(){var e=this.metricsModel.getReadOnlyMetricsFor("video");return e?this.metricsExt.getCurrentDVRInfo(e):null};return r.mapValue("system",r),r.mapOutlet("system"),r.injectInto(i),{notifier:void 0,debug:void 0,eventBus:void 0,metricsExt:void 0,abrController:void 0,metricsModel:void 0,errHandler:void 0,config:void 0,getVersion:function(){return"1.14.0-dev"},getVersionFull:function(){return-1==="78c018d".indexOf("@@")?"1.14.0-dev_78c018d":"1.14.0-dev"},getVersionDashJS:function(){return"1.2.0"},getBuildDate:function(){return-1==="2017-11-9_16:48:44".indexOf("@@")?"2017-11-9_16:48:44":"Not a builded version"},init:function(t){if(!t)throw new Error("MediaPlayer.init(): Invalid Argument");s||(r.injectInto(this),s=!0,this.debug.log("[MediaPlayer] Version: "+this.getVersionFull()+" - "+this.getBuildDate()),this.debug.log("[MediaPlayer] user-agent: "+navigator.userAgent)),(e=r.getObject("videoModel")).setElement(t),N.call(this),(a=r.getObject("debugController")).init("1.14.0-dev"),window.addEventListener("keydown",function(e){if(!0===e.altKey&&!0===e.ctrlKey&&!0===e.shiftKey&&86===e.keyCode){console.log("[MediaPlayer] Version: "+this.getVersion()+" - "+this.getBuildDate());for(var t in I)console.log("["+I[t].getName()+"] Version: "+I[t].getVersion()+" - "+I[t].getBuildDate())}}.bind(this))},addEventListener:function(t,i,n){M(),"hasplayer"===c.PUBLIC_EVENTS[t]?this.eventBus.addEventListener(t,i,n):e.listen(t,i,n)},removeEventListener:function(t,i){M(),"hasplayer"===c.PUBLIC_EVENTS[t]?this.eventBus.removeEventListener(t,i):e.unlisten(t,i)},getVideoModel:function(){return e},getDebug:function(){return this.debug},getMetricsExt:function(){return this.metricsExt},setConfig:function(e){this.config&&e&&(this.debug.log("[MediaPlayer] set config: "+JSON.stringify(e,null,"\t")),this.config.setParams(e))},setParams:function(e){this.setConfig(e)},setDebug:function(e){if(M(),"boolean"!=typeof e)throw new Error("MediaPlayer.setDebug(): Invalid Arguments");!0===e?this.debug.setLevel(4):this.debug.setLevel(0)},getAutoPlay:function(){return x},setAutoPlay:function(e){x=e},setInitialQualityFor:function(e,t){_[e]=t},getQualityFor:function(e){return M(),this.abrController.getQualityFor(e)},setQualityFor:function(e,t){if(M(),"number"!=typeof t)throw new Error("MediaPlayer.setQualityFor(): Invalid Arguments");this.abrController.setQualityFor(e,t)},getAutoSwitchQuality:function(){return M(),this.abrController.getAutoSwitchBitrate()},setAutoSwitchQuality:function(e){if(M(),"boolean"!=typeof e)throw new Error("MediaPlayer.setAutoSwitchQuality(): Invalid Arguments");this.abrController.setAutoSwitchBitrate(e)},getScheduleWhilePaused:function(){return S},setScheduleWhilePaused:function(e){if("boolean"!=typeof e)throw new Error("MediaPlayer.setScheduleWhilePaused(): Invalid Arguments");S=e},setDefaultAudioLang:function(e){if("string"!=typeof e)throw new Error("MediaPlayer.setDefaultAudioLang(): Invalid Arguments");m=e},getDefaultAudioLang:function(){return m},setDefaultSubtitleLang:function(e){if("string"!=typeof e)throw new Error("MediaPlayer.setDefaultSubtitleLang(): Invalid Arguments");g=e},getDefaultSubtitleLang:function(){return g},load:function(e){var t={video:{"ABR.keepBandwidthCondition":!0},audio:{"ABR.keepBandwidthCondition":!0}};if(arguments&&arguments.length>0&&"object"!=typeof arguments[0]&&(console.warn('You are using "deprecated" call of the method load, please refer to the documentation to change prameters call'),e=function(){if(arguments&&arguments.length>0){var e={};return"string"==typeof arguments[0]&&(e.url=arguments[0]),arguments[1]&&(e.protData=arguments[1]),e}}.apply(null,arguments)),!e||!e.url)throw new Error("MediaPlayer.load(): stream has no url.");u=[],h=[],M(),this.reset(0),_.video>=0&&(this.abrController.setQualityFor("video",_.video),t.video["ABR.keepBandwidthCondition"]=!1,_.video=-1),_.audio>=0&&(this.abrController.setQualityFor("audio",_.audio),t.audio["ABR.keepBandwidthCondition"]=!1,_.audio=-1),this.setConfig(t),p=null,f=null,T=e,B.call(this,0)},play:function(){M(),e.play()},seek:function(t){var i=null,n=0;if(M(),"number"!=typeof t)throw new Error("MediaPlayer.seek(): Invalid Arguments");if(this.isLive()){if(i=this.getDVRWindowRange(),n=E.getLiveDelay(),null===i)throw new Error("MediaPlayer.seek(): impossible for live stream");if(t<i.start||t>i.end)throw new Error("MediaPlayer.seek(): seek value outside available time range");t>i.end-n&&(t=i.end-n),E.seek(t,!0)}else{if(t<0||t>e.getDuration())throw new Error("MediaPlayer.seek(): seek value outside available time range");e.setCurrentTime(t)}},pause:function(){M(),e.pause()},stop:function(){M(),e.pause(),this.isLive()||e.setCurrentTime(0);for(var t in I)I[t].stop()},reset:function(e){M(),this.setQualityFor("video",0),this.setQualityFor("audio",0),T=null,B.call(this,e)},refreshManifest:function(e){M(),E.refreshManifest(e)},getDuration:function(){return M(),e.getDuration()},isLive:function(){return M(),e.getDuration()===Number.POSITIVE_INFINITY},getPosition:function(){return M(),e.getCurrentTime()},getDVRWindowRange:function(){if(M(),!this.isLive())return null;var e=K.call(this);return e?e.range:null},getDVRWindowSize:function(){return M(),this.isLive(),null},getDVRSeekOffset:function(e){if(M(),!this.isLive())return null;var t=K.call(this),i=t?t.range.start+e:null;return i&&i>t.range.end&&(i=t.range.end),i},getVideoBitrates:function(){return M(),l.slice()},getMetricsFor:function(e){return this.metricsModel.getReadOnlyMetricsFor(e)},getTrickModeSpeed:function(){return E?E.getTrickModeSpeed():0},setTrickModeSpeed:function(e){M(),E&&E.setTrickModeSpeed(e)},getError:function(){return p},getWarning:function(){return f},getTracks:function(e){if(M(),!e||e!==c.TRACKS_TYPE.AUDIO&&e!==c.TRACKS_TYPE.TEXT)throw new Error('MediaPlayer Invalid Argument - "type" should be defined and shoud be kind of MediaPlayer.TRACKS_TYPE');var t=C(e);if(!t)return[];for(var i=[],n=0;n<t.length;n+=1)i.push(F(t[n]));return i},selectTrack:function(e,t){if(M(),!e||e!==c.TRACKS_TYPE.AUDIO&&e!==c.TRACKS_TYPE.TEXT)throw new Error('MediaPlayer Invalid Argument - "type" should be defined and shoud be kind of MediaPlayer.TRACKS_TYPE');if(!t||!(t.id||t.lang||t.subType))throw new Error("MediaPlayer.selectTrack(): track parameter is not in valid");var i=C(e);if(i){var n=O(e);if(n&&H(n,t))this.debug.log("[MediaPlayer] "+e+" track ["+t.id+" - "+t.lang+"] is already selected");else for(var r=0;r<i.length;r+=1)if(H(i[r],t))return void U(e,i[r])}else this.debug.error("[MediaPlayer] No available track for type "+e)},getSelectedTrack:function(e){if(M(),!e||e!==c.TRACKS_TYPE.AUDIO&&e!==c.TRACKS_TYPE.TEXT)throw new Error('MediaPlayer Invalid Argument - "type" should be defined and shoud be kind of MediaPlayer.TRACKS_TYPE');return F(O(e))},enableSubtitles:function(e){if(M(),"boolean"!=typeof e)throw new Error("MediaPlayer.enableSubtitles(): Invalid Arguments");y=e,E&&E.enableSubtitles(y)},isSubtitlesEnabled:function(){return M(),y},enableSubtitleExternDisplay:function(e){if("boolean"!=typeof e)throw new Error("MediaPlayer.enableSubtitleExternDisplay(): Invalid Arguments");this.config.setParams({"TextTrackExtensions.displayModeExtern":e})},getTTMLRenderingDiv:function(){return e?e.getTTMLRenderingDiv():null},attachTTMLRenderingDiv:function(t){M(),e.setTTMLRenderingDiv(t)},getMute:function(){return M(),e.getMute()},setMute:function(t){if(M(),"boolean"!=typeof t)throw new Error("MediaPlayer.setMute(): Invalid Arguments");e.setMute(t)},getVolume:function(){return M(),e.getVolume()},setVolume:function(t){if(M(),"number"!=typeof t||t<0||t>1)throw new Error("MediaPlayer.setVolume(): Invalid Arguments");e.setVolume(t)},getTerminalId:function(){var e=t(),i=function(){"use strict";var e,t,i,n;try{e=navigator.userAgent.toLowerCase(),i=-1!==e.indexOf("windows nt 10.0")?"Windows 10":-1!==e.indexOf("windows nt 6.3")?"Windows 8.1":-1!==e.indexOf("windows nt 6.2")?"Windows 8":-1!==e.indexOf("windows nt 6.1")?"Windows 7":-1!==e.indexOf("windows nt 6.0")?"Windows Vista/Windows Server 2008":-1!==e.indexOf("windows nt 5.2")?"Windows XP x64/Windows Server 2003":-1!==e.indexOf("windows nt 5.1")?"Windows XP":-1!==e.indexOf("windows nt 5.01")?"Windows 2000, Service Pack 1 (SP1)":-1!==e.indexOf("windows xp")?"Windows XP":-1!==e.indexOf("windows 2000")?"Windows 2000":-1!==e.indexOf("windows nt 5.0")?"Windows 2000":-1!==e.indexOf("windows nt 4.0")?"Windows NT 4.0":-1!==e.indexOf("windows nt")?"Windows NT 4.0":-1!==e.indexOf("winnt4.0")?"Windows NT 4.0":-1!==e.indexOf("winnt")?"Windows NT 4.0":-1!==e.indexOf("windows me")?"Windows ME":-1!==e.indexOf("win 9x 4.90")?"Windows ME":-1!==e.indexOf("windows 98")?"Windows 98":-1!==e.indexOf("win98")?"Windows 98":-1!==e.indexOf("windows 95")?"Windows 95":-1!==e.indexOf("windows_95")?"Windows 95":-1!==e.indexOf("win95")?"Windows 95":-1!==e.indexOf("ce")?"Windows CE":-1!==e.indexOf("win16")?"Windows 3.11":-1!==e.indexOf("iemobile")?"Windows Mobile":-1!==e.indexOf("wm5 pie")?"Windows Mobile":-1!==e.indexOf("windows phone 10.0")?"Windows Phone 10":-1!==e.indexOf("windows")?"Windows (Unknown Version)":-1!==e.indexOf("openbsd")?"Open BSD":-1!==e.indexOf("sunos")?"Sun OS":-1!==e.indexOf("ubuntu")?"Ubuntu":-1!==e.indexOf("ipad")?"iOS (iPad)":-1!==e.indexOf("ipod")?"iOS (iTouch)":-1!==e.indexOf("iphone")?"iOS (iPhone)":-1!==e.indexOf("mac os x beta")?"Mac O SX Beta":-1!==e.indexOf("mac os x 10")?/mac os x 10_(\d+)\_(\d+)/.test(e)?"Mac OS X 10."+RegExp.$1:"Mac OS X 10":-1!==e.indexOf("mac os x")?"Mac OS X":-1!==e.indexOf("mac_68000")?"Mac OS Classic (68000)":-1!==e.indexOf("68K")?"Mac OS Classic (68000)":-1!==e.indexOf("mac_powerpc")?"Mac OS Classic (PowerPC)":-1!==e.indexOf("ppc mac")?"Mac OS Classic (PowerPC)":-1!==e.indexOf("macintosh")?"Mac OS Classic":-1!==e.indexOf("googletv")?"Android (GoogleTV)":-1!==e.indexOf("xoom")?"Android (Xoom)":-1!==e.indexOf("htc_flyer")?"Android (HTC Flyer)":-1!==e.indexOf("android")?"Android":-1!==e.indexOf("symbian")?"Symbian":-1!==e.indexOf("series60")?"Symbian (Series 60)":-1!==e.indexOf("series70")?"Symbian (Series 70)":-1!==e.indexOf("series80")?"Symbian (Series 80)":-1!==e.indexOf("series90")?"Symbian (Series 90)":-1!==e.indexOf("x11")?"UNIX":-1!==e.indexOf("nix")?"UNIX":-1!==e.indexOf("linux")?"Linux":-1!==e.indexOf("qnx")?"QNX":-1!==e.indexOf("os/2")?"IBM OS/2":-1!==e.indexOf("beos")?"BeOS":-1!==e.indexOf("blackberry95")?"Blackberry (Storm 1/2)":-1!==e.indexOf("blackberry97")?"Blackberry (Bold)":-1!==e.indexOf("blackberry96")?"Blackberry (Tour)":-1!==e.indexOf("blackberry89")?"Blackberry (Curve 2)":-1!==e.indexOf("blackberry98")?"Blackberry (Torch)":-1!==e.indexOf("playbook")?"Blackberry (Playbook)":-1!==e.indexOf("wnd.rim")?"Blackberry (IE/FF Emulator)":-1!==e.indexOf("blackberry")?"Blackberry":-1!==e.indexOf("palm")?"Palm OS":-1!==e.indexOf("webos")?"WebOS":-1!==e.indexOf("hpwos")?"WebOS (HP)":-1!==e.indexOf("blazer")?"Palm OS (Blazer)":-1!==e.indexOf("xiino")?"Palm OS (Xiino)":-1!==e.indexOf("kindle")?"Kindle":-1!==e.indexOf("wii")?"Nintendo (Wii)":-1!==e.indexOf("nintendo ds")?"Nintendo (DS)":-1!==e.indexOf("playstation 3")?"Sony (Playstation Console)":-1!==e.indexOf("playstation portable")?"Sony (Playstation Portable)":-1!==e.indexOf("webtv")?"MSN TV (WebTV)":-1!==e.indexOf("inferno")?"Inferno":"Unknown",t=navigator.platform.toLowerCase(),n=-1!==t.indexOf("x64")?"64":-1!==e.indexOf("x86_64")?"64":-1!==e.indexOf("x86-64")?"64":-1!==e.indexOf("win64")?"64":-1!==e.indexOf("x64;")?"64":-1!==e.indexOf("amd64")?"64":-1!==e.indexOf("wow64")?"64":-1!==e.indexOf("x64_64")?"64":-1!==e.indexOf("ia65")?"64":-1!==e.indexOf("sparc64")?"64":-1!==e.indexOf("ppc64")?"64":-1!==e.indexOf("irix64")?"64":-1!==e.indexOf("irix64")?"64":"32"}catch(e){i="error",n="error"}return{name:i.replace(/\s+/g,""),bits:"x"+n}}();return i.name+"-"+i.bits+"-"+e.name},addPlugin:function(e){if(M(),void 0===e)throw new Error("MediaPlayer.addPlugin(): plugin undefined");if("function"!=typeof e.getName||"function"!=typeof e.getVersion||"function"!=typeof e.init||"function"!=typeof e.load||"function"!=typeof e.stop||"function"!=typeof e.reset)throw new Error("MediaPlayer.addPlugin(): plugin API not compliant");I[e.getName()]&&I[e.getName()].destroy(),this.debug.log("[MediaPlayer] Add plugin '"+e.getName()+"' (v"+e.getVersion()+")"),I[e.getName()]=e,e.deferInit=n.defer(),s&&e.init(this,function(){this.deferInit.resolve()}.bind(e))},removePlugin:function(e){var t;if(void 0===e)throw new Error("MediaPlayer.removePlugin(): plugin undefined");if("string"==typeof e)t=e;else{if("function"!=typeof e.getName)throw new Error("MediaPlayer.removePlugin(): plugin API not compliant");t=e.getName()}I[t]&&(this.debug.log("[MediaPlayer] Remove plugin '"+t),I[t].destroy(),I[t]=null,delete I[t])}}}).prototype={constructor:c},c.dependencies={},c.dependencies.protection={},c.dependencies.protection.servers={},c.utils={},c.models={},c.modules={},c.vo={},c.vo.metrics={},c.vo.protection={},c.rules={},c.rules.o={},c.di={},c.PUBLIC_EVENTS={error:"hasplayer",warning:"hasplayer",manifestUrlUpdate:"hasplayer",metricAdded:"hasplayer",metricChanged:"hasplayer",cueEnter:"hasplayer",cueExit:"hasplayer",play_bitrate:"video",download_bitrate:"video",bufferLevel_updated:"video",state_changed:"video"},c.TRACKS_TYPE={AUDIO:"audio",TEXT:"text"},c.hasMediaSourceExtension=function(){return(new c.utils.Capabilities).supportsMediaSource()},c.hasMediaKeysExtension=function(){return(new c.utils.Capabilities).supportsMediaKeys()},c.dependencies.AbrController=function(){"use strict";var e=!0,t={},i={},n={},r={},o="",s=function(e){return t.hasOwnProperty(e)||(t[e]=!0),t[e]},a=function(e){return i.hasOwnProperty(e)||(i[e]=0),i[e]},l=function(e,t){i[e]=t},d=function(t,i){var l,d,u,h,p,f,m=s(t),g=a(t),y=function(e){return r.hasOwnProperty(e)||(r[e]=0),r[e]}(t),_=c.rules.SwitchRequest.prototype.NO_CHANGE,E=c.rules.SwitchRequest.prototype.NO_CHANGE,b=c.rules.SwitchRequest.prototype.NO_CHANGE,v=[],x={};if(!e||!m)return this.debug.log("[AbrController]["+t+"] ABR disabled"),{quality:g,confidence:y};for(this.debug.log("[AbrController]["+t+"] Check rules...."),u=this.getMetricsFor(i),l=0,d=(p=this.abrRulesCollection.getRules(c.rules.BaseRulesCollection.prototype.QUALITY_SWITCH_RULES)).length;l<d;l+=1)v.push(p[l].checkIndex(g,u,i,o));for(x[c.rules.SwitchRequest.prototype.STRONG]=c.rules.SwitchRequest.prototype.NO_CHANGE,x[c.rules.SwitchRequest.prototype.WEAK]=c.rules.SwitchRequest.prototype.NO_CHANGE,x[c.rules.SwitchRequest.prototype.DEFAULT]=c.rules.SwitchRequest.prototype.NO_CHANGE,l=0,d=v.length;l<d;l+=1)(h=v[l]).quality!==c.rules.SwitchRequest.prototype.NO_CHANGE&&(this.debug.log("[AbrController]["+t+"] Request for quality "+h.quality+", priority = "+h.priority+" ("+p[l].name+")"),x[h.priority]=Math.min(x[h.priority],h.quality)),!0===h.max&&(b=Math.min(b,h.quality));return x[c.rules.SwitchRequest.prototype.WEAK]!==c.rules.SwitchRequest.prototype.NO_CHANGE&&(E=c.rules.SwitchRequest.prototype.WEAK,_=x[c.rules.SwitchRequest.prototype.WEAK]),x[c.rules.SwitchRequest.prototype.DEFAULT]!==c.rules.SwitchRequest.prototype.NO_CHANGE&&(E=c.rules.SwitchRequest.prototype.DEFAULT,_=x[c.rules.SwitchRequest.prototype.DEFAULT]),x[c.rules.SwitchRequest.prototype.STRONG]!==c.rules.SwitchRequest.prototype.NO_CHANGE&&(E=c.rules.SwitchRequest.prototype.STRONG,_=x[c.rules.SwitchRequest.prototype.STRONG]),_!==c.rules.SwitchRequest.prototype.NO_CHANGE&&void 0!==_&&(g=_),E!==c.rules.SwitchRequest.prototype.NO_CHANGE&&void 0!==E&&(y=E),b!==c.rules.SwitchRequest.prototype.NO_CHANGE&&(n[t]=b),f=this.manifestExt.getRepresentationCount(i),g<0&&(g=0),g>=f&&(g=f-1),y!==c.rules.SwitchRequest.prototype.STRONG&&y!==c.rules.SwitchRequest.prototype.WEAK&&(y=c.rules.SwitchRequest.prototype.DEFAULT),this.debug.info("[AbrController]["+t+"] Request quality: "+g),{quality:g,confidence:y}},u=function(e,t){var i,n=this.metricsExt.getBitratesForType(e,t),r=this.config.getParamFor(e,"ABR.minQuality","number",-1),o=this.config.getParamFor(e,"ABR.maxQuality","number",-1),s=this.config.getParamFor(e,"ABR.minBandwidth","number",-1),a=this.config.getParamFor(e,"ABR.maxBandwidth","number",-1),l=n.length;if(-1!==s)for(i=0;i<n.length;i++)if(n[i]>=s){r=-1===r?i:Math.max(i,r);break}if(-1!==a)for(i=n.length-1;i>=0;i--)if(n[i]<=a){o=-1===o?i:Math.min(i,o);break}return r=r>=l?l-1:r,r=r<0?0:r,o=o>=l||o<0?l-1:o,{min:r,max:o}};return{debug:void 0,abrRulesCollection:void 0,manifestExt:void 0,metricsModel:void 0,metricsExt:void 0,config:void 0,getAutoSwitchBitrate:function(){return e},setAutoSwitchBitrate:function(t){this.debug.log("[AbrController] Set auto switch: "+t),e=t},getMetricsFor:function(e){return this.manifestExt.getIsVideo(e)?this.metricsModel.getMetricsFor("video"):this.manifestExt.getIsAudio(e)?this.metricsModel.getMetricsFor("audio"):this.metricsModel.getMetricsFor("stream")},getPlaybackQuality:function(e,t){var i,o,s,a=this.getQualityFor(e),c=-1,h=-1,p=this.config.getParamFor(e,"ABR.switchUpIncrementally","boolean",!1);if(s=d.call(this,e,t),i=s.quality,o=s.confidence,this.getAutoSwitchBitrate()){p&&i>a&&(this.debug.log("[AbrController]["+e+"] Incremental switch => quality: "+i),i=a+1);var f=u.call(this,e,t);c=f.min,h=f.max,i<c&&(i=c,this.debug.log("[AbrController]["+e+"] New quality < min => "+i)),i>h&&(i=h,this.debug.log("[AbrController]["+e+"] New quality > max => "+i)),i>n[e]&&(i=n[e],this.debug.log("[AbrController]["+e+"] Max allowed quality = "+i))}return l.call(this,e,i),function(e,t){r[e]=t}.call(this,e,o),this.debug.info("[AbrController]["+e+"] Set quality: "+i),{quality:i,confidence:o}},getAutoSwitchFor:function(e){return s(e)},setAutoSwitchFor:function(e,i){i!==s(e)&&(this.debug.log("[AbrController]["+e+"] Set auto switch: "+i),function(e,i){t[e]=i}(e,i))},getQualityFor:function(e){return a(e)},setQualityFor:function(e,t){t!==a(e)&&(this.debug.log("[AbrController]["+e+"] Set playback quality: "+t),l(e,t))},isMinQuality:function(e,t,i){return i<=u.call(this,e,t).min},setPlayerState:function(e){o=e}}},c.dependencies.AbrController.prototype={constructor:c.dependencies.AbrController},c.dependencies.AbrController.BANDWIDTH_SAFETY=.9,c.dependencies.BufferController=function(){"use strict";var e,i,r,o,s,a,l,d,h,p,f=!1,m=!1,g=!1,_=!0,E=[],b=!1,v=-1,x=!0,T=!1,S=!1,D=-1,I=-1,M=!1,L=!1,R=!1,A=null,P=null,w=0,N=null,B=0,F=!1,C=null,O=!1,U=null,k=null,H=!1,K=0,V=!0,q=!1,z=null,Y=null,j=!0,W=!1,G=-1,X=-1,Q=null,J=0,$=null,Z=-1,ee=null,te=NaN,ie="Safari"===t().name,ne="Firefox"===t().name,re=function(){Ee.call(this)&&null!==N&&this.fragmentController.onBufferControllerStateChange()},oe=function(e,t){var i=0,n=null;!1===j&&(n=Y.start,i=e.getTime()-n.getTime(),Y.duration=i,Y.stopreason=t,j=!0)},se=function(e){"text"!==o&&(this.debug.info("[BufferController]["+o+"] stalled = "+e),M=e,this.videoModel.stallStream(o,M),this.abrController.setPlayerState(M?"buffering":"playing"))},ae=function(){var e;if(!0!==m&&null===Q){if(!1===b&&(e=new Date,oe(e,c.vo.metrics.PlayList.Trace.USER_REQUEST_STOP_REASON),z=this.metricsModel.addPlayList(o,e,0,c.vo.metrics.PlayList.INITIAL_PLAY_START_REASON)),R){if("application/ttml+xml"===U.mimeType)return;R=!1}m=!0,this.debug.info("[BufferController]["+o+"] START"),g=!0,-1===G&&this.metricsModel.addState(o,"buffering",this.videoModel.getCurrentTime()),G=0,X=-1,$=null,this.fragmentController.clearExecutedRequests(N),function(){f&&m&&(this.debug.info("[BufferController]["+o+"] startPlayback"),Ae.call(this))}.call(this)}},le=function(){m&&(this.debug.info("[BufferController]["+o+"] STOP"),clearTimeout(h),clearTimeout(p),m=!1,g=!1,b=!1,v=-1,oe(new Date,c.vo.metrics.PlayList.Trace.USER_REQUEST_STOP_REASON),this.fragmentController.abortRequestsForModel(N))},de=function(t){return e[t]},ue=function(e){this.debug.info("[BufferController]["+o+"] Load request ",null!==e.url?e.url:e.quality)},ce=function(e,t){void 0!==e.sequenceNumber&&(Z=e.sequenceNumber),this.fragmentController.isInitializationRequest(e)?he.call(this,e,t):pe.call(this,e,t)},he=function(e,t){if(Ee.call(this)){var i=t.data,n=e.quality,r=this;this.debug.log("[BufferController]["+o+"] Initialization loaded ",n);try{this.fragmentController.process(i).then(function(t){t?(E[n]=t,r.debug.info("[BufferController]["+o+"] Buffer initialization segment ",null!==e.url?e.url:e.quality),fe.call(r,t,e.quality).then(function(){Ee.call(r)&&De.call(r)})):De.call(r)},function(e){be.call(r),e.name?r.errHandler.sendError(e.name,e.message,e.data):r.errHandler.sendError(c.dependencies.ErrorHandler.prototype.INTERNAL_ERROR,"Internal error while processing media segment",e.message)})}catch(e){be.call(r),e.name?r.errHandler.sendError(e.name,e.message,e.data):r.errHandler.sendError(c.dependencies.ErrorHandler.prototype.INTERNAL_ERROR,"Internal error while processing media segment",e.message)}}},pe=function(e,t){if(Ee.call(this)){var r,s=this.manifestExt.getEventStreamForAdaptationSet(this.getData()),a=this.manifestExt.getEventStreamForRepresentation(this.getData(),i),l=this;te=e.duration,J=0,this.debug.log("[BufferController]["+o+"] Media loaded ",e.url),!0===this.chunkAborted&&(this.chunkAborted=!1),1===this.chunkMissingCount&&(this.chunkMissingCount=0);try{this.fragmentController.process(t.data,e,i).then(function(t){t?((s.length>0||a.length>0)&&(r=ye.call(l,t,e,s,a),l.eventController.addInbandEvents(r)),l.debug.info("[BufferController]["+o+"] Buffer segment from url ",e.url),t=_e.call(l,t),n.when(!S||xe.call(l)).then(function(){S=!1,ne&&(k.timestampOffset=-ge(t,e)),fe.call(l,t,e.quality,e).then(function(){D!==e.quality&&(l.debug.log("[BufferController]["+o+"] Buffered quality changed: "+e.quality),l.metricsModel.addBufferedSwitch(o,e.startTime,i.id,e.quality),D=e.quality),be.call(l),Ae.call(l)})})):(l.debug.error("[BufferController]["+o+"] Error with segment data, no bytes to push"),be.call(l),Ae.call(l))},function(e){be.call(l),e.name?l.errHandler.sendError(e.name,e.message,e.data):l.errHandler.sendError(c.dependencies.ErrorHandler.prototype.INTERNAL_ERROR,"Internal error while processing media segment",e.message)})}catch(e){be.call(l),e.name?l.errHandler.sendError(e.name,e.message,e.data):l.errHandler.sendError(c.dependencies.ErrorHandler.prototype.INTERNAL_ERROR,"Internal error while processing media segment",e.message)}}},fe=function(e,t,r){var s=n.defer(),a=this.videoModel.getCurrentTime(),d=new Date,u=this;if(!0===j&&(j=!1,Y=this.metricsModel.appendPlayListTrace(z,i.id,null,d,a,null,1,null)),Me())return ve.call(this).then(function(){Me()&&(u.debug.log("[BufferController]["+o+"] Buffering segment"),u.sourceBufferExt.append(k,e,r).then(function(){if(u.debug.log("[BufferController]["+o+"] Segment buffered"),F=!1,B>1&&!ie)xe.call(u,-1,Le.call(u)-l).then(function(){me.call(u),s.resolve()});else if(H){var e=q?-1:Le.call(u)+te,t=q?Le.call(u)-te:-1;xe.call(u,e,t).then(function(){me.call(u),s.resolve()})}else me.call(u),s.resolve();u.system.notify("bufferUpdated")},function(i){"text"===o?(u.debug.error("[BufferController]["+o+"] Failed to append data in source buffer : "+i.err.message),s.resolve()):(u.errHandler.sendError(c.dependencies.ErrorHandler.prototype.MEDIA_ERR_APPEND_SOURCEBUFFER,"Failed to append data into "+o+" source buffer",new c.vo.Error(i.err.code,i.err.name,i.err.message)),i.err.code===c.dependencies.ErrorHandler.prototype.DOM_ERR_QUOTA_EXCEEDED?(C={data:e,quality:t},A=s,F=!0,w=0,le.call(u)):s.resolve())}))}),s.promise},me=function(){var e,t,i=null;if(this.debug.getLevel()>=this.debug.INFO&&k){if(null===(i=this.sourceBufferExt.getAllRanges(k))||0===i.length)return;for(e=0,t=i.length;e<t;e+=1)this.debug.info("[BufferController]["+o+"] Buffered range ["+e+"]: "+i.start(e)+" - "+i.end(e)+" ("+this.getVideoModel().getCurrentTime()+")")}},ge=function(e,t){var i,n,r=y.deserialize(e),o=r.getBoxByType("moov"),s=r.getBoxByType("moof"),a=null===s?null:s.getBoxByType("traf"),l=null===a?null:a.getBoxByType("trun");if(null===l||0===l.samples_table.length)return 0;if(void 0===(i=l.samples_table[0].sample_composition_time_offset))return 0;if(o){n=o.getBoxByType("mvhd").timescale}else n=t.timescale;return i/n},ye=function(e,t,i,n){var r,o,s,a=[],l=0,d=Math.pow(256,2),c=Math.pow(256,3),h=Math.max(isNaN(t.startTime)?0:t.startTime,0),p=[];W=!1,s=i.concat(n);for(var f=0;f<s.length;f++)p[s[f].schemeIdUri]=s[f];for(;l<e.length&&(r=String.fromCharCode(e[l+4],e[l+5],e[l+6],e[l+7]),o=e[l]*c+e[l+1]*d+256*e[l+2]+1*e[l+3],"moov"!==r&&"moof"!==r);){if("emsg"===r){W=!0;for(var m=["","",0,0,0,0,""],g=0,y=l+12;y<o+l;)0===g||1===g||6===g?(0!==e[y]?m[g]+=String.fromCharCode(e[y]):g+=1,y+=1):(m[g]=e[y]*c+e[y+1]*d+256*e[y+2]+1*e[y+3],y+=4,g+=1);var _=m[0],E=m[1],b=m[2],v=m[3],x=m[4],T=m[5],S=m[6],D=h*b+v;if(p[_]){var I=new u.vo.Event;I.eventStream=p[_],I.eventStream.value=E,I.eventStream.timescale=b,I.duration=x,I.id=T,I.presentationTime=D,I.messageData=S,I.presentationTimeDelta=v,a.push(I)}}l+=o}return a},_e=function(e){if(!W)return e;for(var t,i,n=e.length,r=0,o=0,s=0,a=Math.pow(256,2),l=Math.pow(256,3),d=new Uint8Array(e.length);r<n;){if(t=String.fromCharCode(e[r+4],e[r+5],e[r+6],e[r+7]),i=e[r]*l+e[r+1]*a+256*e[r+2]+1*e[r+3],"emsg"!==t)for(s=r;s<r+i;s++)d[o]=e[s],o+=1;r+=i}return d.subarray(0,o)},Ee=function(){return!!m||(be.call(this),!1)},be=function(){Q&&(Q.resolve(),Q=null)},ve=function(){var e,t,i=n.defer(),r=0;return F?((t=function(){var n,o,s=this.videoModel.getCurrentTime();n=(o=this.fragmentController.getExecutedRequestForTime(N,s))&&!isNaN(o.startTime)?o.startTime:Math.floor(s),e=o&&!isNaN(o.duration)?o.duration:1,xe.call(this,0,n).then(function(n){(r+=n)>=e?i.resolve():setTimeout(t,1e3*e)})}).call(this),i.promise):n.when(!0)},xe=function(e,t){var i,s,a=n.defer(),l=this;return 0===k.buffered.length?(a.resolve(0),a.promise):(i=void 0!==e&&-1!==e?e:k.buffered.start(0),(s=void 0!==t&&-1!==t?t:k.buffered.end(k.buffered.length-1))<=i?(a.resolve(0),a.promise):(this.debug.info("[BufferController]["+o+"] Remove from "+i+" to "+s+" ("+this.getVideoModel().getCurrentTime()+")"),"text"!==o&&this.sourceBufferExt.abort(r,k),this.sourceBufferExt.remove(k,i,s,P.duration,r).then(function(){l.fragmentController.removeExecutedRequestsBeforeTime(N,s+1),l.fragmentController.cancelPendingRequestsForModel(N),a.resolve(s-i)},function(e){l.errHandler.sendWarning(c.dependencies.ErrorHandler.prototype.MEDIA_ERR_REMOVE_SOURCEBUFFER,"Failed to remove data from "+o+" source buffer",new c.vo.Error(e.code,e.name,e.message)),a.resolve(0)}),a.promise))},Te=function(e){Ee.call(this)&&(be.call(this),e.aborted?we.call(this):"text"!==o?3===(J+=1)?this.errHandler.sendError(c.dependencies.ErrorHandler.prototype.DOWNLOAD_ERR_CONTENT,"Failed to download media segment",{url:e.url,status:e.status}):(this.errHandler.sendWarning(c.dependencies.ErrorHandler.prototype.DOWNLOAD_ERR_CONTENT,"Failed to download media segment",{url:e.url,status:e.status}),$=e,0===G&&Oe.call(this)):this.errHandler.sendWarning(c.dependencies.ErrorHandler.prototype.DOWNLOAD_ERR_CONTENT,"Failed to download media segment",{url:e.url,status:e.status}))},Se=function(){this.debug.log("[BufferController]["+o+"] Stream is complete."),R=!0,oe(new Date,c.vo.metrics.PlayList.Trace.END_OF_CONTENT_STOP_REASON),be.call(this),le.call(this),this.system.notify("bufferingCompleted")},De=function(){if(Ee.call(this)){var e,t,n=Le.call(this),r=this;t=S?n:(e=this.sourceBufferExt.getBufferRange(k,n))?e.end:n,-1===Z||b||S?(this.debug.log("[BufferController]["+o+"] loadNextFragment for time: "+t),this.indexHandler.getSegmentRequestForTime(i,t).then(Ie.bind(this),function(){I=-1,Se.call(r)})):(this.debug.log("[BufferController]["+o+"] loadNextFragment for sequence number: "+Z),this.indexHandler.getNextSegmentRequestFromSN(i,Z).then(Ie.bind(this)))}},Ie=function(e){if(Ee.call(this)){var t=this.manifestModel.getValue();null===e||e.action!==e.ACTION_COMPLETE?null!==e?(H&&(e=this.indexHandler.getIFrameRequest(e)),this.fragmentController.isFragmentLoadedOrPending(this,e)?(this.debug.log("[BufferController]["+o+"] new fragment request => already loaded or pending "+e.url),this.indexHandler.getNextSegmentRequest(i).then(Ie.bind(this))):(this.fragmentController.prepareFragmentForLoading(this,e,ue,ce,Te,null),re.call(this))):(this.debug.log("[BufferController]["+o+"] loadNextFragment failed"),be.call(this),L?"M3U"===t.name&&Pe.call(this):Se.call(this)):Se.call(this)}},Me=function(){return!!U&&!!k},Le=function(){var e=this.videoModel.getCurrentTime();return b?v:e},Re=function(e){if(Me()){var t=Le.call(this);B=this.sourceBufferExt.getBufferLength(k,t),this.debug.log("[BufferController]["+o+"] Working time = "+t+", Buffer level = "+B.toFixed(3)),e&&this.metricsModel.addBufferLevel(o,new Date,B),this.updateBufferState()}},Ae=function(){if(Ee.call(this)){var e,t;this.debug.log("[BufferController]["+o+"] Check buffer..."),Re.call(this,!0),M&&B>a&&se.call(this,!1),e=function(){var e=this.videoModel.getCurrentTime();return P.start+P.duration-e}.call(this),this.debug.log("[BufferController]["+o+"] time to end = "+e),H?B<1&&we.call(this):T||S||B<s&&(s<e||s>=e&&!R)?we.call(this):(t=B-s+.5,Pe.call(this,t))}},Pe=function(e){var t=this;e=e||1,this.debug.log("[BufferController]["+o+"] Check buffer in = "+e.toFixed(3)+" ms (bufferLevel = "+B+")"),clearTimeout(h),h=setTimeout(function(){h=null,Ae.call(t)},1e3*e)},we=function(){var t,r=new Date,s=this.videoModel.getCurrentTime(),a=this.manifestModel.getValue(),l=!1,d=null,u=this;null!==Q&&this.debug.error("[BufferController]["+o+"] deferredFragmentBuffered has not been resolved, create a new one is not correct."),Q=n.defer(),this.debug.log("[BufferController]["+o+"] Start buffering process..."),Fe.call(this),l=0===E.length&&"M3U"!==a.name,t=this.abrController.getPlaybackQuality(o,U).quality,i=de.call(this,t),t!==I&&(this.debug.log("[BufferController]["+o+"] currentDownloadQuality changed : "+t),I=t,l=!0,oe(new Date,c.vo.metrics.PlayList.Trace.REPRESENTATION_SWITCH_STOP_REASON),this.debug.log("[BufferController]["+o+"] Send RepresentationSwitch with quality = "+t),this.metricsModel.addRepresentationSwitch(o,r,s,i.id,t),d=Ne.call(this)),n.when(d||!0).then(function(){!0===l?function(t){if(!Ee.call(this))return n.when(null);var i=this;return E[t]?(this.debug.info("[BufferController]["+o+"] Buffer initialization segment, quality = ",t),fe.call(this,E[t],t).then(function(){i.debug.log("[BufferController]["+o+"] Initialization segment buffered"),Ee.call(i)&&De.call(i)}),n.when(null)):this.indexHandler.getInitRequest(e[t])}.call(u,t).then(function(e){null!==e&&(u.fragmentController.prepareFragmentForLoading(u,e,ue,ce,Te,null),re.call(u))},function(e){be.call(u),e.name===c.dependencies.ErrorHandler.prototype.MEDIA_ERR_CODEC_UNSUPPORTED?u.errHandler.sendError(e.name,e.message,e.data):u.errHandler.sendError(c.dependencies.ErrorHandler.prototype.INTERNAL_ERROR,"Internal error while processing initialization segment",e.message)}):De.call(u)},function(e){be.call(u),e&&u.errHandler.sendError(e.name,e.message,e.data)})},Ne=function(){var t,r,s,a=this.manifestModel.getValue(),l=this;return"M3U"!==a.name?n.when(!0):L||"SegmentList"!==i.segmentInfoType?(ee&&(clearTimeout(ee),ee=null),t=n.defer(),s=this.manifestExt.getDataIndex(U,a,P.index),r=a.Period_asArray[P.index].AdaptationSet_asArray[s].Representation_asArray[I],this.debug.log("[BufferController]["+o+"] Update playlist for representation "+r.id),this.parser.hlsParser.updatePlaylist(r,U).then(function(){e=Be.call(l,U,P),i=de.call(l,I);var n=(r=a.Period_asArray[P.index].AdaptationSet_asArray[s].Representation_asArray[I]).SegmentList.SegmentURL_asArray;n>0&&(te=n[n.length-1]-1),ee=setTimeout(function(){Ne.call(l)},1e3*te),t.resolve()},function(e){e&&l.errHandler.sendWarning(e.name,e.message,e.data),t.reject(e)}),t.promise):n.when(!0)},Be=function(e,t){var i,n,r=this.manifestModel.getValue();return i=this.manifestExt.getDataIndex(e,r,t.index),n=this.manifestExt.getAdaptationsForPeriod(r,t),this.manifestExt.getRepresentationsForAdaptation(r,n[i])},Fe=function(){if(!1===x)return!1;this.debug.log("[BufferController]["+o+"] Data changed"),e=Be.call(this,U,P),i=de.call(this,this.abrController.getPlaybackQuality(o,U).quality),this.bufferExt.updateData(U,o),T&&(E=[],this.fragmentController.clearExecutedRequests(N),S=!0,"text"===o&&(k.UpdateLang(U.id,U.lang),"application/ttml+xml"===U.mimeType&&xe.call(this))),x=!1,T=!1},Ce=function(e){var t,i,n=this.abrController.getQualityFor(o);if(!this.abrController.isMinQuality(o,U,n)){i=this.abrRulesCollection.getRules(c.rules.BaseRulesCollection.prototype.ABANDON_FRAGMENT_RULES);var r=function(e){e.quality<n&&(this.fragmentController.abortRequestsForModel(N),this.debug.info("[BufferController]["+o+"] Abandon current segment download"))};for(t=0;t<i.length;t++)i[t].execute(e.data.request,r.bind(this))}},Oe=function(){null!==$&&(this.debug.log("[BufferController]["+o+"] Signal segment loading failed"),this.system.notify("segmentLoadingFailed",$),$=null)};return{videoModel:void 0,metricsModel:void 0,manifestExt:void 0,manifestModel:void 0,bufferExt:void 0,sourceBufferExt:void 0,abrController:void 0,parser:void 0,fragmentExt:void 0,indexHandler:void 0,debug:void 0,system:void 0,errHandler:void 0,config:void 0,abrRulesCollection:void 0,initialize:function(e,t,i,n,r,o,u){var h=this.manifestModel.getValue();this.debug.log("[BufferController]["+e+"] Initialize"),this[c.dependencies.FragmentLoader.eventList.ENAME_LOADING_PROGRESS]=Ce,L=this.manifestExt.getIsDynamic(h),this.setMediaSource(o),this.setType(e),this.setBuffer(n),this.setFragmentController(r),this.setEventController(u),s=this.config.getParamFor(e,"BufferController.minBufferTime","number",-1),a=this.config.getParamFor(e,"BufferController.minBufferTimeForPlaying","number",c.dependencies.BufferExtensions.BUFFER_TIME_AT_STARTUP),l=this.config.getParamFor(e,"BufferController.bufferToKeep","number",c.dependencies.BufferExtensions.DEFAULT_BUFFER_TO_KEEP),d=this.config.getParamFor(e,"BufferController.liveDelay","number",-1),this.updateData(i,t),this.load(),f=!0},load:function(){var e=this.manifestModel.getValue(),t=this;Fe.call(this),i=de.call(this,this.abrController.getPlaybackQuality(o,U).quality),I=-1,xe.call(this).then(function(){i&&(t.indexHandler.setIsDynamic(L),-1===s&&(s=t.bufferExt.decideBufferLength(e.minBufferTime,P.duration,g)),(-1===d||d<s)&&(d=s),e.minBufferTime=s,"video"===o&&(L?t.indexHandler.updateSegmentList(i).then(function(){(function(){var e,t=n.defer(),r=i.segmentAvailabilityRange.end,s=this;return this.debug.log("[BufferController]["+o+"] Manifest live edge = "+r),e=Math.max(r-d,i.segmentAvailabilityRange.start),this.indexHandler.getSegmentRequestForTime(i,e).then(function(e){P.liveEdge=e.startTime,s.debug.log("[BufferController]["+o+"] Live edge = "+P.liveEdge),t.resolve(P.liveEdge)}),t.promise}).call(t).then(function(e){t.system.notify("startTimeFound",e)})}):t.indexHandler.getCurrentTime(i).then(function(e){e<i.segmentAvailabilityRange.start&&(e=i.segmentAvailabilityRange.start),t.system.notify("startTimeFound",e)})))})},getIndexHandler:function(){return this.indexHandler},getType:function(){return o},setType:function(e){o=e,void 0!==this.indexHandler&&this.indexHandler.setType(e)},getPeriodInfo:function(){return P},getVideoModel:function(){return this.videoModel},setVideoModel:function(e){this.videoModel=e},getFragmentController:function(){return this.fragmentController},setFragmentController:function(e){e&&(this.fragmentController=e,(N=this.fragmentController.attachBufferController(this)).fragmentLoader.subscribe(c.dependencies.FragmentLoader.eventList.ENAME_LOADING_PROGRESS,this),N.setType(o))},setEventController:function(e){this.eventController=e},getData:function(){return U},updateData:function(e,t){this.debug.log("[BufferController]["+o+"] Update data"),T=null!==U&&(U.id!==e.id||U.lang!==e.lang||U.subType!==e.subType),U=e,P=t,x=!0,T&&(this.debug.log("[BufferController]["+o+"] Track changed"),clearTimeout(h),h=null,R=!1,ae.call(this),null===Q&&Ae.call(this))},getHtmlVideoState:function(){return G},getAvailableRepresentations:function(){return e},getCurrentRepresentation:function(){return i},getBuffer:function(){return k},setBuffer:function(e){k=e},getMinBufferTime:function(){return s},setMinBufferTime:function(e){s=e},getLiveDelay:function(){return d},setMediaSource:function(e){r=e},isReady:function(){return!0},isBufferingCompleted:function(){return R},updateManifest:function(){this.system.notify("manifestUpdate")},updateBufferState:function(){var e,t=this.videoModel.getCurrentTime(),i=t-(-1===X?t:X),n=this;if(clearTimeout(p),p=null,!1!==m&&"text"!==o&&!H){switch(G){case-1:G=0,this.debug.info("[BufferController]["+o+"] BUFFERING - "+t+" - "+B),this.metricsModel.addState(o,"buffering",t);break;case 0:!this.getVideoModel().isPaused()&&i>0&&B>=1?(G=1,this.debug.info("[BufferController]["+o+"] PLAYING - "+t),this.metricsModel.addState(o,"playing",t),b=!1,v=-1,J=0):this.getVideoModel().isStalled()||(e=this.sourceBufferExt.getAllRanges(k));break;case 1:if(!this.getVideoModel().isPaused()&&!this.getVideoModel().isSeeking()&&(i<=0&&B<=1||0===B))if(G=0,this.debug.info("[BufferController]["+o+"] BUFFERING - "+t+" - "+B),this.metricsModel.addState(o,"buffering",t),$)Oe.call(this);else{e=this.sourceBufferExt.getAllRanges(k);var r;for(r=0;r<e.length&&!(t<e.start(r)&&(!L||e.start(r)-t<te));r++);r<e.length&&(this.debug.info("[BufferController]["+o+"] BUFFERING => skip buffer discontinuity, seek to "+e.start(r)),this.videoModel.setCurrentTime(e.start(r)))}p=setTimeout(function(){p=null,Re.call(n,!1)},1e3)}t>0&&(X=t)}},updateStalledState:function(){M=this.videoModel.isStalled()},reset:function(e){var t=function(e){e&&(e.reject(),e=null)},i=n.defer(),s=this;return le.call(this),this.sourceBufferExt.abort(r,k),ee&&(clearTimeout(ee),ee=null),n.when(!Q||Q.promise).then(function(){t(A),t(Q),N&&(N.fragmentLoader.unsubscribe(c.dependencies.FragmentLoader.eventList.ENAME_LOADING_PROGRESS,s.abrController),s.fragmentController.abortRequestsForModel(N),s.fragmentController.detachBufferController(N),N=null),E=[],_=!0,F=!1,C=null,O=!1,H&&(s.abrController.setAutoSwitchFor(o,V),s.abrController.setQualityFor(o,K)),e||s.sourceBufferExt.removeSourceBuffer(r,k),U=null,k=null,i.resolve()},function(){i.reject()}),i.promise},getSegmentDuration:function(){return te},setTrickMode:function(e,t){var i=n.defer();return this.debug.log("[BufferController]["+o+"] setTrickMode - enabled = "+e),H===e?(i.resolve(),i.promise):((H=e)?(q=t,K=this.abrController.getQualityFor(o),V=this.abrController.getAutoSwitchFor(o),this.abrController.setAutoSwitchFor(o,!1),this.abrController.setQualityFor(o,0),i.resolve()):(this.abrController.setAutoSwitchFor(o,V),this.abrController.setQualityFor(o,K),xe.call(this).then(function(){i.resolve()})),i.promise)},start:ae,seek:function(e){var t=this;!0===b&&v===e||(this.debug.info("[BufferController]["+o+"] SEEK: "+e),!0===m&&le.call(this),b=!0,v=e,n.when(!Q||Q.promise).then(function(){se.call(t,!0),ae.call(t)}))},stop:le,seeked:function(){this.debug.info("[BufferController]["+o+"] SEEKED"),b=!1,v=-1},updateBufferLevel:Re}},c.dependencies.BufferController.prototype={constructor:c.dependencies.BufferController},c.dependencies.BufferExtensions=function(){"use strict";var e,t,i=0,r=0,o=null,s=null,a=function(e){var t=this.metricsExt.getCurrentHttpRequest(e);return null!==t?(t.tresponse.getTime()-t.trequest.getTime())/1e3:0};return{system:void 0,videoModel:void 0,metricsExt:void 0,metricsModel:void 0,abrController:void 0,bufferMax:void 0,updateData:function(e,t){if(e){var n=e.Representation_asArray.length-1;"audio"===t?(i=n,o=e):"video"===t&&(r=n,s=e)}},getTopQualityIndex:function(e){var t=null;return"audio"===e?t=i:"video"===e&&(t=r),t},decideBufferLength:function(t,i){return e=i===1/0?t>0?t:c.dependencies.BufferExtensions.DEFAULT_MIN_BUFFER_TIME:t>=i?Math.min(i,c.dependencies.BufferExtensions.DEFAULT_MIN_BUFFER_TIME):Math.min(i,t)},getLeastBufferLevel:function(){var e=this.metricsModel.getReadOnlyMetricsFor("video"),t=this.metricsExt.getCurrentBufferLevel(e),i=this.metricsModel.getReadOnlyMetricsFor("audio"),n=this.metricsExt.getCurrentBufferLevel(i);return null===t||null===n?null!==n?n.level:null!==t?t.level:null:Math.min(n.level,t.level)},getRequiredBufferLength:function(l,d,u,h){var p,f=this.metricsModel.getReadOnlyMetricsFor("video"),m=this.metricsModel.getReadOnlyMetricsFor("audio"),g=h>=c.dependencies.BufferExtensions.LONG_FORM_CONTENT_DURATION_THRESHOLD,y=n.defer(),_=!1;return this.bufferMax===c.dependencies.BufferExtensions.BUFFER_SIZE_MIN?(p=e,y.resolve(p)):this.bufferMax===c.dependencies.BufferExtensions.BUFFER_SIZE_INFINITY?(p=h,y.resolve(p)):this.bufferMax===c.dependencies.BufferExtensions.BUFFER_SIZE_REQUIRED?(t=e,u||l||(_=function(){var e,t;return e=o?this.abrController.getQualityFor("audio"):i,t=s?this.abrController.getQualityFor("video"):r,e===i&&t===r}.call(this)),_&&(t=g?c.dependencies.BufferExtensions.BUFFER_TIME_AT_TOP_QUALITY_LONG_FORM:c.dependencies.BufferExtensions.BUFFER_TIME_AT_TOP_QUALITY),p=t+d+Math.max(a.call(this,f),a.call(this,m)),y.resolve(p)):y.reject("invalid bufferMax value: "+this.bufferMax),y.promise},getBufferTarget:function(){return void 0===t?e:t}}},c.dependencies.BufferExtensions.BUFFER_SIZE_REQUIRED="required",c.dependencies.BufferExtensions.BUFFER_SIZE_MIN="min",c.dependencies.BufferExtensions.BUFFER_SIZE_INFINITY="infinity",c.dependencies.BufferExtensions.BUFFER_TIME_AT_STARTUP=1,c.dependencies.BufferExtensions.DEFAULT_MIN_BUFFER_TIME=16,c.dependencies.BufferExtensions.DEFAULT_BUFFER_TO_KEEP=30,c.dependencies.BufferExtensions.DEFAULT_LIVE_DELAY=16,c.dependencies.BufferExtensions.BUFFER_TIME_AT_TOP_QUALITY=30,c.dependencies.BufferExtensions.BUFFER_TIME_AT_TOP_QUALITY_LONG_FORM=300,c.dependencies.BufferExtensions.LONG_FORM_CONTENT_DURATION_THRESHOLD=600,c.dependencies.BufferExtensions.prototype.constructor=c.dependencies.BufferExtensions,c.utils.Capabilities=function(){"use strict"},c.utils.Capabilities.prototype={constructor:c.utils.Capabilities,system:void 0,supportsMediaSource:function(){"use strict";var e="WebKitMediaSource"in window,t="MediaSource"in window;return e||t},supportsMediaKeys:function(){"use strict";var e="WebKitMediaKeys"in window,t="MSMediaKeys"in window,i="MediaKeys"in window;return e||t||i},supportsEncryptedMedia:function(){return this.system.hasMapping("protectionModel")},supportsCodec:function(e,t){"use strict";if(!(e instanceof HTMLMediaElement))throw"element must be of type HTMLMediaElement.";var i=e.canPlayType(t);return"probably"===i||"maybe"===i}},c.utils.Config=function(){"use strict";var e=["video","audio"],t={"BufferController.minBufferTimeForPlaying":-1,"BufferController.minBufferTime":-1,"BufferController.bufferToKeep":-1,"BufferController.liveDelay":-1,"ABR.minBandwidth":-1,"ABR.maxBandwidth":-1,"ABR.minQuality":-1,"ABR.maxQuality":-1,"ABR.switchUpIncrementally":-1,"ABR.switchUpRatioSafetyFactor":-1,"ABR.latencyInBandwidth":-1,"ABR.switchDownBufferTime":-1,"ABR.switchDownBufferRatio":-1,"ABR.switchLowerBufferTime":-1,"ABR.switchLowerBufferRatio":-1,"ABR.switchUpBufferTime":-1,"ABR.switchUpBufferRatio":-1,"ABR.keepBandwidthCondition":-1,"ABR.droppedFramesMinRatio":-1,"ABR.droppedFramesMaxRatio":-1,"ManifestLoader.RetryAttempts":-1,"ManifestLoader.RetryInterval":-1,"FragmentLoader.RetryAttempts":-1,"FragmentLoader.RetryInterval":-1,"Protection.licensePersistence":-1,video:{},audio:{}},i=function(e,t,i,n){var r=e[t];if(void 0===r||-1===r)return n;if(void 0!==i&&typeof r!==i)switch(i){case"number":r=Number(r);break;case"boolean":r="true"===r||"1"===r||1===r}return r};return{debug:void 0,setup:function(){},setParams:function(i){!function(i){var n,r,o;for(n in i)if(i.hasOwnProperty(n)&&-1===n.indexOf("//"))if(e.indexOf(n)>-1){r=i[n];for(o in r)r.hasOwnProperty(o)&&(t[n][o]=i[n][o])}else t[n]=i[n]}(i);var n=this.getParam("Debug.level","number",-1);-1!==n&&this.debug.setLevel(n)},getParam:function(e,n,r){return function(e,n,r){return i(t,e,n,r)}(e,n,r)},getParamFor:function(e,n,r,o){return function(e,n,r,o){var s=t[e];return void 0!==s&&void 0!==s[n]?i(s,n,r,o):i(t,n,r,o)}(e,n,r,o)}}},c.utils.Config.prototype={constructor:c.utils.Config},c.di.Context=function(){"use strict";return{system:void 0,setup:function(){this.system.autoMapOutlets=!0,this.system.mapSingleton("capabilities",c.utils.Capabilities),this.system.mapSingleton("config",c.utils.Config),this.system.mapSingleton("debug",c.utils.Debug),this.system.mapSingleton("debugController",c.utils.DebugController),this.system.mapClass("domParser",c.utils.DOMParser),this.system.mapSingleton("eventBus",c.utils.EventBus),this.system.mapSingleton("textTrackExtensions",c.utils.TextTrackExtensions),this.system.mapSingleton("tokenAuthentication",c.utils.TokenAuthentication),this.system.mapSingleton("vttParser",c.utils.VTTParser),this.system.mapSingleton("ttmlParser",c.utils.TTMLParser),this.system.mapSingleton("ttmlRenderer",c.utils.TTMLRenderer),this.system.mapSingleton("manifestModel",c.models.ManifestModel),this.system.mapClass("metrics",c.models.MetricsList),this.system.mapSingleton("metricsModel",c.models.MetricsModel),this.system.mapSingleton("uriQueryFragModel",c.models.URIQueryAndFragmentModel),this.system.mapSingleton("videoModel",c.models.VideoModel),this.system.mapSingleton("abrController",c.dependencies.AbrController),this.system.mapClass("bufferController",c.dependencies.BufferController),this.system.mapSingleton("bufferExt",c.dependencies.BufferExtensions),this.system.mapSingleton("errHandler",c.dependencies.ErrorHandler),this.system.mapClass("eventController",c.dependencies.EventController),this.system.mapClass("fragmentController",c.dependencies.FragmentController),this.system.mapClass("fragmentLoader",c.dependencies.FragmentLoader),this.system.mapClass("fragmentModel",c.dependencies.FragmentModel),this.system.mapClass("manifestLoader",c.dependencies.ManifestLoader),this.system.mapSingleton("manifestUpdater",c.dependencies.ManifestUpdater),this.system.mapSingleton("mediaSourceExt",c.dependencies.MediaSourceExtensions),this.system.mapSingleton("notifier",c.dependencies.Notifier),this.system.mapSingleton("parser",c.dependencies.Parser),this.system.mapSingleton("sourceBufferExt",c.dependencies.SourceBufferExtensions),this.system.mapClass("stream",c.dependencies.Stream),this.system.mapSingleton("streamController",c.dependencies.StreamController),this.system.mapClass("textController",c.dependencies.TextController),this.system.mapSingleton("textSourceBuffer",c.dependencies.TextSourceBuffer),this.system.mapSingleton("textTTMLXMLMP4SourceBuffer",c.dependencies.TextTTMLXMLMP4SourceBuffer),this.system.mapSingleton("videoExt",c.dependencies.VideoModelExtensions),c.dependencies.ProtectionController&&(this.system.mapClass("protectionController",c.dependencies.ProtectionController),this.system.mapSingleton("protectionExt",c.dependencies.ProtectionExtensions),this.system.mapSingleton("ksClearKey",c.dependencies.protection.KeySystem_ClearKey),this.system.mapSingleton("ksPlayReady",c.dependencies.protection.KeySystem_PlayReady),this.system.mapSingleton("ksWidevine",c.dependencies.protection.KeySystem_Widevine),this.system.mapSingleton("serverClearKey",c.dependencies.protection.servers.ClearKey),this.system.mapSingleton("serverDRMToday",c.dependencies.protection.servers.DRMToday),this.system.mapSingleton("serverPlayReady",c.dependencies.protection.servers.PlayReady),this.system.mapSingleton("serverWidevine",c.dependencies.protection.servers.Widevine),function(){var e=document.createElement("video"),t=this.system.getObject("debug");c.models.ProtectionModel_21Jan2015.detect(e)?this.system.mapSingleton("protectionModel",c.models.ProtectionModel_21Jan2015):c.models.ProtectionModel_3Feb2014.detect(e)?this.system.mapClass("protectionModel",c.models.ProtectionModel_3Feb2014):c.models.ProtectionModel_01b.detect(e)?this.system.mapClass("protectionModel",c.models.ProtectionModel_01b):(t.log("No supported version of EME detected on this user agent!"),t.log("Attempts to play encrypted content will fail!"))}.call(this)),this.system.mapClass("abrRulesCollection",c.rules.BaseRulesCollection),this.system.mapClass("abandonRequestRule",c.rules.AbandonRequestsRule),this.system.mapClass("downloadRatioRule",c.rules.DownloadRatioRule),this.system.mapClass("droppedFramesRule",c.rules.DroppedFramesRule),this.system.mapClass("insufficientBufferRule",c.rules.InsufficientBufferRule),this.system.mapClass("limitSwitchesRule",c.rules.LimitSwitchesRule),this.system.mapClass("baseURLExt",u.dependencies.BaseURLExtensions),this.system.mapClass("fragmentExt",u.dependencies.FragmentExtensions),this.system.mapClass("indexHandler",u.dependencies.DashHandler),this.system.mapSingleton("manifestExt",u.dependencies.DashManifestExtensions),this.system.mapSingleton("metricsExt",c.dependencies.MetricsExtensions),this.system.mapSingleton("timelineConverter",u.dependencies.TimelineConverter),this.system.mapClass("dashParser",u.dependencies.DashParser),l.dependencies.MssParser&&this.system.mapClass("mssParser",l.dependencies.MssParser),d.dependencies.HlsParser&&(this.system.mapClass("hlsParser",d.dependencies.HlsParser),this.system.mapSingleton("hlsDemux",d.dependencies.HlsDemux)),this.system.mapClass("hlsStream",d.dependencies.HlsStream),this.system.mapSingleton("contextManager",c.modules.ContextManager),this.system.mapHandler("setContext","contextManager","setContext")}}},c.modules.ContextManager=function(){"use strict";return{system:void 0,debug:void 0,setContext:function(e){this.system.autoMapOutlets=!0,"MSS"===e?(this.system.mapClass("mp4Processor",c.dependencies.Mp4Processor),this.system.mapClass("indexHandler",l.dependencies.MssHandler),this.system.mapClass("fragmentController",l.dependencies.MssFragmentController),this.system.mapClass("mssFragmentInfoController",l.dependencies.MssFragmentInfoController)):"HLS"===e?(this.system.mapClass("mp4Processor",c.dependencies.Mp4Processor),this.system.mapClass("fragmentController",d.dependencies.HlsFragmentController),this.system.mapClass("indexHandler",d.dependencies.HlsHandler)):(this.system.mapClass("fragmentController",c.dependencies.FragmentController),this.system.mapClass("indexHandler",u.dependencies.DashHandler))}}},c.modules.ContextManager.prototype={constructor:c.modules.ContextManager},c.utils.Debug=function(){"use strict";Date.prototype.HHMMSSmmm=function(){var e=this.getHours().toString(),t=this.getMinutes().toString(),i=this.getSeconds().toString(),n=this.getMilliseconds().toString();return(e[1]?e:"0"+e[0])+":"+(t[1]?t:"0"+t[0])+":"+(i[1]?i:"0"+i[0])+"."+(n[2]?n:"0"+(n[1]?n:"0"+n[0]))},Date.prototype.MMSSmmm=function(){var e=this.getMinutes().toString(),t=this.getSeconds().toString(),i=this.getMilliseconds().toString();return(e[1]?e:"0"+e[0])+":"+(t[1]?t:"0"+t[0])+"."+(i[2]?i:"0"+(i[1]?i:"0"+i[0]))};var e=function(){this.logArray=[],this.showLevel=!0};e.prototype.error=e.prototype.warn=e.prototype.info=e.prototype.debug=function(e){this.logArray.push(e)},e.prototype.getLogs=function(){return this.logArray};var t=0,i=(new Date,console),n=function(e,t){if(e<=s()){var n=r(e,t);switch(e){case 1:i.error(n);break;case 2:i.warn(n);break;case 3:i.info(n);break;case 4:i.debug(n)}}},r=function(e,t){var n="",r=null;return r=new Date,n+="["+r.HHMMSSmmm()+"]",i&&i.showLevel&&(n+="["+o(e)+"]"),Array.apply(null,t).forEach(function(e){n+=e+" "}),n},o=function(e){switch(e){case 1:return"ERROR";case 2:return"WARN";case 3:return"INFO";case 4:return"DEBUG";default:return""}},s=function(){return t};return{NONE:0,ERROR:1,WARN:2,INFO:3,DEBUG:4,ALL:4,getLevel:s,getLogger:function(){return i},setLevel:function(e){t=e},setLogger:function(t){switch(t){case"log4javascript":var n=new log4javascript.PopUpAppender,r=new log4javascript.PatternLayout("%d{HH:mm:ss.SSS} %-5p - %m%n");n.setLayout(r),i.addAppender(n),i.setLevel(log4javascript.Level.ALL),i.initialized=!0;break;case"memory":i=new e;break;case"console":i=console;break;default:i=null}},error:function(){n.call(this,1,arguments)},warn:function(){n.call(this,2,arguments)},info:function(){n.call(this,3,arguments)},log:function(){n.call(this,4,arguments)}}},c.utils.DebugController=function(){"use strict";var e={isInDebug:!1,level:0,loggerType:"console"},t="",i=function(e){if(e&&e.length>0){var t=JSON.stringify(e,null,"\r\n"),i=new Blob([t],{type:"text/json"});if(navigator.msSaveBlob)navigator.msSaveBlob(i,"hasplayer_logs.txt");else{var n=document.createEvent("MouseEvents"),r=document.createElement("a");r.download="hasplayer_logs.txt",r.href=window.URL.createObjectURL(i),r.dataset.downloadurl=["text/json",r.download,r.href].join(":"),n.initMouseEvent("click",!0,!1,window,0,0,0,0,0,!1,!1,!1,!1,0,null),r.dispatchEvent(n)}}};return{debug:void 0,setup:function(){window.addEventListener("keydown",function(n){!0!==n.altKey||!0!==n.ctrlKey||!0!==n.shiftKey||68!==n.keyCode&&90!==n.keyCode||(e.isInDebug?(console.log("hasplayer.js debug OFF (v"+t+")"),e.isInDebug=!1,90===n.keyCode?(i(this.debug.getLogger().getLogs()),this.debug.setLevel(e.level),this.debug.setLogger(e.loggerType)):this.debug.setLevel(0)):(console.log("hasplayer.js debug ON (v"+t+")"),e.isInDebug=!0,e.level=this.debug.getLevel(),this.debug.setLevel(68===n.keyCode?4:3),this.debug.setLogger(68===n.keyCode?"console":"memory")))}.bind(this))},init:function(e){t=e}}},c.utils.DebugController.prototype={constructor:c.utils.DebugController},c.dependencies.ErrorHandler=function(){"use strict";return{eventBus:void 0,debug:void 0,sendWarning:function(e,t,i){this.debug.warn("[Warn] Code: "+e+", Message: "+t+", Data: "+JSON.stringify(i,null,"\t")),this.eventBus.dispatchEvent({type:"warning",data:{code:e,message:t,data:i}})},sendError:function(e,t,i){this.debug.error("[Error] Code: "+e+", Message: "+t+", Data: "+JSON.stringify(i,null,"\t")),this.eventBus.dispatchEvent({type:"error",data:{code:e,message:t,data:i}})}}},c.dependencies.ErrorHandler.prototype={constructor:c.dependencies.ErrorHandler},c.dependencies.ErrorHandler.prototype.INTERNAL_ERROR="INTERNAL_ERROR",c.dependencies.ErrorHandler.prototype.MEDIA_ERR_ABORTED="MEDIA_ERR_ABORTED",c.dependencies.ErrorHandler.prototype.MEDIA_ERR_NETWORK="MEDIA_ERR_NETWORK",c.dependencies.ErrorHandler.prototype.MEDIA_ERR_DECODE="MEDIA_ERR_DECODE",c.dependencies.ErrorHandler.prototype.MEDIA_ERR_SRC_NOT_SUPPORTED="MEDIA_ERR_SRC_NOT_SUPPORTED",c.dependencies.ErrorHandler.prototype.MEDIA_ERR_ENCRYPTED="MEDIA_ERR_ENCRYPTED",c.dependencies.ErrorHandler.prototype.CAPABILITY_ERR_MEDIASOURCE="CAPABILITY_ERR_MEDIASOURCE",c.dependencies.ErrorHandler.prototype.CAPABILITY_ERR_MEDIAKEYS="CAPABILITY_ERR_MEDIAKEYS",c.dependencies.ErrorHandler.prototype.MEDIA_ERR_CREATE_MEDIASOURCE="MEDIA_ERR_CREATE_MEDIASOURCE",c.dependencies.ErrorHandler.prototype.MEDIA_ERR_CODEC_UNSUPPORTED="MEDIA_ERR_CODEC_UNSUPPORTED",c.dependencies.ErrorHandler.prototype.MEDIA_ERR_CREATE_SOURCEBUFFER="MEDIA_ERR_CREATE_SOURCEBUFFER",c.dependencies.ErrorHandler.prototype.MEDIA_ERR_APPEND_SOURCEBUFFER="MEDIA_ERR_APPEND_SOURCEBUFFER",c.dependencies.ErrorHandler.prototype.MEDIA_ERR_REMOVE_SOURCEBUFFER="MEDIA_ERR_REMOVE_SOURCEBUFFER",c.dependencies.ErrorHandler.prototype.MANIFEST_ERR_PARSE="MANIFEST_ERR_PARSE",c.dependencies.ErrorHandler.prototype.MANIFEST_ERR_NO_STREAM="MANIFEST_ERR_NO_STREAM",c.dependencies.ErrorHandler.prototype.MANIFEST_ERR_NO_VIDEO="MANIFEST_ERR_NO_VIDEO",c.dependencies.ErrorHandler.prototype.MANIFEST_ERR_NO_AUDIO="MANIFEST_ERR_NO_AUDIO",c.dependencies.ErrorHandler.prototype.MANIFEST_ERR_NO_TEXT="MANIFEST_ERR_NO_TEXT",c.dependencies.ErrorHandler.prototype.DOWNLOAD_ERR_MANIFEST="DOWNLOAD_ERR_MANIFEST",c.dependencies.ErrorHandler.prototype.DOWNLOAD_ERR_SIDX="DOWNLOAD_ERR_SIDX",c.dependencies.ErrorHandler.prototype.DOWNLOAD_ERR_INIT="DOWNLOAD_ERR_INIT",c.dependencies.ErrorHandler.prototype.DOWNLOAD_ERR_CONTENT="DOWNLOAD_ERR_CONTENT",c.dependencies.ErrorHandler.prototype.MSS_NO_TFRF="MSS_NO_TFRF",c.dependencies.ErrorHandler.prototype.HLS_INVALID_PACKET_ERROR="HLS_INVALID_PACKET_ERROR",c.dependencies.ErrorHandler.prototype.HLS_DEMUX_ERROR="HLS_DEMUX_ERROR",c.dependencies.ErrorHandler.prototype.HLS_INVALID_KEY_ERROR="HLS_INVALID_KEY_ERROR",c.dependencies.ErrorHandler.prototype.MEDIA_KEYERR="MEDIA_KEYERR",c.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_UNKNOWN="MEDIA_KEYERR_UNKNOWN",c.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_CLIENT="MEDIA_KEYERR_CLIENT",c.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_SERVICE="MEDIA_KEYERR_SERVICE",c.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_OUTPUT="MEDIA_KEYERR_OUTPUT",c.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_HARDWARECHANGE="MEDIA_KEYERR_HARDWARECHANGE",c.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_DOMAIN="MEDIA_KEYERR_DOMAIN",c.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_EXPIRED="MEDIA_KEYERR_EXPIRED",c.dependencies.ErrorHandler.prototype.MEDIA_KEYSYSERR_ACCESS_DENIED="MEDIA_KEYSYSERR_ACCESS_DENIED",c.dependencies.ErrorHandler.prototype.MEDIA_KEYMESSERR_URL_LICENSER_UNKNOWN="MEDIA_KEYMESSERR_URL_LICENSER_UNKNOWN",c.dependencies.ErrorHandler.prototype.MEDIA_KEYMESSERR_NO_CHALLENGE="MEDIA_KEYMESSERR_NO_CHALLENGE",c.dependencies.ErrorHandler.prototype.MEDIA_KEYMESSERR_LICENSER_ERROR="MEDIA_KEYMESSERR_LICENSER_ERROR",c.dependencies.ErrorHandler.prototype.MEDIA_KEYMESSERR_NO_SESSION="MEDIA_KEYMESSERR_NO_SESSION",c.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_SERVER_CERTIFICATE="MEDIA_KEYERR_SERVER_CERTIFICATE",c.dependencies.ErrorHandler.prototype.DOM_ERR_INDEX_SIZE=1,c.dependencies.ErrorHandler.prototype.DOM_ERR_HIERARCHY_REQUEST=3,c.dependencies.ErrorHandler.prototype.DOM_ERR_WRONG_DOCUMENT=4,c.dependencies.ErrorHandler.prototype.DOM_ERR_INVALID_CHARACTER=5,c.dependencies.ErrorHandler.prototype.DOM_ERR_NO_MODIFICATION_ALLOWED=7,c.dependencies.ErrorHandler.prototype.DOM_ERR_NOT_FOUND=8,c.dependencies.ErrorHandler.prototype.DOM_ERR_NOT_SUPPORTED=9,c.dependencies.ErrorHandler.prototype.DOM_ERR_INVALID_STATE=11,c.dependencies.ErrorHandler.prototype.DOM_ERR_SYNTAX=12,c.dependencies.ErrorHandler.prototype.DOM_ERR_INVALID_MODIFICATION=13,c.dependencies.ErrorHandler.prototype.DOM_ERR_NAMESPACE=14,c.dependencies.ErrorHandler.prototype.DOM_ERR_INVALID_ACCESS=15,c.dependencies.ErrorHandler.prototype.DOM_ERR_SECURITY=18,c.dependencies.ErrorHandler.prototype.DOM_ERR_NETWORK=19,c.dependencies.ErrorHandler.prototype.DOM_ERR_ABORT=20,c.dependencies.ErrorHandler.prototype.DOM_ERR_URL_MISMATCH=21,c.dependencies.ErrorHandler.prototype.DOM_ERR_QUOTA_EXCEEDED=22,c.dependencies.ErrorHandler.prototype.DOM_ERR_TIMEOUT=23,c.dependencies.ErrorHandler.prototype.DOM_ERR_INVALID_NODE_TYPE=24,c.dependencies.ErrorHandler.prototype.DOM_ERR_DATA_CLONE=25,c.utils.EventBus=function(){"use strict";var e,t=function(t,i){var n=(i?"1":"0")+t;return n in e||(e[n]=[]),e[n]};return e={},{addEventListener:function(e,i,n){var r=t(e,n);-1===r.indexOf(i)&&r.push(i)},removeEventListener:function(e,i,n){var r=t(e,n),o=r.indexOf(i);-1!==o&&r.splice(o,1)},dispatchEvent:function(e){var i=t(e.type,!1).slice(),n=0;for(n=0;n<i.length;n+=1)i[n].call(this,e);return!e.defaultPrevented}}},c.dependencies.EventController=function(){"use strict";var e=[],t=[],i=[],n=null,r=function(){o.call(this,t),o.call(this,e),s.call(this)},o=function(e){var t,n,r=this.videoModel.getCurrentTime(),o=0;if(e)for(o=0;o<e.length;o++)void 0!==(n=e[o])&&(0===(t=n.presentationTime/n.eventStream.timescale)||t<=r&&t+.1>r)&&(this.debug.log("[EventController] Start Event at "+r),n.duration>0&&i.push(n),"urn:mpeg:dash:event:2012"===n.eventStream.schemeIdUri&&1===n.eventStream.value&&a.call(this),e.splice(o,1))},s=function(){var e,t,n=0;if(i)for(e=this.videoModel.getCurrentTime(),n=0;n<i.length;n++)null!==(t=i[n])&&(t.duration+t.presentationTime)/t.eventStream.timescale<e&&(this.debug.log("[EventController] Remove Event at time "+e),t=null,i.splice(n,1))},a=function(){var e=this,t=e.manifestModel.getValue(),i=t.mpdUrl;t.hasOwnProperty("Location")&&(i=t.Location),e.debug.log("[EventController] Refresh manifest @ "+i),e.manifestLoader.load(i).then(function(t){e.manifestModel.setValue(t)})};return{manifestModel:void 0,manifestLoader:void 0,debug:void 0,system:void 0,videoModel:void 0,addInlineEvents:function(t){e=[],t&&t.length>0&&(e=t),this.debug.log("[EventController] Added "+t.length+" inline events")},addInbandEvents:function(e){var i,n=0;for(n=0;n<e.length;n++)i=e[n],t[i.id]=i,this.debug.log("[EventController] Add inband event with id "+i.id)},reset:function(){null!==n&&(clearInterval(n),n=null),e=null,t=null,i=null},clear:function(){null!==n&&(clearInterval(n),n=null)},start:function(){this.debug.log("[EventController] Start Event Controller"),isNaN(100)||(n=setInterval(r.bind(this),100))}}},c.dependencies.EventController.prototype={constructor:c.dependencies.EventController},c.dependencies.FragmentController=function(){"use strict";var e=[],t=function(t){var i=e.length,n=0;for(n=0;n<i;n+=1)if(e[n].getContext()===t)return e[n];return null};return{system:void 0,debug:void 0,process:function(e){var t=null;return null!==e&&void 0!==e&&e.byteLength>0&&(t=new Uint8Array(e)),n.when(t)},attachBufferController:function(i){var n;return i?((n=t(i))||((n=this.system.getObject("fragmentModel")).setContext(i),e.push(n)),n):null},detachBufferController:function(t){var i=e.indexOf(t);i>-1&&e.splice(i,1)},onBufferControllerStateChange:function(){(function(){var t=!0,i=e.length,n=0;for(n=0;n<i;n+=1)if(!e[n].isReady()){t=!1;break}return t})()&&function(){var t=0;for(t=0;t<e.length;t+=1)e[t].executeCurrentRequest()}.call(this)},isFragmentLoadedOrPending:function(e,i){var n=t(e);return!!n&&n.isFragmentLoadedOrPending(i)},getPendingRequests:function(e){var i=t(e);return i?i.getPendingRequests():null},getLoadingRequests:function(e){var i=t(e);return i?i.getLoadingRequests():null},isInitializationRequest:function(e){return e&&e.type&&"initialization segment"===e.type.toLowerCase()},getLoadingTime:function(e){var i=t(e);return i?i.getLoadingTime():null},getExecutedRequestForTime:function(e,t){return e?e.getExecutedRequestForTime(t):null},removeExecutedRequest:function(e,t){e&&e.removeExecutedRequest(t)},removeExecutedRequestsBeforeTime:function(e,t){e&&e.removeExecutedRequestsBeforeTime(t)},clearExecutedRequests:function(e){e&&e.clearExecutedRequests()},cancelPendingRequestsForModel:function(e){e&&e.cancelPendingRequests()},abortRequestsForModel:function(e){e&&e.abortRequests()},prepareFragmentForLoading:function(e,i,n,r,o,s){var a=t(e);return a&&i?(a.addRequest(i),a.setCallbacks(n,r,o,s),!0):null}}},c.dependencies.FragmentController.prototype={constructor:c.dependencies.FragmentController},c.dependencies.FragmentLoader=function(){"use strict";var e,t=2,i=500,r=0,o=[],s=function(a,l){var d=this;(function(t){var i=n.defer(),r=new XMLHttpRequest,s=null,a=!0,l=!0,d=null,u=this;return o.push(r),t.requestStartDate=new Date,s=u.metricsModel.addHttpRequest(t.streamType,null,t.type,t.url,null,t.range,t.requestStartDate,null,null,null,null,t.duration,t.startTime,t.quality),u.metricsModel.appendHttpTrace(s,t.requestStartDate,t.requestStartDate.getTime()-t.requestStartDate.getTime(),[0]),d=t.requestStartDate,r.open("GET",u.tokenAuthentication.addTokenAsQueryArg(t.url),!0),r.responseType="arraybuffer",r=u.tokenAuthentication.setTokenInRequestHeader(r),t.range&&r.setRequestHeader("Range","bytes="+t.range),r.onprogress=function(e){var i=new Date;a&&(a=!1,(!e.lengthComputable||e.lengthComputable&&e.total!==e.loaded)&&(t.firstByteDate=i,s.tresponse=i)),e.lengthComputable&&(t.bytesLoaded=e.loaded,t.bytesTotal=e.total),u.metricsModel.appendHttpTrace(s,i,i.getTime()-d.getTime(),[t.bytesLoaded?t.bytesLoaded:0]),d=i,u.notify(c.dependencies.FragmentLoader.eventList.ENAME_LOADING_PROGRESS,{request:t,httpRequestMetrics:s,lastTraceTime:d})},r.onload=function(){if(!(r.status<200||r.status>399)){l=!1;var n,o,a=new Date,c=r.response,h=c?c.byteLength:0;t.firstByteDate||(t.firstByteDate=t.requestStartDate),t.requestEndDate=a,n=t.firstByteDate.getTime()-t.requestStartDate.getTime(),o=t.requestEndDate.getTime()-t.firstByteDate.getTime(),u.debug.log("[FragmentLoader]["+e+"] Loaded: "+t.url+" ("+r.status+", "+n+"ms, "+o+"ms)"),s.tresponse=t.firstByteDate,s.tfinish=t.requestEndDate,s.responsecode=r.status,s.bytesLength=h,u.metricsModel.appendHttpTrace(s,a,a.getTime()-d.getTime(),[h]),d=a,i.resolve({data:c,request:t})}},r.onabort=function(){var e,i=new Date;r.aborted=!0,0!==s.trace.length&&(e=s.trace[s.trace.length-1].b[0],t.requestEndDate=i,s.tresponse=t.firstByteDate,s.tfinish=t.requestEndDate,s.responsecode=r.status,s.bytesLength=e)},r.onloadend=r.onerror=function(){-1!==o.indexOf(r)&&(o.splice(o.indexOf(r),1),l&&(l=!1,s.responsecode=r.status,i.reject(r)))},u.debug.log("[FragmentLoader]["+e+"] Load: "+t.url),r.send(),i.promise}).call(d,a).then(function(e){r=0,l.resolve(e)},function(e){e.aborted?(a.status=0,a.aborted=!0,l.reject(a)):r>=t?(r=0,a.status=e.status,l.reject(a)):setTimeout(function(){r++,s.call(d,a,l)},i)})};return{metricsModel:void 0,debug:void 0,tokenAuthentication:void 0,config:void 0,notify:void 0,subscribe:void 0,unsubscribe:void 0,setup:function(){t=this.config.getParam("FragmentLoader.RetryAttempts","number",2),i=this.config.getParam("FragmentLoader.RetryInterval","number",500)},setType:function(t){e=t},load:function(e){var t=n.defer();return"Initialization Segment"===e.type&&e.data?t.resolve(e,{data:e.data}):s.call(this,e,t),t.promise},abort:function(){var t=0;for(t=0;t<o.length;t+=1)this.debug.log("[FragmentLoader]["+e+"] Abort XHR "+(o[t].responseURL?o[t].responseURL:"")),o[t].abort()},checkForExistence:function(e){return e?(e.deferred=n.defer(),function(e){var t=new XMLHttpRequest,i=!1;t.open("HEAD",e.url,!0),t.onload=function(){t.status<200||t.status>399||(i=!0,e.deferred.resolve(e))},t.onloadend=t.onerror=function(){i||e.deferred.reject(t)},t.send()}.call(this,e),e.deferred.promise):n.when(null)}}},c.dependencies.FragmentLoader.prototype={constructor:c.dependencies.FragmentLoader},c.dependencies.FragmentLoader.eventList={ENAME_LOADING_PROGRESS:"loadingProgress"},c.dependencies.FragmentModel=function(){"use strict";var e,t,i,n,r,o,s=[],a=[],l=[],d=function(e){var t=s.indexOf(e);-1!==t&&s.splice(t,1)};return{system:void 0,debug:void 0,fragmentLoader:void 0,setContext:function(t){e=t},getContext:function(){return e},setType:function(e){o=e,this.fragmentLoader&&this.fragmentLoader.setType(e)},addRequest:function(e){if(e){if(this.isFragmentLoadedOrPending(e))return;a.push(e),function(e,t){e.sort(function(e,i){return e[t]<i[t]?-1:e[t]>i[t]?1:0})}.call(this,a,"index")}},setCallbacks:function(e,o,s,a){t=e,r=a,n=s,i=o},isFragmentLoadedOrPending:function(e){var t,i=!1,n=0;for(n=0;n<s.length;n++)if(t=s[n],e.startTime===t.startTime||"complete"===t.action&&e.action===t.action){if(e.url===t.url){i=!0;break}s.splice(n,1),n--}if(!i)for(n=0;n<a.length;n++)t=a[n],e.url===t.url&&e.startTime===t.startTime&&(i=!0);if(!i)for(n=0;n<l.length;n++)t=l[n],e.url===t.url&&e.startTime===t.startTime&&(i=!0);return i},isReady:function(){return e.isReady()},getPendingRequests:function(){return a},getLoadingRequests:function(){return l},getLoadingTime:function(){var e,t,i=0;for(t=s.length-1;t>=0;t-=1)if((e=s[t]).requestEndDate instanceof Date&&e.firstByteDate instanceof Date){i=e.requestEndDate.getTime()-e.firstByteDate.getTime();break}return i},getExecutedRequestForTime:function(e){var t,i=NaN,n=NaN,r=null;for(t=s.length-1;t>=0;t-=1)if(r=s[t],i=r.startTime,n=i+r.duration,!isNaN(i)&&!isNaN(n)&&e>i&&e<n)return r;return null},getExecutedRequestForQualityAndIndex:function(e,t){var i,n=null;for(i=s.length-1;i>=0;i-=1)if((n=s[i]).quality===e&&n.index===t)return n;return null},removeExecutedRequest:function(e){d.call(this,e)},removeExecutedRequestsBeforeTime:function(e){var t,i=NaN,n=null;for(t=s.length-1;t>=0;t-=1)i=(n=s[t]).startTime,!isNaN(i)&&i<e&&d.call(this,n)},clearExecutedRequests:function(){s=[]},cancelPendingRequests:function(){a=[]},abortRequests:function(){this.fragmentLoader.abort(),l=[]},executeCurrentRequest:function(){var o;if(0!==a.length&&!(l.length>=2))switch((o=a.shift()).action){case"complete":s.push(o),r.call(e,o);break;case"download":l.push(o),function(r){var o,a;t.call(e,r),o=function(t,n){l.splice(l.indexOf(t),1),s.push(t),i.call(e,t,n),t.deferred=null},a=function(t){l.splice(l.indexOf(t),1),n.call(e,t),t.deferred=null},this.fragmentLoader.load(r).then(o.bind(e,r),a.bind(e,r))}.call(this,o);break;default:this.debug.log("Unknown request action."),o.deferred?(o.deferred.reject(),o.deferred=null):n.call(e,o)}}}},c.dependencies.FragmentModel.prototype={constructor:c.dependencies.FragmentModel},c.dependencies.ManifestLoader=function(){"use strict";var e=2,t=500,i=null,r=function(e){var t=null;return-1!==e.indexOf("/")&&(-1!==e.indexOf("?")&&(e=e.substring(0,e.indexOf("?"))),t=e.substring(0,e.lastIndexOf("/")+1)),t};return{debug:void 0,parser:void 0,config:void 0,metricsModel:void 0,tokenAuthentication:void 0,setup:function(){e=this.config.getParam("ManifestLoader.RetryAttempts","number",2),t=this.config.getParam("ManifestLoader.RetryInterval","number",500)},load:function(o){var s=r(o),a=n.defer(),l=this;return(i=new c.dependencies.XHRLoader).initialize(null,e,t),i.load(o).then(function(e){e.responseURL&&(l.debug.log("[ManifestLoader] Redirect URL: "+e.responseURL),s=r(e.responseURL)),l.tokenAuthentication.checkRequestHeaderForToken(e),l.metricsModel.addHttpRequest("stream",null,"MPD",o,null,null,e.startDate,e.endDate,e.status,null,null),l.parser.parse(function(e){var t,i="",n=0;if(e.length<1)return e;if(15360!==e.charCodeAt(0))return e;for(n=0;n<e.length;n+=1)t=e.charCodeAt(n),i+=String.fromCharCode((255&t)<<8|(65280&t)>>8);return i}(e.responseText),s).then(function(t){t?(t.mpdUrl=o,t.mpdLoadedTime=e.endDate,l.metricsModel.addManifestUpdate("stream",t.type,e.startDate,e.endDate,t.availabilityStartTime),a.resolve(t)):a.reject()},function(e){e&&e.name&&e.message?a.reject(e):(l.debug.error("[ManifestLoader] Manifest parsing error"),a.reject({name:c.dependencies.ErrorHandler.prototype.MANIFEST_ERR_PARSE,message:"Failed to parse manifest",data:{url:o}}))})},function(e){!e||e.aborted?a.reject():(l.metricsModel.addHttpRequest("stream",null,"MPD",o,null,null,e.startDate,e.endDate,e.status,null,null),a.reject({name:c.dependencies.ErrorHandler.prototype.DOWNLOAD_ERR_MANIFEST,message:"Failed to download manifest",data:{url:o,status:e.status}}))}),a.promise},abort:function(){null!==i&&i.abort(),this.parser.abort()}}},c.dependencies.ManifestLoader.prototype={constructor:c.dependencies.ManifestLoader},c.dependencies.ManifestUpdater=function(){"use strict";var e,t=NaN,i=null,r=!1,o=function(){null!==i&&(clearInterval(i),i=null)},s=function(){var e,n,r=this.manifestModel.getValue();void 0!==r&&null!==r&&(n=this.manifestExt.getRefreshDelay(r),e=((new Date).getTime()-r.mpdLoadedTime.getTime())/1e3,t=Math.max(n-e,0),function(){o.call(this),isNaN(t)||(this.debug.log("Refresh manifest in "+t+" seconds."),i=setTimeout(a.bind(this),Math.min(1e3*t,Math.pow(2,31)-1),this))}.call(this))},a=function(){var t,i,o=this;n.when(!e||e.promise).then(function(){e=n.defer(),t=o.manifestModel.getValue(),i=t.mpdUrl,t.hasOwnProperty("Location")&&(i=t.Location),o.manifestLoader.load(i).then(function(e){o.manifestModel.setValue(e),o.debug.log("Manifest has been refreshed."),r||s.call(o)})})};return{debug:void 0,system:void 0,manifestModel:void 0,manifestExt:void 0,manifestLoader:void 0,setup:function(){s.call(this),this.system.mapHandler("streamsComposed",void 0,function(){e&&e.resolve()}.bind(this))},start:function(){r=!1,s.call(this)},stop:function(){r=!0,o.call(this)}}},c.dependencies.ManifestUpdater.prototype={constructor:c.dependencies.ManifestUpdater},c.models.ManifestModel=function(){"use strict";var e=null;return{system:void 0,eventBus:void 0,getValue:function(){return e},setValue:function(t){(e=t)&&this.system.notify("manifestUpdated"),null!==e&&this.eventBus.dispatchEvent({type:"manifestLoaded",data:t})}}},c.models.ManifestModel.prototype={constructor:c.models.ManifestModel},c.dependencies.MediaSourceExtensions=function(){"use strict"},c.dependencies.MediaSourceExtensions.prototype={constructor:c.dependencies.MediaSourceExtensions,createMediaSource:function(){"use strict";var e="WebKitMediaSource"in window;return"MediaSource"in window?new MediaSource:e?new WebKitMediaSource:null},attachMediaSource:function(e,t){"use strict";return t.setSource(window.URL.createObjectURL(e)),!0},detachMediaSource:function(e){"use strict";return e.setSource(null),!0},setDuration:function(e,t){"use strict";var i,n=!1;if("open"!==e.readyState)return e.duration;for(i=0;i<e.sourceBuffers.length;i++)if(e.sourceBuffers[i].updating){n=!0;break}return n||(e.duration=t),e.duration},signalEndOfStream:function(e){"use strict";var t=e.sourceBuffers,i=t.length,n=0;if("open"===e.readyState){for(n;n<i;n++){if(t[n].updating)return;if(0===t[n].buffered.length)return}return e.endOfStream(),!0}}},c.dependencies.MetricsExtensions=function(){"use strict";var e={42:"Baseline","4D":"Main",58:"Extended",64:"High"},t=function(e,t){var i,n,r,o,s,a;for(o=0;o<e.length;o+=1)for(i=e[o].AdaptationSet_asArray,s=0;s<i.length;s+=1)for(r=i[s].Representation_asArray,a=0;a<r.length;a+=1)if(n=r[a],t===n.id)return n;return null},i=function(e,t){var i=!1;return"video"===t?(this.manifestExt.getIsVideo(e),"video"===e.type&&(i=!0)):"audio"===t?(this.manifestExt.getIsAudio(e),"audio"===e.type&&(i=!0)):"text"===t?(this.manifestExt.getIsText(e),"text"===e.type&&(i=!0)):i=!1,i},n=c.utils.copyMethods(u.dependencies.DashMetricsExtensions);return n.config=void 0,n.getDuration=function(){var e=this.manifestModel.getValue(),t=e?e.Period.duration:null;return t!==1/0?t:-1},n.getFormatForType=function(e){var t,i=this.manifestModel.getValue(),n=0;for(n=0;n<i.Period.AdaptationSet.length;n++)if((t=i.Period.AdaptationSet[n]).type===e)return t.mimeType;return null},n.getCodecForType=function(e){var t,i=this.manifestModel.getValue(),n=0;for(n=0;n<i.Period.AdaptationSet.length;n++)if((t=i.Period.AdaptationSet[n]).type===e||t.contentType===e)return t.Representation_asArray[0].codecs;return null},n.getVideoWidthForRepresentation=function(e){var i,n,r=this.manifestModel.getValue();return r?(n=r.Period_asArray,null===(i=t.call(this,n,e))?null:i.width):null},n.getVideoHeightForRepresentation=function(e){var i,n,r=this.manifestModel.getValue();return r?(n=r.Period_asArray,null===(i=t.call(this,n,e))?null:i.height):null},n.getCodecsForRepresentation=function(e){var i,n=this.manifestModel.getValue().Period_asArray;return null===(i=t.call(this,n,e))?null:i.codecs},n.getH264ProfileLevel=function(t){if(t.indexOf("avc1")<0)return"";return e[t.substr(5,2)]+"@"+(parseInt(t.substr(9,2),16)/10).toString()},n.getBitratesForType=function(e,t){var n,r,o,s,a,l,d,u=this.manifestModel.getValue(),c=null,h=[];if(!(null!==u&&void 0!==u||null!==t&&void 0!==t))return null;if(t)c=t;else for(n=u.Period_asArray,r=0;r<n.length;r+=1)for(o=n[r].AdaptationSet_asArray,l=0;l<o.length;l+=1)if(c=o[l],i.call(this,o[l],e)){c=o[l];break}if(null!==c)for(a=(c=this.manifestExt.processAdaptation(c)).Representation_asArray,d=0;d<a.length;d+=1)s=a[d],h.push(s.bandwidth);return h},n.getBitratesWithResolutionForType=function(e){var t,n,r,o,s,a,l,d,u=this.manifestModel.getValue(),c=[];if(null===u||void 0===u)return null;for(t=u.Period_asArray,n=0;n<t.length;n+=1)for(o=t[n].AdaptationSet_asArray,l=0;l<o.length;l+=1)if(r=o[l],i.call(this,r,e)){for(a=(r=this.manifestExt.processAdaptation(r)).Representation_asArray,d=0;d<a.length;d+=1){var h={bitrate:(s=a[d]).bandwidth,width:s.width,height:s.height};c.push(h)}return c}return c},n},c.dependencies.MetricsExtensions.prototype={constructor:c.dependencies.MetricsExtensions},c.models.MetricsModel=function(){"use strict";return{system:void 0,eventBus:void 0,config:void 0,streamMetrics:{},metricsChanged:function(){this.eventBus.dispatchEvent({type:"metricsChanged",data:{}})},metricChanged:function(e){this.eventBus.dispatchEvent({type:"metricChanged",data:{stream:e}}),this.metricsChanged()},metricUpdated:function(e,t,i){this.eventBus.dispatchEvent({type:"metricUpdated",data:{stream:e,metric:t,value:i}}),this.metricChanged(e)},metricAdded:function(e,t,i){this.eventBus.dispatchEvent({type:"metricAdded",data:{stream:e,metric:t,value:i}}),this.metricChanged(e)},clearAllCurrentMetrics:function(){for(var e in this.streamMetrics)if(this.streamMetrics.hasOwnProperty(e)&&"stream"===e)delete this.streamMetrics[e];else{var t=this.config.getParamFor(e,"ABR.keepBandwidthCondition","boolean",!0);for(var i in this.streamMetrics[e])!this.streamMetrics[e].hasOwnProperty(i)||"HttpList"===i&&!1!==t||(this.streamMetrics[e][i]=[])}this.metricsChanged.call(this)},getReadOnlyMetricsFor:function(e){return this.streamMetrics.hasOwnProperty(e)?this.streamMetrics[e]:null},getMetricsFor:function(e){var t;return this.streamMetrics.hasOwnProperty(e)?t=this.streamMetrics[e]:(t=this.system.getObject("metrics"),this.streamMetrics[e]=t),t},addTcpConnection:function(e,t,i,n,r,o){var s=new c.vo.metrics.TCPConnection;return s.tcpid=t,s.dest=i,s.topen=n,s.tclose=r,s.tconnect=o,this.getMetricsFor(e).TcpList.push(s),this.metricAdded(e,"TcpConnection",s),s},addHttpRequest:function(e,t,i,n,r,o,s,a,l,d,u,h,p,f){var m=new c.vo.metrics.HTTPRequest,g=this.getMetricsFor(e).HttpList;return m.stream=e,m.tcpid=t,m.type=i,m.url=n,m.actualurl=r,m.range=o,m.trequest=s,m.tresponse=a,m.tfinish=l,m.responsecode=d,m.interval=u,m.mediaduration=h,m.startTime=p,m.quality=f,g.push(m),this.metricAdded(e,"HttpRequest",m),g.length>10&&g.shift(),m},appendHttpTrace:function(e,t,i,n){var r=new c.vo.metrics.HTTPRequest.Trace;return r.s=t,r.d=i,r.b=n,e.trace.push(r),this.metricUpdated(e.stream,"HttpRequestTrace",e),r},addRepresentationSwitch:function(e,t,i,n,r){var o=new c.vo.metrics.RepresentationSwitch;return o.t=t,o.mt=i,o.to=n,o.lto=r,this.getMetricsFor(e).RepSwitchList.push(o),this.metricAdded(e,"RepresentationSwitch",o),o},addBufferedSwitch:function(e,t,i,n){var r=new c.vo.metrics.BufferedSwitch;return r.mt=t,r.to=i,r.lto=n,this.getMetricsFor(e).BufferedSwitchList.push(r),this.metricAdded(e,"BufferedSwitch",r),r},addState:function(e,t,i,n){var r=this.getMetricsFor(e).State;if(!(r.length>0&&r[r.length-1].current===t)){var o=new c.vo.metrics.State,s=this.getMetricsFor(e).State;return o.current=t,o.position=i,o.reason=n,s.push(o),this.metricAdded(e,"State",o),s.length>10&&s.shift(),o}},addSession:function(e,t,i,n,r){var o=new c.vo.metrics.Session;return o.uri=t,o.loopMode=i?1:0,o.endTime=n,o.playerType=r,this.metricAdded(e,"Session",o),o},addCondition:function(e,t,i,n,r,o){var s=new c.vo.metrics.Condition;return s.isFullScreen=t,s.windowSize=i+"x"+n,s.fps=o,s.droppedFrames=r,this.metricAdded(e,"Condition",s),s},addMetaData:function(){this.metricAdded(null,"ManifestReady",null)},addBufferLevel:function(e,t,i){var n=new c.vo.metrics.BufferLevel,r=this.getMetricsFor(e).BufferLevel;return n.t=t,n.level=Number(i.toFixed(3)),r.push(n),this.metricAdded(e,"BufferLevel",n),r.length>10&&r.shift(),n},addDVRInfo:function(e,t,i){var n=new c.vo.metrics.DVRInfo,r=this.getMetricsFor(e).DVRInfo;return n.t=t,n.range=i,r.push(n),this.metricAdded(e,"DVRInfo",n),r.length>10&&r.shift(),n},addDroppedFrames:function(e,t){var i=new c.vo.metrics.DroppedFrames,n=this.getMetricsFor(e).DroppedFrames;return i.time=t.creationTime,i.droppedFrames=t.droppedVideoFrames,i.decodedFrameCount=t.totalVideoFrames,n.length>0&&n[n.length-1]===i?n[n.length-1]:(n.push(i),this.metricAdded(e,"DroppedFrames",i),i)},addPlaybackQuality:function(e,t,i,n){var r=new c.vo.metrics.PlaybackQuality,o=this.getMetricsFor(e).PlaybackQuality;return r.t=t,r.mt=n,r.droppedFrames=i.droppedVideoFrames,r.totalVideoFrames=i.totalVideoFrames,o.length>0&&r.droppedFrames===o[o.length-1].droppedFrames&&r.totalVideoFrames===o[o.length-1].totalVideoFrames?o[o.length-1]:(o.push(r),this.metricAdded(e,"PlaybackQuality",r),o.length>10&&o.shift(),r)},addVideoResolution:function(e,t,i,n,r){var o=new c.vo.metrics.VideoResolution,s=this.getMetricsFor(e).VideoResolution;return o.t=t,o.mt=r,o.width=i,o.height=n,s.length>0&&o.width===s[s.length-1].width&&o.height===s[s.length-1].height?s[s.length-1]:(s.push(o),this.metricAdded(e,"VideoResolution",o),o)},addManifestUpdate:function(e,t,i,n,r,o,s,a,l,d){var u=new c.vo.metrics.ManifestUpdate,h=this.getMetricsFor("stream");return u.streamType=e,u.type=t,u.requestTime=i,u.fetchTime=n,u.availabilityStartTime=r,u.presentationStartTime=o,u.clientTimeOffset=s,u.currentTime=a,u.buffered=l,u.latency=d,h.ManifestUpdate.push(u),this.metricAdded(e,"ManifestUpdate",u),u},updateManifestUpdateInfo:function(e,t){if(e&&t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);this.metricUpdated(e.streamType,"ManifestUpdate",e)}},addManifestUpdatePeriodInfo:function(e,t,i,n,r){var o=new c.vo.metrics.ManifestUpdate.PeriodInfo;return o.id=t,o.index=i,o.start=n,o.duration=r,e.periodInfo.push(o),this.metricUpdated(e.streamType,"ManifestUpdatePeriodInfo",e),o},addManifestUpdateRepresentationInfo:function(e,t,i,n,r,o,s,a){var l=new c.vo.metrics.ManifestUpdate.RepresentationInfo;return l.id=t,l.index=i,l.periodIndex=n,l.streamType=r,l.startNumber=s,l.segmentInfoType=a,l.presentationTimeOffset=o,e.representationInfo.push(l),this.metricUpdated(e.streamType,"ManifestUpdateRepresentationInfo",e),l},addPlayList:function(e,t,i,n,r){var o=new c.vo.metrics.PlayList,s=this.getMetricsFor(e).PlayList;return o.stream=e,o.start=t,o.mstart=i,o.starttype=n,o.speed=r,s.push(o),this.metricAdded(e,"PlayList",o),s.length>10&&s.shift(),o},appendPlayListTrace:function(e,t,i,n,r,o,s,a){var l=new c.vo.metrics.PlayList.Trace;return l.representationid=t,l.subreplevel=i,l.start=n,l.mstart=r,l.duration=o,l.playbackspeed=s,l.stopreason=a,e&&Array.isArray(e.trace)&&(e.trace.push(l),this.metricUpdated(e.stream,"PlayListTrace",e),e.trace.length>10&&e.trace.shift()),l}}},c.models.MetricsModel.prototype={constructor:c.models.MetricsModel},c.dependencies.Mp4Processor=function(){"use strict";var e=function(e){var i,o,s;return i=new y.boxes.TrackBox,o=new y.boxes.TrackHeaderBox,o.version=1,o.flags=7,o.creation_time=0,o.modification_time=0,o.track_id=e.trackId,o.reserved=0,o.duration=Math.round(e.duration*e.timescale),o.reserved_2=[0,0],o.layer=0,o.alternate_group=0,o.volume=256,o.reserved_3=0,o.matrix=[65536,0,0,0,65536,0,0,0,1073741824],o.width=e.width<<16,o.height=e.height<<16,i.boxes.push(o),(s=new y.boxes.MediaBox).boxes.push(t(e)),s.boxes.push(n(e)),s.boxes.push(r(e)),i.boxes.push(s),i},t=function(e){var t=new y.boxes.MediaHeaderBox;return t.flags=0,t.version=1,t.creation_time=0,t.modification_time=0,t.timescale=e.timescale,t.duration=Math.round(e.duration*e.timescale),t.pad=0,t.language=function(e){var t,i,n;return t=e.charCodeAt(0)-96<<10,i=e.charCodeAt(1)-96<<5,n=e.charCodeAt(2)-96,t|i|n}(e.language),t.pre_defined=0,t},i=function(e){var t,i=0;for(t=0;t<e.length;t+=1)i|=e.charCodeAt(t)<<8*(e.length-t-1);return i},n=function(e){var t=new y.boxes.HandlerBox;switch(t.version=0,t.pre_defined=0,e.type){case"video":t.handler_type=i(t.HANDLERTYPEVIDEO),t.name=t.HANDLERVIDEONAME;break;case"audio":t.handler_type=i(t.HANDLERTYPEAUDIO),t.name=t.HANDLERAUDIONAME;break;default:t.handler_type=i(t.HANDLERTYPETEXT),t.name=t.HANDLERTEXTNAME}return t.name+="\0",t.reserved=[0,0,0],t.flags=0,t},r=function(e){var t=new y.boxes.MediaInformationBox;switch(e.type){case"video":t.boxes.push(g(e));break;case"audio":t.boxes.push(_(e))}return t.boxes.push(o(e)),t.boxes.push(m(e)),t},o=function(){var e,t,i;return e=new y.boxes.DataInformationBox,t=new y.boxes.DataReferenceBox,t.version=0,t.entry_count=1,t.flags=0,i=new y.boxes.DataEntryUrlBox,i.location="",i.version=0,i.flags=1,t.boxes.push(i),e.boxes.push(t),e},s=function(e){var t,i=new Uint8Array(e.length/2);for(t=0;t<e.length/2;t+=1)i[t]=parseInt(""+e[2*t]+e[2*t+1],16);return i},a=function(e,t){var i=new Uint8Array(e.length+t.length);return i.set(e,0),i.set(t,e.length),i},l=function(e){var t=null;return t=void 0!==e.contentProtection?new y.boxes.EncryptedVideoBox:new y.boxes.AVC1VisualSampleEntryBox,t.data_reference_index=1,t.compressorname=[10,65,86,67,32,67,111,100,105,110,103,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],t.depth=24,t.reserved=[0,0,0,0,0,0],t.reserved_2=0,t.reserved_3=0,t.pre_defined=0,t.pre_defined_2=[0,0,0],t.pre_defined_3=65535,t.frame_count=1,t.horizresolution=4718592,t.vertresolution=4718592,t.height=e.height,t.width=e.width,t.boxes.push(function(e){var t,i,n,r,o,l,d,u,c=new RegExp("^[A-Z0-9]7","gi"),h=new RegExp("^[A-Z0-9]8","gi");for((t=new y.boxes.AVCConfigurationBox).configurationVersion=1,t.lengthSizeMinusOne=3,t.reserved=63,t.SPS_NAL=[],t.PPS_NAL=[],i=new Uint8Array(0),(n=e.codecPrivateData.split("00000001")).splice(0,1),r=0,o=0,l=0;l<n.length;l+=1)d=s(n[l]),n[l].match(c)&&(t.SPS_NAL[r++]={NAL_length:d.length,NAL:d},t.AVCProfileIndication=parseInt(n[l].substr(2,2),16),t.profile_compatibility=parseInt(n[l].substr(4,2),16),t.AVCLevelIndication=parseInt(n[l].substr(6,2),16)),n[l].match(h)&&(t.PPS_NAL[o++]={NAL_length:d.length,NAL:d}),(u=new Uint8Array(d.length+4))[3]=d.length,u.set(d,4),i=a(i,u);return t.numOfSequenceParameterSets=r,t.numOfPictureParameterSets=o,t}(e)),void 0!==e.contentProtection&&t.boxes.push(u(e)),t},d=function(e){var t=new y.boxes.TrackEncryptionBox;return t.flags=0,t.version=0,t.default_IsEncrypted=1,t.default_IV_size=8,t.default_KID=e.contentProtection&&e.contentProtection.length>0&&e.contentProtection[0]["cenc:default_KID"]?e.contentProtection[0]["cenc:default_KID"]:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],t},u=function(e){var t=new y.boxes.ProtectionSchemeInformationBox;return t.boxes.push(function(e){var t=new y.boxes.OriginalFormatBox;return t.data_format=i(e.codecs.substring(0,e.codecs.indexOf("."))),t}(e)),t.boxes.push(function(){var e=new y.boxes.SchemeTypeBox;return e.flags=0,e.version=0,e.scheme_type=1667591779,e.scheme_version=65536,e}()),t.boxes.push(function(e){var t=new y.boxes.SchemeInformationBox;return t.boxes.push(d(e)),t}(e)),t},h=function(e){var t,i,n,r,o,s,a;return t=function(e){for(var t=[];e.length>=2;)t.push(parseInt(e.substring(0,2),16)),e=e.substring(2,e.length);return t}(e.codecPrivateData),i=t.length,n=new Uint8Array(2+i),n[0]=5,n[1]=i,n.set(t,2),r=13+n.length,o=new Uint8Array(2+r),o[0]=4,o[1]=r,o[2]=64,o[3]=20,o[3]|=0,o[3]|=1,o[4]=255,o[5]=255,o[6]=255,o[7]=(4278190080&e.bandwidth)>>24,o[8]=(16711680&e.bandwidth)>>16,o[9]=(65280&e.bandwidth)>>8,o[10]=255&e.bandwidth,o[11]=(4278190080&e.bandwidth)>>24,o[12]|=(16711680&e.bandwidth)>>16,o[13]|=(65280&e.bandwidth)>>8,o[14]|=255&e.bandwidth,o.set(n,15),s=3+o.length,a=new Uint8Array(2+s),a[0]=3,a[1]=s,a[2]=(65280&e.trackId)>>8,a[3]=255&e.trackId,a[4]=0,a.set(o,5),a},p=function(e){var t=e.codecs.substring(0,e.codecs.indexOf("."));switch(t){case"mp4a":return function(e){var t,i,n=null;return n=void 0!==e.contentProtection?new y.boxes.EncryptedAudioBox:new y.boxes.MP4AudioSampleEntryBox,n.reserved=[0,0,0,0,0,0],n.data_reference_index=1,n.reserved_2=[0,0],n.channelcount=e.channels,n.samplesize=16,n.pre_defined=0,n.reserved_3=0,n.samplerate=e.samplingRate<<16,t=new y.boxes.ESDBox,i=h(e),t.ES_tag=i[0],t.ES_length=i[1],t.ES_data=i.subarray(2,i.length),t.version=0,t.flags=0,n.boxes.push(t),void 0!==e.contentProtection&&n.boxes.push(u(e)),n}(e);default:throw{name:c.dependencies.ErrorHandler.prototype.MEDIA_ERR_CODEC_UNSUPPORTED,message:"Audio codec is not supported (MP4)",data:{codec:t}}}return null},f=function(e){var t=new y.boxes.SampleDescriptionBox;switch(t.version=0,t.flags=0,e.type){case"video":t.boxes.push(function(e){var t=e.codecs.substring(0,e.codecs.indexOf("."));switch(t){case"avc1":return l(e);default:throw{name:c.dependencies.ErrorHandler.prototype.MEDIA_ERR_CODEC_UNSUPPORTED,message:"Video codec is not supported (MP4)",data:{codec:t}}}}(e));break;case"audio":t.boxes.push(p(e))}return t},m=function(e){var t=new y.boxes.SampleTableBox;return t.boxes.push(function(){var e=new y.boxes.TimeToSampleBox;return e.version=0,e.entry_count=0,e.flags=0,e.entry=[],e}()),t.boxes.push(function(){var e=new y.boxes.SampleToChunkBox;return e.flags=0,e.version=0,e.entry_count=0,e.entry=[],e}()),t.boxes.push(function(){var e=new y.boxes.ChunkOffsetBox;return e.version=0,e.entry_count=0,e.flags=0,e.chunk_offset=[],e}()),t.boxes.push(function(){var e=new y.boxes.SampleSizeBox;return e.version=0,e.flags=0,e.sample_count=0,e.sample_size=0,e}()),t.boxes.push(f(e)),t},g=function(){var e=new y.boxes.VideoMediaHeaderBox;return e.version=0,e.flags=1,e.graphicsmode=0,e.opcolor=[0,0,0],e},_=function(){var e=new y.boxes.SoundMediaHeaderBox;return e.version=0,e.balance=0,e.reserved=0,e.flags=1,e},E=function(e){var t,i,n,r=[];for(n=0;n<e.length;n+=1)t=new Uint8Array(e[n].initData),(i=new y.boxes.ProtectionSystemSpecificHeaderBox).read(t,8,t.length),r.push(i);return r},b=function(t){var i,n,r,o=[];for((i=new y.boxes.MovieBox).boxes.push(function(e){var t=new y.boxes.MovieHeaderBox,i=e[e.length-1];return t.version=1,t.creation_time=0,t.modification_time=0,t.timescale=i.timescale,t.duration=Math.round(i.duration*i.timescale),t.rate=65536,t.volume=256,t.reserved=0,t.reserved_2=[0,0],t.matrix=[65536,0,0,0,65536,0,0,0,1073741824],t.pre_defined=[0,0,0,0,0,0],t.next_track_ID=i.trackId+1,t.flags=0,t}(t)),r=0;r<t.length;r+=1)i.boxes.push(e(t[r]));for(i.boxes.push(function(e){var t,i,n,r=e[e.length-1];for(t=new y.boxes.MovieExtendsBox,n=0;n<e.length;n+=1)r=e[n],(i=new y.boxes.TrackExtendsBox).version=0,i.flags=0,i.track_ID=r.trackId,i.default_sample_description_index=1,i.default_sample_duration=0,i.default_sample_flags=0,i.default_sample_size=0,t.boxes.push(i);return t}(t)),r=0;r<t.length;r++)void 0!==t[r].contentProtection&&(n=this.protectionExt.getSupportedKeySystemsFromContentProtection(t[r].contentProtection),i.boxes.push.apply(i.boxes,E(n)));return o.push(function(){var e=new y.boxes.FileTypeBox;return e.major_brand=1769172790,e.minor_brand=1,e.compatible_brands=[],e.compatible_brands[0]=1769172845,e.compatible_brands[1]=1769172790,e.compatible_brands[2]=1836278888,e}()),o.push(i),o},v=1,x=function(e){var t=new y.boxes.TrackFragmentBox;return t.version=0,t.flags=0,t.boxes.push(T(e)),t.boxes.push(S(e)),t.boxes.push(D(e)),t.boxes.push(I(e)),t},T=function(e){var t=new y.boxes.TrackFragmentHeaderBox;return t.version=0,t.flags=131072,t.track_ID=e.trackId,t},S=function(e){var t=new y.boxes.TrackFragmentBaseMediaDecodeTimeBox;return t.version=1,t.flags=0,t.baseMediaDecodeTime=e.samples.length>0?e.samples[0].dts:0,t},D=function(e){var t,i,n,r=new y.boxes.TrackFragmentRunBox;for(e.samples[0].cts,i=e.samples[0].duration>0?256:0,r.version=0,r.flags=1537|i|("video"===e.type?2048:0),r.data_offset=0,r.samples_table=[],r.sample_count=e.samples.length,t=0;t<e.samples.length;t++)(n={sample_duration:e.samples[t].duration,sample_size:e.samples[t].size,sample_composition_time_offset:e.samples[t].cts-e.samples[t].dts,sample_flags:e.samples[t].flags}).sample_composition_time_offset<0&&(r.version=1),r.samples_table.push(n);return r},I=function(e){var t,i=new y.boxes.SampleDependencyTableBox;for(i.version=0,i.flags=0,i.sample_dependency_table=[],t=0;t<e.samples.length;t++)i.sample_dependency_table.push((267386880&e.samples[t].flags)>>20);return i},M=function(e){var t,i,n,r,o=[],s=0,a={},l=[],d=0;if((t=new y.boxes.MovieFragmentBox).boxes.push(function(){var e=new y.boxes.MovieFragmentHeaderBox;return e.version=0,e.flags=0,e.sequence_number=v++,e}()),e)for(i=0;i<e.length;i+=1)t.boxes.push(x(e[i]));if(o.push(t),t.computeLength(),n=t.size,r=t.getBoxesByType("traf"),n+=8,e&&e.length&&(l=[e.length]),e)for(i=0;i<e.length;i+=1)r[i].getBoxByType("trun").data_offset=n,n+=e[i].data.length,l[i]=e[i].data,s+=l[i].length;for(a.data=new Uint8Array(s),i=0;i<l.length;i++)a.data.set(l[i],d),d+=l[i].length;return o.push(function(e){var t=new y.boxes.MediaDataBox;return t.data=e.data,t}(a)),o};return{protectionExt:void 0,generateInitSegment:function(e){var t=new y.boxes.File;return t.boxes=b.call(this,e),y.serialize(t)},generateMediaSegment:function(e){var t=new y.boxes.File;return t.boxes=M.call(this,e),y.serialize(t)},generateInitMediaSegment:function(e){var t=new y.boxes.File;return t.boxes=b.call(this,e),t.boxes=t.boxes.concat(M.call(this,e)),y.serialize(t)}}},c.dependencies.Mp4Processor.prototype={constructor:c.dependencies.Mp4Processor},c.dependencies.Notifier=function(){"use strict";var e,t=0,i=function(){return this.observableId||(t+=1,this.observableId="_id_"+t),this.observableId};return{system:void 0,setup:function(){(e=this.system).mapValue("notify",this.notify),e.mapValue("subscribe",this.subscribe),e.mapValue("unsubscribe",this.unsubscribe)},notify:function(){var t=arguments[0]+i.call(this),n=new c.vo.Event;n.sender=this,n.type=arguments[0],n.data=arguments[1],n.error=arguments[2],n.timestamp=(new Date).getTime(),e.notify.call(e,t,n)},subscribe:function(t,n,r,o){if(!r&&n[t]&&(r=n[t]=n[t].bind(n)),!n)throw"observer object cannot be null or undefined";if(!r)throw"event handler cannot be null or undefined";t+=i.call(this),e.mapHandler(t,void 0,r,o)},unsubscribe:function(t,n,r){r=r||n[t],t+=i.call(this),e.unmapHandler(t,void 0,r)}}},c.dependencies.Notifier.prototype={constructor:c.dependencies.Notifier},c.dependencies.Parser=function(){"use strict";var e=null;return{debug:void 0,system:void 0,dashParser:void 0,mssParser:void 0,hlsParser:void 0,metricsModel:void 0,parse:function(t,i){if(null===e)if(t.indexOf("SmoothStreamingMedia")>-1&&void 0!==this.mssParser)this.system.notify("setContext","MSS"),e=this.mssParser;else if(t.indexOf("#EXTM3U")>-1&&void 0!==this.hlsParser)this.system.notify("setContext","HLS"),e=this.hlsParser;else{if(!(t.indexOf("MPD")>-1&&void 0!==this.dashParser))return n.reject("manifest cannot be parsed, protocol is unsupported!");this.system.notify("setContext","MPD"),e=this.dashParser}return e.parse(t,i)},abort:function(){null!==e&&void 0!==e.abort&&e.abort()},reset:function(){e=null}}},c.dependencies.Parser.prototype={constructor:c.dependencies.Parser},c.dependencies.SourceBufferExtensions=function(){"use strict";this.system=void 0,this.manifestExt=void 0},c.dependencies.SourceBufferExtensions.prototype={constructor:c.dependencies.SourceBufferExtensions,createSourceBuffer:function(e,t){"use strict";var i=null;if(!e)return null;try{i=e.addSourceBuffer(t)}catch(e){if(!this.manifestExt.getIsTextTrack(t))throw e;if("text/vtt"===t||"text/ttml"===t)i=this.system.getObject("textSourceBuffer");else{if("application/ttml+xml+mp4"!==t&&"application/mp4"!==t&&"application/ttml+xml"!==t)throw e;i=this.system.getObject("textTTMLXMLMP4SourceBuffer")}}return i},removeSourceBuffer:function(e,t){"use strict";try{e.removeSourceBuffer(t)}catch(e){}},getBufferRange:function(e,t,i){"use strict";var n,r,o=null,s=0,a=0,l=null,d=null,u=0,c=i||.03;try{o=e.buffered}catch(e){return null}if(o){for(r=0,n=o.length;r<n;r+=1)if(s=o.start(r),a=o.end(r),null===l){if(u=Math.abs(s-t),t>=s&&t<a){l=s,d=a;continue}if(u<=c){l=s,d=a;continue}}else{if(!((u=s-d)<=c))break;d=a}if(null!==l)return{start:l,end:d}}return null},getAllRanges:function(e){try{return e.buffered}catch(e){return null}},getBufferLength:function(e,t,i){"use strict";var n;return n=this.getBufferRange(e,t,i),null===n?0:n.end-t},waitForUpdateEnd:function(e){"use strict";var t,i=n.defer(),r=function(){e.updating||(clearInterval(t),i.resolve(!0))},o=function(){e.updating||(e.removeEventListener("updateend",o,!1),i.resolve(!0))};if(!e.updating)return i.resolve(!0),i.promise;if("function"==typeof e.addEventListener)try{e.addEventListener("updateend",o,!1)}catch(e){t=setInterval(r,50)}else t=setInterval(r,50);return i.promise},append:function(e,t,i){var r=n.defer(),o=this;return o.waitForUpdateEnd(e).then(function(){try{"append"in e?e.append(t,i):"appendBuffer"in e&&e.appendBuffer(t),o.waitForUpdateEnd(e,i).then(function(){r.resolve()})}catch(e){r.reject({err:e,data:t})}}),r.promise},remove:function(e,t,i,r,o){var s=n.defer(),a=this;return a.waitForUpdateEnd(e).then(function(){try{t>=0&&t<r&&i>t&&"ended"!==o.readyState&&e.remove(t,i),isNaN(i)&&"ended"!==o.readyState&&e.remove(t),a.waitForUpdateEnd(e).then(function(){s.resolve()})}catch(e){s.reject(e)}}),s.promise},abort:function(e,t){"use strict";try{"open"===e.readyState&&t.abort()}catch(e){}}},Math.sign||(Math.sign=function(e){"use strict";return e<0?-1:0===e?0:1}),c.dependencies.Stream=function(){"use strict";var e,t,i,r,o,s,a,l,d,u,h,p,f,m,g,y,_,E,b,v,x,T,S,D,I,M,L,R,A=null,P=null,w=-1,N=null,B=-1,F=null,C=!1,O=!1,U=null,k=null,H=null,K=-1,V=!0,q=!1,z=!1,Y="und",j="und",W=null,G=-1,X=-1,Q="Stopped",J=1,$=!1,Z=!1,ee=null,te=!0,ie=null,ne=!1,re=-1,oe=-1,se=function(){q&&(this.debug.info("[Stream] Play."),this.videoModel.play())},ae=function(){this.debug.info("[Stream] Pause."),this.videoModel.pause()},le=function(t,i){q&&(this.debug.info("[Stream] Seek: "+t),this.manifestExt.getIsDynamic(e)&&!ne&&0!==this.videoModel.getCurrentTime()&&he.call(this),!0===i?(E=t,this.system.unmapHandler("bufferUpdated"),this.system.mapHandler("bufferUpdated",void 0,ve.bind(this)),me.call(this,E)):this.videoModel.setCurrentTime(t))},de=function(){var i=this,r=[],o=n.defer();return n.when(te).then(function(){P&&r.push(P.reset(z)),U&&r.push(U.reset(z)),N&&r.push(N.reset(z)),k&&r.push(k.reset(z)),F&&r.push(F.reset(z)),H&&r.push(H.reset(z)),n.all(r).then(function(){ee&&(ee.reset(),ee=void 0),t&&i.mediaSourceExt.detachMediaSource(i.videoModel),q=!1,A=null,P=null,N=null,F=null,t=null,e=null,o.resolve()})}),o.promise},ue=function(e,i){var n=null,r=null;if(("video"===e.type||"audio"===e.type)&&!this.capabilities.supportsCodec(this.videoModel.getElement(),i))return this.errHandler.sendError(c.dependencies.ErrorHandler.prototype.MEDIA_ERR_CODEC_UNSUPPORTED,"Codec is not supported (HTMLMediaElement)",{codec:i}),null;try{r=this.sourceBufferExt.createSourceBuffer(t,i)}catch(t){return this.errHandler.sendError(c.dependencies.ErrorHandler.prototype.MEDIA_ERR_CREATE_SOURCEBUFFER,"Failed to create "+e.type+" source buffer",new c.vo.Error(t.code,t.name,t.message)),null}return(n=this.system.getObject("bufferController")).initialize(e.type,W,e,r,this.fragmentController,t,ee),"text"===e.type&&r.hasOwnProperty("initialize")&&r.initialize(i,n,e),n},ce=function(t,i){if("MSS"!==e.name||!this.manifestExt.getIsDynamic(e)&&!this.manifestExt.getIsStartOver(e))return null;var n=null;return t&&i&&i.type&&(n=this.system.getObject("mssFragmentInfoController")).initialize(i.type,this.fragmentController,t),n},he=function(){"MSS"===e.name&&(this.manifestExt.getIsDynamic(e)||this.manifestExt.getIsStartOver(e))&&(U&&!1===O&&(O=!0,U.start()),k&&k.start(),H&&C&&H.start())},pe=function(){U&&(O=!1,U.stop()),k&&k.stop(),H&&H.stop()},fe=function(){P&&P.updateBufferLevel(!0),N&&N.updateBufferLevel(!0),F&&F.updateBufferLevel(!0)},me=function(e){this.debug.log("[Stream] startBuffering"+(void 0===e?"":" at time "+e)),P&&(void 0===e?P.start():P.seek(e)),N&&(void 0===e?N.start():N.seek(e)),F&&C&&1===J&&(void 0===e?F.start():F.seek(e))},ge=function(){this.debug.log("[Stream] stopBuffering"),P&&P.stop(),N&&N.stop(),F&&F.stop()},ye=function(){P&&P.seeked(),N&&N.seeked(),F&&F.seeked()},_e=function(){this.scheduleWhilePaused&&!this.manifestExt.getIsDynamic(e)||ge.call(this),clearInterval(void 0)},Ee=function(i){var r=this;e=i,r.debug.log("[Stream] Create MediaSource");try{t=r.mediaSourceExt.createMediaSource()}catch(e){r.errHandler.sendError(c.dependencies.ErrorHandler.prototype.MEDIA_ERR_CREATE_MEDIASOURCE,"Failed to create MediaSource",{name:e.name,message:e.message})}null!==t&&function(){var t,i,r=null,o=null,s=null,a=this;return(t=this.manifestExt.getVideoData(e,W.index))&&(s=this.manifestExt.getCodec(t),A=this.manifestExt.getContentProtectionData(t)),(t=this.manifestExt.getSpecificAudioData(e,W.index,Y))&&(o=this.manifestExt.getCodec(t)),A?this.capabilities.supportsEncryptedMedia()?L?(r=n.defer(),i={},i[c.dependencies.ProtectionController.eventList.ENAME_KEY_SYSTEM_SELECTED]=function(){a.debug.log("[Stream] ProtectionController initialized"),L.unsubscribe(c.dependencies.ProtectionController.eventList.ENAME_KEY_SYSTEM_SELECTED,i),r.resolve(!0)},L.subscribe(c.dependencies.ProtectionController.eventList.ENAME_KEY_SYSTEM_SELECTED,i),this.debug.log("[Stream] Initialize ProtectionController"),L.init(A,o,s),r.promise):n.when(!0):(this.errHandler.sendError(c.dependencies.ErrorHandler.prototype.CAPABILITY_ERR_MEDIAKEYS,"EME is not supported/enabled",null),n.when(!1)):n.when(!0)}.call(r).then(function(){r.debug.log("[Stream] Setup MediaSource"),function(e){var t=n.defer(),i=function(){e.removeEventListener("sourceopen",i),e.removeEventListener("webkitsourceopen",i),t.resolve(e)};return e.addEventListener("sourceopen",i,!1),e.addEventListener("webkitsourceopen",i,!1),this.mediaSourceExt.attachMediaSource(e,this.videoModel),t.promise}.call(r,t).then(function(i){t=i,r.debug.log("[Stream] Initialize MediaSource"),function(){var t,i,n,r;if(e)if(te=!1,ee=this.system.getObject("eventController"),null===(t=this.manifestExt.getVideoData(e,W.index))?this.errHandler.sendError(c.dependencies.ErrorHandler.prototype.MANIFEST_ERR_NO_VIDEO,"No Video data in manifest"):(Te.call(this,t),w=this.manifestExt.getDataIndex(t,e,W.index),i=this.manifestExt.getCodec(t),A=this.manifestExt.getContentProtectionData(t),null===i?this.errHandler.sendError(c.dependencies.ErrorHandler.prototype.MEDIA_ERR_CODEC_UNSUPPORTED,"Video codec information not available",{codec:""}):(P=ue.call(this,t,i),U=ce.call(this,P,t))),null!==P){if(null===(t=this.manifestExt.getSpecificAudioData(e,W.index,Y)))this.errHandler.sendWarning(c.dependencies.ErrorHandler.prototype.MANIFEST_ERR_NO_AUDIO,"No audio data in manifest");else if(Te.call(this,t),B=this.manifestExt.getDataIndex(t,e,W.index),null===(n=this.manifestExt.getCodec(t)))this.errHandler.sendWarning(c.dependencies.ErrorHandler.prototype.MEDIA_ERR_CODEC_UNSUPPORTED,"Audio codec information not available",{codec:""});else{if(null===(N=ue.call(this,t,n)))return void(te=!0);k=ce.call(this,N,t)}null!==(t=this.manifestExt.getSpecificTextData(e,W.index,j))&&(K=this.manifestExt.getDataIndex(t,e,W.index),null===(r=this.manifestExt.getMimeType(t))?this.errHandler.sendWarning(c.dependencies.ErrorHandler.prototype.MANIFEST_ERR_NO_TEXT,"Text codec information not available"):(F=ue.call(this,t,r),H=ce.call(this,F,t))),ee&&ee.addInlineEvents(this.manifestExt.getEventsForPeriod(e,W)),te=!0}else te=!0}.call(r),r.debug.log("[Stream] Initialize playback"),function(){this.debug.log("[Stream] Setting duration: "+W.duration),this.mediaSourceExt.setDuration(t,W.duration),q=!0}.call(r),r.debug.log("[Stream] Playback initialized")})})},be=function(e){this.debug.log("[Stream] Set video model current time: "+e),this.videoModel.unlisten("seeking",l),this.videoModel.setCurrentTime(e)},ve=function(){var t,i,n;if(this.debug.info("[Stream] Check start time"),null!==(t=this.sourceBufferExt.getBufferRange(P.getBuffer(),E,P.getSegmentDuration()))){if(n=Math.max(E,t.start),N){if(null===(i=this.sourceBufferExt.getBufferRange(N.getBuffer(),E,N.getSegmentDuration())))return;if(this.debug.info("[Stream] Check start time: A["+i.start+"-"+i.end+"], V["+t.start+"-"+t.end+"]"),i.end<n)return;n=Math.max(n,i.start)}this.debug.info("[Stream] Check start time: OK => "+n),this.system.unmapHandler("bufferUpdated"),this.videoModel.isPaused()?X=n:be.call(this,n),this.manifestExt.getIsStartOver(e)&&he.call(this),se.call(this)}},xe=function(t,i,n){var r=-1;return t?-1===n?n:((r=this.manifestExt.getDataIndex(i,e,W.index))!==n&&("MSS"===e.name&&(this.manifestExt.getIsDynamic(e)||this.manifestExt.getIsStartOver(e))?this.system.notify("manifestUpdate"):t.updateData(i,W)),r):n},Te=function(e){var t,i;for(i=1;i<e.Representation_asArray.length;)(t=this.manifestExt.getCodecForRepresentation(e.Representation_asArray[i]))&&(this.capabilities.supportsCodec(this.videoModel.getElement(),t)||(this.debug.warn("[Stream] codec not supported: "+t),e.Representation_asArray.splice(i,1),i--)),i++},Se=function(){var e=this.videoModel.getCurrentTime();F.seek(e),F.seeked()},De=function(){if(!0!==document.hidden&&-1!==re){var e=(new Date).getTime()/1e3,t=this.getVideoModel().getCurrentTime(),i=e-re,n=t-oe;this.debug.log("[Stream] VisibilityChange: elapsedClockTime = "+i+", elapsedStreamTime = "+n+" ("+(i-n)+")"),i-n>1&&function(){ae.call(this),ne=!0,this.system.notify("manifestUpdate",!0)}.call(this)}};return{system:void 0,videoModel:void 0,manifestLoader:void 0,manifestModel:void 0,mediaSourceExt:void 0,sourceBufferExt:void 0,manifestExt:void 0,fragmentController:void 0,fragmentExt:void 0,protectionExt:void 0,capabilities:void 0,debug:void 0,metricsExt:void 0,errHandler:void 0,timelineConverter:void 0,scheduleWhilePaused:void 0,textTrackExtensions:void 0,metricsModel:void 0,eventBus:void 0,notify:void 0,setup:function(){this.system.mapHandler("startTimeFound",void 0,function(t){this.debug.info("[Stream] Start time = "+t),-1!==G&&!this.manifestExt.getIsDynamic(e)&&G<W.duration&&(this.debug.info("[Stream] Initial start time = "+G),t=G),le.call(this,t,0===W.index&&V)}.bind(this)),this.system.mapHandler("segmentLoadingFailed",void 0,function(t){var i=this;if(this.debug.log("[Stream] Segment loading failed: start time = "+t.startTime+", duration = "+t.duration),(this.manifestExt.getIsDynamic(e)||this.manifestExt.getIsstartOver(e))&&null===ie){ne=!0;var n=t.duration;this.debug.info("[Stream] Reload session in "+n+" s."),ie=setTimeout(function(){ie=null,ne=!0,i.debug.info("[Stream] Reload session (update manifest)"),i.system.notify("manifestUpdate",!0),pe.call(i)},1e3*n)}else le.call(this,t.startTime+t.duration)}.bind(this)),this.system.mapHandler("bufferingCompleted",void 0,function(){P&&!P.isBufferingCompleted()||N&&!N.isBufferingCompleted()||t&&(this.videoModel.unlisten("pause",s),this.debug.info("[Stream] Signal end of stream"),this.mediaSourceExt.signalEndOfStream(t))}.bind(this)),this.system.mapHandler("sourceDurationChanged",void 0,function(i){this.debug.info("[Stream] Source duration changed: "+i),this.mediaSourceExt.setDuration(t,i),e.mediaPresentationDuration=i,W.duration=i}.bind(this)),c.dependencies.ProtectionController&&(this[c.dependencies.ProtectionController.eventList.ENAME_PROTECTION_ERROR]=function(e){this.errHandler.sendError(e.data.code,e.data.message,e.data.data)}.bind(this)),o=function(){this.debug.info("[Stream] <video> play event"),this.videoModel.listen("pause",s),1!==J?this.setTrickModeSpeed(1):X>=0?(be.call(this,X),X=-1):me.call(this),this.metricsModel.addPlayList("video",(new Date).getTime(),this.videoModel.getCurrentTime(),"play")}.bind(this),s=function(){this.debug.info("[Stream] <video> pause event"),re=-1,oe=-1,1===J&&(this.metricsModel.addState("video","paused",this.videoModel.getCurrentTime()),this.metricsModel.addPlayList("video",(new Date).getTime(),this.videoModel.getCurrentTime(),"pause")),_e.call(this),"MSS"===e.name&&this.manifestExt.getIsDynamic(e)&&he.call(this)}.bind(this),a=function(e){var t,i=e.target.error,n="[Stream] <video> error: ";if(-1!==i.code){switch(i.code){case 1:t=c.dependencies.ErrorHandler.prototype.MEDIA_ERR_ABORTED,n+="fetching process aborted";break;case 2:t=c.dependencies.ErrorHandler.prototype.MEDIA_ERR_NETWORK,n+="network error";break;case 3:t=c.dependencies.ErrorHandler.prototype.MEDIA_ERR_DECODE,n+="media decoding error";break;case 4:t=c.dependencies.ErrorHandler.prototype.MEDIA_ERR_SRC_NOT_SUPPORTED,n+="media format not supported";break;case 5:t=c.dependencies.ErrorHandler.prototype.MEDIA_ERR_ENCRYPTED,n+="media is encrypted"}z=!0,this.errHandler.sendError(t,n)}}.bind(this),l=function(){var e=this.videoModel.getCurrentTime();this.debug.info("[Stream] <video> seeking event: "+e),1===J||e.toFixed(3)===M.toFixed(3)?(e=e<this.getStartTime()?this.getStartTime():e,1===J&&(this.metricsModel.addState("video","seeking",this.getVideoModel().getCurrentTime()),this.metricsModel.addPlayList("video",(new Date).getTime(),e,c.vo.metrics.PlayList.SEEK_START_REASON)),me.call(this,e)):this.setTrickModeSpeed(1)}.bind(this),d=function(){var e,t,i,n,r,o,s,a,d,u=this;if(this.debug.info("[Stream] <video> seeked event"),ye.call(this),1!==J){if(e=(new Date).getTime()/1e3,t=u.videoModel.getCurrentTime(),i=e-v,n=e-D,r=Math.abs(t-x),o=r/i,u.debug.log("[Stream] Trick mode (x"+J+"): elapsed time = "+i.toFixed(3)+", elapsed video time = "+r.toFixed(3)+", speed = "+o.toFixed(3)),"Changed"===Q)clearTimeout(I),Q="Running",v=(new Date).getTime()/1e3,x=t,u.debug.info("[Stream] Trick mode (x"+J+"): videoTime = "+x),s=t+(S=Math.abs(b/J)>1?S/Math.abs(b/J):S)*Math.sign(J),d=0;else if(o<.9*Math.abs(J)){var c=Math.abs(J/o);S*=Math.round(c)+Math.round(c%T),u.debug.info("[Stream] Trick mode (x"+J+"): seek step = "+S),s=t+S*Math.sign(J),d=0}else s=t+S*Math.sign(J),d=Math.abs(s-x)/Math.abs(J)-i-n;(function(e,t){if(u.videoModel.getCurrentTime()===u.getStartTime()||$)return u.debug.log("[Stream] Trick mode (x"+J+"): stop"),void($&&((a=document.createEvent("Event")).initEvent("ended",!0,!0),u.videoModel.getElement().dispatchEvent(a)));t<u.getStartTime()?t=u.getStartTime():t>=u.videoModel.getDuration()&&(t=u.videoModel.getDuration()-T,$=!0),e>0&&u.debug.log("[Stream] Trick mode (x"+J+"): wait "+e.toFixed(3)+" s"),I=setTimeout(function(){D=(new Date).getTime()/1e3,u.debug.log("[Stream] Trick mode (x"+J+"): seek time = "+t.toFixed(3)),M=t,u.videoModel.setCurrentTime(t)},e>0?1e3*e:0)}).call(u,d,s)}this.videoModel.listen("seeking",l),ne=!1,re=-1,oe=-1}.bind(this),u=function(){this.debug.info("[Stream] <video> waiting event"),this.getVideoModel().isSeeking()||this.metricsModel.addState("video","buffering",this.getVideoModel().getCurrentTime())}.bind(this),f=function(){this.debug.info("[Stream] <video> progress event"),fe.call(this)}.bind(this),m=function(){this.debug.info("[Stream] <video> ratechange event: "+this.videoModel.getPlaybackRate()),P&&P.updateStalledState(),N&&N.updateStalledState(),F&&F.updateStalledState()}.bind(this),h=function(){this.debug.info("[Stream] <video> timeupdate event: "+this.videoModel.getCurrentTime()),fe.call(this)}.bind(this),p=function(){var e=this.videoModel.getDuration();this.debug.info("[Stream] <video> durationchange event: "+e)}.bind(this),r=function(){this.debug.info("[Stream] <video> loadedmetadata event")}.bind(this),g=function(){this.debug.info("[Stream] <video> canplay event")}.bind(this),y=function(){this.debug.info("[Stream] <video> playing event"),this.metricsModel.addState("video","playing",this.getVideoModel().getCurrentTime()),re=(new Date).getTime()/1e3,oe=this.getVideoModel().getCurrentTime()}.bind(this),_=function(){this.debug.info("[Stream] <video> loadstart event")}.bind(this),i=function(){this.debug.info("[Stream] <video> ended event"),this.metricsModel.addState("video","stopped",this.videoModel.getCurrentTime(),1),this.manifestExt.getIsStartOver(e)&&pe.call(this)}.bind(this),R=De.bind(this)},load:function(e,t){W=t,Ee.call(this,e)},setVideoModel:function(e){this.videoModel=e,this.videoModel.listen("play",o),this.videoModel.listen("pause",s),this.videoModel.listen("error",a),this.videoModel.listen("seeking",l),this.videoModel.listen("seeked",d),this.videoModel.listen("waiting",u),this.videoModel.listen("timeupdate",h),this.videoModel.listen("durationchange",p),this.videoModel.listen("progress",f),this.videoModel.listen("ratechange",m),this.videoModel.listen("loadedmetadata",r),this.videoModel.listen("ended",i),this.videoModel.listen("canplay",g),this.videoModel.listen("playing",y),this.videoModel.listen("loadstart",_)},setInitialStartTime:function(e){var t=parseFloat(e);isNaN(t)||(G=t)},getAudioTracks:function(){return this.manifestExt.getAudioDatas(e,W.index)},setAudioTrack:function(e){k&&k.stop(),B=xe.call(this,N,e,B)},getSelectedAudioTrack:function(){if(N)return this.manifestExt.getDataForIndex(B,e,W.index)},getSubtitleTracks:function(){return this.manifestExt.getTextDatas(e,W.index)},setSubtitleTrack:function(e){H&&H.stop(),K=xe.call(this,F,e,K)},getSelectedSubtitleTrack:function(){if(F&&C)return this.manifestExt.getDataForIndex(K,e,W.index)},initProtection:function(e){(L=e)&&L.subscribe(c.dependencies.ProtectionController.eventList.ENAME_PROTECTION_ERROR,this)},getVideoModel:function(){return this.videoModel},getManifestExt:function(){return this.manifestExt},setAutoPlay:function(e){V=e},setDefaultAudioLang:function(e){Y=e},setDefaultSubtitleLang:function(e){j=e},getAutoPlay:function(){return V},reset:function(){var e=n.defer(),t=this;return this.debug.info("[Stream] Reset"),ge.call(this),pe.call(this),ae.call(this),clearTimeout(I),clearTimeout(ie),1!==J&&this.videoModel.setMute(Z),this.videoModel.unlisten("play",o),this.videoModel.unlisten("pause",s),this.videoModel.unlisten("error",a),this.videoModel.unlisten("seeking",l),this.videoModel.unlisten("seeked",d),this.videoModel.unlisten("waiting",u),this.videoModel.unlisten("timeupdate",h),this.videoModel.unlisten("durationchange",p),this.videoModel.unlisten("progress",f),this.videoModel.unlisten("ratechange",m),this.videoModel.unlisten("loadedmetadata",r),this.videoModel.unlisten("ended",i),this.videoModel.unlisten("canplay",g),this.videoModel.unlisten("playing",y),this.videoModel.unlisten("loadstart",_),this.system.unmapHandler("streamsComposed",void 0,Se),this.system.unmapHandler("bufferUpdated"),this.system.unmapHandler("startTimeFound"),this.system.unmapHandler("segmentLoadingFailed"),this.system.unmapHandler("bufferingCompleted"),this.system.unmapHandler("sourceDurationChanged"),de.call(this).then(function(){L&&L.unsubscribe(c.dependencies.ProtectionController.eventList.ENAME_PROTECTION_ERROR,t),L=void 0,t.fragmentController=void 0,e.resolve()}),e.promise},getDuration:function(){return W.duration},getStartTime:function(){return W.start},getPeriodIndex:function(){return W.index},getId:function(){return W.id},getPeriodInfo:function(){return W},getMinbufferTime:function(){return P?P.getMinbufferTime():c.dependencies.BufferExtensions.DEFAULT_MIN_BUFFER_TIME},getLiveDelay:function(){return P?P.getLiveDelay():c.dependencies.BufferExtensions.DEFAULT_LIVE_DELAY},startEventController:function(){ee.start()},resetEventController:function(){ee.reset()},enableSubtitles:function(t){var i;t!==C&&(C=t,i=this.textTrackExtensions.getCurrentTextTrack(this.videoModel.getElement()),this.textTrackExtensions.cleanSubtitles(),F&&(t?("MSS"===e.name&&(this.manifestExt.getIsDynamic(e)||this.manifestExt.getIsStartOver(e))?(this.system.mapHandler("streamsComposed",void 0,Se.bind(this),!0),this.system.notify("manifestUpdate")):Se.call(this),i&&"metadata"!==i.kind&&"showing"!==i.mode?i.mode="showing":i&&(i.mode="hidden")):(H&&H.stop(),i&&(i.mode="disabled"),F.stop())))},setTrickModeSpeed:function(e){var t,i,r=[],o=this,a=1!==e,l=function(){o.videoModel.getCurrentTime()>t+1&&(o.videoModel.unlisten("timeupdate",l),o.debug.info("[Stream] Set mute: "+Z+", the mute state before using trick mode."),o.videoModel.setMute(Z))};e!==J&&P&&(o.debug.info("[Stream] Trick mode: speed = "+e),a&&"Stopped"===Q?(this.videoModel.unlisten("pause",s),o.debug.info("[Stream] Set mute: true"),(Z=o.videoModel.getMute())||o.videoModel.setMute(!0),o.videoModel.pause()):a||(o.metricsModel.addPlayList("video",(new Date).getTime(),x,"trickMode",J),J=1,clearTimeout(I),ge.call(o)),r.push(P.setTrickMode(a,e>1)),N&&r.push(N.setTrickMode(a,e>1)),n.all(r).then(function(){b=J,J=e,t=o.videoModel.getCurrentTime(),a?"Running"===Q?(o.metricsModel.addPlayList("video",(new Date).getTime(),x,"trickMode",b),Q="Changed"):"Stopped"===Q&&($=!1,Q="Running",S=T=P.getSegmentDuration(),v=D=(new Date).getTime()/1e3,x=t,o.debug.info("[Stream] Trick mode (x"+J+"): videoTime = "+x),i=t+S*Math.sign(J),i=Math.round(1e3*(i-i%T))/1e3,o.debug.info("[Stream] Trick mode (x"+J+"): seek step = "+S),M=i,le.call(o,i)):(o.videoModel.listen("pause",s),o.debug.info("[Stream] Trick mode: Stopped, current time = "+t),Q="Stopped",o.videoModel.listen("timeupdate",l),t=$?o.getStartTime():t,le.call(o,t,!0))}))},getTrickModeSpeed:function(){return J},updateData:function(t){var i,n;if(e=this.manifestModel.getValue(),W=t,this.debug.log("[Stream] Manifest updated ... set new data on buffers."),P&&(n=(i=P.getData())&&i.hasOwnProperty("id")?this.manifestExt.getDataForId(i.id,e,W.index):this.manifestExt.getDataForIndex(w,e,W.index),Te.call(this,n),P.updateData(n,W)),N&&(n=this.manifestExt.getDataForIndex(B,e,W.index),Te.call(this,n),N.updateData(n,W)),F&&(n=this.manifestExt.getDataForIndex(K,e,W.index),F.updateData(n,W)),ee){var r=this.manifestExt.getEventsForPeriod(e,W);ee.addInlineEvents(r)}ne&&P&&(this.system.unmapHandler("bufferUpdated"),this.system.mapHandler("bufferUpdated",void 0,ve.bind(this)),P.load()),O&&he.call(this)},play:se,seek:le,pause:ae}},c.dependencies.Stream.prototype={constructor:c.dependencies.Stream},c.dependencies.StreamController=function(){"use strict";var e,i,r,o,s,a,l,d,u,h=!1,p=[],f=!1,m=!0,g=!1,y="und",_="und",E=!1,b=!1,v=null,x="Safari"===t().name,T=function(e){e.listen("seeking",s),e.listen("progress",a),e.listen("timeupdate",o),e.listen("pause",l),e.listen("play",d)},S=function(e){e.unlisten("seeking",s),e.unlisten("progress",a),e.unlisten("timeupdate",o),e.unlisten("pause",l),e.unlisten("play",d)},D=function(e,t){["controls","loop","muted","playbackRate","volume"].forEach(function(i){t[i]=e[i]})},I=function(e,t,n){!g&&e&&t&&e!==t&&(g=!0,e.pause(),i=t,function(e,t){var i=e.getElement(),n=t.getElement();return n.parentNode||i.parentNode.insertBefore(n,i),i.style.width="0px",n.style.width="100%",D(i,n),S.call(this,e),T.call(this,t),!0}.call(this,e.getVideoModel(),t.getVideoModel()),n?this.seek(e.getVideoModel().getCurrentTime()):this.seek(t.getStartTime()),this.play(),e.resetEventController(),i.startEventController(),g=!1)},M=function(){var e=L();e&&e.seek(e.getStartTime())},L=function(){var e=i.getPeriodIndex()+1;return e<p.length?p[e]:null},R=function(e){var t=0,i=null,n=p.length,r=0;for(n>0&&(t+=p[0].getStartTime()),r=0;r<n;r+=1)if(i=p[r],t+=i.getDuration(),e<t)return i},A=function(){var e=this.system.getObject("videoModel"),t=document.createElement("video");return e.setElement(t),e},P=function(e){e.parentNode&&e.parentNode.removeChild(e)},w=function(){if(h){this.debug.info("[StreamController] Manifest updated");(function(){var t,n,o,s,a,l,d,c,h,g=this.manifestModel.getValue(),b=this.metricsModel.getMetricsFor("stream"),x=this.metricsExt.getCurrentManifestUpdate(b);if(!g)return!1;if(e.startOver&&(g.startOver=!0),this.debug.info("[StreamController] composeStreams"),this.capabilities.supportsEncryptedMedia()&&(r||(r=this.system.getObject("protectionController"),f=!0),r.setMediaElement(this.videoModel.getElement()),u&&r.setProtectionData(u)),c=this.manifestExt.getMpd(g),i&&(t=i.getPeriodInfo(),c.isClientServerTimeSyncCompleted=t.mpd.isClientServerTimeSyncCompleted,c.clientServerTimeShift=t.mpd.clientServerTimeShift),0===(n=this.manifestExt.getRegularPeriods(g,c)).length)return!1;for(a=0,o=n.length;a<o;a+=1){for(d=n[a],l=0,s=p.length;l<s;l+=1)p[l].getId()===d.id&&(h=p[l],this.debug.info("[StreamController] update stream data"),h.updateData(d));h||(this.debug.info("[StreamController] Create stream"),(h=this.system.getObject("stream")).setVideoModel(0===a?this.videoModel:A.call(this)),h.initProtection(r),h.setAutoPlay(m),h.setDefaultAudioLang(y),h.setDefaultSubtitleLang(_),h.enableSubtitles(E),h.setInitialStartTime(e.startTime),h.load(g,d),p.push(h)),this.metricsModel.addManifestUpdatePeriodInfo(x,d.id,d.index,d.start,d.duration),h=null}return i||(i=p[0],T.call(this,i.getVideoModel())),this.metricsModel.updateManifestUpdateInfo(x,{currentTime:this.videoModel.getCurrentTime(),buffered:this.videoModel.getElement().buffered,presentationStartTime:n[0].start,clientTimeOffset:c.clientServerTimeShift}),v&&(v.resolve(),v=null),!0}).call(this)?this.system.notify("streamsComposed"):this.errHandler.sendError(c.dependencies.ErrorHandler.prototype.MANIFEST_ERR_NO_STREAM,"No stream/period is provided in the manifest"),v&&(v.resolve(),v=null)}else v&&(v.resolve(),v=null)};return{system:void 0,videoModel:void 0,parser:void 0,manifestLoader:void 0,manifestUpdater:void 0,manifestModel:void 0,manifestExt:void 0,fragmentExt:void 0,capabilities:void 0,debug:void 0,metricsModel:void 0,metricsExt:void 0,videoExt:void 0,errHandler:void 0,eventBus:void 0,notify:void 0,subscribe:void 0,unsubscribe:void 0,setup:function(){this.system.mapHandler("manifestUpdate",void 0,function(e){!0===e&&(b=!0),this.refreshManifest()}.bind(this)),this.system.mapHandler("manifestUpdated",void 0,w.bind(this)),o=function(){if(i){var e=new Date,t=i.getStartTime()+i.getDuration(),n=i.getVideoModel().getElement(),r=n.currentTime,o=this.videoExt.getPlaybackQuality(n);this.metricsModel.addPlaybackQuality("video",e,o,r),this.metricsModel.addVideoResolution("video",e,n.videoWidth,n.videoHeight,r),L()&&(i.getVideoModel().getElement().seeking||t-r<.2&&I.call(this,i,L()))}}.bind(this),a=function(){var e=i.getVideoModel().getElement().buffered;if(e.length){var t=e.length-1,n=e.end(t);i.getStartTime()+i.getDuration()-n<6&&(i.getVideoModel().unlisten("progress",a),M())}}.bind(this),s=function(){var e=i.getVideoModel().getCurrentTime(),t=R(e);t&&t!==i&&I.call(this,i,t,e)}.bind(this),l=function(){this.manifestUpdater.stop()}.bind(this),d=function(){this.manifestUpdater.start()}.bind(this)},getManifestExt:function(){return i.getManifestExt()},setAutoPlay:function(e){m=e},getAutoPlay:function(){return m},getVideoModel:function(){return this.videoModel},setVideoModel:function(e){this.videoModel=e},getAudioTracks:function(){return i?i.getAudioTracks():null},getSelectedAudioTrack:function(){if(i)return i.getSelectedAudioTrack()},setAudioTrack:function(e){i&&i.setAudioTrack(e)},getSubtitleTracks:function(){return i?i.getSubtitleTracks():null},setSubtitleTrack:function(e){i&&i.setSubtitleTrack(e)},getSelectedSubtitleTrack:function(){if(i)return i.getSelectedSubtitleTrack()},getMinbufferTime:function(){return i?i.getMinbufferTime():c.dependencies.BufferExtensions.DEFAULT_MIN_BUFFER_TIME},getLiveDelay:function(){return i?i.getLiveDelay():c.dependencies.BufferExtensions.DEFAULT_LIVE_DELAY},load:function(t){var r=this;h=!0,(e=t).protData&&(u=e.protData),function(e){if(x&&"HLS"===e.protocol){var t=this.system.getObject("hlsStream");return t.setVideoModel(this.videoModel),t.setProtectionData(u),t.setAutoPlay(m),t.setDefaultAudioLang(y),t.setDefaultSubtitleLang(_),t.enableSubtitles(E),p.push(t),i=t,T.call(this,i.getVideoModel()),t.load(e.url),!0}return!1}.call(this,e)||(b=!1,v=n.defer(),r.debug.info("[StreamController] load url: "+e.url),r.manifestLoader.load(e.url).then(function(e){r.manifestModel.setValue(e),r.metricsModel.addMetaData(),r.debug.info("[StreamController] Manifest has loaded."),r.manifestUpdater.start()},function(e){v.resolve(),v=null,e&&r.errHandler.sendError(e.name,e.message,e.data)}))},refreshManifest:function(e){var t=this.manifestModel.getValue(),i=e||(t.hasOwnProperty("Location")?t.Location:t.mpdUrl);this.debug.log("[StreamController] Refresh manifest: "+i);var n=this;this.manifestLoader.abort(),this.manifestLoader.load(i,!0).then(function(e){n.manifestModel.setValue(e),n.debug.log("[StreamController] Manifest has been refreshed"),b=!1},function(t){void 0!==t&&(e?b&&n.errHandler.sendError(t.name,t.message,t.data):(n.errHandler.sendWarning(t.name,t.message,t.data),n.eventBus.dispatchEvent({type:"manifestUrlUpdate",data:{url:i}})))})},reset:function(e){var t,o,s={},a=[],l=this;this.debug.info("[StreamController] Reset"),i&&S.call(this,i.getVideoModel()),h=!1,l.manifestLoader.abort(),l.manifestUpdater.stop(),l.parser.reset(),s[c.models.ProtectionModel.eventList.ENAME_TEARDOWN_COMPLETE]=function(){f=!1,r=null,u=null,l.manifestModel.setValue(null),l.metricsModel.addState("video","stopped",l.videoModel.getCurrentTime(),e),l.metricsModel.clearAllCurrentMetrics(),l.notify(c.dependencies.StreamController.eventList.ENAME_TEARDOWN_COMPLETE)},n.when(!v||v.promise).then(function(){for(l.pause(),g=!1,o=0;o<p.length;o+=1)t=p[o],a.push(t.reset()),t!==i&&P(t.getVideoModel().getElement());l.videoModel.reset(),n.all(a).then(function(){p=[],i=null,r?f?(r.protectionModel.subscribe(c.models.ProtectionModel.eventList.ENAME_TEARDOWN_COMPLETE,s,void 0,!0),r.teardown()):(r.setMediaElement(null),s[c.models.ProtectionModel.eventList.ENAME_TEARDOWN_COMPLETE]()):s[c.models.ProtectionModel.eventList.ENAME_TEARDOWN_COMPLETE]()})})},setDefaultAudioLang:function(e){y=e},setDefaultSubtitleLang:function(e){_=e},enableSubtitles:function(e){E=e,i&&i.enableSubtitles(e)},setTrickModeSpeed:function(e){i&&i.setTrickModeSpeed(e)},getTrickModeSpeed:function(){return i?i.getTrickModeSpeed():0},play:function(){i.play()},pause:function(){i&&i.pause()},seek:function(e,t){i&&i.seek(e,t)}}},c.dependencies.StreamController.prototype={constructor:c.dependencies.StreamController},c.dependencies.StreamController.eventList={ENAME_STREAMS_COMPOSED:"streamsComposed",ENAME_TEARDOWN_COMPLETE:"streamTeardownComplete"},c.utils.TokenAuthentication=function(){"use strict";var e={type:c.utils.TokenAuthentication.TYPE_QUERY};return{debug:void 0,getTokenAuthentication:function(){return e},setTokenAuthentication:function(t){e=t},checkRequestHeaderForToken:function(t){void 0!==e.name&&null!==t.getResponseHeader(e.name)&&(e.token=t.getResponseHeader(e.name),this.debug.log(e.name+" received: "+e.token))},addTokenAsQueryArg:function(t){if(void 0!==e.name&&void 0!==e.token&&e.type===c.utils.TokenAuthentication.TYPE_QUERY){t+=(-1===t.indexOf("?")?"?":"&")+e.name+"="+e.token,this.debug.log(e.name+" is being appended on the request url with a value of : "+e.token)}return t},setTokenInRequestHeader:function(t){return e.type===c.utils.TokenAuthentication.TYPE_HEADER&&(t.setRequestHeader(e.name,e.token),this.debug.log(e.name+" is being set in the request header with a value of : "+e.token)),t}}},c.utils.TokenAuthentication.TYPE_QUERY="query",c.utils.TokenAuthentication.TYPE_HEADER="header",c.models.URIQueryAndFragmentModel=function(){"use strict";var e=new c.vo.URIFragmentData,t=[];return{parseURI:function(i){function n(e,t,i,n){var r=n[0].split(/[=]/);return n.push({key:r[0],value:r[1]}),n.shift(),n}var r=[],o=new RegExp(/[?]/),s=new RegExp(/[#]/),a=o.test(i),l=s.test(i);return i.split(/[?#]/).map(function(e,i,n){return i>0&&(a&&0===t.length?t=n[i].split(/[&]/):l&&(r=n[i].split(/[&]/))),n}),t.length>0&&(t=t.reduce(n,null)),r.length>0&&(r=r.reduce(n,null)).forEach(function(t){e[t.key]=t.value}),i},reset:function(){e=new c.vo.URIFragmentData,t=[]},getURIFragmentData:function(){return e},getURIQueryData:t}},c.models.URIQueryAndFragmentModel.prototype={constructor:c.models.URIQueryAndFragmentModel},c.models.VideoModel=function(){"use strict";var e,t=[],i=null;return{system:void 0,debug:void 0,setup:function(){t=[]},reset:function(){t=[]},play:function(){this.debug.info("<video> # play()"),e.play()},pause:function(){this.debug.info("<video> # pause()"),e.pause()},isPaused:function(){return e.paused},isSeeking:function(){return e.seeking},getDuration:function(){return e.duration},getPlaybackRate:function(){return e.playbackRate},setPlaybackRate:function(t){this.debug.info("<video> # playbackRate = "+t),e.playbackRate=t},getMute:function(){return e.muted},setMute:function(t){e.muted=t},getVolume:function(){return e.volume},setVolume:function(t){e.volume=t},getCurrentTime:function(){return e.currentTime},setCurrentTime:function(t){this.debug.info("<video> # currentTime = "+t),e.currentTime=t},listen:function(t,i){e.addEventListener(t,i,!1)},unlisten:function(t,i){e.removeEventListener(t,i,!1)},listenOnParent:function(t,i){e.parentElement.addEventListener(t,i,!1)},unlistenOnParent:function(t,i){e.parentElement.removeEventListener(t,i,!1)},getElement:function(){return e},setElement:function(t){e=t},setSource:function(t){t?(this.debug.info("<video> # set source"),e.src=t):(this.debug.info("<video> # reset source"),e.removeAttribute("src"),e.load())},isStalled:function(){return t.length>0},stallStream:function(i,n){n?function(e){null!==e&&-1===t.indexOf(e)&&(this.debug.info("<video> # stall stream "+e),t.push(e),1===t.length&&this.setPlaybackRate(0))}.call(this,i):function(i){var n=t.indexOf(i);null!==i&&(this.debug.info("<video> # unstall stream "+i),-1!==n&&t.splice(n,1),!1===this.isStalled()&&0===e.playbackRate&&this.setPlaybackRate(1))}.call(this,i)},getTTMLRenderingDiv:function(){return i},setTTMLRenderingDiv:function(e){(i=e).style.position="absolute",i.style.display="flex",i.style.overflow="hidden",i.style.pointerEvents="none",i.style.top=0,i.style.left=0}}},c.models.VideoModel.prototype={constructor:c.models.VideoModel},c.dependencies.VideoModelExtensions=function(){"use strict";return{getPlaybackQuality:function(e){var t="webkitDroppedFrameCount"in e,i=null;return"getVideoPlaybackQuality"in e?i=e.getVideoPlaybackQuality():t&&(i={droppedVideoFrames:e.webkitDroppedFrameCount,creationTime:new Date,totalVideoFrames:e.webkitDecodedFrameCount}),i}}},c.dependencies.VideoModelExtensions.prototype={constructor:c.dependencies.VideoModelExtensions},c.dependencies.XHRLoader=function(){"use strict";var e=null,t=null,i=null,r=null,o=null,s=0,a=0,l=0,d=null,u=null,c=function(){var n=!0,h=function(){n&&(n=!1,e.endDate=new Date,l++,!e.aborted&&s>0&&l<=s?d=setTimeout(function(){c()},a):u.reject(e))};try{(e=new XMLHttpRequest).open("GET",t,!0),i&&(e.responseType=i),r&&e.setRequestHeader("Range","bytes="+r),e.onprogress=function(t){o&&o(e,t)},e.onabort=function(){e.aborted=!0},e.onload=function(){e.status<200||e.status>299||200===e.status&&4===e.readyState&&(n=!1,e.endDate=new Date,u.resolve(e))},e.onloadend=h,e.onerror=h,e.startDate=new Date,e.send()}catch(t){e.onerror()}};return{initialize:function(e,t,n,r){i=e,s=t,a=n,o=r},load:function(e,i){return t=e,r=i,l=0,u=n.defer(),c(),u.promise},abort:function(){null!==e&&e.readyState>0&&e.readyState<4?e.abort():d&&(clearTimeout(d),d=null,u.reject())}}},c.dependencies.XHRLoader.prototype={constructor:c.dependencies.XHRLoader},c.utils.TTMLParser=function(){"use strict";var e=["http://www.w3.org/ns/ttml","http://www.w3.org/2006/10/ttaf1"],t=["http://www.w3.org/ns/ttml#styling","http://www.w3.org/2006/10/ttaf1#styling"],i=["http://www.w3.org/ns/ttml#parameter","http://www.w3.org/2006/10/ttaf1#parameter"],r=["http://www.smpte-ra.org/schemas/2052-1/2010/smpte-tt"],o=/^(0[0-9]|1[0-9]|2[0-3]):([0-5][0-9]):([0-5][0-9])((\.[0-9][0-9][0-9])|(:[0-9][0-9]))$/,s=/^\d+(\.\d+|)(h|m|s|ms|f)$/,a=null,l=null,d=null,u=null,c=null,h=null,p=null,f=[],m=[],g=[],y=function(e){var t,i,n;if(o.test(e))return t=e.split(":"),i=3600*parseFloat(t[0])+60*parseFloat(t[1])+parseFloat(t[2]),t[3]&&p&&!isNaN(p)&&(i+=parseFloat(t[3])/p),i;if(s.test(e)){switch("ms"==e.substr(e.length-2)?(i=parseFloat(e.substr(0,e.length-3)),n=e.substr(e.length-2)):(i=parseFloat(e.substr(0,e.length-2)),n=e.substr(e.length-1)),n){case"h":i=60*i*60;break;case"m":i*=60;break;case"s":break;case"ms":i*=.01;break;case"f":if(!p||isNaN(p))return NaN;i/=p}return i}return NaN},_=function(i,n,r){var o,s,a=null,l=0;for(l=0;l<i.length;l+=1){if(a=b.call(this,[i[l]],t,n))return a;if(o=b.call(this,[i[l]],e,"style")){if(a=E.call(this,f,o,n))return a;for(o=E.call(this,f,o,"style");o;){if(a=E.call(this,f,o,n))return a;o=E.call(this,f,o,"style")}}if(s=b.call(this,[i[l]],e,"region")){if(a=E.call(this,m,s,n))return a;if(o=E.call(this,m,s,"style")){if(a=E.call(this,f,o,n))return a;for(o=E.call(this,f,o,"style");o;){if(a=E.call(this,f,o,n))return a;o=E.call(this,f,o,"style")}}}}return void 0!==r?r:null},E=function(i,n,r){var o=0,s=null,a=0;for(o=0;o<i[n].length;o+=1){for(a=0;a<t.length;a+=1)if((s=i[n].getNamedItem(r))||(s=i[n].getNamedItemNS(t[a],r)),s)return s.nodeValue;for(a=0;a<e.length;a+=1)if((s=i[n].getNamedItem(r))||(s=i[n].getNamedItemNS(e[a],r)),s)return s.nodeValue}return null},b=function(e,t,i){var n=null,r=0,o=0;for(r=0;r<e.length;r+=1)for(o=0;o<t.length;o+=1)if(n=this.domParser.getAttributeValue(e[r],i,t[o]))return n;return n},v=function(e,t){var n={backgroundColor:null,color:null,fontSize:null,fontFamily:null,fontStyle:null,textOutline:{color:null,with:null},textAlign:null,displayAlign:null,origin:null,extent:null,cellResolution:null,rootExtent:t,showBackground:null};return n.backgroundColor=_.call(this,e,"backgroundColor","transparent"),n.color=_.call(this,e,"color"),n.fontSize=_.call(this,e,"fontSize"),n.fontFamily=_.call(this,e,"fontFamily"),n.fontStyle=_.call(this,e,"fontStyle","normal"),n.textOutline=_.call(this,e,"textOutline"),n.extent=_.call(this,e,"extent"),n.origin=_.call(this,e,"origin"),n.textAlign=_.call(this,e,"textAlign","start"),n.displayAlign=_.call(this,e,"displayAlign","before"),n.showBackground=_.call(this,e,"showBackground"),n.cellResolution=b.call(this,e,i,"cellResolution"),n.cellResolution=function(e){e||(e="32 15");var t=e,i=0;for(t=t.split(" "),i=0;i<t.length;i+=1)t[i]=parseFloat(t[i]);return t}(n.cellResolution),n};return{domParser:void 0,videoModel:void 0,parse:function(t){var o,s,E,x,T,S,D,I,M,L,R,A,P,w,N,B=[],F=null,C=null,O=null,U="",k="";try{if(null!==this.videoModel.getTTMLRenderingDiv()&&(k="html"),a=this.domParser.createXmlTree(t),!function(){var e=!1;return l=a?this.domParser.getChildNode(a,"tt"):null,d=l?this.domParser.getChildNode(l,"head"):null,u=d?this.domParser.getChildNode(d,"layout"):null,c=d?this.domParser.getChildNode(d,"styling"):null,h=l?this.domParser.getChildNode(l,"body"):null,l&&d&&h&&(e=!0),e}.call(this))return o="TTML document has incorrect structure",n.reject(o);for(I=0;I<i.length;I+=1)p=this.domParser.getAttributeValue(l,"frameRate",i[I])?parseInt(p,10):null;if(!(D=this.domParser.getChildNodes(h,"div"))||0===D.length)return o="TTML body document does not contain any div",n.reject(o);for(f=this.domParser.getAllSpecificNodes(l,"style"),m=this.domParser.getAllSpecificNodes(l,"region"),g=this.domParser.getAllSpecificNodes(l,"image"),A=_.call(this,[l],"extent"),R=0;R<D.length;R+=1)if((w=b.call(this,[D[R]],r,"backgroundImage"))&&void 0!==g[w.substring(1)]&&(x=y(b.call(this,[D[R]],e,"begin")),T=y(b.call(this,[D[R]],e,"end")),O=v.call(this,[D[R],l],A),S={start:x,end:T,data:"data:image/"+g[w.substring(1)].imagetype.nodeValue+";base64, "+this.domParser.getChildNode(g[w.substring(1)],"#text").nodeValue,type:"image",line:80,style:O},B.push(S)),(s=this.domParser.getChildNodes(D[R],"p"))&&0!==s.length)for(I=0;I<s.length;I+=1)if(S=null,O=null,E=s[I],x=y(b.call(this,[E],e,"begin")),T=y(b.call(this,[E],e,"end")),isNaN(x)||isNaN(T)||T<x)o="TTML document has incorrect timing value";else if((w=b.call(this,[E],r,"backgroundImage"))&&void 0!==g[w.substring(1)]&&(O=v.call(this,[E,D[R],l],A),S={start:x,end:T,data:"data:image/"+g[w.substring(1)].imagetype.nodeValue+";base64, "+this.domParser.getChildNode(g[w.substring(1)],"#text").nodeValue,type:"image",line:80,style:O}),(M=this.domParser.getChildNodes(E,"span")).length>0){for(L=0;L<M.length;L++){L>0&&(U+="\n"),0===L&&(O=v.call(this,[M[L],E,h,l,D[R]],A)),P=this.domParser.getTextNodesIn(M[L]);for(var H=0;H<P.length;H+=1)H>0&&(U+="\n"),U+=P[H].textContent}S={start:x,end:T,data:U,type:"text",line:80,style:O},U="",B.push(S)}else{if(O=v.call(this,[E,h,l],A),I>0&&(F=y(b.call(this,[s[I-1]],e,"begin")),C=y(b.call(this,[s[I-1]],e,"end"))),x===F&&T===C||x>=F&&T<=C)""!==E.textContent&&("html"===k?S={start:x,end:T,data:E.textContent,type:"text",line:80,style:O}:(x>=F&&T<=C?(N=B[B.length-1]).end=x:N=B.pop(),S={start:x,end:T,data:N.data+"\n"+E.textContent,type:"text",line:80,style:O}));else{for(P=this.domParser.getTextNodesIn(E),L=0;L<P.length;L+=1)L>0&&(U+="\n"),U+=P[L].textContent;""!==U&&(S={start:x,end:T,data:U,type:"text",line:80,style:O},U="")}null!==S&&B.push(S)}else o="TTML document does not contain any cues";return B.length>0?n.when(B):n.reject(o)}catch(e){return o=e.message,n.reject(o)}}}},c.utils.TTMLRenderer=function(){"use strict";var e,t=[],i=function(){var i=0;for(i=0;i<t.length;i++)s(t[i],t[i].ttmlStyle,e)},n=function(t){e.hasChildNodes()&&e.removeChild(t)},r=function(e){e=e.replace("#","");return"rgba("+parseInt(e.substring(0,2),16)+","+parseInt(e.substring(2,4),16)+","+parseInt(e.substring(4,6),16)+","+(e.length>6?parseInt(e.substring(6,8),16):255)+")"},o=function(e){var t,i,n=e;return(t=e.replace(/^(rgb|rgba)\(/,"").replace(/\)$/,"").replace(/\s/g,"").split(","))[t.length-1]>1&&(i=parseInt(t[t.length-1],10)/255,n="rgba("+t[0]+","+t[1]+","+t[2]+","+i+")"),n},s=function(e,t,i){var n,s,a,l,d=[i.clientWidth/t.cellResolution[0],i.clientHeight/t.cellResolution[1]];if(e){if(t.backgroundColor&&"#"===t.backgroundColor[0]?t.backgroundColor=r(t.backgroundColor):t.backgroundColor&&"a"===t.backgroundColor[3]&&(t.backgroundColor=o(t.backgroundColor)),t.color&&"#"===t.color[0]?t.color=r(t.color):t.color&&"a"===t.color[3]&&(t.color=o(t.color)),t.origin&&"%"===t.origin[t.origin.length-1])n=t.origin.split("%"),e.style.left=parseInt(n[0],10)+"%",e.style.top=parseInt(n[1],10)+"%",t.extent&&"%"===t.extent[t.extent.length-1]&&(s=t.extent.split("%"),e.style.width=parseInt(s[0],10)+"%",e.style.height=parseInt(s[1],10)+"%");else if(t.origin&&"x"===t.origin[t.origin.length-1])if(n=t.origin.split("px"),t.rootExtent&&"x"===t.rootExtent[t.rootExtent.length-1]){l=t.rootExtent.split("px");var u=n[0]/l[0]*i.clientWidth;e.style.left=u/i.clientWidth*100+"%",u=n[1]/l[1]*i.clientHeight,e.style.top=u/i.clientHeight*100+"%",t.extent&&"x"===t.extent[t.extent.length-1]&&(u=(s=t.extent.split("px"))[0]/l[0]*i.clientWidth,e.style.width=u/i.clientWidth*100+"%",u=s[1]/l[1]*i.clientHeight,e.style.height=u/i.clientHeight*100+"%")}else e.style.left=n[0]+"px",e.style.top=n[1]+"px";else t.origin&&"c"===t.origin[t.origin.length-1]&&(n=t.origin.split("c"),e.style.left=n[0]*d[0]+"px",e.style.top=n[1]*d[1]+"px",t.extent&&"c"===t.extent[t.extent.length-1]&&(s=t.extent.split("c"),e.style.width=s[0]*d[0]+"px",e.style.height=s[1]*d[1]+"px"));switch(a=function(e,t,i){var n={color:i,width:null},o=0;if(e&&((e=e.split(" "))[0]&&isNaN(e[0][0])?(n.color=e[0],o=1):n.color=i,n.color&&"#"===n.color[0]&&(n.color=r(n.color)),e[o]))switch(e[o][e[o].length-1]){case"c":e[o]=e[o].split("c"),e[o][0]&&(n.width=e[o][0]*t[1]+"px");break;case"x":n.width=e[o]}return n}(t.textOutline,d,t.color),e.style.webkitTextStrokeWidth=a.width,e.style.webkitTextStroke=a.color,t.textAlign){case"start":e.style.justifyContent="flex-start";break;case"end":e.style.justifyContent="flex-end";break;case"center":e.style.justifyContent="center";break;case"right":e.style.justifyContent="flex-end";break;case"left":e.style.justifyContent="flex-start";break;default:e.style.justifyContent="flex-start"}switch(t.displayAlign){case"before":e.style.alignItems="flex-start";break;case"center":e.style.alignItems=t.displayAlign;break;case"after":e.style.alignItems="flex-end";break;default:e.style.alignItems="flex-start"}e.style.fontStyle=t.fontStyle,t.showBackground&&"whenActive"===t.showBackground?e.style.backgroundColor="transparent":e.style.backgroundColor=t.backgroundColor,e.style.color=t.color,e.style.fontSize=function(e,t){var i,n;if(e&&"%"===e[e.length-1])i=parseFloat(e.substr(0,e.length-1))/100*t[1]+"px";else if(e&&"x"===e[e.length-1])i=e;else if(e&&"c"===e[e.length-1]){var r=e.replace(/\s/g,"").split("c");for(n=0;n<r.length;n+=1)r[n]=parseFloat(r[n]);i=isNaN(r[1])?r[0]*t[1]+"px":r[1]*t[1]+"px"}else i=t[1]+"px";return i}(t.fontSize,d),e.style.fontFamily=t.fontFamily}};return{videoModel:void 0,initialize:function(t){e=t,document.addEventListener("webkitfullscreenchange",i.bind(this)),document.addEventListener("mozfullscreenchange",i.bind(this)),document.addEventListener("fullscreenchange",i.bind(this)),this.videoModel.listen("seeking",function(){this.cleanSubtitles()}.bind(this))},cleanSubtitles:function(){var e=0;for(e=0;e<t.length;e++)n(t[e]);t=[]},onCueEnter:function(i){var n=function(){var t=document.createElement("div");return t.style.position="absolute",t.style.display="flex",t.style.flexDirection="row",t.style.overflow="initial",t.style.pointerEvents="none",e.appendChild(t),t}();if(i.currentTarget.style&&(s(n,i.currentTarget.style,e),n.ttmlStyle=i.currentTarget.style),"image"!==i.currentTarget.type){var r=document.createElement("p");n.appendChild(r),r.innerText=i.currentTarget.text,r.style.marginTop="auto",n.ttmlStyle&&n.ttmlStyle.showBackground&&"whenActive"===n.ttmlStyle.showBackground&&(r.style.backgroundColor=i.currentTarget.style.backgroundColor)}else{var o=new Image;o.style.height="auto",o.style.width="auto",o.src=i.currentTarget.text,n.appendChild(o)}n.data=i.currentTarget.text,t.push(n)},onCueExit:function(e){var i=0;for(i=0;i<t.length&&(e.currentTarget.text!==t[i].data||t[i].ttmlStyle!==e.currentTarget.style);i++);n(t[i]),t.splice(i,1)}}},c.dependencies.TextController=function(){var e,t,i,n,r=!1,o=null,s="READY",a=function(e){this.debug.log("TextController setState to:"+e),s=e},l=function(){if(r&&"READY"===s){var e=this;e.indexHandler.getInitRequest(n[0]).then(function(t){e.fragmentLoader.load(t).then(d.bind(e,t),u.bind(e,t)),a.call(e,"LOADING")})}},d=function(e,t){var n=this;n.fragmentController.process(t.data,e).then(function(e){null!==e&&n.sourceBufferExt.append(i,e,n.videoModel)})},u=function(){};return{videoModel:void 0,fragmentLoader:void 0,fragmentController:void 0,indexHandler:void 0,sourceBufferExt:void 0,manifestModel:void 0,manifestExt:void 0,debug:void 0,initialize:function(e,t,i,n,o){this.setVideoModel(n),this.setBuffer(i),this.setMediaSource(o),this.updateData(t,e),r=!0,l.call(this)},setPeriodInfo:function(e){o=e},getPeriodIndex:function(){return o.index},getVideoModel:function(){return this.videoModel},setVideoModel:function(e){this.videoModel=e},getData:function(){return t},setData:function(e){t=e},getBuffer:function(){return i},setBuffer:function(e){i=e},setMediaSource:function(t){e=t},updateData:function(e,i){n=function(e,t){var i,n,r=this.manifestModel.getValue();return n=this.manifestExt.getDataIndex(e,r,t.index),i=this.manifestExt.getAdaptationsForPeriod(r,t),this.manifestExt.getRepresentationsForAdaptation(r,i[n])}.call(this,t=e,o=i),a.call(this,"READY"),l.call(this)},reset:function(t){t||(this.sourceBufferExt.abort(e,i),this.sourceBufferExt.removeSourceBuffer(e,i))},start:function(){l.call(this)}}},c.dependencies.TextController.prototype={constructor:c.dependencies.TextController},c.dependencies.TextSourceBuffer=function(){var e,t,i,n={length:0,ranges:[],start:function(e){return this.ranges[e].start},end:function(e){return this.ranges[e].end},addRange:function(e,t){var i=0,n=!1;for(i=0;i<this.ranges.length;i++)this.ranges[i].end<=e+.01&&this.ranges[i].end>=e-.01&&(n=!0,this.ranges[i].end=t),this.ranges[i].start<=t+.01&&this.ranges[i].start>=t-.01&&(n=!0,this.ranges[i].start=e);n||(this.ranges.push({start:e,end:t}),this.length=this.length+1,this.ranges.sort(function(e,t){return e.start-t.start}))},removeRange:function(e,t){var i=0;for(i=this.ranges.length-1;i>=0;i-=1)(void 0===t||-1===t||this.ranges[i].end<=t)&&(void 0===e||-1===e||this.ranges[i].start>=e)&&this.ranges.splice(i,1);this.length=this.ranges.length},reset:function(){this.length=0,this.ranges=[]}};return{system:void 0,eventBus:void 0,errHandler:void 0,textTrackExtensions:void 0,buffered:n,initialize:function(r,o){i=r,e=o.getVideoModel().getElement(),t=o.getData(),n.reset()},remove:function(t,i){if(t<0||t>=i)throw"INVALID_ACCESS_ERR";this.textTrackExtensions.deleteCues(e,!1,t,i),this.buffered.removeRange(t,i)},append:function(i,n){var r=function(e){var t="",i=0,n=0,r=0,o=0,s=new Uint8Array(e);for(s.length>=3&&239===s[0]&&187===s[1]&&191===s[2]&&(i=3);i<s.length;)if((n=s[i])<128)t+=String.fromCharCode(n),i++;else if(n>191&&n<224){if(i+1>=s.length)throw"UTF-8 Decode failed. Two byte character was truncated.";r=s[i+1],t+=String.fromCharCode((31&n)<<6|63&r),i+=2}else{if(i+2>=s.length)throw"UTF-8 Decode failed. Multi byte character was truncated.";r=s[i+1],o=s[i+2],t+=String.fromCharCode((15&n)<<12|(63&r)<<6|63&o),i+=3}return t}(i),o=this.getParser().parse(r,n);0===e.textTracks.length&&this.textTrackExtensions.addTextTrack(e,[],t.Representation_asArray[0].id,t.lang,!0),0!==e.textTracks.length&&(this.textTrackExtensions.addCues(e.textTracks[0],o),n&&this.buffered.addRange(n.startTime,n.startTime+n.duration))},abort:function(){this.textTrackExtensions.deleteCues(e),this.buffered.reset()},getParser:function(){var e;return"text/vtt"===i&&(e=this.system.getObject("vttParser")),e},addEventListener:function(e,t,i){this.eventBus.addEventListener(e,t,i)},removeEventListener:function(e,t,i){this.eventBus.removeEventListener(e,t,i)}}},c.dependencies.TextSourceBuffer.prototype={constructor:c.dependencies.TextSourceBuffer},c.dependencies.TextTTMLXMLMP4SourceBuffer=function(){var e,t,i,r,o={length:0,ranges:[],start:function(e){return this.ranges[e].start},end:function(e){return this.ranges[e].end},addRange:function(e,t){var i=0,n=!1;for(i=0;i<this.ranges.length;i++)this.ranges[i].end<=e+.01&&this.ranges[i].end>=e-.01&&(n=!0,this.ranges[i].end=t),this.ranges[i].start<=t+.01&&this.ranges[i].start>=t-.01&&(n=!0,this.ranges[i].start=e);n||(this.ranges.push({start:e,end:t}),this.length=this.length+1,this.ranges.sort(function(e,t){return e.start-t.start}))},removeRange:function(e,t){var i=0;for(i=this.ranges.length-1;i>=0;i-=1)(void 0===t||-1===t||this.ranges[i].end<=t)&&(void 0===e||-1===e||this.ranges[i].start>=e)&&this.ranges.splice(i,1);this.length=this.ranges.length},reset:function(){this.length=0,this.ranges=[]}};return{updating:!1,system:void 0,eventBus:void 0,buffered:o,textTrackExtensions:void 0,ttmlParser:void 0,debug:void 0,manifestModel:void 0,initialize:function(n,s,a){t=n,e=s.getVideoModel().getElement(),o.reset(),i=a.lang,r=a.id},remove:function(t,i){if(t<0||t>=i)throw"INVALID_ACCESS_ERR";this.getTextTrackExtensions().deleteCues(e,!1,t,i),this.buffered.removeRange(t,i)},append:function(n){var o,s,a,l,d,u,c,h,p,f,m=this,g=y.deserialize(n),_=g.getBoxByType("moov"),E=0,b="utf-8";if("application/ttml+xml"===t)return this.track=this.textTrackExtensions.addTextTrack(e,[],r,i,!0),m.isUTF16(n)&&(b="utf-16"),void this.convertUTFToString(n,b).then(function(t){m.ttmlParser.parse(t).then(function(t){t&&(m.textTrackExtensions.addCues(m.track,t),m.buffered.addRange(0,e.duration),m.eventBus.dispatchEvent({type:"updateend"}))},function(){})});if(_)return o=_.getBoxByType("mvhd"),m.timescale=o.timescale,this.track=this.textTrackExtensions.addTextTrack(e,[],r,i,!0),void this.eventBus.dispatchEvent({type:"updateend"});if(s=g.getBoxByType("moof")){if(a=g.getBoxByType("mdat"),l=s.getBoxByType("traf"),d=l.getBoxByType("tfhd"),u=l.getBoxByType("tfdt"),c=l.getBoxByType("trun"),h=l.getBoxByType("subs"),p=u.baseMediaDecodeTime/m.timescale,E=0,E=256&c.flags?c.samples_table[0].sample_duration/m.timescale:d.default_sample_duration/m.timescale,m.buffered.addRange(p,p+E),h)for(var v=0;v<h.entry_count;v++)for(var x=0;x<h.entry[v].subsample_count;x++){f=a.data.subarray(0,h.entry[v].subSampleEntries[0].subsample_size);break}else f=a.data;m.isUTF16(f)&&(b="utf-16"),m.convertUTFToString(f,b).then(function(e){m.ttmlParser.parse(e).then(function(e){var t,i=m.manifestModel.getValue();if(e){if("MSS"===i.name)for(t=0;t<e.length;t+=1)e[t].start=e[t].start+p,e[t].end=e[t].end+p;m.textTrackExtensions.addCues(m.track,e),m.eventBus.dispatchEvent({type:"updateend"})}},function(){})})}},convertUTFToString:function(e,t){var i=n.defer(),r=new Blob([e],{type:"text/xml"}),o=new FileReader;return o.onload=function(e){i.resolve(e.target.result)},o.readAsText(r,t),i.promise},isUTF16:function(e){var t,i,n,r,o=0,s=e&&e.length,a=null;if(s<2){if(e[0]>255)return!1}else{if(t=e[0],i=e[1],255===t&&254===i)return!0;if(254===t&&255===i)return!0;for(;o<s;o++){if(0===e[o]){a=o;break}if(e[o]>255)return!1}if(null===a)return!1;if(void 0!==(n=e[a+1])&&n>0&&n<128)return!0;if(void 0!==(r=e[a-1])&&r>0&&r<128)return!0}return!1},UpdateLang:function(e,t){r=e,i=t},abort:function(){this.getTextTrackExtensions().deleteCues(e,!0)},getTextTrackExtensions:function(){return this.textTrackExtensions},addEventListener:function(e,t,i){this.eventBus.addEventListener(e,t,i),this.updating||this.eventBus.dispatchEvent({type:"updateend"})},removeEventListener:function(e,t,i){this.eventBus.removeEventListener(e,t,i)}}},c.dependencies.TextTTMLXMLMP4SourceBuffer.prototype={constructor:c.dependencies.TextTTMLXMLMP4SourceBuffer},c.utils.TextTrackExtensions=function(){"use strict";var e,t="",i=null;return{system:void 0,eventBus:void 0,videoModel:void 0,debug:void 0,config:void 0,setup:function(){e=window.VTTCue||window.TextTrackCue},cueEnter:function(e,t,i){this.eventBus.dispatchEvent({type:"cueEnter",data:{text:t,style:e,type:i}})},cueExit:function(e,t,i){this.eventBus.dispatchEvent({type:"cueExit",data:{text:t,style:e,type:i}})},getCurrentTextTrack:function(e){for(var t=0;t<e.textTracks.length;t++)if("hascaption"===e.textTracks[t].label)return e.textTracks[t];return null},addTextTrack:function(n,r,o,s,a){var l,d=null,u=null,c="subtitles",h=this.videoModel.getTTMLRenderingDiv();for((d=this.getCurrentTextTrack(n))?(this.cleanSubtitles(),d.default=a,"showing"!==d.mode&&"metadata"!==d.kind&&(d.mode="showing"),t=s):(h&&(i=this.system.getObject("ttmlRenderer")).initialize(h),"subtitles"===(c=null!==h?"metadata":"subtitles")&&(c=!0===this.config.getParam("TextTrackExtensions.displayModeExtern","boolean")?"metadata":"subtitles"),d=n.addTextTrack(c,"hascaption",s),t=s,d.default=a,d.mode="metadata"!==c?"showing":"hidden"),l=0;l<r.length;l+=1)u=r[l],d.addCue(new e(u.start,u.end,u.data));return d},onCueEnter:function(e){var t=this.videoModel.getTTMLRenderingDiv();"image"===e.currentTarget.type&&null===t&&this.debug.warn("[TextTrackExtensions] Rendering image subtitles without div is impossible"),t&&i.onCueEnter(e),this.cueEnter(e.currentTarget.style,e.currentTarget.text,e.currentTarget.type)},onCueExit:function(e){this.videoModel.getTTMLRenderingDiv()&&i.onCueExit(e),this.cueExit(e.currentTarget.style,e.currentTarget.text)},addCues:function(i,n){var r=0,o=null,s=null;for(r=0;r<n.length;r+=1)(o=n[r]).start<o.end&&((s=new e(o.start,o.end,o.data)).id=t,s.type=o.type,s.onenter=this.onCueEnter.bind(this),s.onexit=this.onCueExit.bind(this),s.snapToLines=!1,s.line=o.line,o.style&&(s.style=o.style),i.addCue(s))},deleteCues:function(e,t,i,n){var r,o=null,s=null,a=0;if(e&&(o=e.textTracks[0])){if("disabled"===(r=o.mode)&&(o.mode="hidden"),s=o.cues)for(a=s.length-1;a>=0;a-=1)(void 0===n||-1===n||s[a].endTime<=n)&&(void 0===i||-1===i||s[a].startTime>=i)&&o.removeCue(s[a]);o.mode=r}},cleanSubtitles:function(){this.videoModel.getTTMLRenderingDiv()&&i&&i.cleanSubtitles()}}},c.utils.VTTParser=function(){"use strict";var e=/X-TIMESTAMP-MAP=(.+)/,t=/\s*(.+?)\s*:((?:\".*?\")|.*?)(?:,|$)/g,i=/(\S*)[\s]*-->[\s]*(\S*)(.*)/g,n=/(?:\r\n|\r|\n)/gm,r=function(e){for(var t=e.split(":"),i=t.length,n=0,r=0;r<i;r++)n+=parseFloat(t[r],10)*Math.pow(60,i-r-1);return n};return{manifestModel:void 0,parse:function(o,s){var a,l,d=[],u=null,c=function(e,t){if(-1===e)return 0;var i=this.manifestModel.getValue().timestampMap;if(!i)return e.local-t.startTime;var n=(e.mpegts-i.mpegts)/9e4;return e.local-i.local-n}.call(this,function(i){var n,o,s,a,l=null,d=null;if(!(n=e.exec(i)))return-1;for(o=n[1];null!==(n=t.exec(o));)switch(s=n[1],a=n[2],s){case"MPEGTS":d=parseInt(a,10);break;case"LOCAL":l=r(a)}return null===l||null===d?-1:{local:l,mpegts:d}}(o),s),h=o.split(n);for(l=0;l<h.length;l++)0!==h[l].trim().length&&(h[l].match(i)?(null!==u&&d.push(u),a=h[l].split(i),u={type:"text",line:80,start:r(a[1])-c,end:r(a[2])-c,data:""}):null!==u&&(u.data+=(0===u.data.length?"":"\n")+h[l]));return null!==u&&d.push(u),d}}},c.rules.AbandonRequestsRule=function(){"use strict";return{debug:void 0,metricsExt:void 0,name:"AbandonRequestRule",execute:function(e,t){var i,n,r=(new Date).getTime(),o=e.streamType,s=new c.rules.SwitchRequest(c.rules.SwitchRequest.prototype.NO_CHANGE,c.rules.SwitchRequest.prototype.WEAK);if(null===e.firstByteDate||e.aborted)return this.debug.log("[AbandonRequestsRule]["+o+"] Request has already been aborted."),void t(s);i=(r-e.firstByteDate.getTime())/1e3,e.bytesLoaded<e.bytesTotal&&i>=.5*e.duration&&(n=e.bytesLoaded/i,e.bytesTotal/n>2*e.duration&&(s=new c.rules.SwitchRequest(0,c.rules.SwitchRequest.prototype.STRONG),this.debug.info("[AbandonRequestsRule]["+o+"] BW = "+(8*n/1e3).toFixed(3)+" kb/s => switch to lowest quality"))),t(s)}}},c.rules.AbandonRequestsRule.prototype={constructor:c.rules.AbandonRequestsRule},c.rules.BaseRulesCollection=function(){"use strict";var e=[],t=[];return{downloadRatioRule:void 0,insufficientBufferRule:void 0,droppedFramesRule:void 0,abandonRequestRule:void 0,getRules:function(i){switch(i){case c.rules.BaseRulesCollection.prototype.QUALITY_SWITCH_RULES:return e;case c.rules.BaseRulesCollection.prototype.ABANDON_FRAGMENT_RULES:return t;default:return null}},setup:function(){e.push(this.downloadRatioRule),e.push(this.insufficientBufferRule),e.push(this.droppedFramesRule),t.push(this.abandonRequestRule)}}},c.rules.BaseRulesCollection.prototype={constructor:c.rules.BaseRulesCollection,QUALITY_SWITCH_RULES:"qualitySwitchRules",ABANDON_FRAGMENT_RULES:"abandonFragmentRules"},c.rules.DownloadRatioRule=function(){"use strict";return{debug:void 0,manifestExt:void 0,metricsExt:void 0,manifestModel:void 0,config:void 0,name:"DownloadRatioRule",checkIndex:function(e,t,i){var n,r,o,s,a,l,d,u,h,p=this.metricsExt.getHttpRequests(t),f=null,m=[],g=c.rules.SwitchRequest.prototype.NO_CHANGE,y=0,_=c.rules.SwitchRequest.prototype.DEFAULT;if(i&&i.hasOwnProperty("type")){if(a=this.config.getParamFor(i.type,"ABR.latencyInBandwidth","boolean",!0),l=this.config.getParamFor(i.type,"ABR.switchUpRatioSafetyFactor","number",1.5),this.debug.log("[DownloadRatioRule]["+i.type+"] Checking download ratio rule... (current = "+e+")"),!t)return this.debug.log("[DownloadRatioRule]["+i.type+"] No metrics, bailing."),new c.rules.SwitchRequest;for(h=p.length-1;h>=0&&null===f;)p[h].tfinish&&p[h].trequest&&p[h].tresponse&&p[h].bytesLength>0&&(f=p[h]),h--;if(null===f)return this.debug.log("[DownloadRatioRule]["+i.type+"] No valid requests made for this stream yet, bailing."),new c.rules.SwitchRequest;if(r=(f.tfinish.getTime()-f.trequest.getTime())/1e3,n=(f.tfinish.getTime()-f.tresponse.getTime())/1e3,r<=0)return this.debug.log("[DownloadRatioRule]["+i.type+"] Don't know how long the download of the last fragment took, bailing."),new c.rules.SwitchRequest;if(null===f.mediaduration||void 0===f.mediaduration||f.mediaduration<=0||isNaN(f.mediaduration))return this.debug.log("[DownloadRatioRule]["+i.type+"] Don't know the duration of the last media fragment, bailing."),new c.rules.SwitchRequest;for(y=f.bytesLength,this.debug.log("[DownloadRatioRule]["+i.type+"] DL: "+Number(n.toFixed(3))+"s, Total: "+Number(r.toFixed(3))+"s, Length: "+y),u=1;h>=0&&u<3;){if(p[h].tfinish&&p[h].trequest&&p[h].tresponse&&p[h].bytesLength>0){var E=(p[h].tfinish.getTime()-p[h].trequest.getTime())/1e3,b=(p[h].tfinish.getTime()-p[h].tresponse.getTime())/1e3;this.debug.log("[DownloadRatioRule]["+i.type+"] DL: "+Number(b.toFixed(3))+"s, Total: "+Number(E.toFixed(3))+"s, Length: "+p[h].bytesLength),r+=E,n+=b,y+=p[h].bytesLength,u+=1}h--}if(y*=8,o=a?y/r:y/n,this.debug.log("[DownloadRatioRule]["+i.type+"] BW = "+Math.round(o/1e3)+" kb/s"),isNaN(o))return new c.rules.SwitchRequest;for(u=this.manifestExt.getRepresentationCount(i),d=this.manifestExt.getRepresentationFor(e,i),s=this.manifestExt.getBandwidth(d),h=0;h<u;h+=1)m.push(this.manifestExt.getRepresentationBandwidth(i,h));if(o<=s){for(h=e-1;h>0&&!(m[h]<=o);h-=1);return g=h,_=c.rules.SwitchRequest.prototype.WEAK,this.debug.info("[DownloadRatioRule]["+i.type+"] SwitchRequest: q="+g+"/"+(u-1)+" ("+m[g]+"), p="+_),new c.rules.SwitchRequest(g,_)}for(h=u-1;h>e&&!(o>m[h]*l);h-=1);return g=h,_=c.rules.SwitchRequest.prototype.STRONG,this.debug.info("[DownloadRatioRule]["+i.type+"] SwitchRequest: q="+g+"/"+(u-1)+" ("+m[g]+"), p="+_),new c.rules.SwitchRequest(g,_)}return new c.rules.SwitchRequest}}},c.rules.DownloadRatioRule.prototype={constructor:c.rules.DownloadRatioRule},c.rules.DroppedFramesRule=function(){"use strict";var e=null,t=-1,i=-1;return{debug:void 0,metricsExt:void 0,manifestModel:void 0,config:void 0,name:"DroppedFramesRule",checkIndex:function(n,r,o,s){var a,l=this.config.getParamFor(o.type,"ABR.droppedFramesMaxRatio","number",.3),d=this.config.getParamFor(o.type,"ABR.droppedFramesMinRatio","number",.1),u=this.metricsExt.getCurrentPlaybackQuality(r),h=c.rules.SwitchRequest.prototype.NO_CHANGE,p=c.rules.SwitchRequest.prototype.DEFAULT;return null===o?new c.rules.SwitchRequest:"video"!==o.type?new c.rules.SwitchRequest:null===u?(e=null,t=i=-1,new c.rules.SwitchRequest):"buffering"===s?(e=null,t=i=-1,new c.rules.SwitchRequest):(function(n){null!==e?n.mt-e.mt<1||(t=n.droppedFrames-e.droppedFrames,i=n.totalVideoFrames-e.totalVideoFrames,e=n):e=n}(u),-1===t?new c.rules.SwitchRequest:(a=t/i,this.debug.info("[DroppedFramesRule]["+o.type+"] DroppedFrames:"+t+", totalVideoFrames:"+i+" => ratio = "+a),a>l&&n>0?(h=n-1,p=c.rules.SwitchRequest.prototype.STRONG):a>d&&(h=n,p=c.rules.SwitchRequest.prototype.STRONG),this.debug.info("[DroppedFramesRule]["+o.type+"] SwitchRequest: q="+h+", p="+p),new c.rules.SwitchRequest(h,p)))}}},c.rules.DroppedFramesRule.prototype={constructor:c.rules.DroppedFramesRule},c.rules.InsufficientBufferRule=function(){"use strict";return{debug:void 0,manifestExt:void 0,metricsExt:void 0,manifestModel:void 0,config:void 0,isStartBuffering:{},name:"InsufficientBufferRule",checkIndex:function(e,t,i,n){var r,o,s,a,l,d,u,h=this.metricsExt.getCurrentBufferLevel(t),p=e,f=c.rules.SwitchRequest.prototype.DEFAULT;if(null===i)return new c.rules.SwitchRequest;if("buffering"===n&&(this.isStartBuffering[i.type]=!0),null===h)return new c.rules.SwitchRequest;if(this.debug.info("[InsufficientBufferRule]["+i.type+"] Checking buffer level ... (current = "+e+", buffer level = "+Math.round(100*h.level)/100+", buffering = "+this.isStartBuffering[i.type]+")"),u=this.manifestExt.getMpd(this.manifestModel.getValue())){if(r=this.config.getParamFor(i.type,"BufferController.minBufferTime","number",u.manifest.minBufferTime),o=this.config.getParamFor(i.type,"ABR.switchLowerBufferRatio","number",.25),s=this.config.getParamFor(i.type,"ABR.switchLowerBufferTime","number",o*r),a=this.config.getParamFor(i.type,"ABR.switchDownBufferRatio","number",.5),l=this.config.getParamFor(i.type,"ABR.switchDownBufferTime","number",a*r),d=this.config.getParamFor(i.type,"ABR.switchUpBufferRatio","number",.75),this.config.getParamFor(i.type,"ABR.switchUpBufferTime","number",d*r),h.level<l&&this.isStartBuffering[i.type])return new c.rules.SwitchRequest;h.level>=l&&(this.isStartBuffering[i.type]=!1);this.manifestExt.getRepresentationCount(i);return 1,h.level<=s?(p=0,f=c.rules.SwitchRequest.prototype.STRONG):h.level<=l&&(p=e>0?e-1:0,f=c.rules.SwitchRequest.prototype.DEFAULT),this.debug.info("[InsufficientBufferRule]["+i.type+"] SwitchRequest: q="+p+", p="+f),new c.rules.SwitchRequest(p,f)}return this.debug.log("[InsufficientBufferRule]["+i.type+"] Manifest not present yet"),new c.rules.SwitchRequest}}},c.rules.InsufficientBufferRule.prototype={constructor:c.rules.OInsufficientBufferRule},c.rules.LimitSwitchesRule=function(){"use strict";var e=0;return{debug:void 0,name:"LimitSwitchesRule",checkIndex:function(t,i){if(e>0)return e-=1,new c.rules.SwitchRequest(t,c.rules.SwitchRequest.prototype.STRONG);var n,r,o=!1,s=(new Date).getTime();for(r=i.RepSwitchList.length-1;r>=0;r-=1){if(n=i.RepSwitchList[r],s-n.t.getTime()>=2e4){this.debug.log("Reached time limit, bailing.");break}if(r>=10){this.debug.log("Found too many switches within validation time, force the stream to not change."),o=!0;break}}return o?(this.debug.log("Wait some time before allowing another switch."),e=5,new c.rules.SwitchRequest(t,c.rules.SwitchRequest.prototype.STRONG)):new c.rules.SwitchRequest(c.rules.SwitchRequest.prototype.NO_CHANGE,c.rules.SwitchRequest.prototype.STRONG)}}},c.rules.LimitSwitchesRule.prototype={constructor:c.rules.LimitSwitchesRule},c.rules.SwitchRequest=function(e,t){"use strict";this.quality=e,this.priority=t,void 0===this.quality&&(this.quality=999),void 0===this.priority&&(this.priority=.5)},c.rules.SwitchRequest.prototype={constructor:c.rules.SwitchRequest,NO_CHANGE:999,DEFAULT:.5,STRONG:1,WEAK:0},c.models.ProtectionModel=function(){},c.models.ProtectionModel.eventList={ENAME_NEED_KEY:"needkey",ENAME_KEY_SYSTEM_ACCESS_COMPLETE:"keySystemAccessComplete",ENAME_KEY_SYSTEM_SELECTED:"keySystemSelected",ENAME_VIDEO_ELEMENT_SELECTED:"videoElementSelected",ENAME_SERVER_CERTIFICATE_UPDATED:"serverCertificateUpdated",ENAME_KEY_MESSAGE:"keyMessage",ENAME_KEY_ADDED:"keyAdded",ENAME_KEY_ERROR:"keyError",ENAME_KEY_SESSION_CREATED:"keySessionCreated",ENAME_KEY_SESSION_REMOVED:"keySessionRemoved",ENAME_KEY_SESSION_CLOSED:"keySessionClosed",ENAME_KEY_STATUSES_CHANGED:"keyStatusesChanged",ENAME_TEARDOWN_COMPLETE:"protectionTeardownComplete"},c.vo.Error=function(e,t,i){"use strict";this.code=e||null,this.message=t||null,this.data=i||null},c.vo.Error.prototype={constructor:c.vo.Error},c.vo.Event=function(){"use strict";this.type=null,this.sender=null,this.data=null,this.error=null,this.timestamp=NaN},c.vo.Event.prototype={constructor:c.vo.Event},c.models.MetricsList=function(){"use strict";return{TcpList:[],HttpList:[],RepSwitchList:[],BufferedSwitchList:[],BufferLevel:[],PlayList:[],State:[],DroppedFrames:[],PlaybackQuality:[],VideoResolution:[],DVRInfo:[],ManifestUpdate:[]}},c.models.MetricsList.prototype={constructor:c.models.MetricsList},c.vo.Mp4Track=function(){"use strict";this.type="und",this.trackId=0,this.timescale=0,this.duration=0,this.codecs="",this.codecPrivateData="",this.bandwidth="",this.width=0,this.height=0,this.language="und",this.channels=0,this.samplingRate=0,this.contentProtection=void 0,this.samples=[],this.data=null},c.vo.Mp4Track.prototype={constructor:c.vo.Mp4Track},c.vo.Mp4Track.Sample=function(){"use strict";this.dts=0,this.cts=0,this.duration=0,this.flags=0,this.data=null,this.size=0},c.vo.Mp4Track.Sample.prototype={constructor:c.vo.Mp4Track.Sample},c.vo.SegmentRequest=function(){"use strict";this.action="download",this.startTime=NaN,this.streamType=null,this.type=null,this.duration=NaN,this.timescale=NaN,this.range=null,this.url=null,this.requestStartDate=null,this.firstByteDate=null,this.requestEndDate=null,this.deferred=null,this.quality=NaN,this.index=NaN,this.availabilityStartTime=null,this.availabilityEndTime=null,this.wallStartTime=null},c.vo.SegmentRequest.prototype={constructor:c.vo.SegmentRequest,ACTION_DOWNLOAD:"download",ACTION_COMPLETE:"complete"},c.vo.URIFragmentData=function(){"use strict";this.t=null,this.xywh=null,this.track=null,this.id=null,this.s=null},c.vo.URIFragmentData.prototype={constructor:c.vo.URIFragmentData},c.vo.metrics.BufferLevel=function(){"use strict";this.t=null,this.level=null},c.vo.metrics.BufferLevel.prototype={constructor:c.vo.metrics.BufferLevel},c.vo.metrics.BufferedSwitch=function(){"use strict";this.mt=null,this.to=null,this.lto=null},c.vo.metrics.BufferedSwitch.prototype={constructor:c.vo.metrics.BufferedSwitch},c.vo.metrics.Condition=function(){"use strict";this.isFullScreen=null,this.windowSize=null,this.droppedFrames=null,this.fps=null,this.bandwidth=null},c.vo.metrics.Condition.prototype={constructor:c.vo.metrics.Condition},c.vo.metrics.DVRInfo=function(){"use strict";this.time=null,this.range=null},c.vo.metrics.DVRInfo.prototype={constructor:c.vo.metrics.DVRInfo},c.vo.metrics.DroppedFrames=function(){"use strict";this.time=null,this.droppedFrames=null},c.vo.metrics.DroppedFrames.prototype={constructor:c.vo.metrics.DroppedFrames},c.vo.metrics.HTTPRequest=function(){"use strict";this.stream=null,this.tcpid=null,this.type=null,this.url=null,this.actualurl=null,this.range=null,this.trequest=null,this.tresponse=null,this.tfinish=null,this.responsecode=null,this.interval=null,this.mediaduration=null,this.trace=[],this.startTime=null,this.quality=null,this.bytesLength=null},c.vo.metrics.HTTPRequest.prototype={constructor:c.vo.metrics.HTTPRequest},c.vo.metrics.HTTPRequest.Trace=function(){"use strict";this.s=null,this.d=null,this.b=[]},c.vo.metrics.HTTPRequest.Trace.prototype={constructor:c.vo.metrics.HTTPRequest.Trace},c.vo.metrics.ManifestUpdate=function(){"use strict";this.streamType=null,this.type=null,this.requestTime=null,this.fetchTime=null,this.availabilityStartTime=null,this.presentationStartTime=0,this.clientTimeOffset=0,this.currentTime=null,this.buffered=null,this.latency=0,this.periodInfo=[],this.representationInfo=[]},c.vo.metrics.ManifestUpdate.PeriodInfo=function(){"use strict";this.id=null,this.index=null,this.start=null,this.duration=null},c.vo.metrics.ManifestUpdate.RepresentationInfo=function(){"use strict";this.id=null,this.index=null,this.streamType=null,this.periodIndex=null,this.presentationTimeOffset=null,this.startNumber=null,this.segmentInfoType=null},c.vo.metrics.ManifestUpdate.prototype={constructor:c.vo.metrics.ManifestUpdate},c.vo.metrics.ManifestUpdate.PeriodInfo.prototype={constructor:c.vo.metrics.ManifestUpdate.PeriodInfo},c.vo.metrics.ManifestUpdate.RepresentationInfo.prototype={constructor:c.vo.metrics.ManifestUpdate.RepresentationInfo},c.vo.metrics.PlayList=function(){"use strict";this.stream=null,this.start=null,this.mstart=null,this.starttype=null,this.trace=[]},c.vo.metrics.PlayList.Trace=function(){"use strict";this.representationid=null,this.subreplevel=null,this.start=null,this.mstart=null,this.duration=null,this.playbackspeed=null,this.stopreason=null},c.vo.metrics.PlayList.prototype={constructor:c.vo.metrics.PlayList},c.vo.metrics.PlayList.INITIAL_PLAY_START_REASON="initial_start",c.vo.metrics.PlayList.SEEK_START_REASON="seek",c.vo.metrics.PlayList.Trace.prototype={constructor:c.vo.metrics.PlayList.Trace()},c.vo.metrics.PlayList.Trace.USER_REQUEST_STOP_REASON="user_request",c.vo.metrics.PlayList.Trace.REPRESENTATION_SWITCH_STOP_REASON="representation_switch",c.vo.metrics.PlayList.Trace.END_OF_CONTENT_STOP_REASON="end_of_content",c.vo.metrics.PlayList.Trace.REBUFFERING_REASON="rebuffering",c.vo.metrics.PlaybackQuality=function(){"use strict";this.t=null,this.mt=null,this.droppedFrames=null,this.totalVideoFrames=null},c.vo.metrics.PlaybackQuality.prototype={constructor:c.vo.metrics.PlaybackQuality},c.vo.metrics.RepresentationSwitch=function(){"use strict";this.t=null,this.mt=null,this.to=null,this.lto=null},c.vo.metrics.RepresentationSwitch.prototype={constructor:c.vo.metrics.RepresentationSwitch},c.vo.metrics.Session=function(){"use strict";this.uri=null,this.loopMode=null,this.endTime=null,this.playerType=null},c.vo.metrics.Session.prototype={constructor:c.vo.metrics.Session},c.vo.metrics.State=function(){"use strict";this.t=null,this.current=null,this.position=null,this.reason=null},c.vo.metrics.State.prototype={constructor:c.vo.metrics.State},c.vo.metrics.TCPConnection=function(){"use strict";this.tcpid=null,this.dest=null,this.topen=null,this.tclose=null,this.tconnect=null},c.vo.metrics.TCPConnection.prototype={constructor:c.vo.metrics.TCPConnection},c.vo.metrics.VideoResolution=function(){"use strict";this.t=null,this.mt=null,this.width=null,this.height=null},c.vo.metrics.VideoResolution.prototype={constructor:c.vo.metrics.VideoResolution},(u=function(){"use strict";return{modules:{},dependencies:{},vo:{},di:{}}}()).dependencies.BaseURLExtensions=function(){"use strict";var e=function(e,t){for(var i,n,r,o,s,a,l,d,u,c,h=new DataView(e),p={},f=0;"sidx"!==d&&f<h.byteLength;){for(u=h.getUint32(f),f+=4,d="",o=0;o<4;o+=1)c=h.getInt8(f),d+=String.fromCharCode(c),f+=1;"moof"!==d&&"traf"!==d&&"sidx"!==d?f+=u-8:"sidx"===d&&(f-=8)}if((r=h.getUint32(f,!1)+f)>e.byteLength)throw"sidx terminates after array buffer";for(p.version=h.getUint8(f+8),f+=12,p.timescale=h.getUint32(f+4,!1),f+=8,0===p.version?(p.earliest_presentation_time=h.getUint32(f,!1),p.first_offset=h.getUint32(f+4,!1),f+=8):(p.earliest_presentation_time=g.Math.to64BitNumber(h.getUint32(f+4,!1),h.getUint32(f,!1)),p.first_offset=(h.getUint32(f+8,!1)<<32)+h.getUint32(f+12,!1),f+=16),p.first_offset+=r+(t||0),p.reference_count=h.getUint16(f+2,!1),f+=4,p.references=[],i=p.first_offset,n=p.earliest_presentation_time,o=0;o<p.reference_count;o+=1)s=(a=h.getUint32(f,!1))>>>31,a&=2147483647,l=h.getUint32(f+4,!1),f+=12,a>0&&p.references.push({size:a,type:s,offset:i,duration:l,time:n,timescale:p.timescale}),i+=a,n+=l;if(f!==r)throw"Error: final pos "+f+" differs from SIDX end "+r;return p},t=function(t,i,n){var r,o,s,a,l,d,c;for(o=[],a=0,l=(r=e.call(this,t,n).references).length;a<l;a+=1)(s=new u.vo.Segment).duration=r[a].duration,s.media=i,s.startTime=r[a].time,s.timescale=r[a].timescale,d=r[a].offset,c=r[a].offset+r[a].size-1,s.mediaRange=d+"-"+c,o.push(s);return this.debug.log("Parsed SIDX box: "+o.length+" segments."),o},i=function(e,t){var r,o,s,a,l,d,u=n.defer(),c=new DataView(e),h=0,p="",f=0,m=!1,g=this;for(g.debug.log("Searching for initialization.");"moov"!==p&&h<c.byteLength;){for(f=c.getUint32(h),h+=4,p="",s=0;s<4;s+=1)a=c.getInt8(h),p+=String.fromCharCode(a),h+=1;"ftyp"===p&&(r=h-8),"moov"===p&&(o=h-8),"moov"!==p&&(h+=f-8)}return c.byteLength-h,"moov"!==p?(g.debug.log("Loading more bytes to find initialization."),t.range.start=0,t.range.end=t.bytesLoaded+t.bytesToLoad,(l=new XMLHttpRequest).onloadend=function(){m||u.reject("Error loading initialization.")},l.onload=function(){m=!0,t.bytesLoaded=t.range.end,i.call(g,l.response).then(function(e){u.resolve(e)})},l.onerror=function(){u.reject("Error loading initialization.")},l.open("GET",g.tokenAuthentication.addTokenAsQueryArg(t.url)),l.responseType="arraybuffer",l.setRequestHeader("Range","bytes="+t.range.start+"-"+t.range.end),(l=g.tokenAuthentication.setTokenInRequestHeader(l)).send(null)):(d=(void 0===r?o:r)+"-"+(o+f-1),g.debug.log("Found the initialization.  Range: "+d),u.resolve(d)),u.promise},r=function(e,i){var o,s,a,l,d,u,h,p,f=n.defer(),m=new DataView(e),g=new XMLHttpRequest,y=0,_="",E=0,b=!0,v=!1,x=this;for(x.debug.log("Searching for SIDX box."),x.debug.log(i.bytesLoaded+" bytes loaded.");"sidx"!==_&&y<m.byteLength;){for(E=m.getUint32(y),y+=4,_="",d=0;d<4;d+=1)u=m.getInt8(y),_+=String.fromCharCode(u),y+=1;"sidx"!==_&&(y+=E-8)}if(o=m.byteLength-y,"sidx"!==_)f.reject();else if(o<E-8)x.debug.log("Found SIDX but we don't have all of it."),i.range.start=0,i.range.end=i.bytesLoaded+(E-o),g.onload=function(){g.status<200||g.status>299||(b=!1,i.bytesLoaded=i.range.end,r.call(x,g.response,i).then(function(e){f.resolve(e)}))},g.onloadend=g.onerror=function(){if(b){b=!1;var e={};e.url=i.url,e.request=g,x.errHandler.sendError(c.dependencies.ErrorHandler.prototype.DOWNLOAD_ERR_SIDX,null,e),f.reject(g)}},g.open("GET",x.tokenAuthentication.addTokenAsQueryArg(i.url)),g.responseType="arraybuffer",g.setRequestHeader("Range","bytes="+i.range.start+"-"+i.range.end),(g=x.tokenAuthentication.setTokenInRequestHeader(g)).send(null);else if(i.range.start=y-8,i.range.end=i.range.start+E,x.debug.log("Found the SIDX box.  Start: "+i.range.start+" | End: "+i.range.end),s=new ArrayBuffer(i.range.end-i.range.start),l=new Uint8Array(s),a=new Uint8Array(e,i.range.start,i.range.end-i.range.start),l.set(a),h=this.parseSIDX.call(this,s,i.range.start),null!==(p=h.references)&&void 0!==p&&p.length>0&&(v=1===p[0].type),v){x.debug.log("Initiate multiple SIDX load.");var T,S,D,I,M=[];for(T=0,S=p.length;T<S;T+=1)D=p[T].offset+"-"+(p[T].offset+p[T].size-1),M.push(this.loadSegments.call(x,i.url,D));n.all(M).then(function(e){for(I=[],T=0,S=e.length;T<S;T+=1)I=I.concat(e[T]);f.resolve(I)},function(e){f.reject(e)})}else x.debug.log("Parsing segments from SIDX."),f.resolve(t.call(x,s,i.url,i.range.start));return f.promise};return{debug:void 0,errHandler:void 0,tokenAuthentication:void 0,loadSegments:function(e,i){var o,s=n.defer(),a=new XMLHttpRequest,l=!0,d=this,u={url:e,range:{},searching:!1,bytesLoaded:0,bytesToLoad:1500,request:a};return null===i?(d.debug.log("No known range for SIDX request."),u.searching=!0,u.range.start=0,u.range.end=u.bytesToLoad):(o=i.split("-"),u.range.start=parseFloat(o[0]),u.range.end=parseFloat(o[1])),a.onload=function(){a.status<200||a.status>299||(l=!1,u.searching?(u.bytesLoaded=u.range.end,r.call(d,a.response,u).then(function(e){s.resolve(e)},function(){s.reject()})):s.resolve(t.call(d,a.response,u.url,u.range.start)))},a.onloadend=a.onerror=function(){if(l){l=!1;var e={};e.url=u.url,e.request=a,d.errHandler.sendError(c.dependencies.ErrorHandler.prototype.DOWNLOAD_ERR_SIDX,null,e),s.reject(a)}},a.open("GET",d.tokenAuthentication.addTokenAsQueryArg(u.url)),a.responseType="arraybuffer",a.setRequestHeader("Range","bytes="+u.range.start+"-"+u.range.end),(a=d.tokenAuthentication.setTokenInRequestHeader(a)).send(null),d.debug.log("Perform SIDX load: "+u.url),s.promise},loadInitialization:function(e){var t=n.defer(),r=new XMLHttpRequest,o=!0,s=this,a={url:e,range:{},searching:!1,bytesLoaded:0,bytesToLoad:1500,request:r};return s.debug.log("Start searching for initialization."),a.range.start=0,a.range.end=a.bytesToLoad,r.onload=function(){r.status<200||r.status>299||(o=!1,a.bytesLoaded=a.range.end,i.call(s,r.response,a).then(function(e){t.resolve(e)},function(){t.reject()}))},r.onloadend=r.onerror=function(){if(o){o=!1;var e={};e.url=a.url,e.request=r,s.errHandler.sendError(c.dependencies.ErrorHandler.prototype.DOWNLOAD_ERR_INIT,null,e),t.reject(r)}},r.open("GET",s.tokenAuthentication.addTokenAsQueryArg(a.url)),r.responseType="arraybuffer",r.setRequestHeader("Range","bytes="+a.range.start+"-"+a.range.end),(r=s.tokenAuthentication.setTokenInRequestHeader(r)).send(null),s.debug.log("Perform init search: "+a.url),t.promise},parseSegments:t,parseSIDX:e,findSIDX:r}},u.dependencies.BaseURLExtensions.prototype={constructor:u.dependencies.BaseURLExtensions},u.di.DashContext=function(){"use strict";return{system:void 0,setup:function(){u.di.DashContext.prototype.setup.call(this),this.system.mapClass("parser",u.dependencies.DashParser),this.system.mapClass("indexHandler",u.dependencies.DashHandler),this.system.mapClass("baseURLExt",u.dependencies.BaseURLExtensions),this.system.mapClass("fragmentExt",u.dependencies.FragmentExtensions),this.system.mapSingleton("manifestExt",u.dependencies.DashManifestExtensions),this.system.mapSingleton("metricsExt",u.dependencies.DashMetricsExtensions),this.system.mapSingleton("timelineConverter",u.dependencies.TimelineConverter)}}},u.di.DashContext.prototype=new c.di.Context,u.di.DashContext.prototype.constructor=u.di.DashContext,u.dependencies.DashHandler=function(){"use strict";var e,t,i=-1,r=null,o=function(e,t){for(;e.length<t;)e="0"+e;return e},s=function(e,t,i){for(var n,r,s,a,l=0,d=0,u=t.length,c="%0".length;;){if((l=e.indexOf("$"+t))<0)return e;if((d=e.indexOf("$",l+u))<0)return e;if((n=e.indexOf("%0",l+u))>l&&n<d)switch(r=e.charAt(d-1),s=parseInt(e.substring(n+c,d-1),10),r){case"d":case"i":case"u":a=o(i.toString(),s);break;case"x":a=o(i.toString(16),s);break;case"X":a=o(i.toString(16),s).toUpperCase();break;case"o":a=o(i.toString(8),s);break;default:return this.debug.log("Unsupported/invalid IEEE 1003.1 format identifier string in URL"),e}else a=i;e=e.substring(0,l)+a+e.substring(d+1)}},a=function(e,t){return e.representation.startNumber+t},l=function(e,t){var i=t.adaptation.period.mpd.manifest.Period_asArray[t.adaptation.period.index].AdaptationSet_asArray[t.adaptation.index].Representation_asArray[t.index].BaseURL;return e===i?e:-1!==e.indexOf("http://")||-1!==e.indexOf("https://")?e:i+e},d=function(t,i){var n,r,o=new c.vo.SegmentRequest;return n=t.adaptation.period,o.streamType=i,o.type="Initialization Segment",o.url=l(t.initialization,t),o.range=t.range,r=n.start,o.availabilityStartTime=this.timelineConverter.calcAvailabilityStartTimeFromPresentationTime(r,t.adaptation.period.mpd,e),o.availabilityEndTime=this.timelineConverter.calcAvailabilityEndTimeFromPresentationTime(r+n.duration,n.mpd,e),o.quality=t.index,o},h=function(t){var n,r=t.adaptation.period,o=!1;return e?o=!1:i<0?o=!1:i<t.availableSegmentsNumber+t.segmentStartIndex?(n=E(i,t))&&(o=n.presentationStartTime-r.start>=t.adaptation.period.duration):o=!0,o},p=function(t,i){var n,r,o,s;return r=t.segmentDuration,o=t.adaptation.period.start+i*r,s=o+r,n=new u.vo.Segment,n.representation=t,n.duration=r,n.presentationStartTime=o,n.mediaStartTime=this.timelineConverter.calcMediaTimeFromPresentationTime(n.presentationStartTime,t),n.availabilityStartTime=this.timelineConverter.calcAvailabilityStartTimeFromPresentationTime(n.presentationStartTime,t.adaptation.period.mpd,e),n.availabilityEndTime=this.timelineConverter.calcAvailabilityEndTimeFromPresentationTime(s,t.adaptation.period.mpd,e),n.wallStartTime=this.timelineConverter.calcWallTimeForSegment(n,e),n.replacementNumber=a(n,i),n.availabilityIdx=i,n},f=function(t){var n,o,s=t.adaptation.period.start,a=t.segmentDuration,l=t.adaptation.period.mpd.manifest.minBufferTime,d=t.segmentAvailabilityRange,u=NaN,c=null,h=t.segments,p=2*a,f=Math.max(2*l,10*a);return d||(d=this.timelineConverter.calcSegmentAvailabilityRange(t,e)),e&&!t.adaptation.period.mpd.isClientServerTimeSyncCompleted?(n=Math.floor(d.start/a),o=Math.floor(d.end/a),{start:n,end:o}):(u=h?(c=E(i,t))?c.presentationStartTime-s:i>0?i*a:r-s||h[0].presentationStartTime-s:i>0?i*a:e?d.end:d.start,n=Math.floor(Math.max(u-p,d.start)/a),o=Math.floor(Math.min(n+f/a,d.end/a)),{start:n,end:o})},m=function(t){var n,o,s=NaN,a=t.segments,l=Number.POSITIVE_INFINITY;if(e&&!t.adaptation.period.mpd.isClientServerTimeSyncCompleted)return{start:0,end:l};if(!e&&null!==r)return null;if(a){if(i<0)return null;s=i}else s=i>0?i:e?l:0;return n=Math.max(s-2,0),o=Math.min(s+10,l),{start:n,end:o}},g=function(t){var i,r,o=this,s=n.defer(),a=function(){(i=o.timelineConverter.calcSegmentAvailabilityRange(t,e)).end>0?s.resolve(i):(r=1e3*Math.abs(i.end),setTimeout(a,r))};return a(),s.promise},y=function(t,i,n,r,o,l,d,c){var h,p,f,m=i/r,g=Math.min(n/r,t.adaptation.period.mpd.maxSegmentDuration);return h=this.timelineConverter.calcPresentationTimeFromMediaTime(m,t),h=m,p=h+g,f=new u.vo.Segment,f.representation=t,f.duration=g,f.mediaStartTime=m,f.presentationStartTime=h,f.availabilityStartTime=t.adaptation.period.mpd.manifest.mpdLoadedTime,f.availabilityEndTime=this.timelineConverter.calcAvailabilityEndTimeFromPresentationTime(p,t.adaptation.period.mpd,e),f.wallStartTime=this.timelineConverter.calcWallTimeForSegment(f,e),f.replacementTime=c||i,f.replacementNumber=a(f,d),o=s(o,"Number",f.replacementNumber),o=s(o,"Time",f.replacementTime),f.media=o,f.mediaRange=l,f.availabilityIdx=d,f},_=function(t){var i,o,a=n.defer(),l=this;return b.call(l,t)?(i="SegmentTimeline"===t.segmentInfoType?function(e){var t,i,o,s,a,l,d,u,c,h,p,f,g,_=this,E=e.adaptation.period.mpd.manifest.Period_asArray[e.adaptation.period.index].AdaptationSet_asArray[e.adaptation.index].Representation_asArray[e.index].SegmentTemplate,b=E.SegmentTimeline,v=e.availableSegmentsNumber>0,x=[],T=0,S=-1,D=!1,I=function(t){return y.call(_,e,T,t.d,g,E.media,t.mediaRange,S,t.tManifest)};for(g=e.timescale,t=b.S_asArray,(c=m.call(_,e))?(p=c.start,f=c.end):h=_.timelineConverter.calcMediaTimeFromPresentationTime(r||0,e),o=0,s=t.length;o<s;o+=1)if(i=t[o],l=0,i.hasOwnProperty("r")&&(l=i.r),i.hasOwnProperty("t")&&(T=i.t),l<0&&(d=(u=t[o+1])&&u.hasOwnProperty("t")?u.t/g:e.adaptation.period.duration,l=Math.ceil((d-T/g)/(i.d/g))-1),D){if(v)break;S+=l+1}else for(a=0;a<=l;a+=1){if(S+=1,c){if(S>f){if(D=!0,v)break;continue}S>=p&&x.push(I.call(_,i))}else{if(x.length>10){if(D=!0,v)break;continue}T/g>=h-i.d/g&&x.push(I.call(_,i))}T+=i.d}var M,L,R=t[0];return M=void 0===R.t?0:_.timelineConverter.calcPresentationTimeFromMediaTime(R.t/g,e),L=_.timelineConverter.calcPresentationTimeFromMediaTime((T-i.d)/g,e),e.segmentAvailabilityRange={start:M,end:L},e.availableSegmentsNumber=S+1,e.segmentStartIndex=0,n.when(x)}.call(l,t):"SegmentTemplate"===t.segmentInfoType?function(t){var i,r,o,a,l=[],d=this,u=n.defer(),c=t.adaptation.period.mpd.manifest.Period_asArray[t.adaptation.period.index].AdaptationSet_asArray[t.adaptation.index].Representation_asArray[t.index].SegmentTemplate,h=t.segmentDuration,m=null,y=Math.floor(t.adaptation.period.start/h),_=null,E=null;return a=t.startNumber,g.call(d,t).then(function(n){for(t.segmentAvailabilityRange=n,m=f.call(d,t),r=m.start,o=m.end,i=r;i<=o;i+=1)(_=p.call(d,t,i-(e?y:0))).replacementTime=(a+i-1)*t.segmentDuration,E=c.media,E=s(E,"Number",_.replacementNumber),E=s(E,"Time",_.replacementTime),_.media=E,l.push(_),_=null;t.availableSegmentsNumber=y+Math.ceil((n.end-n.start)/h),t.segmentStartIndex=r,u.resolve(l)}),u.promise}.call(l,t):"SegmentList"===t.segmentInfoType?function(t){var i,r,o,s,a,l=this,d=[],u=n.defer(),c=t.adaptation.period.mpd.manifest.Period_asArray[t.adaptation.period.index].AdaptationSet_asArray[t.adaptation.index].Representation_asArray[t.index].SegmentList,h=c.SegmentURL_asArray.length,m=0,y=c.SegmentURL_asArray.length;return a=t.startNumber,g.call(l,t).then(function(n){for(e||(s=f.call(l,t),m=s.start,y=s.end),i=m;i<y;i+=1)o=c.SegmentURL_asArray[i],(r=p.call(l,t,i)).replacementTime=(a+i-1)*t.segmentDuration,r.media=o.media,r.mediaRange=o.mediaRange,r.index=o.index,r.indexRange=o.indexRange,o.duration&&(r.duration=o.duration,r.presentationStartTime=r.mediaStartTime=o.time),void 0!==o.sequenceNumber&&(r.sequenceNumber=o.sequenceNumber),void 0!==o.decryptionInfo&&(r.decryptionInfo=o.decryptionInfo),d.push(r),r=null;t.segmentAvailabilityRange=n,t.availableSegmentsNumber=h,t.segmentStartIndex=m,u.resolve(d)}),u.promise}.call(l,t):function(e){var t,i,r,o,s=this,a=e.adaptation.period.mpd.manifest.Period_asArray[e.adaptation.period.index].AdaptationSet_asArray[e.adaptation.index].Representation_asArray[e.index].BaseURL,l=n.defer(),d=[],u=0,c=null;return e.indexRange&&(c=e.indexRange),this.baseURLExt.loadSegments(a,c).then(function(n){for(i=0,r=n.length;i<r;i+=1)t=n[i],o=y.call(s,e,t.startTime,t.duration,t.timescale,t.media,t.mediaRange,u),d.push(o),o=null,u+=1;e.segmentAvailabilityRange={start:d[0].presentationStartTime,end:d[r-1].presentationStartTime},e.availableSegmentsNumber=r,e.segmentStartIndex=0,l.resolve(d)},function(){l.reject()}),l.promise}.call(l,t),n.when(i).then(function(i){if(t.segments=i,o=i.length-1,e&&isNaN(t.adaptation.period.liveEdge)){var n=l.metricsModel.getMetricsFor("stream"),r=i[o].presentationStartTime;t.adaptation.period.liveEdge=r,l.metricsModel.updateManifestUpdateInfo(l.metricsExt.getCurrentManifestUpdate(n),{presentationStartTime:r})}a.resolve(i)},function(){a.reject()}),a.promise):n.when(t.segments)},E=function(e,t){if(!t||!t.segments)return null;var i,n,r=t.segments.length;for(n=0;n<r;n+=1)if((i=t.segments[n]).availabilityIdx===e)return i;return null},b=function(e){var t,n,o,s,a=!1,l=e.segments;return l&&0!==l.length?null!==r?(s=l[0].presentationStartTime,o=l[l.length-1].presentationStartTime,a=r<s||r>o):(n=l[0].availabilityIdx,t=l[l.length-1].availabilityIdx,a=i<n||i>t):a=!0,a},v=function(e){if(null===e||void 0===e)return null;var i,n=new c.vo.SegmentRequest,r=e.representation,o=r.adaptation.period.mpd.manifest.Period_asArray[r.adaptation.period.index].AdaptationSet_asArray[r.adaptation.index].Representation_asArray[r.index].bandwidth;return i=l(e.media,r),i=s(i,"Number",e.replacementNumber),i=s(i,"Time",e.replacementTime),i=s(i,"Bandwidth",o),i=function(e,t){if(null===t||-1===e.indexOf("$RepresentationID$"))return e;var i=t.toString();return e.split("$RepresentationID$").join(i)}(i,r.id),i=function(e){return e.split("$$").join("$")}(i),n.streamType=t,n.type="Media Segment",n.url=i,n.range=e.mediaRange,n.startTime=e.presentationStartTime,n.duration=e.duration,n.timescale=r.timescale,n.availabilityStartTime=e.availabilityStartTime,n.availabilityEndTime=e.availabilityEndTime,n.wallStartTime=e.wallStartTime,n.quality=r.index,n.index=e.availabilityIdx,void 0!==e.sequenceNumber&&(n.sequenceNumber=e.sequenceNumber),void 0!==e.decryptionInfo&&(n.decryptionInfo=e.decryptionInfo),n};return{debug:void 0,baseURLExt:void 0,metricsModel:void 0,metricsExt:void 0,manifestModel:void 0,manifestExt:void 0,timelineConverter:void 0,capabilities:void 0,videoModel:void 0,getType:function(){return t},setType:function(e){t=e},getIsDynamic:function(){return e},setIsDynamic:function(t){e=t},getInitRequest:function(e){var i=n.defer(),r=null,o=null,s=this;return e?(e.initialization?(r=d.call(s,e,t),i.resolve(r)):(o=e.adaptation.period.mpd.manifest.Period_asArray[e.adaptation.period.index].AdaptationSet_asArray[e.adaptation.index].Representation_asArray[e.index].BaseURL,s.baseURLExt.loadInitialization(o).then(function(n){e.range=n,e.initialization=o,r=d.call(s,e,t),i.resolve(r)},function(e){i.reject(e)})),i.promise):n.reject("no represenation")},getSegmentRequestForTime:function(e,o){var s,a,l,d=this;return e?(r=o,i=-1,d.debug.log("[DashHandler]["+t+"] Getting the request for time: "+o),s=n.defer(),_.call(d,e).then(function(){return function(e,i){var r,o,s,a,l=null===i?null:i.segments,d=null===l?0:l.length-1,c=-1;if(this.debug.log("[DashHandler]["+t+"] getIndexForSegments for time ",e),l&&l.length>0)for(a=d;a>=0;a--){if(r=l[a],o=r.presentationStartTime,s=r.duration,e+u.dependencies.DashHandler.EPSILON>=o&&e-u.dependencies.DashHandler.EPSILON<=o+s){c=r.availabilityIdx,this.debug.log("[DashHandler]["+t+"] getIndexForSegments, idx =  ",c);break}if(-1===c&&e-u.dependencies.DashHandler.EPSILON>o+s){this.debug.log("[DashHandler]["+t+"] getIndexForSegments, (past the end) idx =  ",c),c=isNaN(i.segmentDuration)?r.availabilityIdx+1:Math.floor((e-i.adaptation.period.start)/i.segmentDuration);break}}return-1===c&&(isNaN(i.segmentDuration)?l&&l.length>0&&e<l[0].presentationStartTime?(this.debug.log("[DashHandler]["+t+"] getIndexForSegments, (before start) idx =  ",c),c=0):this.debug.log("[DashHandler]["+t+"] Couldn't figure out segment for time: "+e):(this.debug.log("[DashHandler]["+t+"] getIndexForSegments, (segment duration) idx =  ",c),c=Math.floor((e-i.adaptation.period.start)/i.segmentDuration))),n.when(c)}.call(d,o,e)},function(){s.reject()}).then(function(r){return d.debug.log("[DashHandler]["+t+"] Index for time "+o+" is "+r),i=r,n.when(h.call(d,e))}).then(function(r){var o=null;return r?((a=new c.vo.SegmentRequest).action=a.ACTION_COMPLETE,a.index=i,d.debug.log("[DashHandler]["+t+"] Signal complete."),d.debug.log(a),s.resolve(a)):(l=E(i,e),o=v.call(d,l)),n.when(o)}).then(function(e){s.resolve(e)}),s.promise):n.reject("no representation")},getNextSegmentRequest:function(e){var o,s,a,l=this;if(!e)return n.reject("no represenation");if(-1===i)throw"You must call getSegmentRequestForTime first.";return r=null,i+=1,o=n.defer(),l.debug.log("[DashHandler]["+t+"] Getting the next request => index = "+i),h.call(l,e)?((s=new c.vo.SegmentRequest).action=s.ACTION_COMPLETE,s.index=i,l.debug.log("[DashHandler]["+t+"] Signal complete."),o.resolve(s)):_.call(l,e).then(function(){var t;return a=E(i,e),t=v.call(l,a),n.when(t)}).then(function(e){o.resolve(e)}),o.promise},getNextSegmentRequestFromSN:function(e,o){var s,a,l,d,u=this;if(!e)return n.reject("no represenation");if(-1===i)throw"You must call getSegmentRequestForTime first.";return r=null,i+=1,s=n.defer(),u.debug.log("[DashHandler]["+t+"] Getting the next request => sn = "+o),_.call(u,e).then(function(){if(d=h.call(u,e))(a=new c.vo.SegmentRequest).action=a.ACTION_COMPLETE,a.index=i,u.debug.log("[DashHandler]["+t+"] Signal complete."),s.resolve(a);else if(null===(l=function(e,t){if(!t||!t.segments)return null;var i,n,r=t.segments.length;for(n=0;n<r;n+=1)if(void 0!==(i=t.segments[n]).sequenceNumber&&i.sequenceNumber===e)return n<r-1?t.segments[n+1]:null;return null}(o,e)))s.resolve(null);else{i=l.availabilityIdx;var n=v.call(u,l);s.resolve(n)}}),s.promise},getCurrentTime:function(e){var r,o,s=this,a=n.defer();return e?(o=i,_.call(s,e).then(function(i){o<0?r=s.timelineConverter.calcPresentationStartTime(e.adaptation.period):(o=o<i[0].availabilityIdx?i[0].availabilityIdx:Math.min(i[i.length-1].availabilityIdx,o),r=E(o,e).presentationStartTime,s.debug.log("[DashHandler]["+t+"] getSegmentByIndex, index = "+o+" => time = "+r)),s.debug.log("[DashHandler]["+t+"] getCurrentTime => ",r),a.resolve(r)},function(){a.reject()}),a.promise):n.reject("no represenation")},getSegmentCountForDuration:function(e,i,r){var o,s=Math.max(i-r,0),a=n.defer(),l=0;return e?(this.debug.log("[DashHandler]["+t+"] getSegmentCountForDuration"),_.call(this,e).then(function(e){o=e[0].duration,l=Math.ceil(s/o),a.resolve(l)},function(){a.resolve(0)}),a.promise):n.reject("no represenation")},updateSegmentList:function(e){var i=n.defer();return e.segments=null,this.debug.log("[DashHandler]["+t+"] updateSegmentList for representation ",e.id),_.call(this,e).then(function(t){e.segments=t,i.resolve(t)}),i.promise},getIFrameRequest:function(){},getFragmentInfoRequest:function(){}}},u.dependencies.DashHandler.EPSILON=.003,u.dependencies.DashHandler.prototype={constructor:u.dependencies.DashHandler},u.dependencies.DashManifestExtensions=function(){"use strict";this.timelineConverter=void 0},u.dependencies.DashManifestExtensions.prototype={constructor:u.dependencies.DashManifestExtensions,isInteger:Number.isInteger||function(e){return"number"==typeof e&&isFinite(e)&&Math.floor(e)===e},getIsType:function(e,t,i){"use strict";var n,r,o,s=!1;if(!e)return!1;if(void 0===e.type&&(e.type=null),e.ContentComponent_asArray)for(n=0;n<e.ContentComponent_asArray.length&&!s;n++)e.ContentComponent_asArray[n].contentType===t&&(e.type=t,s=!0);if(!s&&e.mimeType)for(n=0;n<i.length&&!s;n++)-1!==e.mimeType.indexOf(i[n])&&(e.type=t,s=!0);if(!s)for(n=0;n<e.Representation_asArray.length&&!s;n++)for(o=e.Representation_asArray[n],r=0;r<i.length&&!s;r++)-1!==o.mimeType.indexOf(i[r])&&(e.type=t,s=!0);return s},getIsVideo:function(e){return this.getIsType(e,"video",["video"])},getIsAudio:function(e){return this.getIsType(e,"audio",["audio"])},getIsText:function(e){return this.getIsType(e,"text",["vtt","ttml","application/mp4"])},getIsTextTrack:function(e){return"text/vtt"===e||"application/ttml+xml"===e||"application/ttml+xml+mp4"===e||"application/mp4"===e},getIsMain:function(){"use strict";return!1},processAdaptation:function(e){"use strict";return void 0!==e.Representation_asArray&&null!==e.Representation_asArray&&e.Representation_asArray.sort(function(e,t){return e.bandwidth-t.bandwidth}),e},getDataForId:function(e,t,i){"use strict";var n,r,o=t.Period_asArray[i].AdaptationSet_asArray;for(n=0,r=o.length;n<r;n+=1)if(o[n].hasOwnProperty("id")&&o[n].id===e)return o[n];return null},getDataForIndex:function(e,t,i){"use strict";var n;return t&&i>=0&&(n=t.Period_asArray[i].AdaptationSet_asArray)&&n.length>0&&!isNaN(e)?n[e]:[]},getIndex:function(e,t){var i,n,r,o=t.Period_asArray;for(n=0;n<o.length;n+=1)for(i=o[n].AdaptationSet_asArray,r=0;r<i.length;r+=1)if(i[r]===e)return r;return-1},getDataIndex:function(e,t,i){"use strict";var n,r,o;if(t&&i>=0)if(n=t.Period_asArray[i].AdaptationSet_asArray,e.id){for(r=0,o=n.length;r<o;r+=1)if(n[r].id&&n[r].id===e.id)return r}else{var s=JSON.stringify(e);for(r=0,o=n.length;r<o;r+=1)if(JSON.stringify(n[r])===s)return r}return-1},getVideoData:function(e,t){"use strict";var i,n;if(!e||t<0)return null;if(0===(i=e.Period_asArray[t].AdaptationSet_asArray).length)return null;for(n=0;n<i.length;n+=1)if(this.getIsVideo(i[n]))return i[n];return null},getTextDatas:function(e,t){"use strict";var i,n,r=[];if(!e||t<0)return r;if(0===(i=e.Period_asArray[t].AdaptationSet_asArray).length)return r;for(n=0;n<i.length;n+=1)this.getIsText(i[n])&&r.push(i[n]);return r},getAudioDatas:function(e,t){"use strict";var i,n,r=[];if(!e||t<0)return r;if(0===(i=e.Period_asArray[t].AdaptationSet_asArray).length)return r;for(n=0;n<i.length;n+=1)this.getIsAudio(i[n])&&r.push(i[n]);return r},getSpecificAudioData:function(e,t,i){"use strict";var n,r;if(!e||t<0)return null;if(0===(r=this.getAudioDatas(e,t)).length)return null;for(n=0;n<r.length;n+=1)if(r[n].lang===i)return this.processAdaptation(r[n]);return this.processAdaptation(r[0])},getSpecificTextData:function(e,t,i){"use strict";var n,r;if(!e||t<0)return null;if(0===(r=this.getTextDatas(e,t)).length)return null;for(n=0;n<r.length;n+=1)if(r[n].lang===i)return this.processAdaptation(r[n]);return this.processAdaptation(r[0])},getCodec:function(e){"use strict";for(var t,i=0,n=null;null===n&&i<e.Representation_asArray.length;)t=e.Representation_asArray[i],n=this.getCodecForRepresentation(t),i++;return n},getCodecForRepresentation:function(e){"use strict";return null===e.codecs||""===e.codecs?null:e.mimeType+';codecs="'+e.codecs+'"'},getMimeType:function(e){"use strict";return e.Representation_asArray[0].mimeType},getKID:function(e){"use strict";return e&&e.hasOwnProperty("cenc:default_KID")?e["cenc:default_KID"]:null},getContentProtectionData:function(e){"use strict";return e&&e.hasOwnProperty("ContentProtection_asArray")&&0!==e.ContentProtection_asArray.length?e.ContentProtection_asArray:null},getIsDynamic:function(e){"use strict";var t=!1;return e&&e.hasOwnProperty("type")&&(t="dynamic"===e.type),t},getIsDVR:function(e){"use strict";var t,i=this.getIsDynamic(e);return t=!isNaN(e.timeShiftBufferDepth),i&&t},getIsOnDemand:function(e){"use strict";var t=!1;return e.profiles&&e.profiles.length>0&&(t=-1!==e.profiles.indexOf("urn:mpeg:dash:profile:isoff-on-demand:2011")),t},getIsStartOver:function(e){"use strict";var t=!1;return e&&e.hasOwnProperty("startOver")&&(t=!0===e.startOver),t},getDuration:function(e){return e&&e.hasOwnProperty("mediaPresentationDuration")?e.mediaPresentationDuration:Number.POSITIVE_INFINITY},getBandwidth:function(e){"use strict";return e&&e.bandwidth?e.bandwidth:NaN},getRefreshDelay:function(e){"use strict";var t=NaN;return e.hasOwnProperty("minimumUpdatePeriod")&&(t=Math.max(parseFloat(e.minimumUpdatePeriod),2)),t},getRepresentationCount:function(e){"use strict";return e?e.Representation_asArray.length:null},getRepresentationFor:function(e,t){"use strict";return t&&t.Representation_asArray&&t.Representation_asArray.length>0&&this.isInteger(e)&&e<t.Representation_asArray.length?t.Representation_asArray[e]:null},getRepresentationsForAdaptation:function(e,t){var i,n,r,o,s,a=[];if(e&&t){i=this.processAdaptation(e.Period_asArray[t.period.index].AdaptationSet_asArray[t.index]);for(var l=0;l<i.Representation_asArray.length;l+=1)s=i.Representation_asArray[l],(n=new u.vo.Representation).index=l,n.adaptation=t,s.hasOwnProperty("id")&&(n.id=s.id),s.hasOwnProperty("SegmentBase")?(o=s.SegmentBase,n.segmentInfoType="SegmentBase"):s.hasOwnProperty("SegmentList")?(o=s.SegmentList,n.segmentInfoType="SegmentList",n.useCalculatedLiveEdgeTime=!0):s.hasOwnProperty("SegmentTemplate")?((o=s.SegmentTemplate).hasOwnProperty("SegmentTimeline")?n.segmentInfoType="SegmentTimeline":n.segmentInfoType="SegmentTemplate",o.hasOwnProperty("initialization")&&(n.initialization=o.initialization.split("$Bandwidth$").join(s.bandwidth).split("$RepresentationID$").join(s.id))):(o=s.BaseURL,n.segmentInfoType="BaseURL"),o.hasOwnProperty("Initialization")?(r=o.Initialization).hasOwnProperty("sourceURL")?n.initialization=r.sourceURL:r.hasOwnProperty("range")&&(n.initialization=s.BaseURL,n.range=r.range):s.hasOwnProperty("mimeType")&&this.getIsTextTrack(s.mimeType)&&!n.initialization&&(n.initialization=s.BaseURL,n.range=0),o.hasOwnProperty("timescale")&&(n.timescale=o.timescale),o.hasOwnProperty("duration")&&(n.segmentDuration=o.duration/n.timescale),o.hasOwnProperty("startNumber")&&(n.startNumber=o.startNumber),o.hasOwnProperty("indexRange")&&(n.indexRange=o.indexRange),o.hasOwnProperty("presentationTimeOffset")&&(n.presentationTimeOffset=o.presentationTimeOffset/n.timescale),n.MSETimeOffset=this.timelineConverter.calcMSETimeOffset(n),a.push(n)}return a},getAdaptationsForPeriod:function(e,t){var i,n=null===e?null:e.Period_asArray[t.index],r=[];if(n)for(var o=0;o<n.AdaptationSet_asArray.length;o+=1)(i=new u.vo.AdaptationSet).index=o,i.period=t,r.push(i);return r},getRegularPeriods:function(e,t){var i,n,r=[],o=this.getIsDynamic(e),s=null,a=null,l=null,d=null;for(i=0,n=e.Period_asArray.length;i<n;i+=1)(a=e.Period_asArray[i]).hasOwnProperty("start")?(d=new u.vo.Period).start=a.start:null!==s&&a.hasOwnProperty("duration")?((d=new u.vo.Period).start=l.start+l.duration,d.duration=a.duration):0!==i||o||((d=new u.vo.Period).start=0),null!==l&&isNaN(l.duration)&&(l.duration=d.start-l.start),null!==d&&a.hasOwnProperty("id")&&(d.id=a.id),null!==d&&a.hasOwnProperty("duration")&&(d.duration=a.duration),null!==d&&(d.index=i,d.mpd=t,r.push(d)),s=a,a=null,l=d,d=null;return 0===r.length?r:(t.checkTime=this.getCheckTime(e,r[0]),null!==l&&isNaN(l.duration)&&(l.duration=this.getEndTimeForLastPeriod(t)-l.start),r)},getMpd:function(e){var t=new u.vo.Mpd;return e?(t.manifest=e,e.hasOwnProperty("availabilityStartTime")?t.availabilityStartTime=new Date(e.availabilityStartTime.getTime()):t.availabilityStartTime=new Date(e.mpdLoadedTime.getTime()),e.hasOwnProperty("availabilityEndTime")&&(t.availabilityEndTime=new Date(e.availabilityEndTime.getTime())),e.hasOwnProperty("suggestedPresentationDelay")&&(t.suggestedPresentationDelay=e.suggestedPresentationDelay),e.hasOwnProperty("timeShiftBufferDepth")&&(t.timeShiftBufferDepth=e.timeShiftBufferDepth),e.hasOwnProperty("maxSegmentDuration")&&(t.maxSegmentDuration=e.maxSegmentDuration),t):null},getFetchTime:function(e,t){return this.timelineConverter.calcPresentationTimeFromWallTime(e.mpdLoadedTime,t)},getCheckTime:function(e,t){var i=NaN;return e.hasOwnProperty("minimumUpdatePeriod")&&(i=this.getFetchTime(e,t)+e.minimumUpdatePeriod),i},getEndTimeForLastPeriod:function(e){var t;if(e.manifest.mediaPresentationDuration)t=e.manifest.mediaPresentationDuration;else{if(isNaN(e.checkTime))return new Error("Must have @mediaPresentationDuration or @minimumUpdatePeriod on MPD or an explicit @duration on the last period.");t=e.checkTime}return t},getEventsForPeriod:function(e,t){var i=null===e?null:e.Period_asArray,n=null===i?null:i[t.index].EventStream_asArray,r=[];if(n)for(var o=0;o<n.length;o+=1){var s=new u.vo.EventStream;if(s.period=t,s.timescale=1,!n[o].hasOwnProperty("schemeIdUri"))throw"Invalid EventStream. SchemeIdUri has to be set";s.schemeIdUri=n[o].schemeIdUri,n[o].hasOwnProperty("timescale")&&(s.timescale=n[o].timescale),n[o].hasOwnProperty("value")&&(s.value=n[o].value);for(var a=0;a<n[o].Event_asArray.length;a+=1){var l=new u.vo.Event;l.presentationTime=0,l.eventStream=s,n[o].Event_asArray[a].hasOwnProperty("presentationTime")&&(l.presentationTime=n[o].Event_asArray[a].presentationTime),n[o].Event_asArray[a].hasOwnProperty("duration")&&(l.duration=n[o].Event_asArray[a].duration),n[o].Event_asArray[a].hasOwnProperty("id")&&(l.id=n[o].Event_asArray[a].id),r.push(l)}}return r},getEventStreamForAdaptationSet:function(e){var t,i=[];if(e&&(t=e.InbandEventStream_asArray))for(var n=0;n<t.length;n+=1){var r=new u.vo.EventStream;if(r.timescale=1,!t[n].hasOwnProperty("schemeIdUri"))throw"Invalid EventStream. SchemeIdUri has to be set";r.schemeIdUri=t[n].schemeIdUri,t[n].hasOwnProperty("timescale")&&(r.timescale=t[n].timescale),t[n].hasOwnProperty("value")&&(r.value=t[n].value),i.push(r)}return i},getEventStreamForRepresentation:function(e,t){var i,n=[];if(e&&t&&(i=e.Representation_asArray[t.index].InbandEventStream_asArray))for(var r=0;r<i.length;r++){var o=new u.vo.EventStream;if(o.timescale=1,o.representation=t,!i[r].hasOwnProperty("schemeIdUri"))throw"Invalid EventStream. SchemeIdUri has to be set";o.schemeIdUri=i[r].schemeIdUri,i[r].hasOwnProperty("timescale")&&(o.timescale=i[r].timescale),i[r].hasOwnProperty("value")&&(o.value=i[r].value),n.push(o)}return n},getRepresentationBandwidth:function(e,t){return this.getBandwidth(this.getRepresentationFor(t,e))}},u.dependencies.DashMetricsExtensions=function(){"use strict";var e=function(e,t){var i=!1;return"video"===t?(this.manifestExt.getIsVideo(e),"video"===e.type&&(i=!0)):"audio"===t?(this.manifestExt.getIsAudio(e),"audio"===e.type&&(i=!0)):i=!1,i};return{manifestModel:void 0,manifestExt:void 0,getBandwidthForRepresentation:function(e){var t,i=this.manifestModel.getValue(),n=null===i?null:i.Period_asArray;return n?null===(t=function(e,t){var i,n,r,o,s,a;for(o=0;o<e.length;o+=1)for(i=e[o].AdaptationSet_asArray,s=0;s<i.length;s+=1)for(r=i[s].Representation_asArray,a=0;a<r.length;a+=1)if(n=r[a],t===n.id)return n;return null}.call(this,n,e))?null:t.bandwidth:null},getIndexForRepresentation:function(e){var t=this.manifestModel.getValue(),i=null===t?null:t.Period_asArray;return i?function(e,t){var i,n,r,o,s,a;for(o=0;o<e.length;o+=1)for(i=e[o].AdaptationSet_asArray,s=0;s<i.length;s+=1)for(r=i[s].Representation_asArray,a=0;a<r.length;a+=1)if(n=r[a],t===n.id)return a;return-1}.call(this,i,e):null},getMaxIndexForBufferType:function(t){var i=this.manifestModel.getValue(),n=null===i?null:i.Period_asArray;return n?function(t,i){var n,r,o,s,a;for(s=0;s<t.length;s+=1)for(r=t[s].AdaptationSet_asArray,a=0;a<r.length;a+=1)if(n=r[a],o=n.Representation_asArray,e.call(this,n,i))return o.length;return-1}.call(this,n,t):null},getCurrentRepresentationSwitch:function(e){if(null===e)return null;var t,i,n=e.RepSwitchList;return null===n||n.length<=0?null:(t=n.length,i=t-1,n[i])},getCurrentBufferLevel:function(e){if(null===e)return null;var t,i,n=e.BufferLevel;return null===n||n.length<=0?null:(t=n.length,i=t-1,n[i])},getCurrentHttpRequest:function(e){if(null===e)return null;var t,i=e.HttpList,n=null;if(null===i||i.length<=0)return null;for(t=i.length-1;t>=0;){if(null!==i[t].responsecode){n=i[t];break}t-=1}return n},getHttpRequests:function(e){return null===e?[]:e.HttpList?e.HttpList:[]},getCurrentDroppedFrames:function(e){if(null===e)return null;var t,i,n=e.DroppedFrames;return null===n||n.length<=0?null:(t=n.length,i=t-1,n[i])},getCurrentPlaybackQuality:function(e){if(null===e)return null;var t=e.PlaybackQuality;return null===t||t.length<=0?null:t[t.length-1]},getCurrentDVRInfo:function(e){if(null===e)return null;var t,i=e.DVRInfo;return null===i||i.length<=0?null:(t=i.length-1,i[t])},getCurrentManifestUpdate:function(e){if(null===e)return null;var t,i,n=e.ManifestUpdate;return null===n||n.length<=0?null:(t=n.length,i=t-1,n[i])}}},u.dependencies.DashMetricsExtensions.prototype={constructor:u.dependencies.DashMetricsExtensions},u.dependencies.DashParser=function(){"use strict";var t=/^P(([\d.]*)Y)?(([\d.]*)M)?(([\d.]*)D)?T?(([\d.]*)H)?(([\d.]*)M)?(([\d.]*)S)?/,r=/^([0-9]{4})-([0-9]{2})-([0-9]{2})T([0-9]{2}):([0-9]{2})(?::([0-9]*)(\.[0-9]*)?)?(?:([+-])([0-9]{2})([0-9]{2}))?/,o=/^[-+]?[0-9]+[.]?[0-9]*([eE][-+]?[0-9]+)?$/,s=[{type:"duration",test:function(e){return t.test(e)},converter:function(e){var i=t.exec(e);return 31536e3*parseFloat(i[2]||0)+2592e3*parseFloat(i[4]||0)+86400*parseFloat(i[6]||0)+3600*parseFloat(i[8]||0)+60*parseFloat(i[10]||0)+parseFloat(i[12]||0)}},{type:"datetime",test:function(e){return r.test(e)},converter:function(e){var t,i=r.exec(e);if(t=Date.UTC(parseInt(i[1],10),parseInt(i[2],10)-1,parseInt(i[3],10),parseInt(i[4],10),parseInt(i[5],10),i[6]&&parseInt(i[6],10)||0,i[7]&&1e3*parseFloat(i[7])||0),i[9]&&i[10]){var n=60*parseInt(i[9],10)+parseInt(i[10],10);t+=("+"===i[8]?-1:1)*n*60*1e3}return new Date(t)}},{type:"numeric",test:function(e){return o.test(e)},converter:function(e){return parseFloat(e)}}];return{debug:void 0,parse:function(t,r){var o,a=new e(s,"",!0),l=new function(e){var t;for(t=[],i=0,len=e.length;i<len;i+=1)e[i].isRoot?t.push("root"):t.push(e[i].name);var n=function(e,t){var i;if(null!==e&&null!==t)for(i in e)e.hasOwnProperty(i)&&(t.hasOwnProperty(i)||(t[i]=e[i]))},r=function(e,t,i){var r,o,s,a,l;if(null!==e&&0!==e.length)for(r=0,o=e.length;r<o;r+=1)s=e[r],t.hasOwnProperty(s.name)&&(i.hasOwnProperty(s.name)?s.merge&&(a=t[s.name],l=i[s.name],"object"==typeof a&&"object"==typeof l?n(a,l):null!=s.mergeFunction?i[s.name]=s.mergeFunction(a,l):i[s.name]=a+l):i[s.name]=t[s.name])},o=function(e,t){var i,n,s,a,l,d,u,c=e;if(null!==c.children&&0!==c.children.length)for(i=0,n=c.children.length;i<n;i+=1)if(d=c.children[i],t.hasOwnProperty(d.name))if(d.isArray)for(s=0,a=(l=t[d.name+"_asArray"]).length;s<a;s+=1)u=l[s],r(c.properties,t,u),o(d,u);else u=t[d.name],r(c.properties,t,u),o(d,u)},s=function(i){var n,r,a,l,d,u,c;if(null===i)return i;if("object"!=typeof i)return i;for(n=0,r=t.length;n<r;n+=1)"root"===t[n]&&(d=e[n],o(d,u=i));for(l in i)if(i.hasOwnProperty(l)){if(-1!==(a=t.indexOf(l)))if((d=e[a]).isArray)for(n=0,r=(c=i[l+"_asArray"]).length;n<r;n+=1)u=c[n],o(d,u);else u=i[l],o(d,u);s(i[l])}return i};return{run:s}}(function(){var e=[];return e.push(function(){var e,t,i,n;return n=[{name:"profiles",merge:!1},{name:"width",merge:!1},{name:"height",merge:!1},{name:"sar",merge:!1},{name:"frameRate",merge:!1},{name:"audioSamplingRate",merge:!1},{name:"mimeType",merge:!1},{name:"segmentProfiles",merge:!1},{name:"codecs",merge:!1},{name:"maximumSAPPeriod",merge:!1},{name:"startsWithSap",merge:!1},{name:"maxPlayoutRate",merge:!1},{name:"codingDependency",merge:!1},{name:"scanType",merge:!1},{name:"FramePacking",merge:!0},{name:"AudioChannelConfiguration",merge:!0},{name:"ContentProtection",merge:!0}],e={},e.name="AdaptationSet",e.isRoot=!1,e.isArray=!0,e.parent=null,e.children=[],e.properties=n,t={},t.name="Representation",t.isRoot=!1,t.isArray=!0,t.parent=e,t.children=[],t.properties=n,e.children.push(t),i={},i.name="SubRepresentation",i.isRoot=!1,i.isArray=!0,i.parent=t,i.children=[],i.properties=n,t.children.push(i),e}()),e.push(function(){var e,t,i,n;return n=[{name:"SegmentBase",merge:!0},{name:"SegmentTemplate",merge:!0},{name:"SegmentList",merge:!0}],e={},e.name="Period",e.isRoot=!1,e.isArray=!0,e.parent=null,e.children=[],e.properties=n,t={},t.name="AdaptationSet",t.isRoot=!1,t.isArray=!0,t.parent=e,t.children=[],t.properties=n,e.children.push(t),i={},i.name="Representation",i.isRoot=!1,i.isArray=!0,i.parent=t,i.children=[],i.properties=n,t.children.push(i),e}()),e.push(function(){var e,t,i,n,r;return r=[{name:"BaseURL",merge:!0,mergeFunction:function(e,t){return 0===t.indexOf("http://")?t:e+t}}],e={},e.name="mpd",e.isRoot=!0,e.isArray=!0,e.parent=null,e.children=[],e.properties=r,t={},t.name="Period",t.isRoot=!1,t.isArray=!0,t.parent=null,t.children=[],t.properties=r,e.children.push(t),i={},i.name="AdaptationSet",i.isRoot=!1,i.isArray=!0,i.parent=t,i.children=[],i.properties=r,t.children.push(i),n={},n.name="Representation",n.isRoot=!1,n.isArray=!0,n.parent=i,n.children=[],n.properties=r,i.children.push(n),e}()),e}()),d=new Date,u=null,c=null;try{o=a.xml_str2json(t),u=new Date,o.hasOwnProperty("BaseURL")?(o.BaseURL=o.BaseURL_asArray[0],0!==o.BaseURL.toString().indexOf("http")&&(o.BaseURL=r+o.BaseURL)):o.BaseURL=r,l.run(o),c=new Date,this.debug.log("Parsing complete: ( xml2json: "+(u.getTime()-d.getTime())+"ms, objectiron: "+(c.getTime()-u.getTime())+"ms, total: "+(c.getTime()-d.getTime())/1e3+"s)")}catch(e){return n.reject(null)}return n.when(o)}}},u.dependencies.DashParser.prototype={constructor:u.dependencies.DashParser},u.dependencies.FragmentExtensions=function(){"use strict";var e=function(e){for(var t,i,n,r,o,s,a=new DataView(e),l=0;"tfdt"!==r&&l<a.byteLength;){for(n=a.getUint32(l),l+=4,r="",o=0;o<4;o+=1)s=a.getInt8(l),r+=String.fromCharCode(s),l+=1;"moof"!==r&&"traf"!==r&&"tfdt"!==r&&(l+=n-8)}if(l===a.byteLength)throw"Error finding live offset.";return i=a.getUint8(l),this.debug.log("position: "+l),0===i?(l+=4,t=a.getUint32(l,!1)):(l+=n-16,t=g.Math.to64BitNumber(a.getUint32(l+4,!1),a.getUint32(l,!1))),{version:i,base_media_decode_time:t}};return{debug:void 0,loadFragment:function(t){var i,r,o,s=n.defer(),a=new XMLHttpRequest,l=!1;return i=t,a.onloadend=function(){l||(r="Error loading fragment: "+i,s.reject(r))},a.onload=function(){l=!0,o=e(a.response),s.resolve(o)},a.onerror=function(){r="Error loading fragment: "+i,s.reject(r)},a.open("GET",i),a.responseType="arraybuffer",a.send(null),s.promise},parseTFDT:e,parseSIDX:function(e){for(var t,i,r,o,s,a,l,d=new DataView(e),u=0;"sidx"!==s&&u<d.byteLength;){for(a=d.getUint32(u),u+=4,s="",o=0;o<4;o+=1)l=d.getInt8(u),s+=String.fromCharCode(l),u+=1;"moof"!==s&&"traf"!==s&&"sidx"!==s?u+=a-8:"sidx"===s&&(u-=8)}return t=d.getUint8(u+8),u+=12,i=d.getUint32(u+4,!1),u+=8,r=0===t?d.getUint32(u,!1):g.Math.to64BitNumber(d.getUint32(u+4,!1),d.getUint32(u,!1)),n.when({earliestPresentationTime:r,timescale:i})}}},u.dependencies.FragmentExtensions.prototype={constructor:u.dependencies.FragmentExtensions},u.dependencies.TimelineConverter=function(){"use strict";var e=function(e,t,i,n){return n?i&&t.timeShiftBufferDepth!==Number.POSITIVE_INFINITY?new Date(t.availabilityStartTime.getTime()+1e3*(e+t.timeShiftBufferDepth)):t.availabilityEndTime:i?new Date(t.availabilityStartTime.getTime()+1e3*e):t.availabilityStartTime},t=function(e,t){return(e.getTime()-t.mpd.availabilityStartTime.getTime())/1e3};return{system:void 0,debug:void 0,uriQueryFragModel:void 0,setup:function(){},calcAvailabilityStartTimeFromPresentationTime:function(t,i,n){return e.call(this,t,i,n)},calcAvailabilityEndTimeFromPresentationTime:function(t,i,n){return e.call(this,t,i,n,!0)},calcPresentationTimeFromWallTime:t,calcPresentationTimeFromMediaTime:function(e,t){return e-t.presentationTimeOffset},calcPresentationStartTime:function(e){var t,i="dynamic"===e.mpd.manifest.type,n=parseInt(this.uriQueryFragModel.getURIFragmentData().s,10);return i?(!isNaN(n)&&n>1262304e3&&((t=n-e.mpd.availabilityStartTime.getTime()/1e3)>e.liveEdge||t<e.liveEdge-e.mpd.timeShiftBufferDepth)&&(t=null),t=t||e.liveEdge):t=!isNaN(n)&&n<e.duration&&n>=0?n:e.start,t},calcActualPresentationTime:function(e,t,i){var n=this.calcSegmentAvailabilityRange(e,i);return t>=n.start&&t<=n.end?t:Math.max(n.end-2*e.adaptation.period.mpd.manifest.minBufferTime,n.start)},calcMediaTimeFromPresentationTime:function(e,t){return t.presentationTimeOffset+e},calcSegmentAvailabilityRange:function(e,i){var n,r,o=e.segmentDuration,s=0,a=e.adaptation.period.duration,l={start:s,end:a};return i?e.adaptation.period.mpd.isClientServerTimeSyncCompleted&&!isNaN(o)||!e.segmentAvailabilityRange?(n=e.adaptation.period.mpd.checkTime,r=t(new Date((new Date).getTime()+0),e.adaptation.period),s=Math.max(r-e.adaptation.period.mpd.timeShiftBufferDepth,0),n+=0,a=isNaN(n)?r:Math.min(n,r),l={start:s,end:a}):e.segmentAvailabilityRange:l},calcWallTimeForSegment:function(e,t){var i,n,r;return t&&(i=e.representation.adaptation.period.mpd.suggestedPresentationDelay,n=e.presentationStartTime+i,r=new Date(e.availabilityStartTime.getTime()+1e3*n)),r},calcMSETimeOffset:function(e){return-e.presentationTimeOffset}}},u.dependencies.TimelineConverter.prototype={constructor:u.dependencies.TimelineConverter},u.vo.AdaptationSet=function(){"use strict";this.period=null,this.index=-1},u.vo.AdaptationSet.prototype={constructor:u.vo.AdaptationSet},u.vo.Event=function(){"use strict";this.duration=NaN,this.presentationTime=NaN,this.id=NaN,this.messageData="",this.eventStream=null,this.presentationTimeDelta=NaN},u.vo.Event.prototype={constructor:u.vo.Event},u.vo.EventStream=function(){"use strict";this.adaptionSet=null,this.representation=null,this.period=null,this.timescale=1,this.value="",this.schemeIdUri=""},u.vo.EventStream.prototype={constructor:u.vo.EventStream},u.vo.Mpd=function(){"use strict";this.manifest=null,this.suggestedPresentationDelay=0,this.availabilityStartTime=null,this.availabilityEndTime=Number.POSITIVE_INFINITY,this.timeShiftBufferDepth=Number.POSITIVE_INFINITY,this.maxSegmentDuration=Number.POSITIVE_INFINITY,this.checkTime=NaN,this.clientServerTimeShift=0,this.isClientServerTimeSyncCompleted=!1},u.vo.Mpd.prototype={constructor:u.vo.Mpd},u.vo.Period=function(){"use strict";this.id=null,this.index=-1,this.duration=NaN,this.start=NaN,this.mpd=null,this.liveEdge=NaN},u.vo.Period.prototype={constructor:u.vo.Period},u.vo.Representation=function(){"use strict";this.id=null,this.index=-1,this.adaptation=null,this.segmentInfoType=null,this.initialization=null,this.segmentDuration=NaN,this.timescale=1,this.startNumber=1,this.indexRange=null,this.range=null,this.presentationTimeOffset=0,this.MSETimeOffset=NaN,this.segmentAvailabilityRange=null,this.availableSegmentsNumber=0},u.vo.Representation.prototype={constructor:u.vo.Representation},u.vo.Segment=function(){"use strict";this.indexRange=null,this.index=null,this.mediaRange=null,this.media=null,this.duration=NaN,this.replacementTime=null,this.replacementNumber=NaN,this.mediaStartTime=NaN,this.presentationStartTime=NaN,this.availabilityStartTime=NaN,this.availabilityEndTime=NaN,this.availabilityIdx=NaN,this.wallStartTime=NaN,this.representation=null},u.vo.Segment.prototype={constructor:u.vo.Segment},(d=function(){"use strict";return{dependencies:{}}}()).dependencies.HlsStream=function(){"use strict";var e,t,i,r,o,s,a,l,d,u,h,f,m,g,y,_,E,b,v,x,T,S={stream:{responseType:"arraybuffer",contentType:"application/octet-stream"},text:{responseType:"text",contentType:"application/x-www-form-urlencoded"}},D=!1,I=!0,M=!1,L="und",R="und",A=-1,P=function(){this.debug.info("[Stream] Pause."),this.videoModel.pause()},w=function(t){return e?e[t]:null},N=function(e,t,i){"string"==typeof t&&(t=function(e){for(var t=new ArrayBuffer(2*e.length),i=new Uint16Array(t),n=0;n<e.length;n++)i[n]=e.charCodeAt(n);return i}(t));var n=0,r=new ArrayBuffer(e.byteLength+4+t.byteLength+4+i.byteLength),o=new DataView(r),s=new Uint8Array(r,n,e.byteLength);s.set(e),n+=s.byteLength,o.setUint32(n,t.byteLength,!0),n+=4;var a=new Uint16Array(r,n,t.length);a.set(t),n+=a.byteLength,o.setUint32(n,i.byteLength,!0),n+=4;return new Uint8Array(r,n,i.byteLength).set(i),new Uint8Array(r,0,r.byteLength)},B=function(e,t){var i;"text"===t?("<ckc>"===(i=e.responseText.trim()).substr(0,5)&&"</ckc>"===i.substr(-6)&&(i=i.slice(5,-6)),i=p.decodeArray(i)):i=new Uint8Array(e.response),e.session.update(i)},F=function(e){this.debug.info("[Stream] <video> needkey event",e);var t=this.videoModel.getElement(),i=function(e){var t=String.fromCharCode.apply(null,new Uint16Array(e.buffer)).split("//");if(2!=t.length)throw"Invalid content key format";return t[1]}(e.initData),n=function(){var e=w("com.apple.fps.1_0");return e&&e.serverCertificate?p.decodeArray(e.serverCertificate):[]}(),r=N(e.initData,i,n),o=new WebKitMediaKeys("com.apple.fps.1_0");t.webkitSetMediaKeys(o);var s=t.webkitKeys.createSession("video/mp4",r);if(!s)throw"Could not create key session";s.error&&this.errHandler.sendError(c.dependencies.ErrorHandler.prototype.MEDIA_KEYMESSERR_NO_SESSION,"Failed to create key session",{code:s.error.code,systemCode:s.error.systemCode}),s.contentId=i,s.addEventListener("webkitkeymessage",v,!1),s.addEventListener("webkitkeyadded",x,!1),s.addEventListener("webkitkeyerror",T,!1)},C=function(e){this.debug.info("[Stream] keymessage event",e);var t,i=e.target,n=e.message,r=w("com.apple.fps.1_0");r&&r.laURL?(n=function(e,t,i){return"text"===t&&(i=String.fromCharCode.apply(null,i),i="spc="+p.encodeASCII(i)+"&assetId="+encodeURIComponent(e.contentId)),i}(i,t=r&&r.requestType&&"text"===r.requestType?"text":"stream",n),function(e,t,i,n){var r=this,o=!0,s=new XMLHttpRequest;s.responseType=S[t].responseType,s.session=e,s.onload=function(){this.status<200||this.status>299||200===this.status&&4===this.readyState&&(r.debug.log("[DRM] Received license response"),o=!1,B(this,t))},s.onerror=s.onloadend=function(){o?(o=!1,this.aborted||r.errHandler.sendError(c.dependencies.ErrorHandler.prototype.MEDIA_KEYMESSERR_LICENSER_ERROR,"License request failed",{url:i,status:this.status,error:this.response}),s=null):s=null},s.open("POST",i,!0),s.setRequestHeader("Content-Type",S[t].contentType),s.send(n)}.call(this,i,t,r.laURL,n)):this.errHandler.sendError(c.dependencies.ErrorHandler.prototype.MEDIA_KEYMESSERR_URL_LICENSER_UNKNOWN,"No license server URL specified")},O=function(e){this.debug.info("[Stream] keyerror event",e);var t=function(e){var t=c.dependencies.ErrorHandler.prototype.MEDIA_KEYERR,i="MediakeyError";if(e.errorCode)switch(e.errorCode.code){case 1:t=c.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_UNKNOWN,i="An unspecified error occurred. This value is used for errors that don't match any of the other codes.";break;case 2:t=c.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_CLIENT,i="The Key System could not be installed or updated.";break;case 3:t=c.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_SERVICE,i="The message passed into update indicated an error from the license service.";break;case 4:t=c.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_OUTPUT,i="There is no available output device with the required characteristics for the content protection system.";break;case 5:t=c.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_HARDWARECHANGE,i+="A hardware configuration change caused a content protection error.";break;case 6:t=c.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_DOMAIN,i="An error occurred in a multi-device domain licensing configuration. The most common error is a failure to join the domain.";break;default:t=c.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_UNKNOWN,i="An unspecified error occurred. This value is used for errors that don't match any of the other codes."}else t=c.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_UNKNOWN,i="An unspecified error occurred. This value is used for errors that don't match any of the other codes.";return e.systemCode&&(i+="  (System Code = "+e.systemCode+")"),new c.vo.protection.KeyError(t,i)}(e);this.errHandler.sendError(t.code,t.msg)};return{system:void 0,videoModel:void 0,capabilities:void 0,debug:void 0,metricsExt:void 0,errHandler:void 0,metricsModel:void 0,eventBus:void 0,notify:void 0,setup:function(){o=function(){this.debug.info("[Stream] <video> play event"),this.metricsModel.addPlayList("video",(new Date).getTime(),this.videoModel.getCurrentTime(),"play")}.bind(this),s=function(){this.debug.info("[Stream] <video> pause event"),this.metricsModel.addState("video","paused",this.videoModel.getCurrentTime()),this.metricsModel.addPlayList("video",(new Date).getTime(),this.videoModel.getCurrentTime(),"pause")}.bind(this),a=function(e){var t,i=e.target.error,n="[Stream] <video> error: ";if(-1!==i.code){switch(i.code){case 1:t=c.dependencies.ErrorHandler.prototype.MEDIA_ERR_ABORTED,n+="[HLS] The fetching process for the media resource was aborted by the user";break;case 2:t=c.dependencies.ErrorHandler.prototype.MEDIA_ERR_NETWORK,n+="[HLS] A network error has caused the user agent to stop fetching the media resource";break;case 3:t=c.dependencies.ErrorHandler.prototype.MEDIA_ERR_DECODE,n+="[HLS] An error has occurred in the decoding of the media resource";break;case 4:t=c.dependencies.ErrorHandler.prototype.MEDIA_ERR_SRC_NOT_SUPPORTED,n+="[HLS] The media could not be loaded, either because the server or network failed or because the format is not supported";break;case 5:t=c.dependencies.ErrorHandler.prototype.MEDIA_ERR_ENCRYPTED,n+="[HLS] The encrypted media stream could not be played"}M=!0,this.errHandler.sendError(t,n)}}.bind(this),l=function(){this.debug.info("[Stream] <video> seeking event: "+this.videoModel.getCurrentTime()),this.metricsModel.addState("video","seeking",this.videoModel.getCurrentTime()),this.metricsModel.addPlayList("video",(new Date).getTime(),this.getVideoModel().getCurrentTime(),c.vo.metrics.PlayList.SEEK_START_REASON)}.bind(this),d=function(){}.bind(this),m=function(){}.bind(this),g=function(){this.debug.info("[Stream] <video> ratechange event: "+this.videoModel.getPlaybackRate())}.bind(this),u=function(){this.debug.info("[Stream] <video> timeupdate event: "+this.videoModel.getCurrentTime())}.bind(this),h=function(){this.debug.info("[Stream] <video> waiting event"),this.getVideoModel().isSeeking()||this.metricsModel.addState("video","buffering",this.getVideoModel().getCurrentTime())}.bind(this),f=function(){this.debug.info("[Stream] <video> durationchange event: "+this.videoModel.getDuration())}.bind(this),i=function(){this.debug.info("[Stream] <video> loadedmetadata event"),this.metricsModel.addMetaData(),this.metricsModel.addState("video","buffering",this.getVideoModel().getCurrentTime())}.bind(this),r=function(){this.debug.info("[Stream] <video> loadeddata event"),this.setAudioLang(L),this.enableSubtitles(D)}.bind(this),y=function(){this.debug.info("[Stream] <video> canplay event"),I&&this.videoModel.play()}.bind(this),_=function(){this.debug.info("[Stream] <video> playing event"),this.metricsModel.addState("video","playing",this.getVideoModel().getCurrentTime())}.bind(this),E=function(){this.debug.info("[Stream] <video> loadstart event")}.bind(this),b=F.bind(this),v=C.bind(this),x=function(e){this.debug.info("[Stream] keyadded event",e)}.bind(this),T=O.bind(this),t=function(){this.debug.info("[Stream] <video> ended event"),this.metricsModel.addState("video","stopped",this.videoModel.getCurrentTime(),1)}.bind(this)},load:function(e){this.videoModel.setSource(e)},setVideoModel:function(e){this.videoModel=e,this.videoModel.listen("play",o),this.videoModel.listen("pause",s),this.videoModel.listen("error",a),this.videoModel.listen("seeking",l),this.videoModel.listen("seeked",d),this.videoModel.listen("timeupdate",u),this.videoModel.listen("waiting",h),this.videoModel.listen("durationchange",f),this.videoModel.listen("progress",m),this.videoModel.listen("ratechange",g),this.videoModel.listen("loadedmetadata",i),this.videoModel.listen("loadeddata",r),this.videoModel.listen("ended",t),this.videoModel.listen("canplay",y),this.videoModel.listen("playing",_),this.videoModel.listen("loadstart",E),this.videoModel.listen("webkitneedkey",b)},reset:function(){return this.debug.info("[Stream] Reset"),P.call(this),this.videoModel.unlisten("play",o),this.videoModel.unlisten("pause",s),this.videoModel.unlisten("error",a),this.videoModel.unlisten("seeking",l),this.videoModel.unlisten("seeked",d),this.videoModel.unlisten("timeupdate",u),this.videoModel.unlisten("waiting",h),this.videoModel.unlisten("durationchange",f),this.videoModel.unlisten("progress",m),this.videoModel.unlisten("ratechange",g),this.videoModel.unlisten("loadedmetadata",i),this.videoModel.unlisten("loadeddata",r),this.videoModel.unlisten("ended",t),this.videoModel.unlisten("canplay",y),this.videoModel.unlisten("playing",_),this.videoModel.unlisten("loadstart",E),this.videoModel.unlisten("webkitneedkey",b),this.debug.info("[Stream] Reset source"),this.videoModel.setSource(null),this.videoModel=null,n.when(!0)},setProtectionData:function(t){e=t},setInitialStartTime:function(e){var t=parseFloat(e);isNaN(t)||(A=t)},getAudioTracks:function(){var e=[],t=this.getVideoModel().getElement().audioTracks;if(0===t.length)return[];for(var i=0;i<t.length;i++)e.push({type:"audio",id:t[i].id,lang:t[i].language});return e},setAudioLang:function(e){this.debug.log("[Stream] Set audio lang: "+e);var t=this.getVideoModel().getElement().audioTracks;if(0!==t.length)for(var i=0;i<t.length;i++)e===t[i].language&&(t[i].enabled=!0)},setAudioTrack:function(e){this.debug.log("[Stream] Set audio track: "+e.lang);var t=this.getVideoModel().getElement().audioTracks;if(0!==t.length)for(var i=0;i<t.length;i++)e.id===t[i].id&&e.lang===t[i].language&&(t[i].enabled=!0)},getSelectedAudioTrack:function(){for(var e=this.getVideoModel().getElement().audioTracks,t=0;t<e.length;t++)if(e[t].enabled)return{type:"audio",id:e[t].id,lang:e[t].language};return null},getSubtitleTracks:function(){var e=[],t=this.getVideoModel().getElement().textTracks;if(0===t.length)return[];for(var i=0;i<t.length;i++)e.push({type:"text",id:t[i].label,lang:t[i].language});return e},enableSubtitles:function(e){D=e;var t=this.getVideoModel().getElement().textTracks;if(0!==t.length){e&&this.debug.log("[Stream] Set subtitle lang: "+R);for(var i=!1,n=0;n<t.length;n++)e&&R===t[n].language?(t[n].mode="showing",i=!0):t[n].mode="hidden";e&&!i&&(t[0].mode="showing")}},setSubtitleTrack:function(e){this.debug.log("[Stream] Set subtitle track: "+e.lang);var t=this.getVideoModel().getElement().textTracks;if(0!==t.length)for(var i=0;i<t.length;i++)e.id===t[i].label&&e.lang===t[i].language&&(t[i].mode="showing")},getSelectedSubtitleTrack:function(){for(var e=this.getVideoModel().getElement().textTracks,t=0;t<e.length;t++)if("showing"===e[t].mode)return{type:"text",id:e[t].label,lang:e[t].language};return null},initProtection:function(){},getVideoModel:function(){return this.videoModel},setAutoPlay:function(e){I=e},setDefaultAudioLang:function(e){L=e},setDefaultSubtitleLang:function(e){R=e},getAutoPlay:function(){return I},getDuration:function(){return this.videoModel.getDuration()},getStartTime:function(){return 0},getPeriodIndex:function(){return 0},getId:function(){return""},getPeriodInfo:function(){return null},getMinbufferTime:function(){return 0},getLiveDelay:function(){return-1},startEventController:function(){},resetEventController:function(){},setTrickModeSpeed:function(){},getTrickModeSpeed:function(){return-1},updateData:function(){},play:function(){},seek:function(e){},pause:P}},d.dependencies.HlsStream.prototype={constructor:d.dependencies.HlsStream},l=function(){"use strict";return{dependencies:{}}}(),c.utils.copyMethods=function(e){var t=new e;t.parent={};for(var i in t)t.parent[i]=t[i];return t.setup=function(){for(var e in this.parent)void 0===this.parent[e]&&(this.parent[e]=this[e])},t},c.utils.DOMParser=function(){"use strict";var e=null,t=null;return{getAllSpecificNodes:function(e,t){var i,n,r=0,o=[];if(e&&(n=e.querySelectorAll(t)))for(r=0;r<n.length;r++)(i=this.getAttributeValue(n[r],"xml:id"))&&(o[i]=n[r].attributes,n[r].childNodes.length>0&&(o[i].childNodes=n[r].childNodes));return o},getAttributeName:function(e,t){var i=[],n=null,r=0,o=null;if(e&&e.attributes&&(o=e.attributes))for(r=0;r<o.length;r++)(n=o[r]).value===t&&i.push(n.name);return i},getTextNodesIn:function(e){var t=[],i=0,n=null,r=null,o=null;if(e)for(n=e.childNodes,i=0;i<n.length;i++)3==(o=(r=n[i]).nodeType)?t.push(r):1!=o&&9!=o&&11!=o||(t=t.concat(this.getTextNodesIn(r)));return t},getAttributeValue:function(e,t,i){var n=null;return e&&"function"==typeof e.getAttribute&&null===(n=e.getAttribute(t))&&i&&(n=e.getAttributeNS(i,t)),n},getChildNode:function(e,t){var i,n=0;if(e&&e.childNodes)for(n=0;n<e.childNodes.length;n++){if((i=e.childNodes[n]).nodeName===t)return i;i=void 0}return i},getChildNodes:function(e,t){var i=0,n=[];if(e&&e.childNodes)for(i=0;i<e.childNodes.length;i++)e.childNodes[i].nodeName===t&&n.push(e.childNodes[i]);return n},createXmlTree:function(i){if(window.DOMParser)try{if(e||(e=new window.DOMParser),(t=e.parseFromString(i,"text/xml")).getElementsByTagName("parsererror").length>0)throw new Error("Error parsing XML")}catch(e){t=null}return t}}},c.utils.ObjectIron=function(e){var t;t=[];for(var i=0,n=e.length;i<n;i+=1)e[i].isRoot?t.push("root"):t.push(e[i].name);var r=function(e,t){var i;if(null!==e&&null!==t)for(i in e)e.hasOwnProperty(i)&&(t.hasOwnProperty(i)||(t[i]=e[i]))},o=function(e,t,i){var n,o,s,a,l;if(null!==e&&0!==e.length)for(n=0,o=e.length;n<o;n+=1)s=e[n],t.hasOwnProperty(s.name)&&(i.hasOwnProperty(s.name)?s.merge&&(a=t[s.name],l=i[s.name],"object"==typeof a&&"object"==typeof l?r(a,l):null!==s.mergeFunction?i[s.name]=s.mergeFunction(a,l):i[s.name]=a+l):i[s.name]=t[s.name])},s=function(e,t){var i,n,r,a,l,d,u,c=e;if(e.transformFunc&&(t=e.transformFunc(t)),null===c.children||0===c.children.length)return t;for(i=0,n=c.children.length;i<n;i+=1){d=c.children[i];var h=null;if(t.hasOwnProperty(d.name))if(d.isArray)for(r=0,a=(l=t[d.name+"_asArray"]).length;r<a;r+=1)u=l[r],o(c.properties,t,u),h=s(d,u),t[d.name+"_asArray"][r]=h,t[d.name][r]=h;else u=t[d.name],o(c.properties,t,u),h=s(d,u),t[d.name]=h,t[d.name+"_asArray"]=[h]}return t},a=function(i){var n,r,o,l,d,u,c;if(null===i)return i;if("object"!=typeof i)return i;for(n=0,r=t.length;n<r;n+=1)"root"===t[n]&&(d=e[n],i=s(d,u=i));for(l in i)if(i.hasOwnProperty(l)){if(-1!==(o=t.indexOf(l)))if((d=e[o]).isArray)for(n=0,r=(c=i[l+"_asArray"]).length;n<r;n+=1)u=c[n],i[l][n]=s(d,u),i[l+"_asArray"][n]=s(d,u);else u=i[l],i[l]=s(d,u),i[l+"_asArray"]=[s(d,u)];i[l]=a(i[l])}return i};return{run:a}},c.dependencies.protection.CommonEncryption={findCencContentProtection:function(e){var t,i=null,n=0;for(n=0;n<e.length;++n)"urn:mpeg:dash:mp4protection:2011"===(t=e[n]).schemeIdUri.toLowerCase()&&"cenc"===t.value.toLowerCase()&&(i=t);return i},getPSSHData:function(e){var t=8,i=new DataView(e),n=i.getUint8(t);return t+=20,n>0&&(t+=4+16*i.getUint32(t)),t+=4,e.slice(t)},getPSSHForKeySystem:function(e,t){var i=c.dependencies.protection.CommonEncryption.parsePSSHList(t);return i.hasOwnProperty(e.uuid.toLowerCase())?i[e.uuid.toLowerCase()]:null},parseInitDataFromContentProtection:function(e){return e&&"pssh"in e?p.decodeArray(e.pssh.__text).buffer:null},readBytes:function(e,t,i){var n=0,r=0;for(r=0;r<i;r++)n<<=8,n+=e[t],t++;return n},parsePSSHList:function(e){if(null===e)return[];for(var t=new DataView(e),i={},n=0;;){var r,o,s,a,l=n;if(n>=t.buffer.byteLength)break;if(r=t.getUint32(n),o=n+r,n+=4,1886614376===t.getUint32(n))if(n+=4,0===(s=t.getUint8(n))||1===s){n++,n+=3,a="";var d,u;for(d=0;d<4;d++)a+=1===(u=t.getUint8(n+d).toString(16)).length?"0"+u:u;for(n+=4,a+="-",d=0;d<2;d++)a+=1===(u=t.getUint8(n+d).toString(16)).length?"0"+u:u;for(n+=2,a+="-",d=0;d<2;d++)a+=1===(u=t.getUint8(n+d).toString(16)).length?"0"+u:u;for(n+=2,a+="-",d=0;d<2;d++)a+=1===(u=t.getUint8(n+d).toString(16)).length?"0"+u:u;for(n+=2,a+="-",d=0;d<6;d++)a+=1===(u=t.getUint8(n+d).toString(16)).length?"0"+u:u;n+=6,a=a.toLowerCase(),t.getUint32(n),n+=4,i[a]=t.buffer.slice(l,o),n=o}else n=o;else n=o}return i},getKeySystemConfigurations:function(e,t,i){var n=[],r=[];return e&&r.push(new c.vo.protection.MediaCapability(e)),t&&n.push(new c.vo.protection.MediaCapability(t)),[new c.vo.protection.KeySystemConfiguration(n,r,"optional","temporary"===i?"optional":"required",[i])]}},ArrayBuffer.isView||(ArrayBuffer.isView=function(e){return e instanceof ArrayBuffer}),ArrayBuffer.prototype.slice||(ArrayBuffer.prototype.slice=function(e,t){var i,n,r=this.byteLength;return e=0|e||0,t=void 0===t?r:0|t,e<0&&(e=Math.max(e+r,0)),t<0&&(t=Math.max(t+r,0)),0===r||e>=r||e>=t?new ArrayBuffer(0):(i=Math.min(r-e,t-e),n=new ArrayBuffer(i),new Uint8Array(n).set(new Uint8Array(this,e,i)),n)}),c.dependencies.ProtectionController=function(){"use strict";var e,t,i,n=null,r=[],o=null,s=!1,a=function(i,n){var o,s,a,l,d,u=this,h=[],p=[],f=0;if(this.keySystem){for(s=0;s<i.length;s++)if(this.keySystem===i[s].ks){o=i[s].ks.sessionType,h.push({ks:i[s].ks,configs:i[s].ks.getKeySystemConfigurations(t,e,o)}),p.push({schemeIdURI:i[s].ks.schemeIdURI,systemString:i[s].ks.systemString}),(a={})[c.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_ACCESS_COMPLETE]=function(e){u.protectionModel.unsubscribe(c.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_ACCESS_COMPLETE,a),e.error?(u.debug.log("[DRM] KeySystem Access Denied! -- "+e.error),u.eventBus.dispatchEvent({type:c.dependencies.ProtectionController.events.KEY_SYSTEM_SELECTED,error:"[DRM] KeySystem Access Denied! -- "+e.error})):(u.debug.log("[DRM] KeySystem Access Granted"),u.eventBus.dispatchEvent({type:c.dependencies.ProtectionController.events.KEY_SYSTEM_SELECTED,data:e.data}),u.createKeySession(i[s].initData,i[s].cdmData))},this.protectionModel.subscribe(c.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_ACCESS_COMPLETE,a,void 0,!0),this.protectionModel.requestKeySystemAccess(h);break}}else if(void 0===this.keySystem){for(this.keySystem=null,r.push(i),f=0;f<i.length;f++)o=i[f].ks.sessionType,h.push({ks:i[f].ks,configs:i[f].ks.getKeySystemConfigurations(t,e,o)}),p.push({schemeIdURI:i[f].ks.schemeIdURI,systemString:i[f].ks.systemString});(l={})[c.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_ACCESS_COMPLETE]=function(e){u.protectionModel&&(u.protectionModel.unsubscribe(c.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_ACCESS_COMPLETE,l),e.error?(u.debug.log("[DRM] KeySystem Access Denied! -- "+e.error),u.keySystem=void 0,u.protectionModel.unsubscribe(c.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_SELECTED,l),n||u.eventBus.dispatchEvent({type:c.dependencies.ProtectionController.events.KEY_SYSTEM_SELECTED,error:"[DRM] KeySystem Access Denied! -- "+e.error}),u.notify(c.dependencies.ProtectionController.eventList.ENAME_PROTECTION_ERROR,new c.vo.Error(c.dependencies.ErrorHandler.prototype.MEDIA_KEYSYSERR_ACCESS_DENIED,"No KeySystem/CDM available",{keySystems:p}))):(d=e.data,u.debug.log("[DRM] KeySystem Access ("+d.keySystem.systemString+") Granted!  Selecting key system..."),u.protectionModel.selectKeySystem(d)))},l[c.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_SELECTED]=function(e){if(u.protectionModel)if(u.protectionModel.unsubscribe(c.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_SELECTED,l),e.error)u.keySystem=void 0,n||u.eventBus.dispatchEvent({type:c.dependencies.ProtectionController.events.KEY_SYSTEM_SELECTED,error:"[DRM] Error selecting key system! -- "+e.error}),u.notify(c.dependencies.ProtectionController.eventList.ENAME_PROTECTION_ERROR,new c.vo.Error(c.dependencies.ErrorHandler.prototype.MEDIA_KEYSYSERR_ACCESS_DENIED,"No KeySystem/CDM available",{keySystems:p}));else for(u.debug.log("[DRM] KeySystem selected => create key session"),u.keySystem=u.protectionModel.keySystem,u.notify(c.dependencies.ProtectionController.eventList.ENAME_KEY_SYSTEM_SELECTED,d),u.eventBus.dispatchEvent({type:c.dependencies.ProtectionController.events.KEY_SYSTEM_SELECTED,data:d}),f=0;f<r.length;f++)for(s=0;s<r[f].length;s++)if(u.keySystem===r[f][s].ks){u.createKeySession(r[f][s].initData,r[f][s].cdmData);break}},this.protectionModel.subscribe(c.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_SELECTED,l,void 0,!0),this.protectionModel.subscribe(c.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_ACCESS_COMPLETE,l,void 0,!0),this.protectionModel.requestKeySystemAccess(h)}else r.push(i)},l=function(e){var t,n,r=this,s=null;t=e.data,n=t.messageType?t.messageType:"license-request",this.debug.log("[DRM] Key message: type = "+n),this.eventBus.dispatchEvent({type:c.dependencies.ProtectionController.events.KEY_MESSAGE,data:t});var a=t.message,l=t.sessionToken,d=function(e){var t=null,n=e.systemString;return i&&(t=n in i?i[n]:null),t}(this.keySystem),u=this.keySystem.systemString,h=this.protectionExt.getLicenseServer(this.keySystem,d,n),p=!0;if(a&&0!==a.byteLength)if(h){if(this.protectionExt.isClearKey(this.keySystem)){var f=this.protectionExt.processClearKeyLicenseRequest(d,a);if(f)return this.debug.log("[DRM] ClearKey license request handled by application!"),void this.protectionModel.updateKeySession(l,f)}o=new XMLHttpRequest;var m=null;if(d)if(d.serverURL){var g=d.serverURL;"string"==typeof g&&""!==g?m=g:"object"==typeof g&&g.hasOwnProperty(n)&&(m=g[n])}else d.laURL&&""!==d.laURL&&(m=d.laURL);if(null===m&&((m=this.keySystem.getLicenseServerURLFromInitData(c.dependencies.protection.CommonEncryption.getPSSHData(l.initData)))||(m=e.data.defaultURL)),m=h.getServerURLFromMessage(m,a,n),this.debug.log("[DRM] Licenser server url: "+m),m){o.open(h.getHTTPMethod(n),m,!0),o.responseType=h.getResponseType(u,n),o.onload=function(){this.status<200||this.status>299||200===this.status&&4===this.readyState&&(r.debug.log("[DRM] Received license response"),p=!1,null!==(s=h.getLicenseMessage(this.response,u,n))?(p=!1,r.protectionModel.updateKeySession(l,s)):p=!0)},o.onerror=o.onloadend=function(){p?(p=!1,this.aborted||r.notify(c.dependencies.ProtectionController.eventList.ENAME_PROTECTION_ERROR,new c.vo.Error(c.dependencies.ErrorHandler.prototype.MEDIA_KEYMESSERR_LICENSER_ERROR,"License request failed",{url:m,status:this.status,error:this.response&&null!==this.response?h.getErrorResponse(this.response):""})),o=null):o=null};var y=function(e){var t;if(e)for(t in e)"authorization"===t.toLowerCase()&&(o.withCredentials=!0),o.setRequestHeader(t,e[t])};d&&y(d.httpRequestHeaders),y(this.keySystem.getRequestHeadersFromMessage(a)),d&&d.withCredentials&&(o.withCredentials=!0),this.debug.log("[DRM] Send license request");var _=this.keySystem.getLicenseRequestFromMessage(a);null===_&&this.notify(c.dependencies.ProtectionController.eventList.ENAME_PROTECTION_ERROR,new c.vo.Error(c.dependencies.ErrorHandler.prototype.MEDIA_KEYMESSERR_NO_CHALLENGE,"No license challenge from CDM key message")),o.send(_)}else this.notify(c.dependencies.ProtectionController.eventList.ENAME_PROTECTION_ERROR,new c.vo.Error(c.dependencies.ErrorHandler.prototype.MEDIA_KEYMESSERR_URL_LICENSER_UNKNOWN,"No license server URL specified"))}else this.debug.log("[DRM] License server request not required for this message (type = "+e.data.messageType+").  Session ID = "+l.getSessionID());else this.notify(c.dependencies.ProtectionController.eventList.ENAME_PROTECTION_ERROR,new c.vo.Error(c.dependencies.ErrorHandler.prototype.MEDIA_KEYMESSERR_NO_CHALLENGE,"Empty key message from CDM"))};return{system:void 0,debug:void 0,notify:void 0,subscribe:void 0,unsubscribe:void 0,protectionExt:void 0,keySystem:void 0,setup:function(){this[c.models.ProtectionModel.eventList.ENAME_KEY_MESSAGE]=l.bind(this),this[c.models.ProtectionModel.eventList.ENAME_NEED_KEY]=function(e){var t,i;if(this.debug.log("[DRM] onNeedKey, initDataType = "+e.data.initDataType),"cenc"===e.data.initDataType){if(t=e.data.initData,ArrayBuffer.isView(t)&&(t=t.buffer),this.keySystem)for(var n=c.dependencies.protection.CommonEncryption.getPSSHForKeySystem(this.keySystem,t),r=this.protectionModel.getAllInitData(),o=0;o<r.length;o++)if(this.protectionExt.initDataEquals(n,r[o]))return void this.debug.log("[DRM] Ignoring initData because we have already seen it!");0!==(i=this.protectionExt.getSupportedKeySystems(t)).length?a.call(this,i,!1):this.debug.log("[DRM] Received needkey event with initData, but we don't support any of the key systems!")}else this.debug.log("[DRM] Only 'cenc' initData is supported!  Ignoring initData of type: "+e.data.initDataType)}.bind(this),this[c.models.ProtectionModel.eventList.ENAME_SERVER_CERTIFICATE_UPDATED]=function(e){e.error?(this.debug.error("[DRM] Failed to set license server certificate"),this.notify(c.dependencies.ProtectionController.eventList.ENAME_PROTECTION_ERROR,new c.vo.Error(c.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_SERVER_CERTIFICATE,"Failed to set server certificate",e.error))):this.debug.log("[DRM] License server certificate successfully updated")}.bind(this),this[c.models.ProtectionModel.eventList.ENAME_KEY_ADDED]=function(){this.debug.log("[DRM] Key added")}.bind(this),this[c.models.ProtectionModel.eventList.ENAME_KEY_ERROR]=function(e){this.notify(c.dependencies.ProtectionController.eventList.ENAME_PROTECTION_ERROR,new c.vo.Error(e.data.code,e.data.message,e.data.data))}.bind(this),this[c.models.ProtectionModel.eventList.ENAME_KEY_SESSION_CREATED]=function(e){e.error?(this.debug.error("[DRM] Failed to create key session"),this.notify(c.dependencies.ProtectionController.eventList.ENAME_PROTECTION_ERROR,new c.vo.Error(c.dependencies.ErrorHandler.prototype.MEDIA_KEYMESSERR_NO_SESSION,"Failed to create key session",e.error))):this.debug.log("[DRM] Session created.  SessionID = "+e.data.getSessionID())}.bind(this),this[c.models.ProtectionModel.eventList.ENAME_KEY_SESSION_CLOSED]=function(e){e.error?this.debug.warn("[DRM] Failed to close session"):this.debug.log("[DRM] Session closed. SessionID = "+e.data)}.bind(this),this[c.models.ProtectionModel.eventList.ENAME_KEY_SESSION_REMOVED]=function(e){e.error?this.debug.warn("[DRM] Failed to remove session"):this.debug.log("[DRM] Session removed. SessionID = "+e.data)}.bind(this),this[c.models.ProtectionModel.eventList.ENAME_KEY_STATUSES_CHANGED]=function(e){e.error?this.notify(c.dependencies.ProtectionController.eventList.ENAME_PROTECTION_ERROR,new c.vo.Error(e.error.code,e.error.message,e.error.data)):this.debug.log("[DRM] Key statuses changed. statuses = "+e.data)}.bind(this),n=this.protectionExt.getKeySystems(),this.protectionModel=this.system.getObject("protectionModel"),this.protectionModel.init(),this.eventBus=this.system.getObject("eventBus"),this.protectionModel.subscribe(c.models.ProtectionModel.eventList.ENAME_SERVER_CERTIFICATE_UPDATED,this),this.protectionModel.subscribe(c.models.ProtectionModel.eventList.ENAME_KEY_ADDED,this),this.protectionModel.subscribe(c.models.ProtectionModel.eventList.ENAME_KEY_ERROR,this),this.protectionModel.subscribe(c.models.ProtectionModel.eventList.ENAME_KEY_SESSION_CREATED,this),this.protectionModel.subscribe(c.models.ProtectionModel.eventList.ENAME_KEY_SESSION_CLOSED,this),this.protectionModel.subscribe(c.models.ProtectionModel.eventList.ENAME_KEY_SESSION_REMOVED,this),this.protectionModel.subscribe(c.models.ProtectionModel.eventList.ENAME_KEY_MESSAGE,this),this.protectionModel.subscribe(c.models.ProtectionModel.eventList.ENAME_KEY_STATUSES_CHANGED,this)},init:function(i,n,r){var o;s||(this.debug.log("[DRM] Initialize ProtectionController ("+r+", "+n+")"),e=n,t=r,(o=this.protectionExt.getSupportedKeySystemsFromContentProtection(i))&&o.length>0&&a.call(this,o,!0),s=!0)},addEventListener:function(e,t){this.eventBus.addEventListener(e,t)},removeEventListener:function(e,t){this.eventBus.removeEventListener(e,t)},teardown:function(){var e=this;o&&(o.aborted=!0,o.abort()),this.protectionModel.unsubscribe(c.models.ProtectionModel.eventList.ENAME_KEY_MESSAGE,this),this.protectionModel.unsubscribe(c.models.ProtectionModel.eventList.ENAME_SERVER_CERTIFICATE_UPDATED,this),this.protectionModel.unsubscribe(c.models.ProtectionModel.eventList.ENAME_KEY_ADDED,this),this.protectionModel.unsubscribe(c.models.ProtectionModel.eventList.ENAME_KEY_ERROR,this),this.protectionModel.unsubscribe(c.models.ProtectionModel.eventList.ENAME_KEY_SESSION_CREATED,this),this.protectionModel.unsubscribe(c.models.ProtectionModel.eventList.ENAME_KEY_SESSION_CLOSED,this),this.protectionModel.unsubscribe(c.models.ProtectionModel.eventList.ENAME_KEY_SESSION_REMOVED,this),this.protectionModel.unsubscribe(c.models.ProtectionModel.eventList.ENAME_KEY_MESSAGE,this),this.protectionModel.unsubscribe(c.models.ProtectionModel.eventList.ENAME_KEY_STATUSES_CHANGED,this),this.keySystem=void 0,this.setMediaElement(null).then(function(){e.protectionModel.teardown(),e.protectionModel=void 0})},createKeySession:function(e,t){var i,n=c.dependencies.protection.CommonEncryption.getPSSHForKeySystem(this.keySystem,e),r=0;if(n){for(this.debug.log("[DRM] create key session for initData:",String.fromCharCode.apply(null,new Uint8Array(n))),i=this.protectionModel.getAllInitData(),r=0;r<i.length;r++)if(this.protectionExt.initDataEquals(n,i[r]))return void this.debug.log("[DRM] Ignoring initData because we have already seen it!");try{this.protectionModel.createKeySession(n,this.keySystem.sessionType,t)}catch(e){this.notify(c.models.ProtectionModel.eventList.ENAME_KEY_SESSION_CREATED,null,{reason:"Create key session raised en exception",error:new c.vo.Error(e.code,e.name,e.message)})}}else this.notify(c.models.ProtectionModel.eventList.ENAME_KEY_SESSION_CREATED,null,{reason:"needkey/encrypted event contains no initData corresponding to that key system "+this.keySystem.systemString,error:null})},loadKeySession:function(e){this.protectionModel.loadKeySession(e)},removeKeySession:function(e){this.protectionModel.removeKeySession(e)},closeKeySession:function(e){this.protectionModel.closeKeySession(e)},setServerCertificate:function(e){this.protectionModel.setServerCertificate(e)},setMediaElement:function(e){return e?this.protectionModel.subscribe(c.models.ProtectionModel.eventList.ENAME_NEED_KEY,this):null===e&&this.protectionModel.unsubscribe(c.models.ProtectionModel.eventList.ENAME_NEED_KEY,this),this.protectionModel.setMediaElement(e)},setSessionType:function(e){this.keysystem&&(this.keySystem.sessionType=e)},setProtectionData:function(e){i=e,this.protectionExt.init(e)}}},c.dependencies.ProtectionController.events={KEY_SYSTEM_SELECTED:"keySystemSelected",SERVER_CERTIFICATE_UPDATED:"serverCertificateUpdated",KEY_ADDED:"keyAdded",KEY_SESSION_CREATED:"keySessionCreated",KEY_SESSION_REMOVED:"keySessionRemoved",KEY_SESSION_CLOSED:"keySessionClosed",KEY_STATUSES_CHANGED:"keyStatusesChanged",KEY_MESSAGE:"keyMessage",LICENSE_REQUEST_COMPLETE:"licenseRequestComplete"},c.dependencies.ProtectionController.eventList={ENAME_PROTECTION_ERROR:"protectionError",ENAME_KEY_SYSTEM_SELECTED:"keySystemSelected"},c.dependencies.ProtectionController.prototype={constructor:c.dependencies.ProtectionController},c.dependencies.ProtectionExtensions=function(){"use strict";this.system=void 0,this.debug=void 0,this.keySystems=[],this.clearkeyKeySystem=void 0},c.dependencies.ProtectionExtensions.prototype={constructor:c.dependencies.ProtectionExtensions,setup:function(){var e;e=this.system.getObject("ksPlayReady"),this.keySystems.push(e),e=this.system.getObject("ksWidevine"),this.keySystems.push(e),e=this.system.getObject("ksClearKey"),this.keySystems.push(e),this.clearkeyKeySystem=e},init:function(e){for(var t=function(t){var i=null;return e&&(i=t in e?e[t]:null),i},i=0;i<this.keySystems.length;i++){var n=this.keySystems[i];n.init(t(n.systemString))}},getKeySystems:function(){return this.keySystems},getKeySystemBySystemString:function(e){for(var t=0;t<this.keySystems.length;t++)if(this.keySystems[t].systemString===e)return this.keySystems[t];return null},isClearKey:function(e){return e===this.clearkeyKeySystem},initDataEquals:function(e,t){if(e.byteLength===t.byteLength){for(var i=new Uint8Array(e),n=new Uint8Array(t),r=0;r<i.length;r++)if(i[r]!==n[r])return!1;return!0}return!1},getSupportedKeySystemsFromContentProtection:function(e){var t,i,n,r,o=[];if(e)for(n=0;n<this.keySystems.length;++n)for(i=this.keySystems[n],r=0;r<e.length;++r)if((t=e[r]).schemeIdUri.toLowerCase()===i.schemeIdURI){var s=i.getInitData(t);s&&o.push({ks:this.keySystems[n],initData:s,cdmData:i.getCDMData()})}return o},getSupportedKeySystems:function(e){var t,i=[],n=c.dependencies.protection.CommonEncryption.parsePSSHList(e);for(this.debug.log("[DRM] Get supported key systems from init data"),t=0;t<this.keySystems.length;++t)this.keySystems[t].uuid in n&&i.push({ks:this.keySystems[t],initData:n[this.keySystems[t].uuid],cdmData:this.keySystems[t].getCDMData()});return i},getLicenseServer:function(e,t,i){if("license-release"===i||"individualization-request"==i)return null;var n=null;return t&&t.hasOwnProperty("drmtoday")?n=this.system.getObject("serverDRMToday"):"com.widevine.alpha"===e.systemString?n=this.system.getObject("serverWidevine"):"com.microsoft.playready"===e.systemString?n=this.system.getObject("serverPlayReady"):"org.w3.clearkey"===e.systemString&&(n=this.system.getObject("serverClearKey")),n},processClearKeyLicenseRequest:function(e,t){try{return c.dependencies.protection.KeySystem_ClearKey.getClearKeysFromProtectionData(e,t)}catch(e){return this.log("Failed to retrieve clearkeys from ProtectionData"),null}},autoSelectKeySystem:function(e,t,i,n){if(this.debug.log("[DRM] Auto select key system: "),this.debug.log("[DRM] ---- video codec = "+i),this.debug.log("[DRM] ---- audio codec = "+n),0===e.length)throw new Error("DRM system for this content not supported by the player!");var r=[],o=[];i&&o.push(new c.vo.protection.MediaCapability(i)),n&&r.push(new c.vo.protection.MediaCapability(n));for(var s=new c.vo.protection.KeySystemConfiguration(r,o),a=[],l=0;l<e.length;l++)a.push({ks:e[l].ks,configs:[s]});var d=this;!function(e){var t={};t[c.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_ACCESS_COMPLETE]=function(t){if(e.protectionModel.unsubscribe(c.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_ACCESS_COMPLETE,this),t.error)d.debug.log(t.error),e.notify(c.dependencies.ProtectionController.eventList.ENAME_PROTECTION_ERROR,new c.vo.Error(c.dependencies.ErrorHandler.prototype.MEDIA_KEYSYSERR_ACCESS_DENIED,"[DRM] KeySystem Access Denied! -- "+t.error,null));else{var i=t.data;d.debug.log("[DRM] KeySystem Access Granted ("+i.keySystem.systemString+")!"),e.selectKeySystem(i)}},e.protectionModel.subscribe(c.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_ACCESS_COMPLETE,t),e.requestKeySystemAccess(a)}(t)}},c.models.ProtectionModel_01b=function(){var e,t=null,i=null,r=[],o=[],s=null,a=function(e,t){if(t&&e){for(var i=e.length,n=0;n<i;n++)if(e[n].sessionID===t)return e[n];return null}return null},l=function(){t.removeEventListener(i.keyerror,s),t.removeEventListener(i.needkey,s),t.removeEventListener(i.keymessage,s),t.removeEventListener(i.keyadded,s)};return{system:void 0,log:void 0,errHandler:void 0,notify:void 0,subscribe:void 0,unsubscribe:void 0,protectionExt:void 0,keySystem:null,setup:function(){s=function(){var t=this;return{handleEvent:function(n){var s=null;switch(n.type){case i.needkey:var l=ArrayBuffer.isView(n.initData)?n.initData.buffer:n.initData;t.notify(c.models.ProtectionModel.eventList.ENAME_NEED_KEY,new c.vo.protection.NeedKey(l,"cenc"));break;case i.keyerror:if((s=a(o,n.sessionId))||(s=a(r,n.sessionId)),s){var d=c.dependencies.ErrorHandler.prototype.MEDIA_KEYERR,u="MediakeyError";switch(n.errorCode.code){case 1:d=c.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_UNKNOWN,u+="An unspecified error occurred. This value is used for errors that don't match any of the other codes.";break;case 2:d=c.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_CLIENT,u+="The Key System could not be installed or updated.";break;case 3:d=c.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_SERVICE,u+="The message passed into update indicated an error from the license service.";break;case 4:d=c.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_OUTPUT,u+="There is no available output device with the required characteristics for the content protection system.";break;case 5:d=c.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_HARDWARECHANGE,u+="A hardware configuration change caused a content protection error.";break;case 6:d=c.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_DOMAIN,u+="An error occurred in a multi-device domain licensing configuration. The most common error is a failure to join the domain."}n.systemCode&&(u+="  (System Code = "+n.systemCode+")"),t.notify(c.models.ProtectionModel.eventList.ENAME_KEY_ERROR,new c.vo.protection.KeyError(d,u))}else t.log("No session token found for key error");break;case i.keyadded:(s=a(o,n.sessionId))||(s=a(r,n.sessionId)),s?t.notify(c.models.ProtectionModel.eventList.ENAME_KEY_ADDED,s):t.log("No session token found for key added");break;case i.keymessage:if((e=null!==n.sessionId&&void 0!==n.sessionId)?!(s=a(o,n.sessionId))&&r.length>0&&(s=r.shift(),o.push(s),s.sessionID=n.sessionId):r.length>0&&(s=r.shift(),o.push(s),0!==r.length&&t.errHandler.mediaKeyMessageError("Multiple key sessions were creates with a user-agent that does not support sessionIDs!! Unpredictable behavior ahead!")),s){var h=ArrayBuffer.isView(n.message)?n.message.buffer:n.message;s.keyMessage=h,t.notify(c.models.ProtectionModel.eventList.ENAME_KEY_MESSAGE,new c.vo.protection.KeyMessage(s,h,n.defaultURL))}else t.log("No session token found for key message")}}}}.call(this)},init:function(){var e=document.createElement("video");i=c.models.ProtectionModel_01b.detect(e)},teardown:function(){t&&l();for(var e=0;e<o.length;e++)this.closeKeySession(o[e]);this.notify(c.models.ProtectionModel.eventList.ENAME_TEARDOWN_COMPLETE)},getAllInitData:function(){var e,t=[];for(e=0;e<r.length;e++)t.push(r[e].initData);for(e=0;e<o.length;e++)t.push(o[e].initData);return t},requestKeySystemAccess:function(e){var i=t;i||(i=document.createElement("video"));for(var n=!1,r=0;r<e.length;r++)for(var o=e[r].ks.systemString,s=e[r].configs,a=null,l=0;l<s.length;l++){var d=s[l].videoCapabilities;if(d&&0!==d.length){a=[];for(var u=0;u<d.length;u++)""!==i.canPlayType(d[u].contentType,o)&&a.push(d[u])}if(a&&(!a||0!==a.length)){n=!0;var h=new c.vo.protection.KeySystemConfiguration(null,a),p=this.protectionExt.getKeySystemBySystemString(o),f=new c.vo.protection.KeySystemAccess(p,h);this.notify(c.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_ACCESS_COMPLETE,f);break}}n||this.notify(c.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_ACCESS_COMPLETE,null,"Key system access denied! -- No valid audio/video content configurations detected!")},selectKeySystem:function(e){this.keySystem=e.keySystem,this.notify(c.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_SELECTED)},setMediaElement:function(e){if(t!==e)return t&&l(),(t=e)&&(t.addEventListener(i.keyerror,s),t.addEventListener(i.needkey,s),t.addEventListener(i.keymessage,s),t.addEventListener(i.keyadded,s),this.notify(c.models.ProtectionModel.eventList.ENAME_VIDEO_ELEMENT_SELECTED)),n.when()},createKeySession:function(n){if(!this.keySystem)throw new Error("Can not create sessions until you have selected a key system");if(e||0===o.length){var s={sessionID:null,initData:n,getSessionID:function(){return this.sessionID},getExpirationTime:function(){return NaN},getSessionType:function(){return"temporary"}};return r.push(s),t[i.generateKeyRequest](this.keySystem.systemString,new Uint8Array(n)),s}throw new Error("Multiple sessions not allowed!")},updateKeySession:function(e,n){var r=e.sessionID;if(this.protectionExt.isClearKey(this.keySystem))for(var o=0;o<n.keyPairs.length;o++)t[i.addKey](this.keySystem.systemString,n.keyPairs[o].key,n.keyPairs[o].keyID,r);else t[i.addKey](this.keySystem.systemString,new Uint8Array(n),e.initData,r)},closeKeySession:function(e){t[i.cancelKeyRequest](this.keySystem.systemString,e.sessionID)},setServerCertificate:function(){},loadKeySession:function(){},removeKeySession:function(){},checkIfEncrypted:function(){}}},c.models.ProtectionModel_01b.prototype={constructor:c.models.ProtectionModel_01b},c.models.ProtectionModel_01b.APIs=[{generateKeyRequest:"generateKeyRequest",addKey:"addKey",cancelKeyRequest:"cancelKeyRequest",needkey:"needkey",keyerror:"keyerror",keyadded:"keyadded",keymessage:"keymessage"},{generateKeyRequest:"webkitGenerateKeyRequest",addKey:"webkitAddKey",cancelKeyRequest:"webkitCancelKeyRequest",needkey:"webkitneedkey",keyerror:"webkitkeyerror",keyadded:"webkitkeyadded",keymessage:"webkitkeymessage"}],c.models.ProtectionModel_01b.detect=function(e){for(var t=c.models.ProtectionModel_01b.APIs,i=0;i<t.length;i++){var n=t[i];if("function"==typeof e[n.generateKeyRequest]&&("function"==typeof e[n.addKey]&&"function"==typeof e[n.cancelKeyRequest]))return n}return null},c.models.ProtectionModel_3Feb2014=function(){var e=null,t=null,i=null,r=null,o=null,s=[],a=null,l=function(){var i=function(){e.removeEventListener("loadedmetadata",r),e[o.setMediaKeys](t),this.notify(c.models.ProtectionModel.eventList.ENAME_VIDEO_ELEMENT_SELECTED)};e.readyState>=1?i.call(this):(r=i.bind(this),e.addEventListener("loadedmetadata",r))},d=function(e,t){var i=this;return{session:e,initData:t,handleEvent:function(e){switch(e.type){case o.error:i.notify(c.models.ProtectionModel.eventList.ENAME_KEY_ERROR,function(e){var t=c.dependencies.ErrorHandler.prototype.MEDIA_KEYERR,i="MediakeyError";if(e.errorCode)switch(e.errorCode.code){case 1:t=c.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_UNKNOWN,i="An unspecified error occurred. This value is used for errors that don't match any of the other codes.";break;case 2:t=c.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_CLIENT,i="The Key System could not be installed or updated.";break;case 3:t=c.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_SERVICE,i="The message passed into update indicated an error from the license service.";break;case 4:t=c.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_OUTPUT,i="There is no available output device with the required characteristics for the content protection system.";break;case 5:t=c.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_HARDWARECHANGE,i+="A hardware configuration change caused a content protection error.";break;case 6:t=c.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_DOMAIN,i="An error occurred in a multi-device domain licensing configuration. The most common error is a failure to join the domain.";break;default:t=c.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_UNKNOWN,i="An unspecified error occurred. This value is used for errors that don't match any of the other codes."}else t=c.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_UNKNOWN,i="An unspecified error occurred. This value is used for errors that don't match any of the other codes.";return e.systemCode&&(i+="  (System Code = "+e.systemCode+")"),new c.vo.protection.KeyError(t,i)}(e));break;case o.message:var t=ArrayBuffer.isView(e.message)?e.message.buffer:e.message;i.notify(c.models.ProtectionModel.eventList.ENAME_KEY_MESSAGE,new c.vo.protection.KeyMessage(this,t,e.destinationURL));break;case o.ready:i.notify(c.models.ProtectionModel.eventList.ENAME_KEY_ADDED,this);break;case o.close:i.notify(c.models.ProtectionModel.eventList.ENAME_KEY_SESSION_CLOSED,this.getSessionID())}},getSessionID:function(){return this.session.sessionId},getExpirationTime:function(){return NaN},getSessionType:function(){return"temporary"}}};return{system:void 0,notify:void 0,subscribe:void 0,unsubscribe:void 0,protectionExt:void 0,debug:void 0,keySystem:null,setup:function(){a=function(){var e=this;return{handleEvent:function(t){switch(t.type){case o.needkey:if(t.initData){var i=ArrayBuffer.isView(t.initData)?t.initData.buffer:t.initData;e.notify(c.models.ProtectionModel.eventList.ENAME_NEED_KEY,new c.vo.protection.NeedKey(i,"cenc"))}}}}}.call(this)},init:function(){var e=document.createElement("video");o=c.models.ProtectionModel_3Feb2014.detect(e)},teardown:function(){try{for(var t=0;t<s.length;t++)this.closeKeySession(s[t]);e&&e.removeEventListener(o.needkey,a),this.notify(c.models.ProtectionModel.eventList.ENAME_TEARDOWN_COMPLETE)}catch(e){this.notify(c.models.ProtectionModel.eventList.ENAME_TEARDOWN_COMPLETE,null,"Error tearing down key sessions and MediaKeys! -- "+e.message)}},getAllInitData:function(){for(var e=[],t=0;t<s.length;t++)e.push(s[t].initData);return e},requestKeySystemAccess:function(e){for(var t=!1,i=0;i<e.length;i++){var n=e[i].ks.systemString,r=e[i].configs,s=null,a=null;this.debug.log("[DRM][3Feb2014] Request access for key system "+n);for(var l=0;l<r.length;l++){var d=r[l].audioCapabilities,u=r[l].videoCapabilities;if(d&&0!==d.length){s=[];for(var h=0;h<d.length;h++)window[o.MediaKeys].isTypeSupported(n,d[h].contentType)&&s.push(d[h])}if(u&&0!==u.length){a=[];for(var p=0;p<u.length;p++)window[o.MediaKeys].isTypeSupported(n,u[p].contentType)&&a.push(u[p])}if(!(!s&&!a||s&&0===s.length||a&&0===a.length)){t=!0;var f=new c.vo.protection.KeySystemConfiguration(s,a),m=this.protectionExt.getKeySystemBySystemString(n),g=new c.vo.protection.KeySystemAccess(m,f);this.debug.log("[DRM][3Feb2014] configuration supported = audio:"+JSON.stringify(s)+", video:"+JSON.stringify(a)),this.notify(c.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_ACCESS_COMPLETE,g);break}}}t||this.notify(c.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_ACCESS_COMPLETE,null,"[DRM][3Feb2014] Key system access denied! -- No valid audio/video content configurations detected!")},selectKeySystem:function(n){this.debug.log("[DRM][3Feb2014] Select key system "+n.keySystem.systemString);try{t=n.mediaKeys=new window[o.MediaKeys](n.keySystem.systemString),this.keySystem=n.keySystem,i=n,e&&l.call(this),this.notify(c.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_SELECTED)}catch(e){this.notify(c.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_SELECTED,null,"Error selecting keys system ("+this.keySystem.systemString+")! Could not create MediaKeys -- TODO")}},setMediaElement:function(i){if(e!==i)return e&&(e.removeEventListener(o.needkey,a),e.removeEventListener("loadedmetadata",r)),(e=i)&&t&&l.call(this),n.when()},createKeySession:function(e,n,r){if(!this.keySystem||!t||!i)throw new Error("Can not create sessions until you have selected a key system");this.debug.log("[DRM][3Feb2014] Create key session");var a=i.ksConfiguration.videoCapabilities[0].contentType,l=t.createSession(a,new Uint8Array(e),r?new Uint8Array(r):null),u=d.call(this,l,e);l.addEventListener(o.error,u),l.addEventListener(o.message,u),l.addEventListener(o.ready,u),l.addEventListener(o.close,u),s.push(u),this.notify(c.models.ProtectionModel.eventList.ENAME_KEY_SESSION_CREATED,u)},updateKeySession:function(e,t){var i=e.session;this.debug.log("[DRM][3Feb2014] Update key session"),this.protectionExt.isClearKey(this.keySystem)?i.update(new Uint8Array(t.toJWK())):i.update(new Uint8Array(t))},closeKeySession:function(e){this.debug.log("[DRM][3Feb2014] Close key session, token = "+e.session.sessionId);var t=e.session;t.removeEventListener(o.error,e),t.removeEventListener(o.message,e),t.removeEventListener(o.ready,e),t.removeEventListener(o.close,e);for(var i=0;i<s.length;i++)if(s[i]===e){s.splice(i,1);break}t[o.release]()},setServerCertificate:function(){},loadKeySession:function(){},removeKeySession:function(){},checkIfEncrypted:function(){}}},c.models.ProtectionModel_3Feb2014.APIs=[{setMediaKeys:"msSetMediaKeys",MediaKeys:"MSMediaKeys",release:"close",needkey:"msneedkey",error:"mskeyerror",message:"mskeymessage",ready:"mskeyadded",close:"mskeyclose"},{setMediaKeys:"setMediaKeys",MediaKeys:"MediaKeys",release:"close",needkey:"needkey",error:"keyerror",message:"keymessage",ready:"keyadded",close:"keyclose"}],c.models.ProtectionModel_3Feb2014.detect=function(e){for(var t=c.models.ProtectionModel_3Feb2014.APIs,i=0;i<t.length;i++){var n=t[i];if("function"==typeof e[n.setMediaKeys]&&"function"==typeof window[n.MediaKeys])return n}return null},c.models.ProtectionModel_3Feb2014.prototype={constructor:c.models.ProtectionModel_3Feb2014},c.models.ProtectionModel_21Jan2015=function(){var e=null,t=null,i=null,r=[],o=function(e,t){var i=this;void 0!==navigator.requestMediaKeySystemAccess&&"function"==typeof navigator.requestMediaKeySystemAccess?function(t){var n=e[t].ks,r=e[t].configs;i.debug.log("[DRM][PM_21Jan2015] requestMediaKeySystemAccess: "+n.systemString),navigator.requestMediaKeySystemAccess(n.systemString,r).then(function(e){var t="function"==typeof e.getConfiguration?e.getConfiguration():null,r=new c.vo.protection.KeySystemAccess(n,t);r.mksa=e,i.notify(c.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_ACCESS_COMPLETE,r)}).catch(function(){++t<e.length?o.call(i,e,t):i.notify(c.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_ACCESS_COMPLETE,null,"Key system access denied!")})}(t):this.notify(c.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_ACCESS_COMPLETE,null,"Insecure origins are not allowed")},s=function(e){var t=e.session;return t.removeEventListener("keystatuseschange",e),t.removeEventListener("message",e),t.close()},a=function(e){for(var t=0;t<r.length;t++)if(r[t]===e){r.splice(t,1);break}},l=function(t,n,o){var s=this,l=function(e,t){for(var i=0;i<r.length;i++)if(r[i].session===e){r[i].usable=t;break}},d={session:t,initData:n,usable:!1,handleEvent:function(t){switch(t.type){case"keystatuseschange":s.notify(c.models.ProtectionModel.eventList.ENAME_KEY_STATUSES_CHANGED,this),t.target.keyStatuses.forEach(function(){var n,r;switch(arguments&&arguments.length>0&&(arguments[0]&&("string"==typeof arguments[0]?n=arguments[0]:r=arguments[0]),arguments[1]&&("string"==typeof arguments[1]?n=arguments[1]:r=arguments[1])),s.debug.log("[DRM][PM_21Jan2015] status = "+n+" for KID "+function(e){var t,i="[";for(t=0;t<e.length;t++)i+="0x"+e[t].toString(16),t<e.length-1&&(i+=",");return i+="]"}(new Uint8Array(r))),n){case"expired":l(t.target,!1),s.notify(c.models.ProtectionModel.eventList.ENAME_KEY_STATUSES_CHANGED,null,new c.vo.Error(c.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_EXPIRED,"License has expired",null));break;case"output-restricted":l(t.target,!1),s.notify(c.models.ProtectionModel.eventList.ENAME_KEY_STATUSES_CHANGED,null,new c.vo.Error(c.dependencies.ErrorHandler.prototype.MEDIA_KEYERR_OUTPUT,"There is no available output device with the required characteristics for the content protection system",null));break;case"usable":l(t.target,!0),e.addEventListener("waitingforkey",i);break;default:s.notify(c.models.ProtectionModel.eventList.ENAME_KEY_STATUSES_CHANGED,{status:n,keyId:r})}});break;case"message":s.debug.log("[DRM][PM_21Jan2015] 'message' event: ",t);var n=ArrayBuffer.isView(t.message)?t.message.buffer:t.message;s.notify(c.models.ProtectionModel.eventList.ENAME_KEY_MESSAGE,new c.vo.protection.KeyMessage(this,n,void 0,t.messageType))}},getSessionID:function(){return this.session.sessionId},getExpirationTime:function(){return this.session.expiration},getKeyStatuses:function(){return this.session.keyStatuses},getSessionType:function(){return o}};return t.addEventListener("keystatuseschange",d),t.addEventListener("message",d),t.closed.then(function(){a(d),s.notify(c.models.ProtectionModel.eventList.ENAME_KEY_SESSION_CLOSED,d.getSessionID())}),r.push(d),d};return{system:void 0,notify:void 0,subscribe:void 0,unsubscribe:void 0,protectionExt:void 0,keySystem:null,config:null,debug:null,setup:function(){i=function(){var e=this;return{session:null,handleEvent:function(t){switch(t.type){case"encrypted":if(e.debug.log("[DRM][PM_21Jan2015] 'encrypted' event"),t.initData){var i=ArrayBuffer.isView(t.initData)?t.initData.buffer:t.initData;e.notify(c.models.ProtectionModel.eventList.ENAME_NEED_KEY,new c.vo.protection.NeedKey(i,"cenc"))}break;case"waitingforkey":e.debug.log("[DRM][PM_21Jan2015] 'waitingforkey' event"),null!==this.session&&this.session.usable&&(this.session.usable=!1,e.notify(c.models.ProtectionModel.eventList.ENAME_KEY_ERROR,new c.vo.protection.KeyError(c.dependencies.ErrorHandler.prototype.MEDIA_ERR_ENCRYPTED,"Media is encrypted and no valid key is available")))}}}}.call(this)},init:function(){i.session=null},teardown:function(){var e,i,n=r.length,o=this;if(this.debug.log("[DRM][PM_21Jan2015] Teardown"),this.config.getParam("Protection.licensePersistence","boolean",!1)){for(i=0;i<r.length;i++)(e=r[i]).usable||(r.splice(i,1),i--);this.notify(c.models.ProtectionModel.eventList.ENAME_TEARDOWN_COMPLETE)}else{var l=function(e){o.debug.log("[DRM][PM_21Jan2015] Session closed"),a(e),i>=n-1&&(t=null,o.notify(c.models.ProtectionModel.eventList.ENAME_TEARDOWN_COMPLETE))};if(0===n)return t=null,void this.notify(c.models.ProtectionModel.eventList.ENAME_TEARDOWN_COMPLETE);for(i=0;i<n;i++)!function(t){o.debug.log("[DRM][PM_21Jan2015] Close session "+e.getSessionID()),e.session.closed.then(function(){l(t)}),s(e).catch(function(){l(t)})}(e=r[i])}},getAllInitData:function(){for(var e=[],t=0;t<r.length;t++)e.push(r[t].initData);return e},requestKeySystemAccess:function(e){o.call(this,e,0)},selectKeySystem:function(n){var r=this;if(r.debug.log("[DRM][PM_21Jan2015] Select key system, create new MediaKeys"),null!==t)return r.debug.log("[DRM][PM_21Jan2015] MediaKeys already created"),void r.notify(c.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_SELECTED);n.mksa.createMediaKeys().then(function(o){r.keySystem=n.keySystem,t=o,e&&e.setMediaKeys(t).then(function(){var t=r.keySystem.getServerCertificate();t?r.setServerCertificate(t).then(function(){r.notify(c.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_SELECTED),e.addEventListener("encrypted",i)}):(r.notify(c.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_SELECTED),e.addEventListener("encrypted",i))})}).catch(function(){r.notify(c.models.ProtectionModel.eventList.ENAME_KEY_SYSTEM_SELECTED,null,"Error selecting keys system ("+n.keySystem.systemString+")! Could not create MediaKeys -- TODO")})},setMediaElement:function(r){var o=this,s=n.defer();return e===r?(s.resolve(),s.promise):(e&&(e.removeEventListener("encrypted",i),e.removeEventListener("waitingforkey",i),e.setMediaKeys?e.setMediaKeys(null).then(function(){o.debug.log("[DRM][PM_21Jan2015] Successfully detached MediaKeys from video element"),s.resolve()},function(e){o.debug.error("[DRM][PM_21Jan2015] Failed to detach MediaKeys from video element: "+e),s.resolve()}):s.resolve()),(e=r)&&t&&e.setMediaKeys&&(e.addEventListener("encrypted",i),e.setMediaKeys(t)),s.promise)},setServerCertificate:function(e){if(!this.keySystem||!t)throw new Error("Can not set server certificate until you have selected a key system");this.debug.log("[DRM][PM_21Jan2015] Set server certificate");var i=this,r=n.defer();return t.setServerCertificate(e).then(function(){i.notify(c.models.ProtectionModel.eventList.ENAME_SERVER_CERTIFICATE_UPDATED),r.resolve()}).catch(function(e){i.notify(c.models.ProtectionModel.eventList.ENAME_SERVER_CERTIFICATE_UPDATED,null,"Error updating server certificate -- "+e.name),r.reject()}),r.promise},createKeySession:function(e,i){if(!this.keySystem||!t)throw new Error("Can not create sessions until you have selected a key system");this.debug.log("[DRM][PM_21Jan2015] Create key session, type = "+i),this.debug.log("[DRM][PM_21Jan2015] initData = "+String.fromCharCode.apply(null,new Uint8Array(e)));var n=t.createSession(i),r=l.call(this,n,e,i),o=this;n.generateRequest("cenc",e).then(function(){o.notify(c.models.ProtectionModel.eventList.ENAME_KEY_SESSION_CREATED,r)}).catch(function(e){a(r),o.notify(c.models.ProtectionModel.eventList.ENAME_KEY_SESSION_CREATED,null,{reason:"Failed to generate key request",error:new c.vo.Error(e.code,e.name,e.message)})})},updateKeySession:function(e,t){var n=e.session,r=this;r.debug.log("[DRM][PM_21Jan2015] Update key session. SessionID = "+n.sessionId),this.protectionExt.isClearKey(this.keySystem)&&(t=t.toJWK()),n.update(t).then(function(){i.session=e}).catch(function(e){r.notify(c.models.ProtectionModel.eventList.ENAME_KEY_ERROR,new c.vo.protection.KeyError(c.dependencies.ErrorHandler.prototype.MEDIA_KEYERR,"Error while providing license to the CDM",e))})},loadKeySession:function(e){if(!this.keySystem||!t)throw new Error("Can not load sessions until you have selected a key system");this.debug.log("[DRM][PM_21Jan2015] Load key session. SessionID = "+e);var i=t.createSession(),n=this;i.load(e).then(function(t){if(t){var r=l.call(this,i);n.notify(c.models.ProtectionModel.eventList.ENAME_KEY_SESSION_CREATED,r)}else n.notify(c.models.ProtectionModel.eventList.ENAME_KEY_SESSION_CREATED,null,{reason:"Failed to load session "+e,error:null})}).catch(function(t){n.notify(c.models.ProtectionModel.eventList.ENAME_KEY_SESSION_CREATED,{reason:"Failed to load session "+e,error:new c.vo.Error(t.code,t.name,t.message)})})},removeKeySession:function(e){var t=e.session;this.debug.log("[DRM][PM_21Jan2015] Remove key session. SessionID = "+e.getSessionID());var i=this;t.remove().then(function(){i.notify(c.models.ProtectionModel.eventList.ENAME_KEY_SESSION_REMOVED,e.getSessionID())},function(t){i.notify(c.models.ProtectionModel.eventList.ENAME_KEY_SESSION_REMOVED,null,"Error removing session ("+e.getSessionID()+"). "+t.name)})},closeKeySession:function(e){this.debug.log("[DRM][PM_21Jan2015] Close key session. SessionID = "+e.getSessionID());var t=this;s(e).catch(function(i){a(e),t.notify(c.models.ProtectionModel.eventList.ENAME_KEY_SESSION_CLOSED,null,"Error closing session ("+e.getSessionID()+") "+i.name)})},checkIfEncrypted:function(){}}},c.models.ProtectionModel_21Jan2015.detect=function(e){return void 0!==e.onencrypted&&void 0!==e.mediaKeys&&!window.MSMediaKeys},c.models.ProtectionModel_21Jan2015.prototype={constructor:c.models.ProtectionModel_21Jan2015},c.dependencies.protection.KeySystem=function(){},c.dependencies.protection.KeySystem_Access=function(){"use strict"},c.dependencies.protection.KeySystem_Access.prototype={constructor:c.dependencies.protection.KeySystem_Access},c.dependencies.protection.KeySystem_ClearKey=function(){"use strict";var e;return{system:void 0,schemeIdURI:"urn:uuid:1077efec-c0b2-4d02-ace3-3c1e52e2fb4b",systemString:"org.w3.clearkey",uuid:"1077efec-c0b2-4d02-ace3-3c1e52e2fb4b",sessionType:"temporary",init:function(t){e=t},getInitData:c.dependencies.protection.CommonEncryption.parseInitDataFromContentProtection,getKeySystemConfigurations:c.dependencies.protection.CommonEncryption.getKeySystemConfigurations,getRequestHeadersFromMessage:function(){return null},getLicenseRequestFromMessage:function(e){return new Uint8Array(e)},getLicenseServerURLFromInitData:function(){return null},getCDMData:function(){return null},getServerCertificate:function(){return null}}},c.dependencies.protection.KeySystem_ClearKey.prototype={constructor:c.dependencies.protection.KeySystem_ClearKey},c.dependencies.protection.KeySystem_ClearKey.getClearKeysFromProtectionData=function(e,t){var i=null;if(e){for(var n=JSON.parse(String.fromCharCode.apply(null,new Uint8Array(t))),r=[],o=0;o<n.kids.length;o++){var s=n.kids[o],a=e.clearkeys.hasOwnProperty(s)?e.clearkeys[s]:null;if(!a)throw new Error("[DRM] ClearKey keyID ("+s+") is not known!");r.push(new c.vo.protection.KeyPair(s,a))}i=new c.vo.protection.ClearKeyKeySet(r)}return i},c.dependencies.protection.KeySystem_PlayReady=function(){"use strict";var e,t="utf16";return{schemeIdURI:"urn:uuid:9a04f079-9840-4286-ab92-e65be0885f95",systemString:"com.microsoft.playready",uuid:"9a04f079-9840-4286-ab92-e65be0885f95",notify:void 0,subscribe:void 0,unsubscribe:void 0,domParser:void 0,sessionType:"temporary",init:function(t){t&&(e=t).sessionType&&(this.sessionType=e.sessionType)},getInitData:function(e){var t,i,n,r,o,s=0,a=new Uint8Array([112,115,115,104,0,0,0,0]),l=new Uint8Array([154,4,240,121,152,64,66,134,171,146,230,91,224,136,95,149]),d=null;if("pssh"in e)return c.dependencies.protection.CommonEncryption.parseInitDataFromContentProtection(e);if("pro"in e)d=p.decodeArray(e.pro.__text);else{if(!("prheader"in e))return null;d=p.decodeArray(e.prheader.__text)}return t=d.length,i=4+a.length+l.length+4+t,n=new ArrayBuffer(i),r=new Uint8Array(n),(o=new DataView(n)).setUint32(s,i),s+=4,r.set(a,s),s+=a.length,r.set(l,s),s+=l.length,o.setUint32(s,t),s+=4,r.set(d,s),s+=t,r.buffer},getKeySystemConfigurations:c.dependencies.protection.CommonEncryption.getKeySystemConfigurations,getRequestHeadersFromMessage:function(e){var i,n,r,o,s={},a=e instanceof ArrayBuffer?e:e.buffer,l="utf16"===t?new Uint16Array(a):new Uint8Array(a),d=0;for(i=String.fromCharCode.apply(null,l),r=(n=this.domParser.createXmlTree(i)).getElementsByTagName("name"),o=n.getElementsByTagName("value"),d=0;d<r.length;d+=1)s[r[d].childNodes[0].nodeValue]=o[d].childNodes[0].nodeValue;return s.hasOwnProperty("Content")&&(s["Content-Type"]=s.Content,delete s.Content),s.hasOwnProperty("Content-Type")||(s["Content-Type"]="text/xml; charset=utf-8"),s},getLicenseRequestFromMessage:function(e){var i,n,r,o=null,s=e instanceof ArrayBuffer?e:e.buffer,a="utf16"===t?new Uint16Array(s):new Uint8Array(s);return i=String.fromCharCode.apply(null,a),(n=this.domParser.createXmlTree(i)).getElementsByTagName("Challenge")[0]?(r=n.getElementsByTagName("Challenge")[0].childNodes[0].nodeValue)&&(o=p.decode(r)):o=i,o},getLicenseServerURLFromInitData:function(e){if(e){var t,i,n,r,o,s,a,l=new DataView(e),d=l.getUint16(4,!0),u=6,c=0;for(c=0;c<d;c++)if(t=l.getUint16(u,!0),u+=2,i=l.getUint16(u,!0),u+=2,1===t){if(n=e.slice(u,u+i),r=String.fromCharCode.apply(null,new Uint16Array(n)),(o=this.domParser.createXmlTree(r)).getElementsByTagName("LA_URL")[0]&&(s=o.getElementsByTagName("LA_URL")[0].childNodes[0].nodeValue))return s;if(o.getElementsByTagName("LUI_URL")[0]&&(a=o.getElementsByTagName("LUI_URL")[0].childNodes[0].nodeValue))return a}else u+=i}return null},getCDMData:function(){var t,i,n,r;if(e&&e.cdmData){for(t=[],r=0;r<e.cdmData.length;++r)t.push(e.cdmData.charCodeAt(r)),t.push(0);for(t=String.fromCharCode.apply(null,t),t=p.encode(t),i='<PlayReadyCDMData type="LicenseAcquisition"><LicenseAcquisition version="1.0" Proactive="false"><CustomData encoding="base64encoded">%CUSTOMDATA%</CustomData></LicenseAcquisition></PlayReadyCDMData>'.replace("%CUSTOMDATA%",t),n=[],r=0;r<i.length;++r)n.push(i.charCodeAt(r)),n.push(0);return new Uint8Array(n).buffer}return null},getServerCertificate:function(){return null},setPlayReadyMessageFormat:function(e){if("utf8"!==e&&"utf16"!==e)throw new Error("Illegal PlayReady message format! -- "+e);t=e}}},c.dependencies.protection.KeySystem_PlayReady.prototype={constructor:c.dependencies.protection.KeySystem_PlayReady},c.dependencies.protection.KeySystem_Widevine=function(){"use strict";var e=null;return{schemeIdURI:"urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed",systemString:"com.widevine.alpha",uuid:"edef8ba9-79d6-4ace-a3c8-27dcd51d21ed",sessionType:"temporary",init:function(t){t&&(e=t).sessionType&&(this.sessionType=e.sessionType)},getInitData:function(t){var i=null;return(i=e&&e.pssh?p.decodeArray(e.pssh).buffer:c.dependencies.protection.CommonEncryption.parseInitDataFromContentProtection(t))&&(i=function(e,t){var i,n,r,o,s=!0;for(i=new Uint8Array(e),r=0;r<=i.length-18;r++)if(18===i[r]&&16===i[r+1]){for(o=n=r+2;o<n+16;o++)if(255!==i[o]){s=!1;break}break}return s&&i.set(t,n),i.buffer}(i,t["cenc:default_KID"])),i},getKeySystemConfigurations:function(t,i,n){var r=c.dependencies.protection.CommonEncryption.getKeySystemConfigurations(t,i,n);return e&&(e.audioRobustness&&(r[0].audioCapabilities[0].robustness=e.audioRobustness),e.videoRobustness&&(r[0].videoCapabilities[0].robustness=e.videoRobustness)),r},getRequestHeadersFromMessage:function(){return null},getLicenseRequestFromMessage:function(e){return new Uint8Array(e)},getLicenseServerURLFromInitData:function(){return null},getCDMData:function(){return null},getServerCertificate:function(){return e&&e.serverCertificate&&e.serverCertificate.length>0?p.decodeArray(e.serverCertificate).buffer:null}}},c.dependencies.protection.KeySystem_Widevine.prototype={constructor:c.dependencies.protection.KeySystem_Widevine},c.dependencies.protection.servers.ClearKey=function(){"use strict";return{getServerURLFromMessage:function(e,t){var i=JSON.parse(String.fromCharCode.apply(null,new Uint8Array(t))),n=0;for(e+="/?",n=0;n<i.kids.length;n++)e+=i.kids[n]+"&";return e=e.substring(0,e.length-1)},getHTTPMethod:function(){return"GET"},getResponseType:function(){return"json"},getLicenseMessage:function(e){var t,i,n,r,o=[];if(!e.hasOwnProperty("keys"))return null;for(t=0;t<e.keys.length;t++)n=(i=e.keys[t]).kid.replace(/=/g,""),r=i.k.replace(/=/g,""),o.push(new c.vo.protection.KeyPair(n,r));return new c.vo.protection.ClearKeyKeySet(o)},getErrorResponse:function(e){return{code:0,name:"UnknownError",message:String.fromCharCode.apply(null,new Uint8Array(e))}}}},c.dependencies.protection.servers.ClearKey.prototype={constructor:c.dependencies.protection.servers.ClearKey},c.dependencies.protection.servers.DRMToday=function(){"use strict";var e={"com.widevine.alpha":{responseType:"json",getLicenseMessage:function(e){return p.decodeArray(e.license)},getErrorResponse:function(e){return e}},"com.microsoft.playready":{responseType:"arraybuffer",getLicenseMessage:function(e){return e},getErrorResponse:function(e){return String.fromCharCode.apply(null,new Uint8Array(e))}}};return{getServerURLFromMessage:function(e){return e},getHTTPMethod:function(){return"POST"},getResponseType:function(t){return e[t].responseType},getLicenseMessage:function(t,i){return e[i].getLicenseMessage(t)},getErrorResponse:function(t,i){return{code:0,name:"UnknownError",message:e[i].getErrorResponse(t)}}}},c.dependencies.protection.servers.DRMToday.prototype={constructor:c.dependencies.protection.servers.DRMToday},c.dependencies.protection.servers.LicenseServer=function(){},c.dependencies.protection.servers.PlayReady=function(){"use strict";var e=function(e){var t="",i=0,n=0,r=0,o=0,s=new Uint8Array(e);for(s.length>=3&&239===s[0]&&187===s[1]&&191===s[2]&&(i=3);i<s.length;)if((n=s[i])<128)t+=String.fromCharCode(n),i++;else if(n>191&&n<224){if(i+1>=s.length)throw"UTF-8 Decode failed. Two byte character was truncated.";r=s[i+1],t+=String.fromCharCode((31&n)<<6|63&r),i+=2}else{if(i+2>=s.length)throw"UTF-8 Decode failed. Multi byte character was truncated.";r=s[i+1],o=s[i+2],t+=String.fromCharCode((15&n)<<12|(63&r)<<6|63&o),i+=3}return t};return{domParser:void 0,getServerURLFromMessage:function(e){return e},getHTTPMethod:function(){return"POST"},getResponseType:function(){return"arraybuffer"},getLicenseMessage:function(t){return function(t){var i=e(t),n=this.domParser.createXmlTree(i),r=n?this.domParser.getChildNode(n,"soap:Envelope"):null,o=r?this.domParser.getChildNode(r,"soap:Body"):null;return(o?this.domParser.getChildNode(o,"soap:Fault"):null)?null:t}.call(this,t)},getErrorResponse:function(t){return function(t){var i=e(t),n=this.domParser.createXmlTree(i),r=n?this.domParser.getChildNode(n,"soap:Envelope"):null,o=r?this.domParser.getChildNode(r,"soap:Body"):null,s=o?this.domParser.getChildNode(o,"soap:Fault"):null,a=s?this.domParser.getChildNode(s,"detail"):null,l=a?this.domParser.getChildNode(a,"Exception"):null,d=null,u="",c="",h="",p=-1,f=-1;return null===s?{code:0,name:"UnknownError",message:String.fromCharCode.apply(null,new Uint8Array(t))}:(d=this.domParser.getChildNode(s,"faultstring").firstChild,u=d?d.nodeValue:null,null!==l&&(c=(d=this.domParser.getChildNode(l,"StatusCode"))?d.firstChild.nodeValue:null,p=(h=(d=this.domParser.getChildNode(l,"Message"))?d.firstChild.nodeValue:null)?h.lastIndexOf("[")+1:-1,f=h?h.indexOf("]"):-1),{code:c,name:u,message:h?h.substring(p,f):""})}.call(this,t)}}},c.dependencies.protection.servers.PlayReady.prototype={constructor:c.dependencies.protection.servers.PlayReady},c.dependencies.protection.servers.Widevine=function(){"use strict";return{getServerURLFromMessage:function(e){return e},getHTTPMethod:function(){return"POST"},getResponseType:function(){return"arraybuffer"},getLicenseMessage:function(e){return e},getErrorResponse:function(e){return{code:0,name:"UnknownError",message:String.fromCharCode.apply(null,new Uint8Array(e))}}}},c.dependencies.protection.servers.Widevine.prototype={constructor:c.dependencies.protection.servers.Widevine},c.vo.protection.ClearKeyKeySet=function(e,t){if(t&&"persistent"!==t&&"temporary"!==t)throw new Error("Invalid ClearKey key set type!  Must be one of 'persistent' or 'temporary'");this.keyPairs=e,this.type=t,this.toJWK=function(){var e,t=this.keyPairs.length,i={};for(i.keys=[],e=0;e<t;e++){var n={kty:"oct",alg:"A128KW",kid:this.keyPairs[e].keyID,k:this.keyPairs[e].key};i.keys.push(n)}this.type&&(i.type=this.type);var r=JSON.stringify(i),o=r.length,s=new ArrayBuffer(o),a=new Uint8Array(s);for(e=0;e<o;e++)a[e]=r.charCodeAt(e);return s}},c.vo.protection.ClearKeyKeySet.prototype={constructor:c.vo.protection.ClearKeyKeySet},c.vo.protection.KeyError=function(e,t,i){"use strict";this.code=e,this.message=t,this.data=i},c.vo.protection.KeyError.prototype={constructor:c.vo.protection.KeyError},c.vo.protection.KeyMessage=function(e,t,i,n){"use strict";this.sessionToken=e,this.message=t,this.defaultURL=i,this.messageType=n},c.vo.protection.KeyMessage.prototype={constructor:c.vo.protection.KeyMessage},c.vo.protection.KeyPair=function(e,t){"use strict";this.keyID=e,this.key=t},c.vo.protection.KeyPair.prototype={constructor:c.vo.protection.KeyPair},c.vo.protection.KeySystemAccess=function(e,t){this.keySystem=e,this.ksConfiguration=t},c.vo.protection.KeySystemAccess.prototype={constructor:c.vo.protection.KeySystemAccess},c.vo.protection.KeySystemConfiguration=function(e,t,i,n,r){this.initDataTypes=["cenc"],this.audioCapabilities=e,this.videoCapabilities=t,this.distinctiveIdentifier=i,this.persistentState=n,this.sessionTypes=r},c.vo.protection.KeySystemConfiguration.prototype={constructor:c.vo.protection.KeySystemConfiguration},c.vo.protection.LicenseRequestComplete=function(e,t){"use strict";this.message=e,this.requestData=t},c.vo.protection.LicenseRequestComplete.prototype={constructor:c.vo.protection.LicenseRequestComplete},c.vo.protection.MediaCapability=function(e,t){this.contentType=e,this.robustness=t},c.vo.protection.MediaCapability.prototype={constructor:c.vo.protection.MediaCapability},c.vo.protection.NeedKey=function(e,t){this.initData=e,this.initDataType=t},c.vo.protection.NeedKey.prototype={constructor:c.vo.protection.NeedKey},c.vo.protection.ProtectionData=function(e,t,i,n){this.laURL=e,this.httpRequestHeaders=t,this.bearerToken=i,this.clearkeys=n},c.vo.protection.ProtectionData.prototype={constructor:c.vo.protection.ProtectionData},c.models.SessionToken=function(){"use strict"},c.models.SessionToken.prototype={initData:null,getSessionID:function(){return""},getExpirationTime:function(){return NaN},getKeyStatuses:function(){return null}},d.dependencies.AES=function(){this.init=function(e){this._tables=[[[],[],[],[],[]],[[],[],[],[],[]]],this._precompute.call(this);var t,i,n,r,o,s=this._tables[0][4],a=this._tables[1],l=e.length,d=1;if(4!==l&&6!==l&&8!==l)throw new Error("Invalid aes key size="+l);for(r=e.slice(0),o=[],this._key=[r,o],t=l;t<4*l+28;t++)n=r[t-1],(t%l==0||8===l&&t%l==4)&&(n=s[n>>>24]<<24^s[n>>16&255]<<16^s[n>>8&255]<<8^s[255&n],t%l==0&&(n=n<<8^n>>>24^d<<24,d=d<<1^283*(d>>7))),r[t]=r[t-l]^n;for(i=0;t;i++,t--)n=r[3&i?t:t-4],o[i]=t<=4||i<4?n:a[0][s[n>>>24]]^a[1][s[n>>16&255]]^a[2][s[n>>8&255]]^a[3][s[255&n]]},this._precompute=function(){var e,t,i,n,r,o,s,a,l=this._tables[0],d=this._tables[1],u=l[4],c=d[4],h=[],p=[];for(e=0;e<256;e++)p[(h[e]=e<<1^283*(e>>7))^e]=e;for(t=i=0;!u[t];t^=n||1,i=p[i]||1)for(o=(o=i^i<<1^i<<2^i<<3^i<<4)>>8^255&o^99,u[t]=o,c[o]=t,a=16843009*h[r=h[n=h[t]]]^65537*r^257*n^16843008*t,s=257*h[o]^16843008*o,e=0;e<4;e++)l[e][t]=s=s<<24^s>>>8,d[e][o]=a=a<<24^a>>>8;for(e=0;e<5;e++)l[e]=l[e].slice(0),d[e]=d[e].slice(0)},this.decrypt=function(e,t,i,n,r,o){var s,a,l,d,u=this._key[1],c=e^u[0],h=n^u[1],p=i^u[2],f=t^u[3],m=u.length/4-2,g=4,y=this._tables[1],_=y[0],E=y[1],b=y[2],v=y[3],x=y[4];for(d=0;d<m;d++)s=_[c>>>24]^E[h>>16&255]^b[p>>8&255]^v[255&f]^u[g],a=_[h>>>24]^E[p>>16&255]^b[f>>8&255]^v[255&c]^u[g+1],l=_[p>>>24]^E[f>>16&255]^b[c>>8&255]^v[255&h]^u[g+2],f=_[f>>>24]^E[c>>16&255]^b[h>>8&255]^v[255&p]^u[g+3],g+=4,c=s,h=a,p=l;for(d=0;d<4;d++)r[(3&-d)+o]=x[c>>>24]<<24^x[h>>16&255]<<16^x[p>>8&255]<<8^x[255&f]^u[g++],s=c,c=h,h=p,p=f,f=s}},d.dependencies.AES.prototype={constructor:d.dependencies.AES},d.dependencies.AES128Decrypter=function(e,t){"use strict";this.key=e,this.iv=t,this.ntoh=function(e){return e<<24|(65280&e)<<8|(16711680&e)>>8|e>>>24},this.doDecrypt=function(e,t,i){var n,r,o,s,a,l,u,c,h,p=new Int32Array(e.buffer,e.byteOffset,e.byteLength>>2),f=new d.dependencies.AES,m=new Uint8Array(e.byteLength),g=new Int32Array(m.buffer);for(f.init(Array.prototype.slice.call(t)),n=~~i[0],r=~~i[1],o=~~i[2],s=~~i[3],h=0;h<p.length;h+=4)a=~~this.ntoh(p[h]),l=~~this.ntoh(p[h+1]),u=~~this.ntoh(p[h+2]),c=~~this.ntoh(p[h+3]),f.decrypt(a,l,u,c,g,h),g[h]=this.ntoh(g[h]^n),g[h+1]=this.ntoh(g[h+1]^r),g[h+2]=this.ntoh(g[h+2]^o),g[h+3]=this.ntoh(g[h+3]^s),n=a,r=l,o=u,s=c;return m},this.localDecrypt=function(e,t,i,n){var r=this.doDecrypt(e,t,i);n.set(r,e.byteOffset)},this.decrypt=function(e){var t=new Int32Array(e),i=new Uint8Array(e.byteLength),n=0,r=this.key,o=this.iv;for(this.localDecrypt(t.subarray(n,n+32e3),r,o,i),n=32e3;n<t.length;n+=32e3)o=new Uint32Array([this.ntoh(t[n-4]),this.ntoh(t[n-3]),this.ntoh(t[n-2]),this.ntoh(t[n-1])]),this.localDecrypt(t.subarray(n,n+32e3),r,o,i);return i}},d.dependencies.AES128Decrypter.prototype={constructor:d.dependencies.AES128Decrypter},d.dependencies.HlsDemux=function(){"use strict";var e=function(e,t){var i=new Uint8Array(e.byteLength+t.byteLength);return i.set(e,0),i.set(t,e.byteLength),i},t=[1,5,6],i=1,n=[],r=[],o=-1,s=-1,a=function(e,t,i,n){for(var r,o=t;o<e.length;){if((r=new _.ts.TsPacket).parse(e.subarray(o,o+_.ts.TsPacket.prototype.TS_PACKET_SIZE)),r.getPid()===i&&(void 0===n||r.getPusi()===n))return{offset:o,packet:r};o+=_.ts.TsPacket.prototype.TS_PACKET_SIZE}return null},l=function(e){var t,i,r,a,l=null,d=null;if((t=new _.ts.TsPacket).parse(e),!t.hasAdaptationFieldOnly()&&(i=t.getPid(),r=n[i]))if(t.getPusi())if((a=new _.pes.PesPacket).parse(t.getPayload()),l=new c.vo.Mp4Track.Sample,l.cts=a.getPts().getValue(),l.dts=null!==a.getDts()?a.getDts().getValue():l.cts,l.size=0,l.duration=0,l.subSamples=[],-1===o&&(o=l.dts),l.mpegTimestamp=l.cts,l.dts-=o,l.cts-=o,l.dts+=s,l.cts+=s,d=a.getPayload(),"audio"===r.type&&(l.flags=16777216),"video"===r.type&&-1!==r.streamType.search("H.264")&&(l.flags=_.h264.isIDR(d)?33554432:16842752),l.subSamples.push(d),l.dts>=0)r.samples.push(l);else{var u=Math.abs(l.dts)/9e4;if(u>10)throw{name:c.dependencies.ErrorHandler.prototype.HLS_DEMUX_ERROR,message:"A/V desynchronization ("+Math.round(u)+" s.)"}}else r.samples.length>0&&(l=r.samples[r.samples.length-1]).subSamples.push(t.getPayload())},d=function(e){var t,i,n,r,o=0,s=0;if(0!==e.samples.length){for(n=0;n<e.samples.length;n++){for(i=0,t=e.samples[n],r=0;r<t.subSamples.length;r++)i+=t.subSamples[r].length;n>0&&(e.samples[n-1].duration=e.samples[n].dts-e.samples[n-1].dts),t.size=i,o+=i}for(e.samples[e.samples.length-1].duration=e.samples[e.samples.length-2].duration,e.data=new Uint8Array(o),e.dataCTS=[],n=0;n<e.samples.length;n++)for(t=e.samples[n],-1!==e.streamType.search("ADTS")&&(e.dataCTS[s]=t.cts),r=0;r<t.subSamples.length;r++)e.data.set(t.subSamples[r],s),s+=t.subSamples[r].length;if(-1!==e.streamType.search("H.264")&&u.call(this,e),-1!==e.streamType.search("ADTS")&&h.call(this,e),e.previousCts&&e.previousDuration){var a=(t=e.samples[0]).cts-(e.previousCts+e.previousDuration);a>0&&a<e.timescale&&(t.cts-=a,t.dts-=a,t.duration+=a,this.debug.log("[HlsDemux]["+e.type+"] Patch sample duration, cts = "+(t.cts/9e4).toFixed(3)+", duration = "+(t.duration/9e4).toFixed(3)))}}},u=function(e){var i,n,r,o,s,a,l;for(r=0,s=0,a=0;a<e.samples.length;a++){for((i=e.samples[a]).nalus=_.h264.parseNALUs(e.data.subarray(s,s+i.size)),l=0;l<i.nalus.length;l++)n=i.nalus[l],-1!==t.indexOf(n.type)?(n.offset+=s,r+=4+i.nalus[l].size):(i.nalus.splice(l,1),l--);s+=i.size}for(o=new Uint8Array(r),s=0,a=0;a<e.samples.length;a++)for((i=e.samples[a]).size=0,l=0;l<i.nalus.length;l++)n=i.nalus[l],o[s++]=(4278190080&n.size)>>24,o[s++]=(16711680&n.size)>>16,o[s++]=(65280&n.size)>>8,o[s++]=255&n.size,o.set(e.data.subarray(n.offset,n.offset+n.size),s),s+=n.size,i.size+=4+n.size;e.data=o},h=function(e){var t,i,n,r,o,s,a,l,d=[];for(t=_.aac.parseADTS(e.data,e.dataCTS),i=0,l=0;l<t.length;l++)i+=t[l].length;for(r=new Uint8Array(i),s=e.samples[0].cts,a=1024*e.timescale/e.samplingRate,n=0,l=0;l<t.length;l++)(o=new c.vo.Mp4Track.Sample).cts=o.dts=t[l].cts?t[l].cts:s,o.size=t[l].length,o.duration=a,o.flags=16777216,0===d.length&&(o.mpegTimestamp=e.samples[0].mpegTimestamp),d.push(o),s=o.cts+a,l>0&&(d[l-1].duration=d[l].cts-d[l-1].cts,d[l-1].duration>a&&this.debug.log("[HlsDemux]["+e.type+"] Patch sample duration, cts = "+(d[l-1].cts/9e4).toFixed(3)+", duration = "+(d[l-1].duration/9e4).toFixed(3))),r.set(e.data.subarray(t[l].offset,t[l].offset+t[l].length),n),n+=t[l].length;e.data=r,e.samples=d},p=function(e){var t="",i=0,n=0;for(i=0;i<e.length;i++)(n=e[i].toString(16)).length<2&&(n="0"+n),t+=n;return t},f=function(t,i){var n,r,o,s,l,d,u,h;if(null===(n=a.call(this,t,0,i.pid,!0)))throw{name:c.dependencies.ErrorHandler.prototype.HLS_DEMUX_ERROR,message:"No packets for track "+i.type};if((r=new _.pes.PesPacket).parse(n.packet.getPayload()),o=r.getPayload(),-1!==i.streamType.search("H.264")){for(s=_.h264.getSequenceHeader(o);null===s;)n=a.call(this,t,n.offset+_.ts.TsPacket.prototype.TS_PACKET_SIZE,i.pid,!1),o=e(o,n.packet.getPayload()),s=_.h264.getSequenceHeader(o);i.codecPrivateData=p(s.bytes),i.codecs="avc1.",(l=/00000001[0-9]7/.exec(i.codecPrivateData))&&l[0]&&(i.codecs+=i.codecPrivateData.substr(i.codecPrivateData.indexOf(l[0])+10,6)),i.width=s.width,i.height=s.height,this.debug.log("[HlsDemux] width  = "+i.width),this.debug.log("[HlsDemux] height = "+i.height)}-1!==i.streamType.search("AAC")&&(u=(248&(d=_.aac.getAudioSpecificConfig(o))[0])>>3,i.codecPrivateData=p(d),i.codecs="mp4a.40."+u,h=(7&d[0])<<1|(128&d[1])>>7,i.samplingRate=_.aac.SAMPLING_FREQUENCY[h],i.channels=(120&d[1])>>3,i.bandwidth=0),this.debug.log("[HlsDemux] codecs = "+i.codecs),this.debug.log("[HlsDemux] codecPrivateData = "+i.codecPrivateData)},m=function(e){var t,o,s,l,d,u,h=0;if(!function(e){return(new _.ts.TsPacket).checkSyncWord(e.subarray(0,_.ts.TsPacket.prototype.TS_PACKET_SIZE))}.call(this,e))throw{name:c.dependencies.ErrorHandler.prototype.HLS_INVALID_PACKET_ERROR,message:"Failed to demux, packet is invalid, missing SYNC byte"};if(null===(t=function(e){var t=a.call(this,e,0,_.ts.TsPacket.prototype.PAT_PID);if(null===t)return null;var i=new _.si.PAT;return i.parse(t.packet.getPayload()),i}.call(this,e)))throw{name:c.dependencies.ErrorHandler.prototype.HLS_DEMUX_ERROR,message:"Failed to demux, missing signalization (PAT)"};if(null===(o=function(e,t){var i=a.call(this,e,0,t);if(null===i)return null;var n=new _.si.PMT;return n.parse(i.packet.getPayload()),n}.call(this,e,t.getPmtPid())))throw{name:c.dependencies.ErrorHandler.prototype.HLS_DEMUX_ERROR,message:"Failed to demux, missing signalization (PMT)"};for(h=0;h<o.m_listOfComponents.length;h++){if(s=o.m_listOfComponents[h],l=s.m_elementary_PID,!(d=n[l])){if(d=new c.vo.Mp4Track,d.timescale=_.Pts.prototype.SYSTEM_CLOCK_FREQUENCY,d.pid=l,null===(u=o.gStreamTypes[s.m_stream_type])){this.debug.log("[HlsDemux] Stream Type "+s.m_stream_type+" unknown!");continue}switch(d.streamType=u.name,u.value){case 224:d.type="video";break;case 192:d.type="audio";break;case 252:d.type="data";break;default:d.type="und"}}if(f.call(this,e,d),""===d.codecs)throw{name:c.dependencies.ErrorHandler.prototype.HLS_DEMUX_ERROR,message:"Failed to get codec information for track "+d.type};n[l]||(d.trackId=i,i++,this.debug.log("[HlsDemux] Add track: type = "+d.type+", PID = "+d.pid+", trackId = "+d.trackId),r.push(d),n[l]=d)}return r};return{debug:void 0,reset:function(){this.debug.log("[HlsDemux] Reset"),i=1,n=[],r=[],o=-1,s=-1},getTracks:m,demux:function(e,t){var i,n,o=0,a=-1;for(-1===s&&(s=9e4*t.startTime,this.debug.log("[HlsDemux] Media start time = "+s+" ("+t.startTime+")")),this.debug.log("[HlsDemux] Demux chunk, size = "+e.length+", nb packets = "+Math.round(e.length/_.ts.TsPacket.prototype.TS_PACKET_SIZE)),m.call(this,e),o=0;o<r.length;o++)(i=r[o]).samples.length>0&&(i.previousCts=i.samples[i.samples.length-1].cts,i.previousDuration=i.samples[i.samples.length-1].duration),r[o].samples=[],r[o].data=null;for(o=0;o<e.length;){if(o+_.ts.TsPacket.prototype.TS_PACKET_SIZE>e.length){this.debug.log("[HlsDemux] Demux chunk, residual bytes = "+(e.length-o));break}l.call(this,e.subarray(o,o+_.ts.TsPacket.prototype.TS_PACKET_SIZE)),o+=_.ts.TsPacket.prototype.TS_PACKET_SIZE}for(o=0;o<r.length;o++)if(0!==(i=r[o]).samples.length&&(d.call(this,i),this.debug.log("[HlsDemux]["+i.type+"] Demux: 1st PTS = "+i.samples[0].dts+" ("+i.samples[0].dts/9e4+")"),a=Math.max(a,i.samples[0].dts),(n=Math.abs(i.samples[0].dts-a)/9e4)>10))throw{name:c.dependencies.ErrorHandler.prototype.HLS_DEMUX_ERROR,message:"A/V desynchronization ("+Math.round(n)+" s.)"};var u=[];for(o=0;o<r.length;o++)r[o].samples.length>0&&u.push(r[o]);return u}}},d.dependencies.HlsDemux.prototype={constructor:d.dependencies.HlsDemux},d.dependencies.HlsFragmentController=function(){"use strict";var e={},t=function(e,t){var i=new Date,n=new DataView(t.key.buffer),o=new Uint32Array([n.getUint32(0),n.getUint32(4),n.getUint32(8),n.getUint32(12)]);n=new DataView(function(e){var t=new Uint8Array(16),i=0;for(i=12;i<16;i++)t[i]=e>>8*(15-i)&255;return t}(t.iv).buffer);var s=new Uint32Array([n.getUint32(0),n.getUint32(4),n.getUint32(8),n.getUint32(12)]),a=new d.dependencies.AES128Decrypter(o,s);return r.debug.log("[HlsFragmentController] decrypted chunk ("+(((new Date).getTime()-i.getTime())/1e3).toFixed(3)+"s.)"),a.decrypt(e)},i=function(i,r){var o,s=n.defer(),a=this;return r.decryptionInfo&&"NONE"!==r.decryptionInfo.method?((o=e[r.decryptionInfo.uri])?s.resolve(t.call(this,i,o)):(o=r.decryptionInfo,function(e){var t=n.defer();this.debug.log("[HlsFragmentController]","Load decryption key: "+e.uri);var i=new c.dependencies.XHRLoader;return i.initialize("arraybuffer",0,0),i.load(e.uri).then(function(i){e.key=new Uint8Array(i.response),t.resolve()},function(i){!i||i.aborted?t.reject():t.reject({name:c.dependencies.ErrorHandler.prototype.DOWNLOAD_ERR_MANIFEST,message:"Failed to download HLS decryption key",data:{url:e.uri,status:i.status}})}),t.promise}.call(this,o).then(function(){if(o.key&&16!==o.key.byteLength)return s.reject({name:c.dependencies.ErrorHandler.prototype.HLS_INVALID_KEY_ERROR,message:"Invalid HLS key - Key length ("+o.key.byteLength+") does not respect specification"});e[o.uri]=o,s.resolve(t.call(a,i,o))},function(e){s.reject(e)})),s.promise):(s.resolve(i),s.promise)},r=c.utils.copyMethods(c.dependencies.FragmentController);return r.manifestModel=void 0,r.hlsDemux=void 0,r.mp4Processor=void 0,r.process=function(e,t){var o=n.defer(),s=null;return null===e||void 0===e||0===e.byteLength?(o.resolve(null),o.promise):t&&"Media Segment"===t.type?"text"===t.streamType?(o.resolve(e),o.promise):(i.call(r,e,t).then(function(e){try{r.manifestModel.getValue()?(s=function(e,t){var i=0,n=r.hlsDemux.demux(new Uint8Array(e),t);for(i=0;i<n.length;i+=1)!r.manifestModel.getValue().timestampMap&&n[i].samples[0].mpegTimestamp&&(r.manifestModel.getValue().timestampMap={local:n[i].samples[0].cts/9e4,mpegts:n[i].samples[0].mpegTimestamp});return r.mp4Processor.generateInitMediaSegment(n)}(e,t),r.sequenceNumber++,o.resolve(s)):o.resolve(null)}catch(e){o.reject(e)}},function(e){o.reject(e)}),o.promise):(o.resolve(null),o.promise)},r},d.dependencies.HlsFragmentController.prototype={constructor:d.dependencies.HlsFragmentController},d.dependencies.HlsHandler=function(){"use strict";var e=c.utils.copyMethods(u.dependencies.DashHandler);return e.getInitRequest=function(t){var i,r,o,s=null,a=null,l=n.defer();return s=t.adaptation.period,a=s.start,i=e.manifestModel.getValue(),r=e.manifestExt.getIsDynamic(i),o=new c.vo.SegmentRequest,o.streamType=e.getType(),o.type="Initialization Segment",o.url=null,o.data=1,o.range=t.range,o.availabilityStartTime=this.timelineConverter.calcAvailabilityStartTimeFromPresentationTime(a,t.adaptation.period.mpd,r),o.availabilityEndTime=this.timelineConverter.calcAvailabilityEndTimeFromPresentationTime(a+s.duration,s.mpd,r),o.quality=t.index,l.resolve(o),l.promise},e},d.dependencies.HlsHandler.prototype={constructor:d.dependencies.HlsHandler},d.dependencies.HlsParser=function(){var e,t=/#EXT-X-STREAM-INF:([^\n\r]*)[\r\n]+([^\r\n]+)/g,i=/#EXT-X-MEDIA:(.*)/g,r=/\s*(.+?)\s*=((?:\".*?\")|.*?)(?:,|$)/g,o=new RegExp("(?:(?:#(EXT-X-MEDIA-SEQUENCE):*(\\d+))|(?:#(EXT-X-TARGETDURATION):*(\\d+))|(?:#(EXT-X-PROGRAM-DATE-TIME):*(.+))|(?:#(EXT-X-KEY):(.+))|(?:#(EXTINF):*(\\d+(?:\\.\\d+)?)(?:,(.*))?[\r\n]*(.*))|(?:#(EXT-X-ENDLIST)))","g"),s=2,a=500,l=function(e){for(var t,i,n,o={};null!==(t=r.exec(e));)i=t[1],n=t[2].replace(/"/g,""),o[i]=n;return o},d=function(e,t){return 0===e.indexOf("http://")||0===e.indexOf("https://")?e:t+e},u=function(e,t){for(var i=0;i<e.length&&e[i].sequenceNumber<t;i++)e.shift(),i--},h=function(e){var t=null;return-1!==e.indexOf("/")&&(-1!==e.indexOf("?")&&(e=e.substring(0,e.indexOf("?"))),t=e.substring(0,e.lastIndexOf("/")+1)),t},p=function(t,i){var r=this,h=n.defer();return this.debug.log("[HlsParser]","Load playlist manifest: "+t.url),(e=new c.dependencies.XHRLoader).initialize("text",s,a),e.load(t.url).then(function(e){!function(e,t,i){var n,r,s,a,c,h=null,p=0,f=0,m=null;if(!e||e&&e.length<0)return!1;if(0!==e.indexOf("#EXTM3U"))return!1;(n=t.SegmentList)||(n={name:"SegmentList",isRoot:!1,isArray:!1,duration:0,startNumber:0,timescale:1,BaseURL:t.BaseURL,SegmentURL_asArray:[]},t.SegmentList=n),r=n.SegmentURL_asArray,t.duration=1/0;for(var g,y;null!==(g=o.exec(e));)switch((g=g.filter(function(e){return void 0!==e}))[1]){case"EXT-X-MEDIA-SEQUENCE":f=parseInt(g[2]),n.startNumber=f;break;case"EXT-X-TARGETDURATION":n.duration=parseInt(g[2]);break;case"EXT-X-KEY":h={method:(y=l(g[2])).METHOD||"NONE",uri:d(y.URI,n.BaseURL),iv:y.IV};break;case"EXTINF":(s={name:"SegmentURL",isRoot:!1,isArray:!0,media:d(g[4],n.BaseURL),sequenceNumber:f,time:0===r.length?0:r[r.length-1].time+r[r.length-1].duration,duration:parseFloat(g[2]),decryptionInfo:h}).decryptionInfo&&!s.decryptionInfo.iv&&(s.decryptionInfo.iv=s.sequenceNumber),(0===r.length||s.sequenceNumber>r[r.length-1].sequenceNumber)&&r.push(s),f++,p+=s.duration,m&&(s.programDateTime=m,m+=1e3*s.duration);break;case"EXT-X-ENDLIST":t.duration=p;break;case"EXT-X-PROGRAM-DATE-TIME":m=Date.parse(g[2])}if(u(r,n.startNumber),i.segments&&i.segments.length>0&&(u(r,i.segments[0].sequenceNumber),r.length>0&&(u(i.segments,r[0].sequenceNumber),i.segments.length>0&&r[0].time!==i.segments[0].time)))for(r[0].time=i.segments[0].time,c=1;c<r.length;c++)r[c].time=r[c-1].time+r[c-1].duration;if(0===r.length)return!0;i.segments=r;var _={start:r[0].time,end:r[r.length-1].time+r[r.length-1].duration};return m&&(_.programStart=r[0].programDateTime,_.programEnd=r[r.length-1].programDateTime+r[r.length-1].duration),"video"===i.contentType&&this.metricsModel.addDVRInfo("video",new Date,_),a={name:"Initialization",sourceURL:t.SegmentList.SegmentURL_asArray[0].media},t.SegmentList.Initialization=a,!0}.call(r,e.response,t,i)?h.reject({name:c.dependencies.ErrorHandler.prototype.MANIFEST_ERR_PARSE,message:"Failed to parse variant stream playlist",data:{url:t.url}}):h.resolve()},function(e){!e||e.aborted?h.reject():h.reject({name:c.dependencies.ErrorHandler.prototype.DOWNLOAD_ERR_MANIFEST,message:"Failed to download variant stream playlist",data:{url:t.url,status:e.status}})}),h.promise},f=function(e,r){var o,s,a,f,m,g,y,_,E=this,b=n.defer(),v=[],x=0,T=[],S=[],D=[],I=0;if(0!==e.indexOf("#EXTM3U"))return this.debug.error("[HlsParser] no stream in HLS manifest"),b.reject(),b.promise;if(o={},o.name="M3U",o.isRoot=!0,o.isArray=!0,o.parent=null,o.BaseURL=r,o.profiles="urn:mpeg:dash:profile:isoff-live:2011",o.type="static",s={},s.name="Period",s.isRoot=!1,s.isArray=!1,s.parent=o,s.duration=0,s.BaseURL=o.BaseURL,o.Period=s,o.Period_asArray=[s],v=[],s.AdaptationSet=v,s.AdaptationSet_asArray=v,0===(T=function(e){for(var i,n,r,o,s,a,d,u,c,h,p=[];null!==(n=t.exec(e));){for(o=(o=(r=l(n[1])).CODECS||"").split(","),s=a="",h=0;h<o.length;h++)-1!==o[h].indexOf("avc1")?a=o[h]:s=o[h];d=(d=r.RESOLUTION||"0x0").split("x"),u=parseInt(d[0],10),c=parseInt(d[1],10),i={programId:r["PROGRAM-ID"]||"",bandwidth:parseInt(r.BANDWIDTH||"0",10),audioCodec:s,videoCodec:a,width:u,height:c,audioId:r.AUDIO||"",subtitlesId:r.SUBTITLES||"",uri:n[2]},p.push(i)}return p}(e)).length)return this.debug.error("[HlsParser] No stream in HLS manifest"),b.reject(),b.promise;for(T.sort(function(e,t){return e.bandwidth-t.bandwidth}),a={name:"AdaptationSet",isRoot:!1,isArray:!0,id:"video",lang:"",contentType:"video",mimeType:"video/mp4",maxWidth:0,maxHeight:0,BaseURL:s.BaseURL},f=[],I=0;I<T.length&&!((g=T[I]).bandwidth<=64e3);I++)(m={name:"Representation",isRoot:!1,isArray:!0,id:x.toString(),mimeType:"video/mp4",codecs:g.videoCodec.length>0?g.audioId.length>0?g.videoCodec:g.videoCodec+","+g.audioCodec:"",bandwidth:g.bandwidth,width:g.width,height:g.height,url:d(g.uri,a.BaseURL)}).BaseURL=h(m.url),f.push(m),x++;for(a.Representation=f.length>1?f:f[0],a.Representation_asArray=f,v.push(a),_=this.abrController.getPlaybackQuality("video",v[0]).quality,m=v[0].Representation_asArray[_],D.push(p.call(this,m,a)),S=function(e){for(var t,n,r,o,s=[];null!==(t=i.exec(e))&&(n=l(t[1]),0!==(r=(n.TYPE||"").toLowerCase()).length);)o={type:r,groupId:n["GROUP-ID"]||"",name:r+(n.NAME?"_"+n.NAME:""),language:n.LANGUAGE||"",autoSelect:"YES"===n["AUTO-SELECT"],default:"YES"===n.SUTITLES,uri:n.URI||""},s.push(o);return s}(e),I=0;I<S.length;I++)a={name:"AdaptationSet",isRoot:!1,isArray:!0,id:(y=S[I]).name,lang:y.language,contentType:y.type,mimeType:"audio"===y.type?"audio/mp4":"text/vtt",maxWidth:0,maxHeight:0,BaseURL:s.BaseURL},(m={name:"Representation",isRoot:!1,isArray:!0,id:"",mimeType:"audio"===y.type?"audio/mp4":"text/vtt",codecs:"audio"===y.type?T[0].audioCodec:"WebVTT",bandwidth:0,width:0,height:0,url:d(y.uri,a.BaseURL)}).BaseURL=h(m.url),a.Representation=m,a.Representation_asArray=[m],v.push(a),D.push(p.call(this,m,a));return n.all(D).then(function(){(function(e,t){var i,r,o,s,a,l,d=n.defer(),h=e.Period_asArray[0],p=h.AdaptationSet_asArray[0],f=p.Representation_asArray[t],m=new c.vo.SegmentRequest;for(h.start=0,p.duration=f.duration,h.duration=f.duration,f.duration!==1/0&&(e.mediaPresentationDuration=f.duration),e.type=f.duration===1/0?"dynamic":"static",i=f.SegmentList.duration*f.SegmentList.SegmentURL_asArray.length,"dynamic"===e.type&&(r=new Date,e.availabilityStartTime=new Date(r.getTime()-1e3*i),e.timeShiftBufferDepth=i),e.minBufferTime=3*f.SegmentList.duration,o=Math.max.apply(null,h.AdaptationSet_asArray.map(function(e){var i=t>e.Representation_asArray.length?0:t;return e.Representation_asArray[i].SegmentList.startNumber})),s=0;s<h.AdaptationSet_asArray.length;s++){var g=h.AdaptationSet_asArray[s];for(a=0;a<g.Representation_asArray.length;a++)if(g.Representation_asArray[a].SegmentList){var y=g.Representation_asArray[a].SegmentList.SegmentURL_asArray;if(y.length>0&&y[0].sequenceNumber<o&&(u(y,o),y.length>0))for(y[0].time=0,l=1;l<y.length;l++)y[l].time=y[l-1].time+y[l-1].duration}}f=p.Representation_asArray[t],m.type="Initialization Segment",m.url=f.SegmentList.Initialization.sourceURL;return""===f.codecs?(this.debug.log("[HlsParser]","Load initialization segment: "+m.url),this.fragmentLoader.load(m).then(function(e,t){var i=this.hlsDemux.getTracks(new Uint8Array(t.data)),n=0;for(e.codecs="",n=0;n<i.length;n++)e.codecs+=i[n].codecs,n<i.length-1&&(e.codecs+=",");d.resolve()}.bind(this,f),function(){d.resolve()}.bind(this))):d.resolve(),d.promise}).call(E,o,_).then(function(){b.resolve(o)})},function(e){e?b.reject(e):b.resolve(null)}),b.promise};return{debug:void 0,config:void 0,manifestModel:void 0,fragmentLoader:void 0,abrController:void 0,hlsDemux:void 0,metricsModel:void 0,setup:function(){s=this.config.getParam("ManifestLoader.RetryAttempts","number",2),a=this.config.getParam("ManifestLoader.RetryInterval","number",500)},parse:function(e,t){return this.hlsDemux.reset(),this.debug.log("[HlsParser]","Doing parse."),this.debug.log("[HlsParser]",e),f.call(this,e,t)},updatePlaylist:p,abort:function(){null!==e&&e.abort()}}},d.dependencies.HlsParser.prototype={constructor:d.dependencies.HlsParser},Number.MAX_SAFE_INTEGER||(Number.MAX_SAFE_INTEGER=9007199254740991),l.dependencies.MssParser=function(){"use strict";var e=["AAC","AACL","AVC1","H264","TTML","DFXP"],t={96e3:0,88200:1,64e3:2,48e3:3,44100:4,32e3:5,24e3:6,22050:7,16e3:8,12e3:9,11025:10,8e3:11,7350:12},i={video:"video/mp4",audio:"audio/mp4",text:"application/ttml+xml+mp4"},o=null,s=null,a=function(e){var t,n,r={},o=[],a={},d=null,u=null;for(r.id=this.domParser.getAttributeValue(e,"Name"),r.lang=this.domParser.getAttributeValue(e,"Language"),r.contentType=this.domParser.getAttributeValue(e,"Type"),r.mimeType=i[r.contentType],r.maxWidth=this.domParser.getAttributeValue(e,"MaxWidth"),r.maxHeight=this.domParser.getAttributeValue(e,"MaxHeight"),r.BaseURL=s,(u=this.domParser.getAttributeValue(e,"Subtype"))&&(r.subType=u),a=h.call(this,e),d=this.domParser.getChildNodes(e,"QualityLevel"),n=0;n<d.length;n++)d[n].BaseURL=r.BaseURL,d[n].mimeType=r.mimeType,d[n].Id=r.id+"_"+this.domParser.getAttributeValue(d[n],"Index"),null!==(t=l.call(this,d[n],e))&&(t.SegmentTemplate=a,o.push(t));return 0===o.length?null:(r.Representation=o.length>1?o:o[0],r.Representation_asArray=o,r.SegmentTemplate=a,r)},l=function(t,i){var n={},r=null,o=this.domParser.getAttributeValue(i,"Type");if(n.id=t.Id,n.bandwidth=parseInt(this.domParser.getAttributeValue(t,"Bitrate"),10),n.mimeType=t.mimeType,n.width=parseInt(this.domParser.getAttributeValue(t,"MaxWidth"),10),n.height=parseInt(this.domParser.getAttributeValue(t,"MaxHeight"),10),null!==(r=this.domParser.getAttributeValue(t,"FourCC"))&&""!==r||(r=this.domParser.getAttributeValue(i,"FourCC")),null===r||""===r){if("audio"!==o)return this.errHandler.sendWarning(c.dependencies.ErrorHandler.prototype.MEDIA_ERR_CODEC_UNSUPPORTED,o+" codec/FourCC not provided",{codec:""}),null;r="AAC"}return-1===e.indexOf(r.toUpperCase())?(this.debug.warn("[MssParser] Codec not supported: "+r),null):("H264"===r||"AVC1"===r?n.codecs=d.call(this,t):r.indexOf("AAC")>=0&&(n.codecs=u.call(this,t,r),n.audioSamplingRate=parseInt(this.domParser.getAttributeValue(t,"SamplingRate"),10),n.audioChannels=parseInt(this.domParser.getAttributeValue(t,"Channels"),10)),n.codecPrivateData=""+this.domParser.getAttributeValue(t,"CodecPrivateData"),n.BaseURL=t.BaseURL,n)},d=function(e){var t,i=this.domParser.getAttributeValue(e,"CodecPrivateData").toString();return t=/00000001[0-9]7/.exec(i),"avc1."+(t&&t[0]?i.substr(i.indexOf(t[0])+10,6):void 0)},u=function(e,i){var n,r,o,s,a=0,l=this.domParser.getAttributeValue(e,"CodecPrivateData").toString(),d=parseInt(this.domParser.getAttributeValue(e,"SamplingRate"),10);return"AACH"===i&&(a=5),void 0===l||""===l?(a=2,o=t[d],"AACH"===i?(a=5,l=new Uint8Array(4),s=t[2*d],l[0]=a<<3|o>>1,l[1]=o<<7|e.Channels<<3|s>>1,l[2]=s<<7|8,l[3]=0,(r=new Uint16Array(2))[0]=(l[0]<<8)+l[1],r[1]=(l[2]<<8)+l[3],n=r[0].toString(16),n=r[0].toString(16)+r[1].toString(16)):((l=new Uint8Array(2))[0]=a<<3|o>>1,l[1]=o<<7|parseInt(this.domParser.getAttributeValue(e,"Channels"),10)<<3,(r=new Uint16Array(1))[0]=(l[0]<<8)+l[1],n=r[0].toString(16)),l=(l=""+n).toUpperCase(),e.setAttribute("CodecPrivateData",l)):0===a&&(a=(248&parseInt(l.substr(0,2),16))>>3),"mp4a.40."+a},h=function(e){var t,i={};return t=this.domParser.getAttributeValue(e,"Url").replace("{bitrate}","$Bandwidth$"),t=t.replace("{start time}","$Time$"),i.media=t,i.timescale=1e7,i.SegmentTimeline=f.call(this,e),i},f=function(e){var t,i,n,o,s,a,l={},d=this.domParser.getChildNodes(e,"c"),u=[],c=0;for(n=0;n<d.length;n++)if(t={},(a=this.domParser.getAttributeValue(d[n],"t"))&&r.math.Long.fromString(a).greaterThan(r.math.Long.fromNumber(Number.MAX_SAFE_INTEGER))&&(t.tManifest=a),t.t=parseFloat(a),t.d=parseFloat(this.domParser.getAttributeValue(d[n],"d")),0!==n||t.t||(t.t=0),n>0&&((i=u[u.length-1]).d||(i.tManifest?i.d=r.math.Long.fromString(a).subtract(r.math.Long.fromString(i.tManifest)).toNumber():i.d=t.t-i.t),t.t||(i.tManifest?(t.tManifest=r.math.Long.fromString(i.tManifest).add(r.math.Long.fromNumber(i.d)).toString(),t.t=parseFloat(t.tManifest)):t.t=i.t+i.d)),c+=t.d,u.push(t),s=parseFloat(this.domParser.getAttributeValue(d[n],"r")))for(o=0;o<s-1;o++)i=u[u.length-1],(t={}).t=i.t+i.d,t.d=i.d,i.tManifest&&(t.tManifest=r.math.Long.fromString(i.tManifest).add(r.math.Long.fromNumber(i.d)).toString()),c+=t.d,u.push(t);return l.S=u,l.S_asArray=u,l.duration=c/1e7,l},m=function(e){var t,i,n,r=0;for((e[r+3]<<24)+(e[r+2]<<16)+(e[r+1]<<8)+e[r],(e[(r+=4)+1]<<8)+e[r],r+=2;r<e.length;)if(t=(e[r+1]<<8)+e[r],r+=2,1===t)return i=(e[r+1]<<8)+e[r],r+=2,(n=new Uint8Array(i)).set(e.subarray(r,r+i)),n;return null},g=function(e){y(e,0,3),y(e,1,2),y(e,4,5),y(e,6,7)},y=function(e,t,i){var n=e[t];e[t]=e[i],e[i]=n},_=function(e){var t=e.SegmentTemplate,i=t.SegmentTimeline.S_asArray;if(0!==i.length){var n={start:i[0].t/t.timescale,end:(i[i.length-1].t+i[i.length-1].d)/t.timescale};this.metricsModel.addDVRInfo(e.contentType,new Date,n)}},E=function(e){var t,i,n,r,l,d,u,h,f,y={},E=[],b=this.domParser.getChildNode(o,"SmoothStreamingMedia"),v=this.domParser.getChildNode(b,"Protection"),x=null;y.name="MSS",y.profiles="urn:mpeg:dash:profile:isoff-live:2011";var T=this.domParser.getAttributeValue(b,"IsLive");y.type=null!==T&&"true"===T.toLowerCase()?"dynamic":"static",y.timeShiftBufferDepth=parseFloat(this.domParser.getAttributeValue(b,"DVRWindowLength"))/1e7;var S=parseFloat(this.domParser.getAttributeValue(b,"Duration"));if("dynamic"===y.type&&S>0&&(y.type="static",y.startOver=!0,y.timeShiftBufferDepth=S/1e7),y.mediaPresentationDuration=0===S?1/0:S/1e7,y.BaseURL=s,y.minBufferTime=c.dependencies.BufferExtensions.DEFAULT_MIN_BUFFER_TIME,"dynamic"===y.type&&(y.availabilityStartTime=new Date(e.getTime()-1e3*y.timeShiftBufferDepth)),y.Period=function(){var e,t,i={},n=[],r=this.domParser.getChildNode(o,"SmoothStreamingMedia");for(i.BaseURL=s,t=0;t<r.childNodes.length;t++)"StreamIndex"===r.childNodes[t].nodeName&&null!==(e=a.call(this,r.childNodes[t]))&&n.push(e);return n.length>0&&(i.AdaptationSet=n.length>1?n:n[0]),i.AdaptationSet_asArray=n,i}.call(this),y.Period_asArray=[y.Period],t=y.Period,t.start=0,void 0!==v){if(!c.dependencies.ProtectionController)return y.error={name:c.dependencies.ErrorHandler.prototype.MEDIA_ERR_ENCRYPTED,message:"protected content detected but protection module is not included."},y;(x=this.domParser.getChildNode(v,"ProtectionHeader")).firstChild.data=x.firstChild.data.replace(/\n|\r/g,""),r=function(e){var t,i,n,r;return t=p.decodeArray(e.firstChild.data),i=m(t),i=new Uint16Array(i.buffer),i=String.fromCharCode.apply(null,i),n=(new DOMParser).parseFromString(i,"application/xml"),r=n.querySelector("KID").textContent,r=p.decodeArray(r),g(r),r}(x),(n=function(e){var t,i={},n=this.system.getObject("ksPlayReady");return t={__text:e.firstChild.data,__prefix:"mspr"},i.schemeIdUri=n.schemeIdURI,i.value=n.systemString,i.pro=t,i.pro_asArray=t,i}.call(this,x))["cenc:default_KID"]=r,E.push(n),(n=function(){var e={},t=this.system.getObject("ksWidevine");return e.schemeIdUri=t.schemeIdURI,e.value=t.systemString,e}.call(this,x))["cenc:default_KID"]=r,E.push(n),y.ContentProtection=E.length>1?E:E[0],y.ContentProtection_asArray=E}for(i=t.AdaptationSet_asArray,h=0;h<i.length;h+=1)void 0!==y.ContentProtection&&(i[h].ContentProtection=y.ContentProtection,i[h].ContentProtection_asArray=y.ContentProtection_asArray),"dynamic"===y.type&&(y.timeShiftBufferDepth>0&&"video"===i[h].contentType&&y.timeShiftBufferDepth>i[h].SegmentTemplate.SegmentTimeline.duration&&(y.timeShiftBufferDepth=i[h].SegmentTemplate.SegmentTimeline.duration),_.call(this,i[h]));if(y.timeShiftBufferDepth<y.minBufferTime&&(y.minBufferTime=y.timeShiftBufferDepth),delete y.ContentProtection,delete y.ContentProtection_asArray,"static"===y.type){var D=this.manifestModel.getValue();if(D&&D.timestampOffset)l=D.timestampOffset;else for(h=0;h<i.length;h++)"audio"!==i[h].contentType&&"video"!==i[h].contentType||(d=(u=i[h].SegmentTemplate.SegmentTimeline.S_asArray)[0].t,l||(l=d),l=Math.min(l,d),y.mediaPresentationDuration=Math.min(y.mediaPresentationDuration,i[h].SegmentTemplate.SegmentTimeline.duration));if(l>0){for(y.timestampOffset=l,h=0;h<i.length;h++){for(u=i[h].SegmentTemplate.SegmentTimeline.S_asArray,f=0;f<u.length;f++)u[f].tManifest||(u[f].tManifest=u[f].t),u[f].t-=l;"audio"!==i[h].contentType&&"video"!==i[h].contentType||(t.start=Math.max(u[0].t,t.start))}t.start/=1e7}}return y.mediaPresentationDuration=Math.floor(1e3*y.mediaPresentationDuration)/1e3,t.duration=y.mediaPresentationDuration,y};return{debug:void 0,system:void 0,errHandler:void 0,domParser:void 0,metricsModel:void 0,manifestModel:void 0,parse:function(e,t){this.debug.info("[MssParser]","Doing parse.");var i=new Date,r=null,a=null,l=null;return o=this.domParser.createXmlTree(e),r=new Date,null===o?n.reject(null):(s=t,(a=E.call(this,i)).error?n.reject(a.error):(l=new Date,this.debug.info("[MssParser]","Parsing complete (xmlParser: "+(r.getTime()-i.getTime())+"ms, mss2dash: "+(l.getTime()-r.getTime())+"ms, total: "+((new Date).getTime()-i.getTime())/1e3+"s)"),n.when(a)))}}},l.dependencies.MssParser.prototype={constructor:l.dependencies.MssParser},l.dependencies.MssHandler=function(){"use strict";var e=c.utils.copyMethods(u.dependencies.DashHandler);return e.mp4Processor=void 0,e.getInitRequest=function(t){var i=null,r=null,o=null,s=n.defer();if(!t)throw new Error("MssHandler.getInitRequest(): representation is undefined");r=(i=t.adaptation.period).start,(o=new c.vo.SegmentRequest).streamType=e.getType(),o.type="Initialization Segment",o.url=null;try{o.data=function(t){var i,n,r,o,s,a=e.manifestModel.getValue();if(t.initData)return t.initData;if(i=t.adaptation,n=a.Period_asArray[i.period.index].AdaptationSet_asArray[i.index],r=n.Representation_asArray[t.index],o=new c.vo.Mp4Track,o.type=e.getType()||"und",o.trackId=i.index+1,o.timescale=t.timescale,o.duration=t.adaptation.period.duration,o.codecs=r.codecs,o.codecPrivateData=r.codecPrivateData,o.bandwidth=r.bandwidth,"text"!==o.type&&(s=r.mimeType+';codecs="'+r.codecs+'"',!this.capabilities.supportsCodec(this.videoModel.getElement(),s)))throw{name:c.dependencies.ErrorHandler.prototype.MEDIA_ERR_CODEC_UNSUPPORTED,message:"Codec is not supported (HTMLMediaElement)",data:{codec:s,bandwidth:r.bandwidth,codecPrivateData:r.codecPrivateData}};return n.ContentProtection_asArray&&n.ContentProtection_asArray.length>0&&(o.contentProtection=n.ContentProtection_asArray),o.width=r.width||n.maxWidth,o.height=r.height||n.maxHeight,o.language=n.lang?n.lang:"und",o.channels=function(e,t){var i=1;return e.audioChannels?i=e.audioChannels:t.audioChannels&&(i=t.audioChannels),i}(n,r),o.samplingRate=function(e,t){return e.audioSamplingRate?e.audioSamplingRate:t.audioSamplingRate}(n,r),t.initData=e.mp4Processor.generateInitSegment([o]),t.initData}.call(this,t)}catch(e){return s.reject(e),s.promise}return o.range=t.range,o.availabilityStartTime=this.timelineConverter.calcAvailabilityStartTimeFromPresentationTime(r,t.adaptation.period.mpd,e.getIsDynamic()),o.availabilityEndTime=this.timelineConverter.calcAvailabilityEndTimeFromPresentationTime(r+i.duration,i.mpd,e.getIsDynamic()),o.quality=t.index,s.resolve(o),s.promise},e.getIFrameRequest=function(e){return e&&e.url&&("video"===e.streamType||"audio"===e.streamType)&&(e.url=e.url.replace("Fragments","KeyFrames")),e},e.getFragmentInfoRequest=function(e){return e&&e.url&&(e.url=e.url.replace("Fragments","FragmentInfo"),e.type="FragmentInfo Segment"),e},e},l.dependencies.MssHandler.prototype={constructor:l.dependencies.MssHandler},l.dependencies.MssFragmentController=function(){"use strict";var e=function(e,t,i,n){var o,s,a=this.manifestModel.getValue(),l=!1,d=n.SegmentTemplate.SegmentTimeline.S_asArray,u=n.SegmentTemplate.timescale,c=t.entry,h=null,p=0,f=null,m=n.type;if(this.manifestExt.getIsDynamic(a)||this.manifestExt.getIsStartOver(a)){for(;p<c.length&&(c[p].fragment_absolute_time.greaterThan(r.math.Long.fromNumber(Number.MAX_SAFE_INTEGER))&&(c[p].fragment_absolute_timeManifest=c[p].fragment_absolute_time.toString()),c[p].fragment_absolute_time=c[p].fragment_absolute_time.toNumber(),c[p].fragment_duration=c[p].fragment_duration.toNumber(),!(this.manifestExt.getIsStartOver(a)&&(o=d[0].tManifest?parseFloat(d[0].tManifest):d[0].t,c[p].fragment_absolute_time>o+a.timeShiftBufferDepth*u)));)o=d[d.length-1].tManifest?parseFloat(d[d.length-1].tManifest):d[d.length-1].t,c[p].fragment_absolute_time>o&&(this.debug.log("[MssFragmentController]["+m+"] Add new segment - t = "+c[p].fragment_absolute_time/u),(h={}).t=c[p].fragment_absolute_time,h.d=c[p].fragment_duration,d[0].tManifest&&(h.t-=parseFloat(d[0].tManifest)-d[0].t),c[p].fragment_absolute_timeManifest?h.tManifest=c[p].fragment_absolute_timeManifest:d[0].tManifest&&(h.tManifest=c[p].fragment_absolute_time),d.push(h),l=!0),p+=1;if(this.manifestExt.getIsStartOver(a)){if("video"===m){var g=((h=d[d.length-1]).t+h.d)/u;g>this.videoModel.getDuration()&&this.system.notify("sourceDurationChanged",g)}}else if(a.timeShiftBufferDepth&&a.timeShiftBufferDepth>0){if(l)for(f=(h=d[d.length-1]).t-a.timeShiftBufferDepth*u,h=d[0];h.t<f;)this.debug.log("[MssFragmentController]["+m+"] Remove segment  - t = "+h.t/u),d.splice(0,1),h=d[0];s={start:d[0].t/n.SegmentTemplate.timescale,end:i.baseMediaDecodeTime/n.SegmentTemplate.timescale+e.duration};var y=this.metricsModel.getMetricsFor(n.type).DVRInfo;y&&y.length>0&&s.end>y[y.length-1].range.end&&this.metricsModel.addDVRInfo(n.type,new Date,s)}}},t=function(t,i,n){var r,o,s=0,a=this.manifestModel.getValue(),l=a?this.manifestExt.getIndex(n,a)+1:-1,d=y.deserialize(t),u=null,h=null,p=null,f=null,m=null,g=null,_=null,E=null,b=null,v=null,x=-1,T=0,S=0,D=0,I=0;if(!d)return null;if(u=d.getBoxByType("moof"),h=d.getBoxByType("mdat"),p=u.getBoxByType("traf"),f=p.getBoxByType("trun"),m=p.getBoxByType("tfhd"),o=void 0!==f.samples_table[0].sample_duration?f.samples_table[0].sample_duration:m.default_sample_duration,r=i.duration*i.timescale,1===f.samples_table.length&&o<r&&function(e,t){var i,n,r,o,s,a=null,l=null,d=null,u=null,c=null,h=null;for(a=e.getBoxByType("moof"),l=e.getBoxByType("mdat"),u=(d=a.getBoxByType("traf")).getBoxByType("trun"),i=d.getBoxByType("tfhd"),u.samples_table[0].sample_duration||(u.samples_table[0].sample_duration=i.default_sample_duration),u.flags|=256,i.flags&=16777207,r=Math.floor(t/u.samples_table[0].sample_duration),n=0;n<r-1;n++)u.samples_table.push(u.samples_table[0]);if(u.sample_count=u.samples_table.length,(o=r*u.samples_table[0].sample_duration)<t&&(u.samples_table[u.samples_table.length-1].sample_duration+=t-o),null!==(c=d.getBoxByType("sepiff"))){for(c.sample_count>1&&(c.entry=c.entry.slice(0,1)),n=0;n<r-1;n+=1)c.entry.push(c.entry[0]);c.sample_count=c.entry.length}if(null!==(h=d.getBoxByType("saiz"))){if(0===h.default_sample_info_size)for(h.sample_count>1&&(h.sample_info_size=h.sample_info_size.slice(0,1)),n=0;n<r-1;n+=1)h.sample_info_size.push(h.sample_info_size[0]);h.sample_count=c.entry.length}for(s=l.data,l.data=new Uint8Array(s.length*u.sample_count),n=0;n<u.sample_count;n++)l.data.set(s,s.length*n)}(d,r),m.track_ID=l,p.removeBoxByType("tfxd"),null===(b=p.getBoxByType("tfdt"))&&((b=new y.boxes.TrackFragmentBaseMediaDecodeTimeBox).version=1,b.flags=0,b.baseMediaDecodeTime=Math.floor(i.startTime*i.timescale),x=p.getBoxIndexByType("tfhd"),p.boxes.splice(x+1,0,b)),"dynamic"===a.type){if(null===(v=p.getBoxesByType("tfrf"))||0===v.length)throw{name:c.dependencies.ErrorHandler.prototype.MSS_NO_TFRF,message:"Missing tfrf in live media segment",data:{url:i.url}};for(s=0;s<v.length;s+=1)e.call(this,i,v[s],b,n),p.removeBoxByType("tfrf")}if(null!==(_=p.getBoxByType("sepiff"))&&(_.boxtype="senc",_.extended_type=void 0,null===(g=p.getBoxByType("saio")))){if(g=new y.boxes.SampleAuxiliaryInformationOffsetsBox,g.version=0,g.flags=0,g.entry_count=1,g.offset=[],E=new y.boxes.SampleAuxiliaryInformationSizesBox,E.version=0,E.flags=0,E.sample_count=_.sample_count,E.default_sample_info_size=0,E.sample_info_size=[],2&_.flags)for(s=0;s<_.sample_count;s+=1)E.sample_info_size[s]=10+6*_.entry[s].NumberOfEntries;else E.default_sample_info_size=8;p.boxes.push(E),p.boxes.push(g)}return m.flags&=16777214,m.flags|=131072,f.flags|=1,f.data_offset=0,T=d.getLength(),f.data_offset=T-h.size+8,null!==(g=p.getBoxByType("saio"))&&(S=d.getBoxOffsetByType("moof"),D=u.getBoxOffsetByType("traf"),I=p.getBoxOffsetByType("senc"),g.offset[0]=S+D+I+16),y.serialize(d)},i=c.utils.copyMethods(c.dependencies.FragmentController);return i.manifestModel=void 0,i.manifestExt=void 0,i.metricsModel=void 0,i.videoModel=void 0,i.mediaSourceExt=void 0,i.process=function(i,r,o){var s=n.defer(),a=null,l=this.manifestModel.getValue(),d=null;if(!(null!==i&&void 0!==i&&i.byteLength>0))return s.resolve(null),s.promise;if(a=new Uint8Array(i),l&&o)try{d=l.Period_asArray[o.adaptation.period.index].AdaptationSet_asArray[o.adaptation.index],r&&("Media Segment"===r.type?(a=t.call(this,a,r,d),s.resolve(a||null)):"FragmentInfo Segment"===r.type?(function(t,i,n){var r,o=null,s=null,a=null,l=null,d=null,u=0;if(o=y.deserialize(t),s=o.getBoxByType("moof"),a=s.getBoxByType("traf"),null===(l=a.getBoxByType("tfdt"))&&((l=new y.boxes.TrackFragmentBaseMediaDecodeTimeBox).version=1,l.flags=0,l.baseMediaDecodeTime=Math.floor(i.startTime*i.timescale),r=a.getBoxIndexByType("tfhd"),a.boxes.splice(r+1,0,l)),null===(d=a.getBoxesByType("tfrf"))||0===d.length)throw{name:c.dependencies.ErrorHandler.prototype.MSS_NO_TFRF,message:"Missing tfrf in live FragmentInfo segment",data:{url:i.url}};for(u=0;u<d.length;u+=1)e.call(this,i,d[u],l,n)}.call(this,a,r,d),s.resolve(a)):s.resolve(a))}catch(e){s.reject(e)}else s.resolve(a);return s.promise},i},l.dependencies.MssFragmentController.prototype={constructor:l.dependencies.MssFragmentController},l.dependencies.MssFragmentInfoController=function(){"use strict";var e,t,i,r=!1,o=!1,s=null,a=null,l=null,d=null,u=function(){o&&(this.debug.info("[MssFragmentInfoController]["+e+"] STOP"),s.abortRequestsForModel(a),clearTimeout(i),o=!1)},h=function(){if(o){var i,n=t.getData(),r=n.SegmentTemplate.SegmentTimeline.S_asArray,s=r[r.length-2],a=n.Representation_asArray[0];this.debug.log("[MssFragmentInfoController]["+e+"] Load next fragment for time: "+s.t/n.SegmentTemplate.timescale),i=p(n,a,s),f.call(this,i)}},p=function(t,i,n){var r=t.SegmentTemplate.timescale,o=new c.vo.SegmentRequest;return o.action="download",o.startTime=n.t/r,o.streamType=e,o.type="FragmentInfo Segment",o.duration=n.d/r,o.timescale=r,o.quality=i.quality,o.url=t.BaseURL+t.SegmentTemplate.media,o.url=o.url.replace("$Bandwidth$",i.bandwidth),o.url=o.url.replace("$Time$",n.tManifest?n.tManifest:n.t),o.url=o.url.replace("/Fragments(","/FragmentInfo("),o},f=function(t){s.isFragmentLoadedOrPending(this,t)?this.debug.log("[MssFragmentInfoController]["+e+"] No more fragments"):(this.debug.log("[MssFragmentInfoController]["+e+"] Request fragment info "+t.url),s.prepareFragmentForLoading(this,t,m,g,y,null),s.onBufferControllerStateChange())},m=function(t){this.debug.info("[MssFragmentInfoController]["+e+"] Load request ",null!==t.url?t.url:t.quality)},g=function(i,n){var r,o,a=this,u=t.getAvailableRepresentations()[0];this.debug.log("[MssFragmentInfoController]["+e+"] FragmentInfo loaded ",i.url),d||(d=i.startTime);try{s.process(n.data,i,u).then(function(){r=((new Date).getTime()-l)/1e3,o=i.startTime+i.duration-d,_.call(a,Math.max(0,o-r))})}catch(e){this.errHandler.sendError(c.dependencies.ErrorHandler.prototype.INTERNAL_ERROR,"Internal error while processing fragment info segment",e.message)}},y=function(e){o||this.errHandler.sendWarning(c.dependencies.ErrorHandler.prototype.DOWNLOAD_ERR_CONTENT,"Failed to download fragmentInfo segment",{url:e.url,status:e.status})},_=function(t){var n=this;this.debug.log("[MssFragmentInfoController]["+e+"] Load next fragment in "+t+" s."),clearTimeout(i),i=setTimeout(function(){i=null,h.call(n)},1e3*t)};return{debug:void 0,system:void 0,errHandler:void 0,initialize:function(i,n,o){this.debug.log("[MssFragmentInfoController]["+i+"] Initialize"),t=o,e=i,(a=(s=n).attachBufferController(this)).setType(i),r=!0},reset:function(){return u.call(this),a&&(s.abortRequestsForModel(a),s.detachBufferController(a),a=null),n.when(null)},start:function(){r&&!o&&(this.debug.info("[MssFragmentInfoController]["+e+"] START"),o=!0,l=(new Date).getTime(),h.call(this))},stop:u,isReady:function(){return r}}},l.dependencies.MssFragmentInfoController.prototype={constructor:l.dependencies.MssFragmentInfoController};var h={};h.encode=function(e){for(var t=[],i=0;i<e.length;++i){var n=e.charCodeAt(i);n<128?t.push(n):n<2048?(t.push(192|n>>6),t.push(128|63&n)):n<65536?(t.push(224|n>>12),t.push(128|63&n>>6),t.push(128|63&n)):(t.push(240|n>>18),t.push(128|63&n>>12),t.push(128|63&n>>6),t.push(128|63&n))}return t},h.decode=function(e){for(var t=[],i=0;i<e.length;){var n=e[i++];n<128||(n<224?(n=(31&n)<<6,n|=63&e[i++]):n<240?(n=(15&n)<<12,n|=(63&e[i++])<<6,n|=63&e[i++]):(n=(7&n)<<18,n|=(63&e[i++])<<12,n|=(63&e[i++])<<6,n|=63&e[i++])),t.push(String.fromCharCode(n))}return t.join("")};var p={};if(function(e){var t=function(t){for(var i=0,n=[],r=0|t.length/3;0<r--;){o=(t[i]<<16)+(t[i+1]<<8)+t[i+2];i+=3,n.push(e.charAt(63&o>>18)),n.push(e.charAt(63&o>>12)),n.push(e.charAt(63&o>>6)),n.push(e.charAt(63&o))}if(2==t.length-i){o=(t[i]<<16)+(t[i+1]<<8);n.push(e.charAt(63&o>>18)),n.push(e.charAt(63&o>>12)),n.push(e.charAt(63&o>>6)),n.push("=")}else if(1==t.length-i){var o=t[i]<<16;n.push(e.charAt(63&o>>18)),n.push(e.charAt(63&o>>12)),n.push("==")}return n.join("")},i=function(){for(var t=[],i=0;i<e.length;++i)t[e.charCodeAt(i)]=i;return t["=".charCodeAt(0)]=0,t}(),n=function(e){for(var t=0,n=[],r=0|e.length/4;0<r--;){var o=(i[e.charCodeAt(t)]<<18)+(i[e.charCodeAt(t+1)]<<12)+(i[e.charCodeAt(t+2)]<<6)+i[e.charCodeAt(t+3)];n.push(255&o>>16),n.push(255&o>>8),n.push(255&o),t+=4}return n&&("="==e.charAt(t-2)?(n.pop(),n.pop()):"="==e.charAt(t-1)&&n.pop()),n},r={};r.encode=function(e){for(var t=[],i=0;i<e.length;++i)t.push(e.charCodeAt(i));return t},r.decode=function(e){for(var t=0;t<s.length;++t)a[t]=String.fromCharCode(a[t]);return a.join("")},p.decodeArray=function(e){var t=n(e);return new Uint8Array(t)},p.encodeASCII=function(e){var i=r.encode(e);return t(i)},p.decodeASCII=function(e){var t=n(e);return r.decode(t)},p.encode=function(e){var i=h.encode(e);return t(i)},p.decode=function(e){var t=n(e);return h.decode(t)}}("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"),void 0===f)var f=p.encode;if(void 0===m)var m=p.decode;if(function(e){"use strict";var t={VERSION:"0.5.3"};t.System=function(){this._mappings={},this._outlets={},this._handlers={},this.strictInjections=!0,this.autoMapOutlets=!1,this.postInjectionHook="setup"},t.System.prototype={_createAndSetupInstance:function(e,t){var i=new t;return this.injectInto(i,e),i},_retrieveFromCacheOrCreate:function(e,t){void 0===t&&(t=!1);var i;if(!this._mappings.hasOwnProperty(e))throw new Error(1e3);var n=this._mappings[e];return!t&&n.isSingleton?(null==n.object&&(n.object=this._createAndSetupInstance(e,n.clazz)),i=n.object):i=n.clazz?this._createAndSetupInstance(e,n.clazz):n.object,i},mapOutlet:function(e,t,i){if(void 0===e)throw new Error(1010);return t=t||"global",i=i||e,this._outlets.hasOwnProperty(t)||(this._outlets[t]={}),this._outlets[t][i]=e,this},getObject:function(e){if(void 0===e)throw new Error(1020);return this._retrieveFromCacheOrCreate(e)},mapValue:function(e,t){if(void 0===e)throw new Error(1030);return this._mappings[e]={clazz:null,object:t,isSingleton:!0},this.autoMapOutlets&&this.mapOutlet(e),this.hasMapping(e)&&this.injectInto(t,e),this},hasMapping:function(e){if(void 0===e)throw new Error(1040);return this._mappings.hasOwnProperty(e)},mapClass:function(e,t){if(void 0===e)throw new Error(1050);if(void 0===t)throw new Error(1051);return this._mappings[e]={clazz:t,object:null,isSingleton:!1},this.autoMapOutlets&&this.mapOutlet(e),this},mapSingleton:function(e,t){if(void 0===e)throw new Error(1060);if(void 0===t)throw new Error(1061);return this._mappings[e]={clazz:t,object:null,isSingleton:!0},this.autoMapOutlets&&this.mapOutlet(e),this},instantiate:function(e){if(void 0===e)throw new Error(1070);return this._retrieveFromCacheOrCreate(e,!0)},injectInto:function(e,t){if(void 0===e)throw new Error(1080);if("object"==typeof e){var i=[];this._outlets.hasOwnProperty("global")&&i.push(this._outlets.global),void 0!==t&&this._outlets.hasOwnProperty(t)&&i.push(this._outlets[t]);for(var n in i){var r=i[n];for(var o in r){var s=r[o];(!this.strictInjections||o in e)&&(e[o]=this.getObject(s))}}"setup"in e&&e.setup.call(e)}return this},unmap:function(e){if(void 0===e)throw new Error(1090);return delete this._mappings[e],this},unmapOutlet:function(e,t){if(void 0===e)throw new Error(1100);if(void 0===t)throw new Error(1101);return delete this._outlets[e][t],this},mapHandler:function(e,t,i,n,r){if(void 0===e)throw new Error(1110);return t=t||"global",i=i||e,void 0===n&&(n=!1),void 0===r&&(r=!1),this._handlers.hasOwnProperty(e)||(this._handlers[e]={}),this._handlers[e].hasOwnProperty(t)||(this._handlers[e][t]=[]),this._handlers[e][t].push({handler:i,oneShot:n,passEvent:r}),this},unmapHandler:function(e,t,i){if(void 0===e)throw new Error(1120);if(t=t||"global",this._handlers.hasOwnProperty(e)&&this._handlers[e].hasOwnProperty(t)){var n=this._handlers[e][t];for(var r in n){var o=n[r];if(!i||o.handler===i){n.splice(r,1);break}}}return this},notify:function(e){if(void 0===e)throw new Error(1130);var t=Array.prototype.slice.call(arguments),i=t.slice(1);if(this._handlers.hasOwnProperty(e)){var n=this._handlers[e];for(var r in n){var o,s=n[r];"global"!==r&&(o=this.getObject(r));var a,l,d=[];for(a=0,l=s.length;a<l;a++){var u,c=s[a];u=o&&"string"==typeof c.handler?o[c.handler]:c.handler,c.oneShot&&d.unshift(a),c.passEvent?u.apply(o,t):u.apply(o,i)}for(a=0,l=d.length;a<l;a++)s.splice(d[a],1)}}return this}},e.dijon=t}(this),r={},r.math={},r.math.Long=function(e,t){this.low_=0|e,this.high_=0|t},r.math.Long.IntCache_={},r.math.Long.fromInt=function(e){if(-128<=e&&e<128){var t=r.math.Long.IntCache_[e];if(t)return t}var i=new r.math.Long(0|e,e<0?-1:0);return-128<=e&&e<128&&(r.math.Long.IntCache_[e]=i),i},r.math.Long.fromNumber=function(e){return isNaN(e)||!isFinite(e)?r.math.Long.ZERO:e<=-r.math.Long.TWO_PWR_63_DBL_?r.math.Long.MIN_VALUE:e+1>=r.math.Long.TWO_PWR_63_DBL_?r.math.Long.MAX_VALUE:e<0?r.math.Long.fromNumber(-e).negate():new r.math.Long(e%r.math.Long.TWO_PWR_32_DBL_|0,e/r.math.Long.TWO_PWR_32_DBL_|0)},r.math.Long.fromBits=function(e,t){return new r.math.Long(e,t)},r.math.Long.fromString=function(e,t){if(0==e.length)throw Error("number format error: empty string");var i=t||10;if(i<2||36<i)throw Error("radix out of range: "+i);if("-"==e.charAt(0))return r.math.Long.fromString(e.substring(1),i).negate();if(e.indexOf("-")>=0)throw Error('number format error: interior "-" character: '+e);for(var n=r.math.Long.fromNumber(Math.pow(i,8)),o=r.math.Long.ZERO,s=0;s<e.length;s+=8){var a=Math.min(8,e.length-s),l=parseInt(e.substring(s,s+a),i);if(a<8){var d=r.math.Long.fromNumber(Math.pow(i,a));o=o.multiply(d).add(r.math.Long.fromNumber(l))}else o=(o=o.multiply(n)).add(r.math.Long.fromNumber(l))}return o},r.math.Long.TWO_PWR_16_DBL_=65536,r.math.Long.TWO_PWR_24_DBL_=1<<24,r.math.Long.TWO_PWR_32_DBL_=r.math.Long.TWO_PWR_16_DBL_*r.math.Long.TWO_PWR_16_DBL_,r.math.Long.TWO_PWR_31_DBL_=r.math.Long.TWO_PWR_32_DBL_/2,r.math.Long.TWO_PWR_48_DBL_=r.math.Long.TWO_PWR_32_DBL_*r.math.Long.TWO_PWR_16_DBL_,r.math.Long.TWO_PWR_64_DBL_=r.math.Long.TWO_PWR_32_DBL_*r.math.Long.TWO_PWR_32_DBL_,r.math.Long.TWO_PWR_63_DBL_=r.math.Long.TWO_PWR_64_DBL_/2,r.math.Long.ZERO=r.math.Long.fromInt(0),r.math.Long.ONE=r.math.Long.fromInt(1),r.math.Long.NEG_ONE=r.math.Long.fromInt(-1),r.math.Long.MAX_VALUE=r.math.Long.fromBits(-1,2147483647),r.math.Long.MIN_VALUE=r.math.Long.fromBits(0,-2147483648),r.math.Long.TWO_PWR_24_=r.math.Long.fromInt(1<<24),r.math.Long.prototype.toInt=function(){return this.low_},r.math.Long.prototype.toNumber=function(){return this.high_*r.math.Long.TWO_PWR_32_DBL_+this.getLowBitsUnsigned()},r.math.Long.prototype.toString=function(e){var t=e||10;if(t<2||36<t)throw Error("radix out of range: "+t);if(this.isZero())return"0";if(this.isNegative()){if(this.equals(r.math.Long.MIN_VALUE)){var i=r.math.Long.fromNumber(t),n=this.div(i),o=n.multiply(i).subtract(this);return n.toString(t)+o.toInt().toString(t)}return"-"+this.negate().toString(t)}for(var s=r.math.Long.fromNumber(Math.pow(t,6)),o=this,a="";;){var l=o.div(s),d=o.subtract(l.multiply(s)).toInt().toString(t);if((o=l).isZero())return d+a;for(;d.length<6;)d="0"+d;a=""+d+a}},r.math.Long.prototype.getHighBits=function(){return this.high_},r.math.Long.prototype.getLowBits=function(){return this.low_},r.math.Long.prototype.getLowBitsUnsigned=function(){return this.low_>=0?this.low_:r.math.Long.TWO_PWR_32_DBL_+this.low_},r.math.Long.prototype.getNumBitsAbs=function(){if(this.isNegative())return this.equals(r.math.Long.MIN_VALUE)?64:this.negate().getNumBitsAbs();for(var e=0!=this.high_?this.high_:this.low_,t=31;t>0&&0==(e&1<<t);t--);return 0!=this.high_?t+33:t+1},r.math.Long.prototype.isZero=function(){return 0==this.high_&&0==this.low_},r.math.Long.prototype.isNegative=function(){return this.high_<0},r.math.Long.prototype.isOdd=function(){return 1==(1&this.low_)},r.math.Long.prototype.equals=function(e){return this.high_==e.high_&&this.low_==e.low_},r.math.Long.prototype.notEquals=function(e){return this.high_!=e.high_||this.low_!=e.low_},r.math.Long.prototype.lessThan=function(e){return this.compare(e)<0},r.math.Long.prototype.lessThanOrEqual=function(e){return this.compare(e)<=0},r.math.Long.prototype.greaterThan=function(e){return this.compare(e)>0},r.math.Long.prototype.greaterThanOrEqual=function(e){return this.compare(e)>=0},r.math.Long.prototype.compare=function(e){if(this.equals(e))return 0;var t=this.isNegative(),i=e.isNegative();return t&&!i?-1:!t&&i?1:this.subtract(e).isNegative()?-1:1},r.math.Long.prototype.negate=function(){return this.equals(r.math.Long.MIN_VALUE)?r.math.Long.MIN_VALUE:this.not().add(r.math.Long.ONE)},r.math.Long.prototype.add=function(e){var t=this.high_>>>16,i=65535&this.high_,n=this.low_>>>16,o=65535&this.low_,s=e.high_>>>16,a=65535&e.high_,l=e.low_>>>16,d=0,u=0,c=0,h=0;return h+=o+(65535&e.low_),c+=h>>>16,h&=65535,c+=n+l,u+=c>>>16,c&=65535,u+=i+a,d+=u>>>16,u&=65535,d+=t+s,d&=65535,r.math.Long.fromBits(c<<16|h,d<<16|u)},r.math.Long.prototype.subtract=function(e){return this.add(e.negate())},r.math.Long.prototype.multiply=function(e){if(this.isZero())return r.math.Long.ZERO;if(e.isZero())return r.math.Long.ZERO;if(this.equals(r.math.Long.MIN_VALUE))return e.isOdd()?r.math.Long.MIN_VALUE:r.math.Long.ZERO;if(e.equals(r.math.Long.MIN_VALUE))return this.isOdd()?r.math.Long.MIN_VALUE:r.math.Long.ZERO;if(this.isNegative())return e.isNegative()?this.negate().multiply(e.negate()):this.negate().multiply(e).negate();if(e.isNegative())return this.multiply(e.negate()).negate();if(this.lessThan(r.math.Long.TWO_PWR_24_)&&e.lessThan(r.math.Long.TWO_PWR_24_))return r.math.Long.fromNumber(this.toNumber()*e.toNumber());var t=this.high_>>>16,i=65535&this.high_,n=this.low_>>>16,o=65535&this.low_,s=e.high_>>>16,a=65535&e.high_,l=e.low_>>>16,d=65535&e.low_,u=0,c=0,h=0,p=0;return p+=o*d,h+=p>>>16,p&=65535,h+=n*d,c+=h>>>16,h&=65535,h+=o*l,c+=h>>>16,h&=65535,c+=i*d,u+=c>>>16,c&=65535,c+=n*l,u+=c>>>16,c&=65535,c+=o*a,u+=c>>>16,c&=65535,u+=t*d+i*l+n*a+o*s,u&=65535,r.math.Long.fromBits(h<<16|p,u<<16|c)},r.math.Long.prototype.div=function(e){if(e.isZero())throw Error("division by zero");if(this.isZero())return r.math.Long.ZERO;if(this.equals(r.math.Long.MIN_VALUE)){if(e.equals(r.math.Long.ONE)||e.equals(r.math.Long.NEG_ONE))return r.math.Long.MIN_VALUE;if(e.equals(r.math.Long.MIN_VALUE))return r.math.Long.ONE;if((n=this.shiftRight(1).div(e).shiftLeft(1)).equals(r.math.Long.ZERO))return e.isNegative()?r.math.Long.ONE:r.math.Long.NEG_ONE;i=this.subtract(e.multiply(n));return n.add(i.div(e))}if(e.equals(r.math.Long.MIN_VALUE))return r.math.Long.ZERO;if(this.isNegative())return e.isNegative()?this.negate().div(e.negate()):this.negate().div(e).negate();if(e.isNegative())return this.div(e.negate()).negate();for(var t=r.math.Long.ZERO,i=this;i.greaterThanOrEqual(e);){for(var n=Math.max(1,Math.floor(i.toNumber()/e.toNumber())),o=Math.ceil(Math.log(n)/Math.LN2),s=o<=48?1:Math.pow(2,o-48),a=r.math.Long.fromNumber(n),l=a.multiply(e);l.isNegative()||l.greaterThan(i);)n-=s,l=(a=r.math.Long.fromNumber(n)).multiply(e);a.isZero()&&(a=r.math.Long.ONE),t=t.add(a),i=i.subtract(l)}return t},r.math.Long.prototype.modulo=function(e){return this.subtract(this.div(e).multiply(e))},r.math.Long.prototype.not=function(){return r.math.Long.fromBits(~this.low_,~this.high_)},r.math.Long.prototype.and=function(e){return r.math.Long.fromBits(this.low_&e.low_,this.high_&e.high_)},r.math.Long.prototype.or=function(e){return r.math.Long.fromBits(this.low_|e.low_,this.high_|e.high_)},r.math.Long.prototype.xor=function(e){return r.math.Long.fromBits(this.low_^e.low_,this.high_^e.high_)},r.math.Long.prototype.shiftLeft=function(e){if(0==(e&=63))return this;var t=this.low_;if(e<32){var i=this.high_;return r.math.Long.fromBits(t<<e,i<<e|t>>>32-e)}return r.math.Long.fromBits(0,t<<e-32)},r.math.Long.prototype.shiftRight=function(e){if(0==(e&=63))return this;var t=this.high_;if(e<32){var i=this.low_;return r.math.Long.fromBits(i>>>e|t<<32-e,t>>e)}return r.math.Long.fromBits(t>>e-32,t>=0?0:-1)},r.math.Long.prototype.shiftRightUnsigned=function(e){if(0==(e&=63))return this;var t=this.high_;if(e<32){var i=this.low_;return r.math.Long.fromBits(i>>>e|t<<32-e,t>>>e)}return 32==e?r.math.Long.fromBits(t,0):r.math.Long.fromBits(t>>>e-32,0)},void 0===g)var g={};void 0===g.Math&&(g.Math={}),g.Math.to64BitNumber=function(e,t){var i,n;return i=new r.math.Long(0,t),n=new r.math.Long(e,0),i.add(n).toNumber()},n=function(){"use strict";function e(e){var t=Function.call;return function(){return t.apply(e,arguments)}}function t(e,t){t.stack&&"object"==typeof e&&null!==e&&e.stack&&-1===e.stack.indexOf(O)&&(e.stack=i(e.stack)+"\n"+O+"\n"+i(t.stack))}function i(e){for(var t=e.split("\n"),i=[],n=0;n<t.length;++n){var r=t[n];(function(e){var t=/at .+ \((.*):(\d+):\d+\)/.exec(e);if(!t)return!1;var i=t[1],n=t[2];return i===S&&n>=I&&n<=K})(r)||function(e){return-1!==e.indexOf("(module.js:")||-1!==e.indexOf("(node.js:")}(r)||i.push(r)}return i.join("\n")}function n(){if(Error.captureStackTrace){var e,t,i=Error.prepareStackTrace;return Error.prepareStackTrace=function(i,n){e=n[1].getFileName(),t=n[1].getLineNumber()},(new Error).stack,Error.prepareStackTrace=i,S=e,t}}function r(e){return f(e)}function o(){function e(e){i&&(t=f(e),R(i,function(e,i){D(function(){t.promiseDispatch.apply(t,i)})},void 0),i=void 0,n=void 0)}var t,i=[],n=[],l=w(o.prototype),d=w(s.prototype);return d.promiseDispatch=function(e,r,o){var s=L(arguments);i?(i.push(s),"when"===r&&o[1]&&n.push(o[1])):D(function(){t.promiseDispatch.apply(t,s)})},d.valueOf=function(){return i?d:t=a(t)},Error.captureStackTrace&&r.longStackJumpLimit>0&&(Error.captureStackTrace(d,o),d.stack=d.stack.substring(d.stack.indexOf("\n")+1)),l.promise=d,l.resolve=e,l.fulfill=function(t){e(p(t))},l.reject=function(t){e(h(t))},l.notify=function(e){i&&R(n,function(t,i){D(function(){i(e)})},void 0)},l}function s(e,t,i,n,r){void 0===t&&(t=function(e){return h(new Error("Promise does not support operation: "+e))});var o=w(s.prototype);return o.promiseDispatch=function(i,n,r){var s;try{s=e[n]?e[n].apply(o,r):t.call(o,n,r)}catch(e){s=h(e)}i&&i(s)},i&&(o.valueOf=i),r&&(o.exception=n),o}function a(e){return l(e)?e.valueOf():e}function l(e){return e&&"function"==typeof e.promiseDispatch}function d(e){return e&&"function"==typeof e.then}function u(e){return!d(a(e))}function c(e){return e=a(e),l(e)&&"exception"in e}function h(e){var t=s({when:function(t){if(t){var i=A(U,this);-1!==i&&(k.splice(i,1),U.splice(i,1))}return t?t(e):this}},function(){return h(e)},function(){return this},e,!0);return U.push(t),k.push(e),t}function p(e){return s({when:function(){return e},get:function(t){return e[t]},set:function(t,i){e[t]=i},delete:function(t){delete e[t]},post:function(t,i){return null==t?e.apply(void 0,i):e[t].apply(e,i)},apply:function(t,i){return e.apply(t,i)},keys:function(){return B(e)}},void 0,function(){return e})}function f(e){return l(e)?e:(e=a(e),d(e)?function(e){var t=o();return D(function(){try{e.then(t.resolve,t.reject,t.notify)}catch(e){t.reject(e)}}),t.promise}(e):p(e))}function m(e,i,n,s){var a=o(),l=!1,d=f(e);return D(function(){d.promiseDispatch(function(e){l||(l=!0,a.resolve(function(e){try{return"function"==typeof i?i(e):e}catch(e){return h(e)}}(e)))},"when",[function(e){l||(l=!0,a.resolve(function(e){if("function"==typeof n){t(e,d);try{return n(e)}catch(e){return h(e)}}return h(e)}(e)))}])}),d.promiseDispatch(void 0,"when",[void 0,function(e){var t,i=!1;try{t=function(e){return"function"==typeof s?s(e):e}(e)}catch(e){if(i=!0,!r.onerror)throw e;r.onerror(e)}i||a.notify(t)}]),a.promise}function g(e,t,i){return m(e,function(e){return x(e).then(function(e){return t.apply(void 0,e)},i)},i)}function y(e,t,i){var n=o();return D(function(){f(e).promiseDispatch(n.resolve,t,i)}),n.promise}function _(e){return function(t){var i=L(arguments,1);return y(t,e,i)}}function E(e,t){var i=L(arguments,2);return H(e,t,i)}function b(e,t){return y(e,"apply",[void 0,t])}function v(e){var t=L(arguments,1);return b(e,t)}function x(e){return m(e,function(e){var t=e.length;if(0===t)return f(e);var i=o();return R(e,function(n,r,o){u(r)?(e[o]=a(r),0==--t&&i.resolve(e)):m(r,function(n){e[o]=n,0==--t&&i.resolve(e)}).fail(i.reject)},void 0),i.promise})}function T(e,t){return m(e,void 0,t)}var S,D,I=n(),M=function(){};"undefined"!=typeof process?D=process.nextTick:"function"==typeof setImmediate?D="undefined"!=typeof window?setImmediate.bind(window):setImmediate:function(){function e(){if(--o,++a>=r){a=0,r*=4;for(var e=s&&Math.min(s-1,r);o<e;)++o,t()}for(;s;){--s;var n=(i=i.next).task;i.task=void 0,n()}a=0}var t,i={task:void 0,next:null},n=i,r=2,o=0,s=0,a=0;if(D=function(e){n=n.next={task:e,next:null},o<++s&&o<r&&(++o,t())},"undefined"!=typeof MessageChannel){var l=new MessageChannel;l.port1.onmessage=e,t=function(){l.port2.postMessage(0)}}else t=function(){setTimeout(e,0)}}();var L=e(Array.prototype.slice),R=e(Array.prototype.reduce||function(e,t){var i=0,n=this.length;if(1===arguments.length)for(;;){if(i in this){t=this[i++];break}if(++i>=n)throw new TypeError}for(;i<n;i++)i in this&&(t=e(t,this[i],i));return t}),A=e(Array.prototype.indexOf||function(e){for(var t=0;t<this.length;t++)if(this[t]===e)return t;return-1}),P=e(Array.prototype.map||function(e,t){var i=this,n=[];return R(i,function(r,o,s){n.push(e.call(t,o,s,i))},void 0),n}),w=Object.create||function(e){function t(){}return t.prototype=e,new t},N=e(Object.prototype.hasOwnProperty),B=Object.keys||function(e){var t=[];for(var i in e)N(e,i)&&t.push(i);return t},F=e(Object.prototype.toString);var C;C="undefined"!=typeof ReturnValue?ReturnValue:function(e){this.value=e};r.longStackJumpLimit=1;var O="From previous event:";r.nextTick=D,r.defer=o;o.prototype.makeNodeResolver=function(){var e=this;return function(t,i){t?e.reject(t):arguments.length>2?e.resolve(L(arguments,1)):e.resolve(i)}},r.promise=function(e){var t=o();return v(e,t.resolve,t.reject,t.notify).fail(t.reject),t.promise};r.makePromise=s;s.prototype.then=function(e,t,i){return m(this,e,t,i)},s.prototype.thenResolve=function(e){return m(this,function(){return e})},R(["isFulfilled","isRejected","isPending","dispatch","when","spread","get","put","set","del","delete","post","send","invoke","keys","fapply","fcall","fbind","all","allResolved","timeout","delay","catch","finally","fail","fin","progress","done","nfcall","nfapply","nfbind","denodeify","nbind","ncall","napply","nbind","npost","nsend","ninvoke","nodeify"],function(e,t){s.prototype[t]=function(){return r[t].apply(r,[this].concat(L(arguments)))}},void 0),s.prototype.toSource=function(){return this.toString()},s.prototype.toString=function(){return"[object Promise]"},r.nearer=a;r.isPromise=l;r.isPromiseAlike=d;r.isPending=function(e){return!u(e)&&!c(e)};r.isFulfilled=u;r.isRejected=c;var U=[],k=[];"undefined"!=typeof process&&process.on&&process.on("exit",function(){for(var e=0;e<k.length;e++){var t=k[e];t&&void 0!==t.stack?console.warn("Unhandled rejected promise:",t.stack):console.warn("Unhandled rejected promise (no stack):",t)}});r.reject=h;r.fulfill=p;r.resolve=f;r.master=function(e){return s({isDef:function(){}},function(t,i){return y(e,t,i)},function(){return a(e)})};r.when=m;r.spread=g;r.async=function(e){return function(){function t(e,t){var o;try{o=i[e](t)}catch(e){return function(e){return"[object StopIteration]"===F(e)||e instanceof C}(e)?e.value:h(e)}return m(o,n,r)}var i=e.apply(this,arguments),n=t.bind(t,"send"),r=t.bind(t,"throw");return n()}};r.return=function(e){throw new C(e)};r.promised=function(e){return function(){return g([this,x(arguments)],function(t,i){return e.apply(t,i)})}};r.dispatch=y;r.dispatcher=_;r.get=_("get"),r.set=_("set"),r.delete=r.del=_("delete");var H=r.post=_("post");r.send=E,r.invoke=E;r.fapply=b;r.try=v,r.fcall=v;r.fbind=function(e){var t=L(arguments,1);return function(){var i=t.concat(L(arguments));return y(e,"apply",[this,i])}};r.keys=_("keys"),r.all=x;r.allResolved=function(e){return m(e,function(e){return e=P(e,f),m(x(P(e,function(e){return m(e,M,M)})),function(){return e})})};r.catch=r.fail=T;r.progress=function(e,t){return m(e,void 0,void 0,t)};r.finally=r.fin=function(e,t){return m(e,function(e){return m(t(),function(){return e})},function(e){return m(t(),function(){return h(e)})})};r.done=function(e,i,n,o){var s=function(i){D(function(){if(t(i,e),!r.onerror)throw i;r.onerror(i)})},a=i||n||o?m(e,i,n,o):e;"object"==typeof process&&process&&process.domain&&(s=process.domain.bind(s));T(a,s)};r.timeout=function(e,t){var i=o(),n=setTimeout(function(){i.reject(new Error("Timed out after "+t+" ms"))},t);return m(e,function(e){clearTimeout(n),i.resolve(e)},function(e){clearTimeout(n),i.reject(e)}),i.promise};r.delay=function(e,t){void 0===t&&(t=e,e=void 0);var i=o();return setTimeout(function(){i.resolve(e)},t),i.promise};r.nfapply=function(e,t){var i=L(t),n=o();return i.push(n.makeNodeResolver()),b(e,i).fail(n.reject),n.promise};r.nfcall=function(e){var t=L(arguments,1),i=o();return t.push(i.makeNodeResolver()),b(e,t).fail(i.reject),i.promise};r.nfbind=function(e){var t=L(arguments,1);return function(){var i=t.concat(L(arguments)),n=o();return i.push(n.makeNodeResolver()),b(e,i).fail(n.reject),n.promise}},r.denodeify=r.nfbind;r.nbind=function(e){var t=L(arguments,1);return function(){var i=t.concat(L(arguments)),n=o();i.push(n.makeNodeResolver());var r=this;return b(function(){return e.apply(r,arguments)},i).fail(n.reject),n.promise}};r.npost=function(e,t,i){var n=L(i||[]),r=o();return n.push(r.makeNodeResolver()),H(e,t,n).fail(r.reject),r.promise};r.nsend=function(e,t){var i=L(arguments,2),n=o();return i.push(n.makeNodeResolver()),H(e,t,i).fail(n.reject),n.promise},r.ninvoke=r.nsend;r.nodeify=function(e,t){{if(!t)return e;e.then(function(e){D(function(){t(null,e)})},function(e){D(function(){t(e)})})}};var K=n();return r}();var y=function(){var e={boxes:{},fields:{},debug:!1,warningHandler:function(e){}},t={};return e.registerTypeBoxes=function(){t.moov=e.boxes.MovieBox,t.moof=e.boxes.MovieFragmentBox,t.ftyp=e.boxes.FileTypeBox,t.mfhd=e.boxes.MovieFragmentHeaderBox,t.mfra=e.boxes.MovieFragmentRandomAccessBox,t.udta=e.boxes.UserDataBox,t.trak=e.boxes.TrackBox,t.edts=e.boxes.EditBox,t.mdia=e.boxes.MediaBox,t.minf=e.boxes.MediaInformationBox,t.dinf=e.boxes.DataInformationBox,t.stbl=e.boxes.SampleTableBox,t.mvex=e.boxes.MovieExtendsBox,t.traf=e.boxes.TrackFragmentBox,t.meta=e.boxes.MetaBox,t.mvhd=e.boxes.MovieHeaderBox,t.mdat=e.boxes.MediaDataBox,t.free=e.boxes.FreeSpaceBox,t.sidx=e.boxes.SegmentIndexBox,t.tkhd=e.boxes.TrackHeaderBox,t.mdhd=e.boxes.MediaHeaderBox,t.mehd=e.boxes.MovieExtendsHeaderBox,t.hdlr=e.boxes.HandlerBox,t.stts=e.boxes.TimeToSampleBox,t.stsc=e.boxes.SampleToChunkBox,t.stco=e.boxes.ChunkOffsetBox,t.trex=e.boxes.TrackExtendsBox,t.vmhd=e.boxes.VideoMediaHeaderBox,t.smhd=e.boxes.SoundMediaHeaderBox,t.dref=e.boxes.DataReferenceBox,t["url "]=e.boxes.DataEntryUrlBox,t["urn "]=e.boxes.DataEntryUrnBox,t.tfhd=e.boxes.TrackFragmentHeaderBox,t.tfdt=e.boxes.TrackFragmentBaseMediaDecodeTimeBox,t.trun=e.boxes.TrackFragmentRunBox,t.stsd=e.boxes.SampleDescriptionBox,t.sdtp=e.boxes.SampleDependencyTableBox,t.avc1=e.boxes.AVC1VisualSampleEntryBox,t.encv=e.boxes.EncryptedVideoBox,t.avcC=e.boxes.AVCConfigurationBox,t.pasp=e.boxes.PixelAspectRatioBox,t.mp4a=e.boxes.MP4AudioSampleEntryBox,t.enca=e.boxes.EncryptedAudioBox,t.esds=e.boxes.ESDBox,t.stsz=e.boxes.SampleSizeBox,t.pssh=e.boxes.ProtectionSystemSpecificHeaderBox,t.senc=e.boxes.SampleEncryptionBox,t.saiz=e.boxes.SampleAuxiliaryInformationSizesBox,t.saio=e.boxes.SampleAuxiliaryInformationOffsetsBox,t.sinf=e.boxes.ProtectionSchemeInformationBox,t.schi=e.boxes.SchemeInformationBox,t.tenc=e.boxes.TrackEncryptionBox,t.schm=e.boxes.SchemeTypeBox,t.elst=e.boxes.EditListBox,t.hmhd=e.boxes.HintMediaHeaderBox,t.nmhd=e.boxes.NullMediaHeaderBox,t.ctts=e.boxes.CompositionOffsetBox,t.cslg=e.boxes.CompositionToDecodeBox,t.stss=e.boxes.SyncSampleBox,t.tref=e.boxes.TrackReferenceBox,t.frma=e.boxes.OriginalFormatBox,t.subs=e.boxes.SubSampleInformationBox,t[JSON.stringify([109,29,155,5,66,213,68,230,128,226,20,29,175,247,87,178])]=e.boxes.TfxdBox,t[JSON.stringify([212,128,126,242,202,57,70,149,142,84,38,203,158,70,167,159])]=e.boxes.TfrfBox,t[JSON.stringify([208,138,79,24,16,243,74,130,182,200,50,216,171,161,131,211])]=e.boxes.PiffProtectionSystemSpecificHeaderBox,t[JSON.stringify([137,116,219,206,123,231,76,81,132,249,113,72,249,136,37,84])]=e.boxes.PiffTrackEncryptionBox,t[JSON.stringify([162,57,79,82,90,155,79,20,162,68,108,66,124,100,141,244])]=e.boxes.PiffSampleEncryptionBox},e.constructorTypeBox=function(e){var t,i;return t=Object.create(e.prototype),i=Array.prototype.slice.call(arguments,1),e.apply(t,i),t},e.searchBox=function(i,n){var r;return(r=n?t[n]:t[i])||(r=e.boxes.UnknownBox),r},e.createBox=function(t,i,n){return e.constructorTypeBox.apply(null,[e.searchBox(t,n),i])},e.deserialize=function(t){var i=new e.boxes.File;try{i.read(t)}catch(t){return e.warningHandler(t.message),null}return i},e.serialize=function(e){var t=e.getLength(),i=new Uint8Array(t);return e.write(i),i},e.ParseException=function(e){this.message=e,this.name="ParseException"},e.DataIntegrityException=function(e){this.message=e,this.name="DataIntegrityException"},e}();"undefined"!=typeof module&&void 0!==module.exports?module.exports=y:window.mp4lib=y,y.fields.readBytes=function(e,t,i){var n=0,r=0;for(r=0;r<i;r++)n<<=8,n+=e[t],t++;return n},y.fields.writeBytes=function(e,t,i,n){var r=0;for(r=0;r<i;r++)e[t+i-r-1]=255&n,n>>=8},y.fields.readString=function(e,t,i){var n,r="";for(n=t;n<t+i;n++)r+=String.fromCharCode(e[n]);return r},y.fields.NumberField=function(e,t){this.bits=e,this.signed=t},y.fields.NumberField.prototype.read=function(e,t){return y.fields.readBytes(e,t,this.bits/8)},y.fields.NumberField.prototype.write=function(e,t,i){y.fields.writeBytes(e,t,this.bits/8,i)},y.fields.NumberField.prototype.getLength=function(){return this.bits/8},y.fields.LongNumberField=function(){},y.fields.LongNumberField.prototype.read=function(e,t){var i=y.fields.readBytes(e,t,4),n=y.fields.readBytes(e,t+4,4);return r.math.Long.fromBits(n,i)},y.fields.LongNumberField.prototype.write=function(e,t,i){var n="function"==typeof i.getLowBits?i:r.math.Long.fromNumber(i),o=n.getLowBits(),s=n.getHighBits();y.fields.writeBytes(e,t,4,s),y.fields.writeBytes(e,t+4,4,o)},y.fields.LongNumberField.prototype.getLength=function(){return 8},y.fields.FixedLenStringField=function(e){this.size=e},y.fields.FixedLenStringField.prototype.read=function(e,t){var i="",n=0;for(n=0;n<this.size;n++)i+=String.fromCharCode(e[t+n]);return i},y.fields.FixedLenStringField.prototype.write=function(e,t,i){var n=0;for(n=0;n<this.size;n++)e[t+n]=i.charCodeAt(n)},y.fields.FixedLenStringField.prototype.getLength=function(){return this.size},y.fields.BoxTypeField=function(){},y.fields.BoxTypeField.prototype.read=function(e,t){var i="",n=0;for(n=0;n<4;n++)i+=String.fromCharCode(e[t+n]);return i},y.fields.BoxTypeField.prototype.write=function(e,t,i){var n=0;for(n=0;n<4;n++)e[t+n]=i.charCodeAt(n)},y.fields.BoxTypeField.prototype.getLength=function(){return 4},y.fields.StringField=function(){},y.fields.StringField.prototype.read=function(e,t,i){var n="",r=0;for(r=t;r<i;r++)if(n+=String.fromCharCode(e[r]),0===e[r])return n;if(i-t<255&&e[0]==String.fromCharCode(i-t))return n=n.substr(1,i-t),y.warningHandler('null-terminated string expected, but found a string "'+n+'", which seems to be length-prefixed instead. Conversion done.'),n;throw new y.ParseException('expected null-terminated string, but end of field reached without termination. Read so far:"'+n+'"')},y.fields.StringField.prototype.write=function(e,t,i){var n=0;for(n=0;n<i.length;n++)e[t+n]=i.charCodeAt(n);e[t+i.length]=0},y.fields.StringField.prototype.getLength=function(e){return e.length},y.fields.ArrayField=function(e,t){this.innerField=e,this.size=t},y.fields.ArrayField.prototype.read=function(e,t){var i=-1,n=[],r=0;for(r=0;r<this.size;r++)n.push(this.innerField.read(e,t)),-1==i&&(i=this.innerField.getLength(n[r])),t+=i;return n},y.fields.FIELD_INT8=new y.fields.NumberField(8,!0),y.fields.FIELD_INT16=new y.fields.NumberField(16,!0),y.fields.FIELD_INT32=new y.fields.NumberField(32,!0),y.fields.FIELD_INT64=new y.fields.LongNumberField,y.fields.FIELD_UINT8=new y.fields.NumberField(8,!1),y.fields.FIELD_UINT16=new y.fields.NumberField(16,!1),y.fields.FIELD_UINT32=new y.fields.NumberField(32,!1),y.fields.FIELD_UINT64=new y.fields.LongNumberField,y.fields.FIELD_BIT8=new y.fields.NumberField(8,!1),y.fields.FIELD_BIT16=new y.fields.NumberField(16,!1),y.fields.FIELD_BIT24=new y.fields.NumberField(24,!1),y.fields.FIELD_BIT32=new y.fields.NumberField(32,!1),y.fields.FIELD_ID=new y.fields.BoxTypeField(4),y.fields.FIELD_STRING=new y.fields.StringField,y.boxes.File=function(){this.boxes=[]},y.boxes.File.prototype.getBoxByType=function(e){var t=0;for(t=0;t<this.boxes.length;t++)if(this.boxes[t].boxtype===e)return this.boxes[t];return null},y.boxes.File.prototype.getLength=function(){var e=0,t=0;for(t=0;t<this.boxes.length;t++)this.boxes[t].computeLength(),e+=this.boxes[t].size;return e},y.boxes.File.prototype.write=function(e){var t=0,i=0;for(i=0;i<this.boxes.length;i++)t=this.boxes[i].write(e,t)},y.boxes.File.prototype.read=function(e){for(var t,i=0,n=null,r=0,o=null,s=0,a=e.length;s<a;)if(i=y.fields.FIELD_UINT32.read(e,s),"uuid"==(n=y.fields.readString(e,s+4,4))&&(r=1==i?16:8,o=new y.fields.ArrayField(y.fields.FIELD_INT8,16).read(e,s+r,s+r+16),o=JSON.stringify(o)),t=y.createBox(n,i,o),"uuid"===n?(s=t.read(e,s+16*y.fields.FIELD_INT8.getLength()+8,s+i),o=null):s=t.read(e,s+8,s+i),y.debug&&(t.__sourceBuffer=e.subarray(s-t.size,s)),t.boxtype&&this.boxes.push(t),t.size<=0||null===t.size)throw new y.ParseException("Problem on size of box "+t.boxtype+", parsing stopped to avoid infinite loop")},y.boxes.File.prototype.getBoxOffsetByType=function(e){var t=0,i=0;for(i=0;i<this.boxes.length;i++){if(this.boxes[i].boxtype===e)return t;t+=this.boxes[i].size}return-1},y.boxes.File.prototype.getBoxIndexByType=function(e){var t=0,i=0;for(i=0;i<this.boxes.length;i++){if(this.boxes[i].boxtype===e)return t;t++}return-1},y.boxes.Box=function(e,t,i,n){this.size=t||null,this.boxtype=e,1===this.size&&n&&(this.largesize=n),i&&(this.extended_type=i),this.localPos=0,this.localEnd=0},y.boxes.Box.prototype.write=function(e,t){this.localPos=t;var i=0;if(this._writeData(e,y.fields.FIELD_UINT32,this.size),this.extended_type?this._writeData(e,y.fields.FIELD_ID,"uuid"):this._writeData(e,y.fields.FIELD_ID,this.boxtype),1===this.size&&this._writeData(e,y.fields.FIELD_INT64,this.largesize),this.extended_type)for(i=0;i<16;i++)this._writeData(e,y.fields.FIELD_INT8,this.extended_type[i])},y.boxes.Box.prototype.getBoxByType=function(e){var t=0;if(this.hasOwnProperty("boxes"))for(t=0;t<this.boxes.length;t++)if(this.boxes[t].boxtype===e)return this.boxes[t];return null},y.boxes.Box.prototype.getBoxesByType=function(e){var t=[],i=0;if(this.hasOwnProperty("boxes"))for(i=0;i<this.boxes.length;i++)this.boxes[i].boxtype===e&&t.push(this.boxes[i]);return t},y.boxes.Box.prototype.removeBoxByType=function(e){var t=0;if(this.hasOwnProperty("boxes"))for(t=0;t<this.boxes.length;t++)this.boxes[t].boxtype===e&&this.boxes.splice(t,1);else y.warningHandler(this.boxtype+"does not have "+e+" box, impossible to remove it")},y.boxes.Box.prototype.getBoxOffsetByType=function(e){var t=8,i=0;if(this.hasOwnProperty("boxes"))for(i=0;i<this.boxes.length;i++){if(this.boxes[i].boxtype===e)return t;t+=this.boxes[i].size}return null},y.boxes.Box.prototype.getBoxIndexByType=function(e){var t=0,i=0;if(this.hasOwnProperty("boxes"))for(i=0;i<this.boxes.length;i++){if(this.boxes[i].boxtype===e)return t;t++}return null},y.boxes.Box.prototype.computeLength=function(){this.size=y.fields.FIELD_UINT32.getLength()+y.fields.FIELD_ID.getLength(),this.extended_type&&(this.size+=16*y.fields.FIELD_INT8.getLength())},y.boxes.Box.prototype._readData=function(e,t){var i=t.read(e,this.localPos,this.localEnd);return this.localPos+=t.getLength(i),i},y.boxes.Box.prototype._writeData=function(e,t,i){if(void 0===i||null===i)throw new y.ParseException("a field to write is null or undefined for box : "+this.boxtype);t.write(e,this.localPos,i),this.localPos+=t.getLength(i)},y.boxes.Box.prototype._writeBuffer=function(e,t,i){e.set(t,this.localPos),this.localPos+=i},y.boxes.Box.prototype._writeArrayData=function(e,t,i){var n=0;if(void 0===i||null===i||0===i.length)throw new y.ParseException("an array to write is null, undefined or length = 0 for box : "+this.boxtype);for(n=0;n<i.length;n++)this._writeData(e,t,i[n])},y.boxes.Box.prototype._readArrayData=function(e,t){var i=[],n=t.getLength(),r=(this.localEnd-this.localPos)/n,o=0;for(o=0;o<r;o++)i.push(t.read(e,this.localPos)),this.localPos+=n;return i},y.boxes.Box.prototype._readArrayFieldData=function(e,t,i){var n=-1,r=[],o=0;for(o=0;o<i;o++)r.push(t.read(e,this.localPos)),-1===n&&(n=t.getLength(r[o])),this.localPos+=n;return r},y.boxes.ContainerBox=function(e,t){y.boxes.Box.call(this,e,t),this.boxes=[]},y.boxes.ContainerBox.prototype=Object.create(y.boxes.Box.prototype),y.boxes.ContainerBox.prototype.constructor=y.boxes.ContainerBox,y.boxes.ContainerBox.prototype.computeLength=function(){y.boxes.Box.prototype.computeLength.call(this);var e=0;for(e=0;e<this.boxes.length;e++)this.boxes[e].computeLength(),this.size+=this.boxes[e].size},y.boxes.ContainerBox.prototype.write=function(e,t){y.boxes.Box.prototype.write.call(this,e,t);var i=0;for(i=0;i<this.boxes.length;i++)this.localPos=this.boxes[i].write(e,this.localPos);return this.localPos},y.boxes.ContainerBox.prototype.read=function(e,t,i){for(var n,r,o=0,s=0,a=null;t<i;)if(o=y.fields.FIELD_UINT32.read(e,t),"uuid"===(n=y.fields.readString(e,t+4,4))&&(s=1==o?16:8,a=new y.fields.ArrayField(y.fields.FIELD_INT8,16).read(e,t+s,t+s+16),a=JSON.stringify(a)),r=y.createBox(n,o,a),"uuid"===n?(t=r.read(e,t+16*y.fields.FIELD_INT8.getLength()+8,t+o),a=null):t=r.read(e,t+8,t+o),y.debug&&(r.__sourceBuffer=e.subarray(t-r.size,t)),r.boxtype&&this.boxes.push(r),r.size<=0||null===r.size)throw new y.ParseException("Problem on size of box "+r.boxtype+", parsing stopped to avoid infinite loop");return t},y.boxes.FullBox=function(e,t,i){y.boxes.Box.call(this,e,t,i),this.version=null,this.flags=null},y.boxes.FullBox.prototype=Object.create(y.boxes.Box.prototype),y.boxes.FullBox.prototype.constructor=y.boxes.FullBox,y.boxes.FullBox.prototype.read=function(e,t,i){this.localPos=t,this.localEnd=i,this.version=this._readData(e,y.fields.FIELD_INT8),this.flags=this._readData(e,y.fields.FIELD_BIT24)},y.boxes.FullBox.prototype.write=function(e,t){y.boxes.Box.prototype.write.call(this,e,t),this._writeData(e,y.fields.FIELD_INT8,this.version),this._writeData(e,y.fields.FIELD_BIT24,this.flags)},y.boxes.FullBox.prototype.getFullBoxAttributesLength=function(){this.size+=y.fields.FIELD_INT8.getLength()+y.fields.FIELD_BIT24.getLength()},y.boxes.FullBox.prototype.computeLength=function(){y.boxes.Box.prototype.computeLength.call(this),y.boxes.FullBox.prototype.getFullBoxAttributesLength.call(this)},y.boxes.ContainerFullBox=function(e,t){y.boxes.FullBox.call(this,e,t),this.boxes=[]},y.boxes.ContainerFullBox.prototype=Object.create(y.boxes.FullBox.prototype),y.boxes.ContainerFullBox.prototype.constructor=y.boxes.ContainerFullBox,y.boxes.ContainerFullBox.prototype.computeLength=function(e){y.boxes.FullBox.prototype.computeLength.call(this);var t=0;for(e&&(this.size+=y.fields.FIELD_UINT32.getLength()),t=0;t<this.boxes.length;t++)this.boxes[t].computeLength(),this.size+=this.boxes[t].size},y.boxes.ContainerFullBox.prototype.read=function(e,t,i,n){y.boxes.FullBox.prototype.read.call(this,e,t,i);var r,o,s=0,a=0,l=null;for(n&&(this.entry_count=this._readData(e,y.fields.FIELD_UINT32));this.localPos<this.localEnd;)if(s=y.fields.FIELD_UINT32.read(e,this.localPos),"uuid"==(r=y.fields.readString(e,this.localPos+4,4))&&(a=1==s?16:8,l=new y.fields.ArrayField(y.fields.FIELD_INT8,16).read(e,this.localPos+a,this.localPos+a+16),l=JSON.stringify(l)),o=y.createBox(r,s,l),"uuid"===r?(this.localPos=o.read(e,this.localPos+16*y.fields.FIELD_INT8.getLength()+8,this.localPos+s),l=null):this.localPos=o.read(e,this.localPos+8,this.localPos+s),y.debug&&(o.__sourceBuffer=e.subarray(this.localPos-o.size,this.localPos)),o.boxtype&&this.boxes.push(o),o.size<=0||null===o.size)throw new y.ParseException("Problem on size of box "+o.boxtype+", parsing stopped to avoid infinite loop");return this.localPos},y.boxes.ContainerFullBox.prototype.write=function(e,t,i){y.boxes.FullBox.prototype.write.call(this,e,t);var n=0;for(!0===i&&this._writeData(e,y.fields.FIELD_UINT32,this.entry_count),n=0;n<this.boxes.length;n++)this.localPos=this.boxes[n].write(e,this.localPos);return this.localPos},y.boxes.UnknownBox=function(e){y.boxes.Box.call(this,null,e)},y.boxes.UnknownBox.prototype=Object.create(y.boxes.Box.prototype),y.boxes.UnknownBox.prototype.constructor=y.boxes.UnknownBox,y.boxes.UnknownBox.prototype.read=function(e,t,i){return this.localPos=t,this.localEnd=i,this.unrecognized_data=e.subarray(this.localPos,this.localEnd),this.localEnd},y.boxes.UnknownBox.prototype.write=function(e,t){return y.boxes.Box.prototype.write.call(this,e,t),this._writeBuffer(e,this.unrecognized_data,this.unrecognized_data.length),this.localPos},y.boxes.UnknownBox.prototype.computeLength=function(){y.boxes.Box.prototype.computeLength.call(this),this.size+=this.unrecognized_data.length},y.boxes.FileTypeBox=function(e){y.boxes.Box.call(this,"ftyp",e)},y.boxes.FileTypeBox.prototype=Object.create(y.boxes.Box.prototype),y.boxes.FileTypeBox.prototype.constructor=y.boxes.FileTypeBox,y.boxes.FileTypeBox.prototype.computeLength=function(){y.boxes.Box.prototype.computeLength.call(this),this.size+=2*y.fields.FIELD_INT32.getLength()+y.fields.FIELD_INT32.getLength()*this.compatible_brands.length},y.boxes.FileTypeBox.prototype.read=function(e,t,i){return this.localPos=t,this.localEnd=i,this.major_brand=this._readData(e,y.fields.FIELD_INT32),this.minor_brand=this._readData(e,y.fields.FIELD_INT32),this.compatible_brands=this._readArrayData(e,y.fields.FIELD_INT32),this.localPos},y.boxes.FileTypeBox.prototype.write=function(e,t){return y.boxes.Box.prototype.write.call(this,e,t),this._writeData(e,y.fields.FIELD_INT32,this.major_brand),this._writeData(e,y.fields.FIELD_INT32,this.minor_brand),this._writeArrayData(e,y.fields.FIELD_INT32,this.compatible_brands),this.localPos},y.boxes.MovieBox=function(e){y.boxes.ContainerBox.call(this,"moov",e)},y.boxes.MovieBox.prototype=Object.create(y.boxes.ContainerBox.prototype),y.boxes.MovieBox.prototype.constructor=y.boxes.MovieBox,y.boxes.MovieFragmentBox=function(e){y.boxes.ContainerBox.call(this,"moof",e)},y.boxes.MovieFragmentBox.prototype=Object.create(y.boxes.ContainerBox.prototype),y.boxes.MovieFragmentBox.prototype.constructor=y.boxes.MovieFragmentBox,y.boxes.MovieFragmentRandomAccessBox=function(e){y.boxes.ContainerBox.call(this,"mfra",e)},y.boxes.MovieFragmentRandomAccessBox.prototype=Object.create(y.boxes.ContainerBox.prototype),y.boxes.MovieFragmentRandomAccessBox.prototype.constructor=y.boxes.MovieFragmentRandomAccessBox,y.boxes.UserDataBox=function(e){y.boxes.ContainerBox.call(this,"udta",e)},y.boxes.UserDataBox.prototype=Object.create(y.boxes.ContainerBox.prototype),y.boxes.UserDataBox.prototype.constructor=y.boxes.UserDataBox,y.boxes.TrackBox=function(e){y.boxes.ContainerBox.call(this,"trak",e)},y.boxes.TrackBox.prototype=Object.create(y.boxes.ContainerBox.prototype),y.boxes.TrackBox.prototype.constructor=y.boxes.TrackBox,y.boxes.EditBox=function(e){y.boxes.ContainerBox.call(this,"edts",e)},y.boxes.EditBox.prototype=Object.create(y.boxes.ContainerBox.prototype),y.boxes.EditBox.prototype.constructor=y.boxes.EditBox,y.boxes.MediaBox=function(e){y.boxes.ContainerBox.call(this,"mdia",e)},y.boxes.MediaBox.prototype=Object.create(y.boxes.ContainerBox.prototype),y.boxes.MediaBox.prototype.constructor=y.boxes.MediaBox,y.boxes.MediaInformationBox=function(e){y.boxes.ContainerBox.call(this,"minf",e)},y.boxes.MediaInformationBox.prototype=Object.create(y.boxes.ContainerBox.prototype),y.boxes.MediaInformationBox.prototype.constructor=y.boxes.MediaInformationBox,y.boxes.DataInformationBox=function(e){y.boxes.ContainerBox.call(this,"dinf",e)},y.boxes.DataInformationBox.prototype=Object.create(y.boxes.ContainerBox.prototype),y.boxes.DataInformationBox.prototype.constructor=y.boxes.DataInformationBox,y.boxes.SampleTableBox=function(e){y.boxes.ContainerBox.call(this,"stbl",e)},y.boxes.SampleTableBox.prototype=Object.create(y.boxes.ContainerBox.prototype),y.boxes.SampleTableBox.prototype.constructor=y.boxes.SampleTableBox,y.boxes.MovieExtendsBox=function(e){y.boxes.ContainerBox.call(this,"mvex",e)},y.boxes.MovieExtendsBox.prototype=Object.create(y.boxes.ContainerBox.prototype),y.boxes.MovieExtendsBox.prototype.constructor=y.boxes.MovieExtendsBox,y.boxes.TrackFragmentBox=function(e){y.boxes.ContainerBox.call(this,"traf",e)},y.boxes.TrackFragmentBox.prototype=Object.create(y.boxes.ContainerBox.prototype),y.boxes.TrackFragmentBox.prototype.constructor=y.boxes.TrackFragmentBox,y.boxes.MetaBox=function(e){y.boxes.ContainerFullBox.call(this,"meta",e)},y.boxes.MetaBox.prototype=Object.create(y.boxes.ContainerFullBox.prototype),y.boxes.MetaBox.prototype.constructor=y.boxes.MetaBox,y.boxes.MetaBox.prototype.computeLength=function(){y.boxes.ContainerFullBox.prototype.computeLength.call(this,!1)},y.boxes.MetaBox.prototype.read=function(e,t,i){return y.boxes.ContainerFullBox.prototype.read.call(this,e,t,i,!1)},y.boxes.MetaBox.prototype.write=function(e,t){return y.boxes.ContainerFullBox.prototype.write.call(this,e,t,!1)},y.boxes.MovieHeaderBox=function(e){y.boxes.FullBox.call(this,"mvhd",e)},y.boxes.MovieHeaderBox.prototype=Object.create(y.boxes.FullBox.prototype),y.boxes.MovieHeaderBox.prototype.constructor=y.boxes.MovieHeaderBox,y.boxes.MovieHeaderBox.prototype.computeLength=function(){y.boxes.FullBox.prototype.computeLength.call(this),this.size+=y.fields.FIELD_INT32.getLength()+2*y.fields.FIELD_INT16.getLength(),this.size+=2*y.fields.FIELD_INT32.getLength()+9*y.fields.FIELD_INT32.getLength(),this.size+=6*y.fields.FIELD_BIT32.getLength()+y.fields.FIELD_UINT32.getLength(),1===this.version?this.size+=3*y.fields.FIELD_UINT64.getLength()+y.fields.FIELD_UINT32.getLength():this.size+=4*y.fields.FIELD_UINT32.getLength()},y.boxes.MovieHeaderBox.prototype.write=function(e,t){return y.boxes.FullBox.prototype.write.call(this,e,t),1===this.version?(this._writeData(e,y.fields.FIELD_UINT64,this.creation_time),this._writeData(e,y.fields.FIELD_UINT64,this.modification_time),this._writeData(e,y.fields.FIELD_UINT32,this.timescale),this._writeData(e,y.fields.FIELD_UINT64,this.duration)):(this._writeData(e,y.fields.FIELD_UINT32,this.creation_time),this._writeData(e,y.fields.FIELD_UINT32,this.modification_time),this._writeData(e,y.fields.FIELD_UINT32,this.timescale),this._writeData(e,y.fields.FIELD_UINT32,this.duration)),this._writeData(e,y.fields.FIELD_INT32,this.rate),this._writeData(e,y.fields.FIELD_INT16,this.volume),this._writeData(e,y.fields.FIELD_INT16,this.reserved),this._writeArrayData(e,y.fields.FIELD_INT32,this.reserved_2),this._writeArrayData(e,y.fields.FIELD_INT32,this.matrix),this._writeArrayData(e,y.fields.FIELD_BIT32,this.pre_defined),this._writeData(e,y.fields.FIELD_UINT32,this.next_track_ID),this.localPos},y.boxes.MovieHeaderBox.prototype.read=function(e,t,i){return y.boxes.FullBox.prototype.read.call(this,e,t,i),1==this.version?(this.creation_time=this._readData(e,y.fields.FIELD_UINT64),this.modification_time=this._readData(e,y.fields.FIELD_UINT64),this.timescale=this._readData(e,y.fields.FIELD_UINT32),this.duration=this._readData(e,y.fields.FIELD_UINT64)):(this.creation_time=this._readData(e,y.fields.FIELD_UINT32),this.modification_time=this._readData(e,y.fields.FIELD_UINT32),this.timescale=this._readData(e,y.fields.FIELD_UINT32),this.duration=this._readData(e,y.fields.FIELD_UINT32)),this.rate=this._readData(e,y.fields.FIELD_INT32),this.volume=this._readData(e,y.fields.FIELD_INT16),this.reserved=this._readData(e,y.fields.FIELD_INT16),this.reserved_2=this._readArrayFieldData(e,y.fields.FIELD_INT32,2),this.matrix=this._readArrayFieldData(e,y.fields.FIELD_INT32,9),this.pre_defined=this._readArrayFieldData(e,y.fields.FIELD_BIT32,6),this.next_track_ID=this._readData(e,y.fields.FIELD_UINT32),this.localPos},y.boxes.MediaDataBox=function(e){y.boxes.Box.call(this,"mdat",e)},y.boxes.MediaDataBox.prototype=Object.create(y.boxes.Box.prototype),y.boxes.MediaDataBox.prototype.constructor=y.boxes.MediaDataBox,y.boxes.MediaDataBox.prototype.computeLength=function(){y.boxes.Box.prototype.computeLength.call(this),this.size+=this.data.length},y.boxes.MediaDataBox.prototype.read=function(e,t,i){return this.data=e.subarray(t,i),i},y.boxes.MediaDataBox.prototype.write=function(e,t){return y.boxes.Box.prototype.write.call(this,e,t),this._writeBuffer(e,this.data,this.data.length),this.localPos},y.boxes.FreeSpaceBox=function(e){y.boxes.Box.call(this,"free",e)},y.boxes.FreeSpaceBox.prototype=Object.create(y.boxes.Box.prototype),y.boxes.FreeSpaceBox.prototype.constructor=y.boxes.FreeSpaceBox,y.boxes.FreeSpaceBox.prototype.computeLength=function(){y.boxes.Box.prototype.computeLength.call(this),this.size+=this.data.length},y.boxes.FreeSpaceBox.prototype.read=function(e,t,i){return this.localPos=t,this.localEnd=i,this.data=e.subarray(this.localPos,this.localEnd),this.localEnd},y.boxes.FreeSpaceBox.prototype.write=function(e,t){return y.boxes.Box.prototype.write.call(this,e,t),this._writeBuffer(e,this.data,this.data.length),this.localPos},y.boxes.SegmentIndexBox=function(e){y.boxes.FullBox.call(this,"sidx",e)},y.boxes.SegmentIndexBox.prototype=Object.create(y.boxes.FullBox.prototype),y.boxes.SegmentIndexBox.prototype.constructor=y.boxes.SegmentIndexBox,y.boxes.SegmentIndexBox.prototype.computeLength=function(){y.boxes.FullBox.prototype.computeLength.call(this),this.size+=2*y.fields.FIELD_UINT32.getLength(),1===this.version?this.size+=2*y.fields.FIELD_UINT64.getLength():this.size+=2*y.fields.FIELD_UINT32.getLength(),this.size+=y.fields.FIELD_UINT16.getLength(),this.size+=y.fields.FIELD_UINT16.getLength(),this.size+=(y.fields.FIELD_UINT64.getLength()+y.fields.FIELD_UINT32.getLength())*this.reference_count},y.boxes.SegmentIndexBox.prototype.read=function(e,t,i){y.boxes.FullBox.prototype.read.call(this,e,t,i);var n=0,r={};for(this.reference_ID=this._readData(e,y.fields.FIELD_UINT32),this.timescale=this._readData(e,y.fields.FIELD_UINT32),1===this.version?(this.earliest_presentation_time=this._readData(e,y.fields.FIELD_UINT64),this.first_offset=this._readData(e,y.fields.FIELD_UINT64)):(this.earliest_presentation_time=this._readData(e,y.fields.FIELD_UINT32),this.first_offset=this._readData(e,y.fields.FIELD_UINT32)),this.reserved=this._readData(e,y.fields.FIELD_UINT16),this.reference_count=this._readData(e,y.fields.FIELD_UINT16),this.references=[],n=0;n<this.reference_count;n++)(r={}).reference_info=this._readData(e,y.fields.FIELD_UINT64),r.SAP=this._readData(e,y.fields.FIELD_UINT32),this.references.push(r);return this.localPos},y.boxes.SegmentIndexBox.prototype.write=function(e,t){y.boxes.FullBox.prototype.write.call(this,e,t);var i=0;for(this._writeData(e,y.fields.FIELD_UINT32,this.reference_ID),this._writeData(e,y.fields.FIELD_UINT32,this.timescale),1===this.version?(this._writeData(e,y.fields.FIELD_UINT64,this.earliest_presentation_time),this._writeData(e,y.fields.FIELD_UINT64,this.first_offset)):(this._writeData(e,y.fields.FIELD_UINT32,this.earliest_presentation_time),this._writeData(e,y.fields.FIELD_UINT32,this.first_offset)),this._writeData(e,y.fields.FIELD_UINT16,this.reserved),this._writeData(e,y.fields.FIELD_UINT16,this.reference_count),i=0;i<this.reference_count;i++)this._writeData(e,y.fields.FIELD_UINT64,this.references[i].reference_info),this._writeData(e,y.fields.FIELD_UINT32,this.references[i].SAP);return this.localPos},y.boxes.TrackHeaderBox=function(e){y.boxes.FullBox.call(this,"tkhd",e)},y.boxes.TrackHeaderBox.prototype=Object.create(y.boxes.FullBox.prototype),y.boxes.TrackHeaderBox.prototype.constructor=y.boxes.TrackHeaderBox,y.boxes.TrackHeaderBox.prototype.computeLength=function(){y.boxes.FullBox.prototype.computeLength.call(this),this.size+=4*y.fields.FIELD_INT16.getLength()+2*y.fields.FIELD_INT32.getLength()+2*y.fields.FIELD_UINT32.getLength()+9*y.fields.FIELD_INT32.getLength(),1==this.version?this.size+=3*y.fields.FIELD_UINT64.getLength()+2*y.fields.FIELD_UINT32.getLength():this.size+=5*y.fields.FIELD_UINT32.getLength()},y.boxes.TrackHeaderBox.prototype.read=function(e,t,i){return y.boxes.FullBox.prototype.read.call(this,e,t,i),1===this.version?(this.creation_time=this._readData(e,y.fields.FIELD_UINT64),this.modification_time=this._readData(e,y.fields.FIELD_UINT64),this.track_id=this._readData(e,y.fields.FIELD_UINT32),this.reserved=this._readData(e,y.fields.FIELD_UINT32),this.duration=this._readData(e,y.fields.FIELD_UINT64)):(this.creation_time=this._readData(e,y.fields.FIELD_UINT32),this.modification_time=this._readData(e,y.fields.FIELD_UINT32),this.track_id=this._readData(e,y.fields.FIELD_UINT32),this.reserved=this._readData(e,y.fields.FIELD_UINT32),this.duration=this._readData(e,y.fields.FIELD_UINT32)),this.reserved_2=this._readArrayFieldData(e,y.fields.FIELD_UINT32,2),this.layer=this._readData(e,y.fields.FIELD_INT16),this.alternate_group=this._readData(e,y.fields.FIELD_INT16),this.volume=this._readData(e,y.fields.FIELD_INT16),this.reserved_3=this._readData(e,y.fields.FIELD_INT16),this.matrix=this._readArrayFieldData(e,y.fields.FIELD_INT32,9),this.width=this._readData(e,y.fields.FIELD_INT32),this.height=this._readData(e,y.fields.FIELD_INT32),this.localPos},y.boxes.TrackHeaderBox.prototype.write=function(e,t){return y.boxes.FullBox.prototype.write.call(this,e,t),1===this.version?(this._writeData(e,y.fields.FIELD_UINT64,this.creation_time),this._writeData(e,y.fields.FIELD_UINT64,this.modification_time),this._writeData(e,y.fields.FIELD_UINT32,this.track_id),this._writeData(e,y.fields.FIELD_UINT32,this.reserved),this._writeData(e,y.fields.FIELD_UINT64,this.duration)):(this._writeData(e,y.fields.FIELD_UINT32,this.creation_time),this._writeData(e,y.fields.FIELD_UINT32,this.modification_time),this._writeData(e,y.fields.FIELD_UINT32,this.track_id),this._writeData(e,y.fields.FIELD_UINT32,this.reserved),this._writeData(e,y.fields.FIELD_UINT32,this.duration)),this._writeArrayData(e,y.fields.FIELD_UINT32,this.reserved_2),this._writeData(e,y.fields.FIELD_INT16,this.layer),this._writeData(e,y.fields.FIELD_INT16,this.alternate_group),this._writeData(e,y.fields.FIELD_INT16,this.volume),this._writeData(e,y.fields.FIELD_INT16,this.reserved_3),this._writeArrayData(e,y.fields.FIELD_INT32,this.matrix),this._writeData(e,y.fields.FIELD_INT32,this.width),this._writeData(e,y.fields.FIELD_INT32,this.height),this.localPos},y.boxes.MediaHeaderBox=function(e){y.boxes.FullBox.call(this,"mdhd",e)},y.boxes.MediaHeaderBox.prototype=Object.create(y.boxes.FullBox.prototype),y.boxes.MediaHeaderBox.prototype.constructor=y.boxes.MediaHeaderBox,y.boxes.MediaHeaderBox.prototype.computeLength=function(){y.boxes.FullBox.prototype.computeLength.call(this),this.size+=2*y.fields.FIELD_UINT16.getLength(),1==this.version?this.size+=3*y.fields.FIELD_UINT64.getLength()+y.fields.FIELD_UINT32.getLength():this.size+=4*y.fields.FIELD_UINT32.getLength()},y.boxes.MediaHeaderBox.prototype.read=function(e,t,i){return y.boxes.FullBox.prototype.read.call(this,e,t,i),1===this.version?(this.creation_time=this._readData(e,y.fields.FIELD_UINT64),this.modification_time=this._readData(e,y.fields.FIELD_UINT64),this.timescale=this._readData(e,y.fields.FIELD_UINT32),this.duration=this._readData(e,y.fields.FIELD_UINT64)):(this.creation_time=this._readData(e,y.fields.FIELD_UINT32),this.modification_time=this._readData(e,y.fields.FIELD_UINT32),this.timescale=this._readData(e,y.fields.FIELD_UINT32),this.duration=this._readData(e,y.fields.FIELD_UINT32)),this.language=this._readData(e,y.fields.FIELD_UINT16),this.pre_defined=this._readData(e,y.fields.FIELD_UINT16),this.localPos},y.boxes.MediaHeaderBox.prototype.write=function(e,t){return y.boxes.FullBox.prototype.write.call(this,e,t),1===this.version?(this._writeData(e,y.fields.FIELD_UINT64,this.creation_time),this._writeData(e,y.fields.FIELD_UINT64,this.modification_time),this._writeData(e,y.fields.FIELD_UINT32,this.timescale),this._writeData(e,y.fields.FIELD_UINT64,this.duration)):(this._writeData(e,y.fields.FIELD_UINT32,this.creation_time),this._writeData(e,y.fields.FIELD_UINT32,this.modification_time),this._writeData(e,y.fields.FIELD_UINT32,this.timescale),this._writeData(e,y.fields.FIELD_UINT32,this.duration)),this._writeData(e,y.fields.FIELD_UINT16,this.language),this._writeData(e,y.fields.FIELD_UINT16,this.pre_defined),this.localPos},y.boxes.MovieExtendsHeaderBox=function(e){y.boxes.FullBox.call(this,"mehd",e)},y.boxes.MovieExtendsHeaderBox.prototype=Object.create(y.boxes.FullBox.prototype),y.boxes.MovieExtendsHeaderBox.prototype.constructor=y.boxes.MovieExtendsHeaderBox,y.boxes.MovieExtendsHeaderBox.prototype.computeLength=function(){y.boxes.FullBox.prototype.computeLength.call(this),1==this.version?this.size+=y.fields.FIELD_UINT64.getLength():this.size+=y.fields.FIELD_UINT32.getLength()},y.boxes.MovieExtendsHeaderBox.prototype.read=function(e,t,i){return y.boxes.FullBox.prototype.read.call(this,e,t,i),1===this.version?this.fragment_duration=this._readData(e,y.fields.FIELD_UINT64):this.fragment_duration=this._readData(e,y.fields.FIELD_UINT32),this.localPos},y.boxes.MovieExtendsHeaderBox.prototype.write=function(e,t){return y.boxes.FullBox.prototype.write.call(this,e,t),1===this.version?this._writeData(e,y.fields.FIELD_UINT64,this.fragment_duration):this._writeData(e,y.fields.FIELD_UINT32,this.fragment_duration),this.localPos},y.boxes.HandlerBox=function(e){y.boxes.FullBox.call(this,"hdlr",e)},y.boxes.HandlerBox.prototype=Object.create(y.boxes.FullBox.prototype),y.boxes.HandlerBox.prototype.constructor=y.boxes.HandlerBox,y.boxes.HandlerBox.prototype.HANDLERTYPEVIDEO="vide",y.boxes.HandlerBox.prototype.HANDLERTYPEAUDIO="soun",y.boxes.HandlerBox.prototype.HANDLERTYPETEXT="meta",y.boxes.HandlerBox.prototype.HANDLERVIDEONAME="Video Track",y.boxes.HandlerBox.prototype.HANDLERAUDIONAME="Audio Track",y.boxes.HandlerBox.prototype.HANDLERTEXTNAME="Text Track",y.boxes.HandlerBox.prototype.computeLength=function(){y.boxes.FullBox.prototype.computeLength.call(this),this.size+=2*y.fields.FIELD_UINT32.getLength()+3*y.fields.FIELD_UINT32.getLength()+y.fields.FIELD_STRING.getLength(this.name)},y.boxes.HandlerBox.prototype.read=function(e,t,i){return y.boxes.FullBox.prototype.read.call(this,e,t,i),this.pre_defined=this._readData(e,y.fields.FIELD_UINT32),this.handler_type=this._readData(e,y.fields.FIELD_UINT32),this.reserved=this._readArrayFieldData(e,y.fields.FIELD_UINT32,3),this.name=this._readData(e,y.fields.FIELD_STRING),this.localPos},y.boxes.HandlerBox.prototype.write=function(e,t){return y.boxes.FullBox.prototype.write.call(this,e,t),this._writeData(e,y.fields.FIELD_UINT32,this.pre_defined),this._writeData(e,y.fields.FIELD_UINT32,this.handler_type),this._writeArrayData(e,y.fields.FIELD_UINT32,this.reserved),this._writeData(e,y.fields.FIELD_STRING,this.name),this.localPos},y.boxes.TimeToSampleBox=function(e){y.boxes.FullBox.call(this,"stts",e)},y.boxes.TimeToSampleBox.prototype=Object.create(y.boxes.FullBox.prototype),y.boxes.TimeToSampleBox.prototype.constructor=y.boxes.TimeToSampleBox,y.boxes.TimeToSampleBox.prototype.computeLength=function(){y.boxes.FullBox.prototype.computeLength.call(this),this.size+=y.fields.FIELD_UINT32.getLength(),this.size+=this.entry_count*(2*y.fields.FIELD_UINT32.getLength())},y.boxes.TimeToSampleBox.prototype.read=function(e,t,i){y.boxes.FullBox.prototype.read.call(this,e,t,i);var n=0,r={};for(this.entry_count=this._readData(e,y.fields.FIELD_UINT32),this.entry=[],n=0;n<this.entry_count;n++)(r={}).sample_count=this._readData(e,y.fields.FIELD_UINT32),r.sample_delta=this._readData(e,y.fields.FIELD_UINT32),this.entry.push(r);return this.localPos},y.boxes.TimeToSampleBox.prototype.write=function(e,t){y.boxes.FullBox.prototype.write.call(this,e,t);var i=0;for(this._writeData(e,y.fields.FIELD_UINT32,this.entry_count),i=0;i<this.entry_count;i++)this._writeData(e,y.fields.FIELD_UINT32,this.entry[i].sample_count),this._writeData(e,y.fields.FIELD_UINT32,this.entry[i].sample_delta);return this.localPos},y.boxes.SampleToChunkBox=function(e){y.boxes.FullBox.call(this,"stsc",e)},y.boxes.SampleToChunkBox.prototype=Object.create(y.boxes.FullBox.prototype),y.boxes.SampleToChunkBox.prototype.constructor=y.boxes.SampleToChunkBox,y.boxes.SampleToChunkBox.prototype.computeLength=function(){y.boxes.FullBox.prototype.computeLength.call(this),this.size+=y.fields.FIELD_UINT32.getLength(),this.size+=this.entry_count*(3*y.fields.FIELD_UINT32.getLength())},y.boxes.SampleToChunkBox.prototype.read=function(e,t,i){y.boxes.FullBox.prototype.read.call(this,e,t,i);var n=0,r={};for(this.entry_count=this._readData(e,y.fields.FIELD_UINT32),this.entry=[],n=0;n<this.entry_count;n++)(r={}).first_chunk=this._readData(e,y.fields.FIELD_UINT32),r.samples_per_chunk=this._readData(e,y.fields.FIELD_UINT32),r.samples_description_index=this._readData(e,y.fields.FIELD_UINT32),this.entry.push(r);return this.localPos},y.boxes.SampleToChunkBox.prototype.write=function(e,t){y.boxes.FullBox.prototype.write.call(this,e,t);var i=0;for(this._writeData(e,y.fields.FIELD_UINT32,this.entry_count),i=0;i<this.entry_count;i++)this._writeData(e,y.fields.FIELD_UINT32,this.entry[i].first_chunk),this._writeData(e,y.fields.FIELD_UINT32,this.entry[i].samples_per_chunk),this._writeData(e,y.fields.FIELD_UINT32,this.entry[i].samples_description_index);return this.localPos},y.boxes.ChunkOffsetBox=function(e){y.boxes.FullBox.call(this,"stco",e)},y.boxes.ChunkOffsetBox.prototype=Object.create(y.boxes.FullBox.prototype),y.boxes.ChunkOffsetBox.prototype.constructor=y.boxes.ChunkOffsetBox,y.boxes.ChunkOffsetBox.prototype.computeLength=function(){y.boxes.FullBox.prototype.computeLength.call(this),this.size+=y.fields.FIELD_UINT32.getLength()+this.entry_count*y.fields.FIELD_UINT32.getLength()},y.boxes.ChunkOffsetBox.prototype.read=function(e,t,i){return y.boxes.FullBox.prototype.read.call(this,e,t,i),this.entry_count=this._readData(e,y.fields.FIELD_UINT32),this.chunk_offset=this._readArrayFieldData(e,y.fields.FIELD_UINT32,this.entry_count),this.localPos},y.boxes.ChunkOffsetBox.prototype.write=function(e,t){y.boxes.FullBox.prototype.write.call(this,e,t);var i=0;for(this._writeData(e,y.fields.FIELD_UINT32,this.entry_count),i=0;i<this.entry_count;i++)this._writeData(e,y.fields.FIELD_UINT32,this.chunk_offset[i]);return this.localPos},y.boxes.TrackExtendsBox=function(e){y.boxes.FullBox.call(this,"trex",e)},y.boxes.TrackExtendsBox.prototype=Object.create(y.boxes.FullBox.prototype),y.boxes.TrackExtendsBox.prototype.constructor=y.boxes.TrackExtendsBox,y.boxes.TrackExtendsBox.prototype.computeLength=function(){y.boxes.FullBox.prototype.computeLength.call(this),this.size+=5*y.fields.FIELD_UINT32.getLength()},y.boxes.TrackExtendsBox.prototype.read=function(e,t,i){return y.boxes.FullBox.prototype.read.call(this,e,t,i),this.track_ID=this._readData(e,y.fields.FIELD_UINT32),this.default_sample_description_index=this._readData(e,y.fields.FIELD_UINT32),this.default_sample_duration=this._readData(e,y.fields.FIELD_UINT32),this.default_sample_size=this._readData(e,y.fields.FIELD_UINT32),this.default_sample_flags=this._readData(e,y.fields.FIELD_UINT32),this.localPos},y.boxes.TrackExtendsBox.prototype.write=function(e,t){return y.boxes.FullBox.prototype.write.call(this,e,t),this._writeData(e,y.fields.FIELD_UINT32,this.track_ID),this._writeData(e,y.fields.FIELD_UINT32,this.default_sample_description_index),this._writeData(e,y.fields.FIELD_UINT32,this.default_sample_duration),this._writeData(e,y.fields.FIELD_UINT32,this.default_sample_size),this._writeData(e,y.fields.FIELD_UINT32,this.default_sample_flags),this.localPos},y.boxes.VideoMediaHeaderBox=function(e){y.boxes.FullBox.call(this,"vmhd",e)},y.boxes.VideoMediaHeaderBox.prototype=Object.create(y.boxes.FullBox.prototype),y.boxes.VideoMediaHeaderBox.prototype.constructor=y.boxes.VideoMediaHeaderBox,y.boxes.VideoMediaHeaderBox.prototype.computeLength=function(){y.boxes.FullBox.prototype.computeLength.call(this),this.size+=y.fields.FIELD_INT16.getLength()+3*y.fields.FIELD_UINT16.getLength()},y.boxes.VideoMediaHeaderBox.prototype.read=function(e,t,i){return y.boxes.FullBox.prototype.read.call(this,e,t,i),this.graphicsmode=this._readData(e,y.fields.FIELD_INT16),this.opcolor=this._readArrayFieldData(e,y.fields.FIELD_UINT16,3),this.localPos},y.boxes.VideoMediaHeaderBox.prototype.write=function(e,t){return y.boxes.FullBox.prototype.write.call(this,e,t),this._writeData(e,y.fields.FIELD_INT16,this.graphicsmode),this._writeArrayData(e,y.fields.FIELD_UINT16,this.opcolor),this.localPos},y.boxes.SoundMediaHeaderBox=function(e){y.boxes.FullBox.call(this,"smhd",e)},y.boxes.SoundMediaHeaderBox.prototype=Object.create(y.boxes.FullBox.prototype),y.boxes.SoundMediaHeaderBox.prototype.constructor=y.boxes.SoundMediaHeaderBox,y.boxes.SoundMediaHeaderBox.prototype.computeLength=function(){y.boxes.FullBox.prototype.computeLength.call(this),this.size+=y.fields.FIELD_INT16.getLength()+y.fields.FIELD_UINT16.getLength()},y.boxes.SoundMediaHeaderBox.prototype.read=function(e,t,i){return y.boxes.FullBox.prototype.read.call(this,e,t,i),this.balance=this._readData(e,y.fields.FIELD_INT16),this.reserved=this._readData(e,y.fields.FIELD_UINT16),this.localPos},y.boxes.SoundMediaHeaderBox.prototype.write=function(e,t){return y.boxes.FullBox.prototype.write.call(this,e,t),this._writeData(e,y.fields.FIELD_INT16,this.balance),this._writeData(e,y.fields.FIELD_UINT16,this.reserved),this.localPos},y.boxes.DataReferenceBox=function(e){y.boxes.ContainerFullBox.call(this,"dref",e)},y.boxes.DataReferenceBox.prototype=Object.create(y.boxes.ContainerFullBox.prototype),y.boxes.DataReferenceBox.prototype.constructor=y.boxes.DataReferenceBox,y.boxes.DataReferenceBox.prototype.computeLength=function(){y.boxes.ContainerFullBox.prototype.computeLength.call(this,!0)},y.boxes.DataReferenceBox.prototype.read=function(e,t,i){return y.boxes.ContainerFullBox.prototype.read.call(this,e,t,i,!0)},y.boxes.DataReferenceBox.prototype.write=function(e,t){return this.entry_count||(this.entry_count=this.boxes.length),y.boxes.ContainerFullBox.prototype.write.call(this,e,t,!0)},y.boxes.DataEntryUrlBox=function(e){y.boxes.FullBox.call(this,"url ",e)},y.boxes.DataEntryUrlBox.prototype=Object.create(y.boxes.FullBox.prototype),y.boxes.DataEntryUrlBox.prototype.constructor=y.boxes.DataEntryUrlBox,y.boxes.DataEntryUrlBox.prototype.computeLength=function(){y.boxes.FullBox.prototype.computeLength.call(this),void 0!==this.location&&(this.size+=y.fields.FIELD_STRING.getLength(this.location))},y.boxes.DataEntryUrlBox.prototype.read=function(e,t,i){return y.boxes.FullBox.prototype.read.call(this,e,t,i),!1&this.flags&&(this.location=this._readData(e,y.fields.FIELD_STRING)),this.localPos},y.boxes.DataEntryUrlBox.prototype.write=function(e,t){return y.boxes.FullBox.prototype.write.call(this,e,t),void 0!==this.location&&this._writeData(e,y.fields.FIELD_STRING,this.location),this.localPos},y.boxes.DataEntryUrnBox=function(e){y.boxes.FullBox.call(this,"urn ",e)},y.boxes.DataEntryUrnBox.prototype=Object.create(y.boxes.FullBox.prototype),y.boxes.DataEntryUrnBox.prototype.constructor=y.boxes.DataEntryUrnBox,y.boxes.DataEntryUrnBox.prototype.computeLength=function(){y.boxes.FullBox.prototype.computeLength.call(this),!1&this.flags&&(this.size+=y.fields.FIELD_STRING.getLength(this.name)+y.fields.FIELD_STRING.getLength(this.location))},y.boxes.DataEntryUrnBox.prototype.read=function(e,t,i){return y.boxes.FullBox.prototype.read.call(this,e,t,i),!1&this.flags&&(this.name=this._readData(e,y.fields.FIELD_STRING),this.location=this._readData(e,y.fields.FIELD_STRING)),this.localPos},y.boxes.DataEntryUrnBox.prototype.write=function(e,t){return y.boxes.FullBox.prototype.write.call(this,e,t),!1&this.flags&&(this._writeData(e,y.fields.FIELD_STRING,this.name),this._writeData(e,y.fields.FIELD_STRING,this.location)),this.localPos},y.boxes.MovieFragmentHeaderBox=function(e){y.boxes.FullBox.call(this,"mfhd",e)},y.boxes.MovieFragmentHeaderBox.prototype=Object.create(y.boxes.FullBox.prototype),y.boxes.MovieFragmentHeaderBox.prototype.constructor=y.boxes.MovieFragmentHeaderBox,y.boxes.MovieFragmentHeaderBox.prototype.computeLength=function(){y.boxes.FullBox.prototype.computeLength.call(this),this.size+=y.fields.FIELD_UINT32.getLength()},y.boxes.MovieFragmentHeaderBox.prototype.read=function(e,t,i){return y.boxes.FullBox.prototype.read.call(this,e,t,i),this.sequence_number=this._readData(e,y.fields.FIELD_UINT32),this.localPos},y.boxes.MovieFragmentHeaderBox.prototype.write=function(e,t){return y.boxes.FullBox.prototype.write.call(this,e,t),this._writeData(e,y.fields.FIELD_UINT32,this.sequence_number),this.localPos},y.boxes.TrackFragmentHeaderBox=function(e){y.boxes.FullBox.call(this,"tfhd",e)},y.boxes.TrackFragmentHeaderBox.prototype=Object.create(y.boxes.FullBox.prototype),y.boxes.TrackFragmentHeaderBox.prototype.constructor=y.boxes.TrackFragmentHeaderBox,y.boxes.TrackFragmentHeaderBox.prototype.computeLength=function(){y.boxes.FullBox.prototype.computeLength.call(this),this.size+=y.fields.FIELD_UINT32.getLength(),0!=(1&this.flags)&&void 0!==this.base_data_offset&&(this.size+=y.fields.FIELD_UINT64.getLength()),0!=(2&this.flags)&&void 0!==this.sample_description_index&&(this.size+=y.fields.FIELD_UINT32.getLength()),0!=(8&this.flags)&&void 0!==this.default_sample_duration&&(this.size+=y.fields.FIELD_UINT32.getLength()),0!=(16&this.flags)&&void 0!==this.default_sample_size&&(this.size+=y.fields.FIELD_UINT32.getLength()),0!=(32&this.flags)&&void 0!==this.default_sample_flags&&(this.size+=y.fields.FIELD_UINT32.getLength())},y.boxes.TrackFragmentHeaderBox.prototype.read=function(e,t,i){return y.boxes.FullBox.prototype.read.call(this,e,t,i),this.track_ID=this._readData(e,y.fields.FIELD_UINT32),0!=(1&this.flags)&&(this.base_data_offset=this._readData(e,y.fields.FIELD_UINT64)),0!=(2&this.flags)&&(this.sample_description_index=this._readData(e,y.fields.FIELD_UINT32)),0!=(8&this.flags)&&(this.default_sample_duration=this._readData(e,y.fields.FIELD_UINT32)),0!=(16&this.flags)&&(this.default_sample_size=this._readData(e,y.fields.FIELD_UINT32)),0!=(32&this.flags)&&(this.default_sample_flags=this._readData(e,y.fields.FIELD_UINT32)),this.localPos},y.boxes.TrackFragmentHeaderBox.prototype.write=function(e,t){return y.boxes.FullBox.prototype.write.call(this,e,t),this._writeData(e,y.fields.FIELD_UINT32,this.track_ID),0!=(1&this.flags)&&this._writeData(e,y.fields.FIELD_UINT64,this.base_data_offset),0!=(2&this.flags)&&this._writeData(e,y.fields.FIELD_UINT32,this.sample_description_index),0!=(8&this.flags)&&this._writeData(e,y.fields.FIELD_UINT32,this.default_sample_duration),0!=(16&this.flags)&&this._writeData(e,y.fields.FIELD_UINT32,this.default_sample_size),0!=(32&this.flags)&&this._writeData(e,y.fields.FIELD_UINT32,this.default_sample_flags),this.localPos},y.boxes.TrackFragmentBaseMediaDecodeTimeBox=function(e){y.boxes.FullBox.call(this,"tfdt",e)},y.boxes.TrackFragmentBaseMediaDecodeTimeBox.prototype=Object.create(y.boxes.FullBox.prototype),y.boxes.TrackFragmentBaseMediaDecodeTimeBox.prototype.constructor=y.boxes.TrackFragmentBaseMediaDecodeTimeBox,y.boxes.TrackFragmentBaseMediaDecodeTimeBox.prototype.computeLength=function(){y.boxes.FullBox.prototype.computeLength.call(this),1===this.version?this.size+=y.fields.FIELD_UINT64.getLength():this.size+=y.fields.FIELD_UINT32.getLength()},y.boxes.TrackFragmentBaseMediaDecodeTimeBox.prototype.read=function(e,t,i){return y.boxes.FullBox.prototype.read.call(this,e,t,i),1===this.version?this.baseMediaDecodeTime=this._readData(e,y.fields.FIELD_UINT64):this.baseMediaDecodeTime=this._readData(e,y.fields.FIELD_UINT32),this.localPos},y.boxes.TrackFragmentBaseMediaDecodeTimeBox.prototype.write=function(e,t){return y.boxes.FullBox.prototype.write.call(this,e,t),1===this.version?this._writeData(e,y.fields.FIELD_UINT64,this.baseMediaDecodeTime):this._writeData(e,y.fields.FIELD_UINT32,this.baseMediaDecodeTime),this.localPos},y.boxes.TrackFragmentRunBox=function(e){y.boxes.FullBox.call(this,"trun",e)},y.boxes.TrackFragmentRunBox.prototype=Object.create(y.boxes.FullBox.prototype),y.boxes.TrackFragmentRunBox.prototype.constructor=y.boxes.TrackFragmentRunBox,y.boxes.TrackFragmentRunBox.prototype.computeLength=function(){y.boxes.FullBox.prototype.computeLength.call(this);var e=0;for(this.size+=y.fields.FIELD_UINT32.getLength(),0!=(1&this.flags)&&void 0!==this.data_offset&&(this.size+=y.fields.FIELD_INT32.getLength()),0!=(4&this.flags)&&void 0!==this.first_sample_flags&&(this.size+=y.fields.FIELD_UINT32.getLength()),e=0;e<this.sample_count;e++)0!=(256&this.flags)&&void 0!==this.samples_table[e].sample_duration&&(this.size+=y.fields.FIELD_UINT32.getLength()),0!=(512&this.flags)&&void 0!==this.samples_table[e].sample_size&&(this.size+=y.fields.FIELD_UINT32.getLength()),0!=(1024&this.flags)&&void 0!==this.samples_table[e].sample_flags&&(this.size+=y.fields.FIELD_UINT32.getLength()),1===this.version?0!=(2048&this.flags)&&void 0!==this.samples_table[e].sample_composition_time_offset&&(this.size+=y.fields.FIELD_INT32.getLength()):0!=(2048&this.flags)&&void 0!==this.samples_table[e].sample_composition_time_offset&&(this.size+=y.fields.FIELD_UINT32.getLength())},y.boxes.TrackFragmentRunBox.prototype.read=function(e,t,i){y.boxes.FullBox.prototype.read.call(this,e,t,i);var n=0,r={};for(this.sample_count=this._readData(e,y.fields.FIELD_UINT32),0!=(1&this.flags)&&(this.data_offset=this._readData(e,y.fields.FIELD_INT32)),0!=(4&this.flags)&&(this.first_sample_flags=this._readData(e,y.fields.FIELD_UINT32)),this.samples_table=[],n=0;n<this.sample_count;n++)r={},0!=(256&this.flags)&&(r.sample_duration=this._readData(e,y.fields.FIELD_UINT32)),0!=(512&this.flags)&&(r.sample_size=this._readData(e,y.fields.FIELD_UINT32)),0!=(1024&this.flags)&&(r.sample_flags=this._readData(e,y.fields.FIELD_UINT32)),1===this.version?0!=(2048&this.flags)&&(r.sample_composition_time_offset=this._readData(e,y.fields.FIELD_INT32)):0!=(2048&this.flags)&&(r.sample_composition_time_offset=this._readData(e,y.fields.FIELD_UINT32)),this.samples_table.push(r);return this.localPos},y.boxes.TrackFragmentRunBox.prototype.write=function(e,t){y.boxes.FullBox.prototype.write.call(this,e,t);var i=0;for(this._writeData(e,y.fields.FIELD_UINT32,this.sample_count),0!=(1&this.flags)&&this._writeData(e,y.fields.FIELD_INT32,this.data_offset),0!=(4&this.flags)&&this._writeData(e,y.fields.FIELD_UINT32,this.first_sample_flags),i=0;i<this.sample_count;i++)0!=(256&this.flags)&&this._writeData(e,y.fields.FIELD_UINT32,this.samples_table[i].sample_duration),0!=(512&this.flags)&&this._writeData(e,y.fields.FIELD_UINT32,this.samples_table[i].sample_size),0!=(1024&this.flags)&&this._writeData(e,y.fields.FIELD_UINT32,this.samples_table[i].sample_flags),1===this.version?0!=(2048&this.flags)&&this._writeData(e,y.fields.FIELD_INT32,this.samples_table[i].sample_composition_time_offset):0!=(2048&this.flags)&&this._writeData(e,y.fields.FIELD_UINT32,this.samples_table[i].sample_composition_time_offset);return this.localPos},y.boxes.SampleDescriptionBox=function(e){y.boxes.ContainerFullBox.call(this,"stsd",e)},y.boxes.SampleDescriptionBox.prototype=Object.create(y.boxes.ContainerFullBox.prototype),y.boxes.SampleDescriptionBox.prototype.constructor=y.boxes.SampleDescriptionBox,y.boxes.SampleDescriptionBox.prototype.computeLength=function(){y.boxes.ContainerFullBox.prototype.computeLength.call(this,!0)},y.boxes.SampleDescriptionBox.prototype.read=function(e,t,i){return y.boxes.ContainerFullBox.prototype.read.call(this,e,t,i,!0)},y.boxes.SampleDescriptionBox.prototype.write=function(e,t){return this.entry_count=this.boxes.length,y.boxes.ContainerFullBox.prototype.write.call(this,e,t,!0)},y.boxes.SampleDependencyTableBox=function(e){y.boxes.FullBox.call(this,"sdtp",e)},y.boxes.SampleDependencyTableBox.prototype=Object.create(y.boxes.FullBox.prototype),y.boxes.SampleDependencyTableBox.prototype.constructor=y.boxes.SampleDependencyTableBox,y.boxes.SampleDependencyTableBox.prototype.computeLength=function(){y.boxes.FullBox.prototype.computeLength.call(this),this.size+=y.fields.FIELD_UINT8.getLength()*this.sample_dependency_table.length},y.boxes.SampleDependencyTableBox.prototype.read=function(e,t,i){return y.boxes.FullBox.prototype.read.call(this,e,t,i),this.sample_dependency_table=this._readArrayData(e,y.fields.FIELD_UINT8),this.localPos},y.boxes.SampleDependencyTableBox.prototype.write=function(e,t){return y.boxes.FullBox.prototype.write.call(this,e,t),this._writeArrayData(e,y.fields.FIELD_UINT8,this.sample_dependency_table),this.localPos},y.boxes.SampleEntryBox=function(e,t){y.boxes.Box.call(this,e,t)},y.boxes.SampleEntryBox.prototype=Object.create(y.boxes.Box.prototype),y.boxes.SampleEntryBox.prototype.constructor=y.boxes.SampleEntryBox,y.boxes.SampleEntryBox.prototype.computeLength=function(){y.boxes.Box.prototype.computeLength.call(this),this.size+=y.fields.FIELD_UINT16.getLength()+6*y.fields.FIELD_UINT8.getLength()},y.boxes.SampleEntryBox.prototype.read=function(e,t,i){return this.localPos=t,this.localEnd=i,this.reserved=this._readArrayFieldData(e,y.fields.FIELD_UINT8,6),this.data_reference_index=this._readData(e,y.fields.FIELD_UINT16),this.localPos},y.boxes.SampleEntryBox.prototype.write=function(e,t){return y.boxes.Box.prototype.write.call(this,e,t),this._writeArrayData(e,y.fields.FIELD_UINT8,this.reserved),this._writeData(e,y.fields.FIELD_UINT16,this.data_reference_index),this.localPos},y.boxes.VisualSampleEntryBox=function(e,t){y.boxes.SampleEntryBox.call(this,e,t)},y.boxes.VisualSampleEntryBox.prototype=Object.create(y.boxes.SampleEntryBox.prototype),y.boxes.VisualSampleEntryBox.prototype.constructor=y.boxes.VisualSampleEntryBox,y.boxes.VisualSampleEntryBox.prototype.computeLength=function(){y.boxes.SampleEntryBox.prototype.computeLength.call(this),this.size+=7*y.fields.FIELD_UINT16.getLength()+3*y.fields.FIELD_UINT32.getLength(),this.size+=3*y.fields.FIELD_UINT32.getLength(),this.size+=32},y.boxes.VisualSampleEntryBox.prototype.read=function(e,t,i){return y.boxes.SampleEntryBox.prototype.read.call(this,e,t,i),this.pre_defined=this._readData(e,y.fields.FIELD_UINT16),this.reserved_2=this._readData(e,y.fields.FIELD_UINT16),this.pre_defined_2=this._readArrayFieldData(e,y.fields.FIELD_UINT32,3),this.width=this._readData(e,y.fields.FIELD_UINT16),this.height=this._readData(e,y.fields.FIELD_UINT16),this.horizresolution=this._readData(e,y.fields.FIELD_UINT32),this.vertresolution=this._readData(e,y.fields.FIELD_UINT32),this.reserved_3=this._readData(e,y.fields.FIELD_UINT32),this.frame_count=this._readData(e,y.fields.FIELD_UINT16),this.compressorname=this._readArrayFieldData(e,y.fields.FIELD_UINT8,32),this.depth=this._readData(e,y.fields.FIELD_UINT16),this.pre_defined_3=this._readData(e,y.fields.FIELD_INT16),this.localPos},y.boxes.VisualSampleEntryBox.prototype.write=function(e,t){return y.boxes.SampleEntryBox.prototype.write.call(this,e,t),this._writeData(e,y.fields.FIELD_UINT16,this.pre_defined),this._writeData(e,y.fields.FIELD_UINT16,this.reserved_2),this._writeArrayData(e,y.fields.FIELD_UINT32,this.pre_defined_2),this._writeData(e,y.fields.FIELD_UINT16,this.width),this._writeData(e,y.fields.FIELD_UINT16,this.height),this._writeData(e,y.fields.FIELD_UINT32,this.horizresolution),this._writeData(e,y.fields.FIELD_UINT32,this.vertresolution),this._writeData(e,y.fields.FIELD_UINT32,this.reserved_3),this._writeData(e,y.fields.FIELD_UINT16,this.frame_count),this._writeArrayData(e,y.fields.FIELD_UINT8,this.compressorname),this._writeData(e,y.fields.FIELD_UINT16,this.depth),this._writeData(e,y.fields.FIELD_INT16,this.pre_defined_3),this.localPos},y.boxes.VisualSampleEntryContainerBox=function(e,t){y.boxes.VisualSampleEntryBox.call(this,e,t),this.boxes=[]},y.boxes.VisualSampleEntryContainerBox.prototype=Object.create(y.boxes.VisualSampleEntryBox.prototype),y.boxes.VisualSampleEntryContainerBox.prototype.constructor=y.boxes.VisualSampleEntryContainerBox,y.boxes.VisualSampleEntryContainerBox.prototype.computeLength=function(){y.boxes.VisualSampleEntryBox.prototype.computeLength.call(this);var e=0;for(e=0;e<this.boxes.length;e++)this.boxes[e].computeLength(),this.size+=this.boxes[e].size},y.boxes.VisualSampleEntryContainerBox.prototype.read=function(e,t,i){y.boxes.VisualSampleEntryBox.prototype.read.call(this,e,t,i);for(var n,r,o=0,s=0,a=null;this.localPos<this.localEnd;){if(o=y.fields.FIELD_UINT32.read(e,this.localPos),"uuid"==(n=y.fields.readString(e,this.localPos+4,4))&&(s=1==o?16:8,a=new y.fields.ArrayField(y.fields.FIELD_INT8,16).read(e,this.localPos+s,this.localPos+s+16),a=JSON.stringify(a)),r=y.createBox(n,o,a),this.localPos="uuid"===n?r.read(e,this.localPos+16*y.fields.FIELD_INT8.getLength()+8,this.localPos+o):r.read(e,this.localPos+8,this.localPos+o),y.debug&&(r.__sourceBuffer=e.subarray(this.localPos-r.size,this.localPos)),this.boxes.push(r),r.size<=0||null===r.size)throw new y.ParseException("Problem on size of box "+r.boxtype+", parsing stopped to avoid infinite loop");if(!r.boxtype)throw new y.ParseException("Problem on unknown box, parsing stopped to avoid infinite loop")}return this.localPos},y.boxes.VisualSampleEntryContainerBox.prototype.write=function(e,t){y.boxes.VisualSampleEntryBox.prototype.write.call(this,e,t);var i=0;for(i=0;i<this.boxes.length;i++)this.localPos=this.boxes[i].write(e,this.localPos);return this.localPos},y.boxes.AVC1VisualSampleEntryBox=function(e){y.boxes.VisualSampleEntryContainerBox.call(this,"avc1",e)},y.boxes.AVC1VisualSampleEntryBox.prototype=Object.create(y.boxes.VisualSampleEntryContainerBox.prototype),y.boxes.AVC1VisualSampleEntryBox.prototype.constructor=y.boxes.AVC1VisualSampleEntryBox,y.boxes.EncryptedVideoBox=function(e){y.boxes.VisualSampleEntryContainerBox.call(this,"encv",e)},y.boxes.EncryptedVideoBox.prototype=Object.create(y.boxes.VisualSampleEntryContainerBox.prototype),y.boxes.EncryptedVideoBox.prototype.constructor=y.boxes.EncryptedVideoBox,y.boxes.AVCConfigurationBox=function(e){y.boxes.Box.call(this,"avcC",e)},y.boxes.AVCConfigurationBox.prototype=Object.create(y.boxes.Box.prototype),y.boxes.AVCConfigurationBox.prototype.constructor=y.boxes.AVCConfigurationBox,y.boxes.AVCConfigurationBox.prototype.computeLength=function(){y.boxes.Box.prototype.computeLength.call(this),this.size+=4*y.fields.FIELD_UINT8.getLength()+3*y.fields.FIELD_UINT8.getLength(),this.size+=this._getNALLength(this.numOfSequenceParameterSets,this.SPS_NAL),this.size+=this._getNALLength(this.numOfPictureParameterSets,this.PPS_NAL)},y.boxes.AVCConfigurationBox.prototype._getNALLength=function(e,t){var i=0,n=0;for(n=0;n<e;n++)i+=y.fields.FIELD_UINT16.getLength()+t[n].NAL_length;return i},y.boxes.AVCConfigurationBox.prototype.read=function(e,t,i){return this.localPos=t,this.localEnd=i,this.configurationVersion=this._readData(e,y.fields.FIELD_UINT8),this.AVCProfileIndication=this._readData(e,y.fields.FIELD_UINT8),this.profile_compatibility=this._readData(e,y.fields.FIELD_UINT8),this.AVCLevelIndication=this._readData(e,y.fields.FIELD_UINT8),this.temp=this._readData(e,y.fields.FIELD_UINT8),this.lengthSizeMinusOne=3&this.temp,this.numOfSequenceParameterSets_tmp=this._readData(e,y.fields.FIELD_UINT8),this.numOfSequenceParameterSets=31&this.numOfSequenceParameterSets_tmp,this.SPS_NAL=this._readNAL(e,this.numOfSequenceParameterSets),this.numOfPictureParameterSets=this._readData(e,y.fields.FIELD_UINT8),this.PPS_NAL=this._readNAL(e,this.numOfPictureParameterSets),this.localPos},y.boxes.AVCConfigurationBox.prototype._readNAL=function(e,t){var i=[],n=0,r={};for(n=0;n<t;n++)(r={}).NAL_length=this._readData(e,y.fields.FIELD_UINT16),r.NAL=e.subarray(this.localPos,this.localPos+r.NAL_length),this.localPos+=r.NAL_length,i.push(r);return i},y.boxes.AVCConfigurationBox.prototype.write=function(e,t){return y.boxes.Box.prototype.write.call(this,e,t),this._writeData(e,y.fields.FIELD_UINT8,this.configurationVersion),this._writeData(e,y.fields.FIELD_UINT8,this.AVCProfileIndication),this._writeData(e,y.fields.FIELD_UINT8,this.profile_compatibility),this._writeData(e,y.fields.FIELD_UINT8,this.AVCLevelIndication),this.temp=252|this.lengthSizeMinusOne,this._writeData(e,y.fields.FIELD_UINT8,this.temp),this.numOfSequenceParameterSets=this.SPS_NAL.length,this.numOfSequenceParameterSets_tmp=224|this.numOfSequenceParameterSets,this._writeData(e,y.fields.FIELD_UINT8,this.numOfSequenceParameterSets_tmp),this._writeNAL(e,this.numOfSequenceParameterSets,this.SPS_NAL),this._writeData(e,y.fields.FIELD_UINT8,this.numOfPictureParameterSets),this._writeNAL(e,this.numOfPictureParameterSets,this.PPS_NAL),this.localPos},y.boxes.AVCConfigurationBox.prototype._writeNAL=function(e,t,i){var n=0;for(n=0;n<t;n++)this._writeData(e,y.fields.FIELD_UINT16,i[n].NAL_length),this._writeBuffer(e,i[n].NAL,i[n].NAL_length)},y.boxes.PixelAspectRatioBox=function(e){y.boxes.Box.call(this,"pasp",e)},y.boxes.PixelAspectRatioBox.prototype=Object.create(y.boxes.Box.prototype),y.boxes.PixelAspectRatioBox.prototype.constructor=y.boxes.PixelAspectRatioBox,y.boxes.PixelAspectRatioBox.prototype.computeLength=function(){y.boxes.Box.prototype.computeLength.call(this),this.size+=2*y.fields.FIELD_INT32.getLength()},y.boxes.PixelAspectRatioBox.prototype.read=function(e,t,i){return this.localPos=t,this.localEnd=i,this.hSpacing=this._readData(e,y.fields.FIELD_INT32),this.vSpacing=this._readData(e,y.fields.FIELD_INT32),this.localPos},y.boxes.PixelAspectRatioBox.prototype.write=function(e,t){return y.boxes.Box.prototype.write.call(this,e,t),this._writeData(e,y.fields.FIELD_INT32,this.hSpacing),this._writeData(e,y.fields.FIELD_INT32,this.vSpacing),this.localPos},y.boxes.AudioSampleEntryBox=function(e,t){y.boxes.SampleEntryBox.call(this,e,t)},y.boxes.AudioSampleEntryBox.prototype=Object.create(y.boxes.SampleEntryBox.prototype),y.boxes.AudioSampleEntryBox.prototype.constructor=y.boxes.AudioSampleEntryBox,y.boxes.AudioSampleEntryBox.prototype.computeLength=function(){y.boxes.SampleEntryBox.prototype.computeLength.call(this),this.size+=4*y.fields.FIELD_UINT16.getLength()+3*y.fields.FIELD_UINT32.getLength()},y.boxes.AudioSampleEntryBox.prototype.read=function(e,t,i){return y.boxes.SampleEntryBox.prototype.read.call(this,e,t,i),this.reserved_2=this._readArrayFieldData(e,y.fields.FIELD_UINT32,2),this.channelcount=this._readData(e,y.fields.FIELD_UINT16),this.samplesize=this._readData(e,y.fields.FIELD_UINT16),this.pre_defined=this._readData(e,y.fields.FIELD_UINT16),this.reserved_3=this._readData(e,y.fields.FIELD_UINT16),this.samplerate=this._readData(e,y.fields.FIELD_UINT32),this.localPos},y.boxes.AudioSampleEntryBox.prototype.write=function(e,t){return y.boxes.SampleEntryBox.prototype.write.call(this,e,t),this._writeArrayData(e,y.fields.FIELD_UINT32,this.reserved_2),this._writeData(e,y.fields.FIELD_UINT16,this.channelcount),this._writeData(e,y.fields.FIELD_UINT16,this.samplesize),this._writeData(e,y.fields.FIELD_UINT16,this.pre_defined),this._writeData(e,y.fields.FIELD_UINT16,this.reserved_3),this._writeData(e,y.fields.FIELD_UINT32,this.samplerate),this.localPos},y.boxes.AudioSampleEntryContainerBox=function(e,t){y.boxes.AudioSampleEntryBox.call(this,e,t),this.boxes=[]},y.boxes.AudioSampleEntryContainerBox.prototype=Object.create(y.boxes.AudioSampleEntryBox.prototype),y.boxes.AudioSampleEntryContainerBox.prototype.constructor=y.boxes.AudioSampleEntryContainerBox,y.boxes.AudioSampleEntryContainerBox.prototype.computeLength=function(){y.boxes.AudioSampleEntryBox.prototype.computeLength.call(this);var e=0;for(e=0;e<this.boxes.length;e++)this.boxes[e].computeLength(),this.size+=this.boxes[e].size},y.boxes.AudioSampleEntryContainerBox.prototype.read=function(e,t,i){y.boxes.AudioSampleEntryBox.prototype.read.call(this,e,t,i);for(var n,r,o=0,s=0,a=null;this.localPos<this.localEnd;){if(o=y.fields.FIELD_UINT32.read(e,this.localPos),"uuid"==(n=y.fields.readString(e,this.localPos+4,4))&&(s=1==o?16:8,a=new y.fields.ArrayField(y.fields.FIELD_INT8,16).read(e,this.localPos+s,this.localPos+s+16),a=JSON.stringify(a)),r=y.createBox(n,o,a),this.localPos="uuid"===n?r.read(e,this.localPos+16*y.fields.FIELD_INT8.getLength()+8,this.localPos+o):r.read(e,this.localPos+8,this.localPos+o),y.debug&&(r.__sourceBuffer=e.subarray(this.localPos-r.size,this.localPos)),this.boxes.push(r),r.size<=0||null===r.size)throw new y.ParseException("Problem on size of box "+r.boxtype+", parsing stopped to avoid infinite loop");if(!r.boxtype)throw new y.ParseException("Problem on unknown box, parsing stopped to avoid infinite loop")}return this.localPos},y.boxes.AudioSampleEntryContainerBox.prototype.write=function(e,t){y.boxes.AudioSampleEntryBox.prototype.write.call(this,e,t);var i=0;for(i=0;i<this.boxes.length;i++)this.localPos=this.boxes[i].write(e,this.localPos);return this.localPos},y.boxes.MP4AudioSampleEntryBox=function(e){y.boxes.AudioSampleEntryContainerBox.call(this,"mp4a",e)},y.boxes.MP4AudioSampleEntryBox.prototype=Object.create(y.boxes.AudioSampleEntryContainerBox.prototype),y.boxes.MP4AudioSampleEntryBox.prototype.constructor=y.boxes.MP4AudioSampleEntryBox,y.boxes.EncryptedAudioBox=function(e){y.boxes.AudioSampleEntryContainerBox.call(this,"enca",e)},y.boxes.EncryptedAudioBox.prototype=Object.create(y.boxes.AudioSampleEntryContainerBox.prototype),y.boxes.EncryptedAudioBox.prototype.constructor=y.boxes.EncryptedAudioBox,y.boxes.ESDBox=function(e){y.boxes.FullBox.call(this,"esds",e)},y.boxes.ESDBox.prototype=Object.create(y.boxes.FullBox.prototype),y.boxes.ESDBox.prototype.constructor=y.boxes.ESDBox,y.boxes.ESDBox.prototype.computeLength=function(){y.boxes.FullBox.prototype.computeLength.call(this),this.size+=2*y.fields.FIELD_UINT8.getLength()+this.ES_length},y.boxes.ESDBox.prototype.read=function(e,t,i){return y.boxes.FullBox.prototype.read.call(this,e,t,i),this.ES_tag=this._readData(e,y.fields.FIELD_UINT8),this.ES_length=this._readData(e,y.fields.FIELD_UINT8),this.ES_data=e.subarray(this.localPos,this.localPos+this.ES_length),this.localPos+=this.ES_length,this.localPos},y.boxes.ESDBox.prototype.write=function(e,t){return y.boxes.FullBox.prototype.write.call(this,e,t),this._writeData(e,y.fields.FIELD_UINT8,this.ES_tag),this._writeData(e,y.fields.FIELD_UINT8,this.ES_length),this._writeBuffer(e,this.ES_data,this.ES_length),this.localPos},y.boxes.SampleSizeBox=function(e){y.boxes.FullBox.call(this,"stsz",e)},y.boxes.SampleSizeBox.prototype=Object.create(y.boxes.FullBox.prototype),y.boxes.SampleSizeBox.prototype.constructor=y.boxes.SampleSizeBox,y.boxes.SampleSizeBox.prototype.computeLength=function(){y.boxes.FullBox.prototype.computeLength.call(this),this.size+=2*y.fields.FIELD_UINT32.getLength()+y.fields.FIELD_UINT32.getLength()*this.sample_count},y.boxes.SampleSizeBox.prototype.read=function(e,t,i){return y.boxes.FullBox.prototype.read.call(this,e,t,i),this.sample_size=this._readData(e,y.fields.FIELD_UINT32),this.sample_count=this._readData(e,y.fields.FIELD_UINT32),this.entries=this._readArrayFieldData(e,y.fields.FIELD_UINT32,this.sample_count),this.localPos},y.boxes.SampleSizeBox.prototype.write=function(e,t){y.boxes.FullBox.prototype.write.call(this,e,t);var i=0;for(this._writeData(e,y.fields.FIELD_UINT32,this.sample_size),this._writeData(e,y.fields.FIELD_UINT32,this.sample_count),i=0;i<this.sample_count;i++)this._writeData(e,y.fields.FIELD_UINT32,this.entries[i]);return this.localPos},y.boxes.ProtectionSystemSpecificHeaderBox=function(e){y.boxes.FullBox.call(this,"pssh",e)},y.boxes.ProtectionSystemSpecificHeaderBox.prototype=Object.create(y.boxes.FullBox.prototype),y.boxes.ProtectionSystemSpecificHeaderBox.prototype.constructor=y.boxes.ProtectionSystemSpecificHeaderBox,y.boxes.ProtectionSystemSpecificHeaderBox.prototype.computeLength=function(){y.boxes.FullBox.prototype.computeLength.call(this),this.size+=16*y.fields.FIELD_UINT8.getLength(),this.size+=y.fields.FIELD_UINT32.getLength(),this.size+=y.fields.FIELD_UINT8.getLength()*this.DataSize},y.boxes.ProtectionSystemSpecificHeaderBox.prototype.read=function(e,t,i){return y.boxes.FullBox.prototype.read.call(this,e,t,i),this.SystemID=this._readArrayFieldData(e,y.fields.FIELD_UINT8,16),this.DataSize=this._readData(e,y.fields.FIELD_UINT32),this.Data=this._readArrayFieldData(e,y.fields.FIELD_UINT8,this.DataSize),this.localPos},y.boxes.ProtectionSystemSpecificHeaderBox.prototype.write=function(e,t){y.boxes.FullBox.prototype.write.call(this,e,t);var i=0;for(i=0;i<16;i++)this._writeData(e,y.fields.FIELD_UINT8,this.SystemID[i]);for(this._writeData(e,y.fields.FIELD_UINT32,this.DataSize),i=0;i<this.DataSize;i++)this._writeData(e,y.fields.FIELD_UINT8,this.Data[i]);return this.localPos},y.boxes.SampleEncryptionBox=function(e){y.boxes.FullBox.call(this,"senc",e)},y.boxes.SampleEncryptionBox.prototype=Object.create(y.boxes.FullBox.prototype),y.boxes.SampleEncryptionBox.prototype.constructor=y.boxes.SampleEncryptionBox,y.boxes.SampleEncryptionBox.prototype.computeLength=function(){y.boxes.FullBox.prototype.computeLength.call(this);var e=0,t=0;for(this.size+=y.fields.FIELD_UINT32.getLength(),1&this.flags&&(this.size+=y.fields.FIELD_UINT8.getLength()),e=0;e<this.sample_count;e++)if(this.size+=8,2&this.flags)for(this.size+=y.fields.FIELD_UINT16.getLength(),t=0;t<this.entry[e].NumberOfEntries;t++)this.size+=y.fields.FIELD_UINT16.getLength(),this.size+=y.fields.FIELD_UINT32.getLength()},y.boxes.SampleEncryptionBox.prototype.write=function(e,t){y.boxes.FullBox.prototype.write.call(this,e,t);var i=0,n=0;for(this._writeData(e,y.fields.FIELD_UINT32,this.sample_count),1&this.flags&&this._writeData(e,y.fields.FIELD_UINT8,this.IV_size),i=0;i<this.sample_count;i++)if(this._writeBuffer(e,this.entry[i].InitializationVector,8),2&this.flags)for(this._writeData(e,y.fields.FIELD_UINT16,this.entry[i].NumberOfEntries),n=0;n<this.entry[i].NumberOfEntries;n++)this._writeData(e,y.fields.FIELD_UINT16,this.entry[i].clearAndCryptedData[n].BytesOfClearData),this._writeData(e,y.fields.FIELD_UINT32,this.entry[i].clearAndCryptedData[n].BytesOfEncryptedData);return this.localPos},y.boxes.SampleEncryptionBox.prototype.read=function(e,t,i){y.boxes.FullBox.prototype.read.call(this,e,t,i);var n=0,r=0,o={},s={};for(this.sample_count=this._readData(e,y.fields.FIELD_UINT32),1&this.flags&&(this.IV_size=this._readData(e,y.fields.FIELD_UINT8)),this.entry=[],n=0;n<this.sample_count;n++){if(s={},s.InitializationVector=e.subarray(this.localPos,this.localPos+8),this.localPos+=8,2&this.flags)for(s.NumberOfEntries=this._readData(e,y.fields.FIELD_UINT16),s.clearAndCryptedData=[],r=0;r<s.NumberOfEntries;r++)(o={}).BytesOfClearData=this._readData(e,y.fields.FIELD_UINT16),o.BytesOfEncryptedData=this._readData(e,y.fields.FIELD_UINT32),s.clearAndCryptedData.push(o);this.entry.push(s)}return this.localPos},y.boxes.SampleAuxiliaryInformationSizesBox=function(e){y.boxes.FullBox.call(this,"saiz",e)},y.boxes.SampleAuxiliaryInformationSizesBox.prototype=Object.create(y.boxes.FullBox.prototype),y.boxes.SampleAuxiliaryInformationSizesBox.prototype.constructor=y.boxes.SampleAuxiliaryInformationSizesBox,y.boxes.SampleAuxiliaryInformationSizesBox.prototype.computeLength=function(){y.boxes.FullBox.prototype.computeLength.call(this),1&this.flags&&(this.size+=2*y.fields.FIELD_UINT32.getLength()),this.size+=y.fields.FIELD_UINT8.getLength()+y.fields.FIELD_UINT32.getLength(),0===this.default_sample_info_size&&(this.size+=y.fields.FIELD_UINT8.getLength()*this.sample_count)},y.boxes.SampleAuxiliaryInformationSizesBox.prototype.read=function(e,t,i){return y.boxes.FullBox.prototype.read.call(this,e,t,i),1&this.flags&&(this.aux_info_type=this._readData(e,y.fields.FIELD_UINT32),this.aux_info_type_parameter=this._readData(e,y.fields.FIELD_UINT32)),this.default_sample_info_size=this._readData(e,y.fields.FIELD_UINT8),this.sample_count=this._readData(e,y.fields.FIELD_UINT32),0===this.default_sample_info_size&&(this.sample_info_size=this._readArrayFieldData(e,y.fields.FIELD_UINT8,this.sample_count)),this.localPos},y.boxes.SampleAuxiliaryInformationSizesBox.prototype.write=function(e,t){y.boxes.FullBox.prototype.write.call(this,e,t);var i=0;if(1&this.flags&&(this._writeData(e,y.fields.FIELD_UINT32,this.aux_info_type),this._writeData(e,y.fields.FIELD_UINT32,this.aux_info_type_parameter)),this._writeData(e,y.fields.FIELD_UINT8,this.default_sample_info_size),this._writeData(e,y.fields.FIELD_UINT32,this.sample_count),0===this.default_sample_info_size)for(i=0;i<this.sample_count;i++)this._writeData(e,y.fields.FIELD_UINT8,this.sample_info_size[i]);return this.localPos},y.boxes.SampleAuxiliaryInformationOffsetsBox=function(e){y.boxes.FullBox.call(this,"saio",e)},y.boxes.SampleAuxiliaryInformationOffsetsBox.prototype=Object.create(y.boxes.FullBox.prototype),y.boxes.SampleAuxiliaryInformationOffsetsBox.prototype.constructor=y.boxes.SampleAuxiliaryInformationOffsetsBox,y.boxes.SampleAuxiliaryInformationOffsetsBox.prototype.computeLength=function(){y.boxes.FullBox.prototype.computeLength.call(this),1&this.flags&&(this.size+=2*y.fields.FIELD_UINT32.getLength()),this.size+=y.fields.FIELD_UINT32.getLength(),0===this.version?this.size+=y.fields.FIELD_UINT32.getLength()*this.entry_count:this.size+=y.fields.FIELD_UINT64.getLength()*this.entry_count},y.boxes.SampleAuxiliaryInformationOffsetsBox.prototype.read=function(e,t,i){return y.boxes.FullBox.prototype.read.call(this,e,t,i),1&this.flags&&(this.aux_info_type=this._readData(e,y.fields.FIELD_UINT32),this.aux_info_type_parameter=this._readData(e,y.fields.FIELD_UINT32)),this.entry_count=this._readData(e,y.fields.FIELD_UINT32),0===this.version?this.offset=this._readArrayFieldData(e,y.fields.FIELD_UINT32,this.entry_count):this.offset=this._readArrayFieldData(e,y.fields.FIELD_UINT64,this.entry_count),this.localPos},y.boxes.SampleAuxiliaryInformationOffsetsBox.prototype.write=function(e,t){y.boxes.FullBox.prototype.write.call(this,e,t);var i=0;if(1&this.flags&&(this._writeData(e,y.fields.FIELD_UINT32,this.aux_info_type),this._writeData(e,y.fields.FIELD_UINT32,this.aux_info_type_parameter)),this._writeData(e,y.fields.FIELD_UINT32,this.entry_count),0===this.version)for(i=0;i<this.entry_count;i++)this._writeData(e,y.fields.FIELD_UINT32,this.offset[i]);else for(i=0;i<this.entry_count;i++)this._writeData(e,y.fields.FIELD_UINT64,this.offset[i]);return this.localPos},y.boxes.ProtectionSchemeInformationBox=function(e){y.boxes.ContainerBox.call(this,"sinf",e)},y.boxes.ProtectionSchemeInformationBox.prototype=Object.create(y.boxes.ContainerBox.prototype),y.boxes.ProtectionSchemeInformationBox.prototype.constructor=y.boxes.ProtectionSchemeInformationBox,y.boxes.SchemeInformationBox=function(e){y.boxes.ContainerBox.call(this,"schi",e)},y.boxes.SchemeInformationBox.prototype=Object.create(y.boxes.ContainerBox.prototype),y.boxes.SchemeInformationBox.prototype.constructor=y.boxes.SchemeInformationBox,y.boxes.TrackEncryptionBox=function(e){y.boxes.FullBox.call(this,"tenc",e)},y.boxes.TrackEncryptionBox.prototype=Object.create(y.boxes.FullBox.prototype),y.boxes.TrackEncryptionBox.prototype.constructor=y.boxes.TrackEncryptionBox,y.boxes.TrackEncryptionBox.prototype.computeLength=function(){y.boxes.FullBox.prototype.computeLength.call(this),this.size+=y.fields.FIELD_BIT24.getLength(),this.size+=y.fields.FIELD_UINT8.getLength(),this.size+=16*y.fields.FIELD_UINT8.getLength()},y.boxes.TrackEncryptionBox.prototype.read=function(e,t,i){return y.boxes.FullBox.prototype.read.call(this,e,t,i),this.default_IsEncrypted=this._readData(e,y.fields.FIELD_BIT24),this.default_IV_size=this._readData(e,y.fields.FIELD_UINT8),this.default_KID=this._readArrayFieldData(e,y.fields.FIELD_UINT8,16),this.localPos},y.boxes.TrackEncryptionBox.prototype.write=function(e,t){return y.boxes.FullBox.prototype.write.call(this,e,t),this._writeData(e,y.fields.FIELD_BIT24,this.default_IsEncrypted),this._writeData(e,y.fields.FIELD_UINT8,this.default_IV_size),this._writeArrayData(e,y.fields.FIELD_UINT8,this.default_KID),this.localPos},y.boxes.SchemeTypeBox=function(e){y.boxes.FullBox.call(this,"schm",e)},y.boxes.SchemeTypeBox.prototype=Object.create(y.boxes.FullBox.prototype),y.boxes.SchemeTypeBox.prototype.constructor=y.boxes.SchemeTypeBox,y.boxes.SchemeTypeBox.prototype.computeLength=function(){y.boxes.FullBox.prototype.computeLength.call(this),this.size+=2*y.fields.FIELD_UINT32.getLength(),1&this.flags&&(this.size+=y.fields.FIELD_STRING.getLength(this.scheme_uri))},y.boxes.SchemeTypeBox.prototype.read=function(e,t,i){return y.boxes.FullBox.prototype.read.call(this,e,t,i),this.scheme_type=this._readData(e,y.fields.FIELD_UINT32),this.scheme_version=this._readData(e,y.fields.FIELD_UINT32),1&this.flags&&(this.scheme_uri=this._readData(e,y.fields.FIELD_STRING)),this.localPos},y.boxes.SchemeTypeBox.prototype.write=function(e,t){return y.boxes.FullBox.prototype.write.call(this,e,t),this._writeData(e,y.fields.FIELD_UINT32,this.scheme_type),this._writeData(e,y.fields.FIELD_UINT32,this.scheme_version),1&this.flags&&this._writeData(e,y.fields.FIELD_STRING,this.scheme_uri),this.localPos},y.boxes.EditListBox=function(e){y.boxes.FullBox.call(this,"elst",e),this.entries=[]},y.boxes.EditListBox.prototype=Object.create(y.boxes.FullBox.prototype),y.boxes.EditListBox.prototype.constructor=y.boxes.EditListBox,y.boxes.EditListBox.prototype.computeLength=function(){y.boxes.FullBox.prototype.computeLength.call(this),this.size+=y.fields.FIELD_UINT32.getLength(),1===this.version?this.size+=(2*y.fields.FIELD_UINT64.getLength()+2*y.fields.FIELD_UINT16.getLength())*this.entry_count:this.size+=(2*y.fields.FIELD_UINT32.getLength()+2*y.fields.FIELD_UINT16.getLength())*this.entry_count},y.boxes.EditListBox.prototype.read=function(e,t,i){y.boxes.FullBox.prototype.read.call(this,e,t,i);var n=0,r={};for(this.entry_count=this._readData(e,y.fields.FIELD_UINT32),n=0;n<this.entry_count;n++)r={},1===this.version?(r.segment_duration=this._readData(e,y.fields.FIELD_UINT64),r.media_time=this._readData(e,y.fields.FIELD_UINT64)):(r.segment_duration=this._readData(e,y.fields.FIELD_UINT32),r.media_time=this._readData(e,y.fields.FIELD_UINT32)),r.media_rate_integer=this._readData(e,y.fields.FIELD_UINT16),r.media_rate_fraction=this._readData(e,y.fields.FIELD_UINT16),this.entries.push(r);return this.localPos},y.boxes.EditListBox.prototype.write=function(e,t){y.boxes.FullBox.prototype.write.call(this,e,t);var i=0;for(this._writeData(e,y.fields.FIELD_UINT32,this.entry_count),i=0;i<this.entry_count;i++)1===this.version?(this._writeData(e,y.fields.FIELD_UINT64,this.entries[i].segment_duration),this._writeData(e,y.fields.FIELD_UINT64,this.entries[i].media_time)):(this._writeData(e,y.fields.FIELD_UINT32,this.entries[i].segment_duration),this._writeData(e,y.fields.FIELD_UINT32,this.entries[i].media_time)),this._writeData(e,y.fields.FIELD_UINT16,this.entries[i].media_rate_integer),this._writeData(e,y.fields.FIELD_UINT16,this.entries[i].media_rate_fraction);return this.localPos},y.boxes.HintMediaHeaderBox=function(e){y.boxes.FullBox.call(this,"hmhd",e)},y.boxes.HintMediaHeaderBox.prototype=Object.create(y.boxes.FullBox.prototype),y.boxes.HintMediaHeaderBox.prototype.constructor=y.boxes.HintMediaHeaderBox,y.boxes.HintMediaHeaderBox.prototype.computeLength=function(){y.boxes.FullBox.prototype.computeLength.call(this),this.size+=2*y.fields.FIELD_UINT16.getLength(),this.size+=3*y.fields.FIELD_UINT32.getLength()},y.boxes.HintMediaHeaderBox.prototype.read=function(e,t,i){return y.boxes.FullBox.prototype.read.call(this,e,t,i),this.maxPDUsize=this._readData(e,y.fields.FIELD_UINT16),this.avgPDUsize=this._readData(e,y.fields.FIELD_UINT16),this.maxbitrate=this._readData(e,y.fields.FIELD_UINT32),this.avgbitrate=this._readData(e,y.fields.FIELD_UINT32),this.reserved=this._readData(e,y.fields.FIELD_UINT32),this.localPos},y.boxes.HintMediaHeaderBox.prototype.write=function(e,t){return y.boxes.FullBox.prototype.write.call(this,e,t),this._writeData(e,y.fields.FIELD_UINT16,this.maxPDUsize),this._writeData(e,y.fields.FIELD_UINT16,this.avgPDUsize),this._writeData(e,y.fields.FIELD_UINT32,this.maxbitrate),this._writeData(e,y.fields.FIELD_UINT32,this.avgbitrate),this._writeData(e,y.fields.FIELD_UINT32,this.reserved),this.localPos},y.boxes.NullMediaHeaderBox=function(e){y.boxes.FullBox.call(this,"nmhd",e)},y.boxes.NullMediaHeaderBox.prototype=Object.create(y.boxes.FullBox.prototype),y.boxes.NullMediaHeaderBox.prototype.constructor=y.boxes.NullMediaHeaderBox,y.boxes.CompositionOffsetBox=function(e){y.boxes.FullBox.call(this,"ctts",e),this.entries=[]},y.boxes.CompositionOffsetBox.prototype=Object.create(y.boxes.FullBox.prototype),y.boxes.CompositionOffsetBox.prototype.constructor=y.boxes.CompositionOffsetBox,y.boxes.CompositionOffsetBox.prototype.computeLength=function(){y.boxes.FullBox.prototype.computeLength.call(this),this.size+=y.fields.FIELD_UINT32.getLength(),0===this.version?this.size+=2*y.fields.FIELD_UINT32.getLength()*this.entry_count:this.size+=(y.fields.FIELD_UINT32.getLength()+y.fields.FIELD_INT32.getLength())*this.entry_count},y.boxes.CompositionOffsetBox.prototype.read=function(e,t,i){y.boxes.FullBox.prototype.read.call(this,e,t,i);var n=0,r={};for(this.entry_count=this._readData(e,y.fields.FIELD_UINT32),n=0;n<this.entry_count;n++)r={},0===this.version?(r.sample_count=this._readData(e,y.fields.FIELD_UINT32),r.sample_offset=this._readData(e,y.fields.FIELD_UINT32)):(r.sample_count=this._readData(e,y.fields.FIELD_UINT32),r.sample_offset=this._readData(e,y.fields.FIELD_INT32)),this.entries.push(r);return this.localPos},y.boxes.CompositionOffsetBox.prototype.write=function(e,t){y.boxes.FullBox.prototype.write.call(this,e,t);var i=0;for(this._writeData(e,y.fields.FIELD_UINT32,this.entry_count),i=0;i<this.entry_count;i++)0===this.version?(this._writeData(e,y.fields.FIELD_UINT32,this.entries[i].sample_count),this._writeData(e,y.fields.FIELD_UINT32,this.entries[i].sample_offset)):(this._writeData(e,y.fields.FIELD_UINT32,this.entries[i].sample_count),this._writeData(e,y.fields.FIELD_INT32,this.entries[i].sample_offset));return this.localPos},y.boxes.CompositionToDecodeBox=function(e){y.boxes.FullBox.call(this,"cslg",e)},y.boxes.CompositionToDecodeBox.prototype=Object.create(y.boxes.FullBox.prototype),y.boxes.CompositionToDecodeBox.prototype.constructor=y.boxes.CompositionToDecodeBox,y.boxes.CompositionToDecodeBox.prototype.computeLength=function(){y.boxes.FullBox.prototype.computeLength.call(this),this.size+=5*y.fields.FIELD_INT32.getLength()},y.boxes.CompositionToDecodeBox.prototype.read=function(e,t,i){return y.boxes.FullBox.prototype.read.call(this,e,t,i),this.compositionToDTSShift=this._readData(e,y.fields.FIELD_INT32),this.leastDecodeToDisplayDelta=this._readData(e,y.fields.FIELD_INT32),this.greatestDecodeToDisplayDelta=this._readData(e,y.fields.FIELD_INT32),this.compositionStartTime=this._readData(e,y.fields.FIELD_INT32),this.compositionEndTime=this._readData(e,y.fields.FIELD_INT32),this.localPos},y.boxes.CompositionToDecodeBox.prototype.write=function(e,t){return y.boxes.FullBox.prototype.write.call(this,e,t),this._writeData(e,y.fields.FIELD_INT32,this.compositionToDTSShift),this._writeData(e,y.fields.FIELD_INT32,this.leastDecodeToDisplayDelta),this._writeData(e,y.fields.FIELD_INT32,this.greatestDecodeToDisplayDelta),this._writeData(e,y.fields.FIELD_INT32,this.compositionStartTime),this._writeData(e,y.fields.FIELD_INT32,this.compositionEndTime),this.localPos},y.boxes.SyncSampleBox=function(e){y.boxes.FullBox.call(this,"stss",e),this.entries=[]},y.boxes.SyncSampleBox.prototype=Object.create(y.boxes.FullBox.prototype),y.boxes.SyncSampleBox.prototype.constructor=y.boxes.SyncSampleBox,y.boxes.SyncSampleBox.prototype.computeLength=function(){y.boxes.FullBox.prototype.computeLength.call(this),this.size+=y.fields.FIELD_UINT32.getLength(),this.size+=y.fields.FIELD_UINT32.getLength()*this.entry_count},y.boxes.SyncSampleBox.prototype.read=function(e,t,i){y.boxes.FullBox.prototype.read.call(this,e,t,i);var n=0,r={};for(this.entry_count=this._readData(e,y.fields.FIELD_UINT32),n=0;n<this.entry_count;n++)(r={}).sample_number=this._readData(e,y.fields.FIELD_UINT32),this.entries.push(r);return this.localPos},y.boxes.SyncSampleBox.prototype.write=function(e,t){y.boxes.FullBox.prototype.write.call(this,e,t);var i=0;for(this._writeData(e,y.fields.FIELD_UINT32,this.entry_count),i=0;i<this.entry_count;i++)this._writeData(e,y.fields.FIELD_UINT32,this.entries[i].sample_number);return this.localPos},y.boxes.TrackReferenceBox=function(e){y.boxes.FullBox.call(this,"tref",e)},y.boxes.TrackReferenceBox.prototype=Object.create(y.boxes.FullBox.prototype),y.boxes.TrackReferenceBox.prototype.constructor=y.boxes.TrackReferenceBox,y.boxes.TrackReferenceBox.prototype.computeLength=function(){y.boxes.FullBox.prototype.computeLength.call(this),this.size+=y.fields.FIELD_UINT32.getLength()*this.track_IDs.length},y.boxes.TrackReferenceBox.prototype.read=function(e,t,i){return y.boxes.FullBox.prototype.read.call(this,e,t,i),this.track_IDs=this._readArrayData(e,y.fields.FIELD_UINT32),this.localPos},y.boxes.TrackReferenceBox.prototype.write=function(e,t){return y.boxes.FullBox.prototype.write.call(this,e,t),this._writeArrayData(e,y.fields.FIELD_UINT32,this.track_IDs),this.localPos},y.boxes.OriginalFormatBox=function(e){y.boxes.Box.call(this,"frma",e)},y.boxes.OriginalFormatBox.prototype=Object.create(y.boxes.Box.prototype),y.boxes.OriginalFormatBox.prototype.constructor=y.boxes.OriginalFormatBox,y.boxes.OriginalFormatBox.prototype.computeLength=function(){y.boxes.Box.prototype.computeLength.call(this),this.size+=y.fields.FIELD_UINT32.getLength()},y.boxes.OriginalFormatBox.prototype.read=function(e,t,i){return this.localPos=t,this.localEnd=i,this.data_format=this._readData(e,y.fields.FIELD_UINT32),this.localPos},y.boxes.OriginalFormatBox.prototype.write=function(e,t){return y.boxes.Box.prototype.write.call(this,e,t),this._writeData(e,y.fields.FIELD_UINT32,this.data_format),this.localPos},y.boxes.PiffSampleEncryptionBox=function(e){y.boxes.FullBox.call(this,"sepiff",e,[162,57,79,82,90,155,79,20,162,68,108,66,124,100,141,244])},y.boxes.PiffSampleEncryptionBox.prototype=Object.create(y.boxes.FullBox.prototype),y.boxes.PiffSampleEncryptionBox.prototype.constructor=y.boxes.PiffSampleEncryptionBox,y.boxes.PiffSampleEncryptionBox.prototype.computeLength=function(){y.boxes.FullBox.prototype.computeLength.call(this);var e=0,t=0;for(this.size+=y.fields.FIELD_UINT32.getLength(),1&this.flags&&(this.size+=y.fields.FIELD_UINT8.getLength()),e=0;e<this.sample_count;e++)if(this.size+=8,2&this.flags)for(this.size+=y.fields.FIELD_UINT16.getLength(),t=0;t<this.entry[e].NumberOfEntries;t++)this.size+=y.fields.FIELD_UINT16.getLength(),this.size+=y.fields.FIELD_UINT32.getLength()},y.boxes.PiffSampleEncryptionBox.prototype.write=function(e,t){y.boxes.FullBox.prototype.write.call(this,e,t);var i=0,n=0;for(this._writeData(e,y.fields.FIELD_UINT32,this.sample_count),1&this.flags&&this._writeData(e,y.fields.FIELD_UINT8,this.IV_size),i=0;i<this.sample_count;i++)if(this._writeBuffer(e,this.entry[i].InitializationVector,8),2&this.flags)for(this._writeData(e,y.fields.FIELD_UINT16,this.entry[i].NumberOfEntries),n=0;n<this.entry[i].NumberOfEntries;n++)this._writeData(e,y.fields.FIELD_UINT16,this.entry[i].clearAndCryptedData[n].BytesOfClearData),this._writeData(e,y.fields.FIELD_UINT32,this.entry[i].clearAndCryptedData[n].BytesOfEncryptedData);return this.localPos},y.boxes.PiffSampleEncryptionBox.prototype.read=function(e,t,i){y.boxes.FullBox.prototype.read.call(this,e,t,i);var n=0,r=0,o={},s={};for(this.sample_count=this._readData(e,y.fields.FIELD_UINT32),1&this.flags&&(this.IV_size=this._readData(e,y.fields.FIELD_UINT8)),this.entry=[],n=0;n<this.sample_count;n++){if(s={},s.InitializationVector=e.subarray(this.localPos,this.localPos+8),this.localPos+=8,2&this.flags)for(s.NumberOfEntries=this._readData(e,y.fields.FIELD_UINT16),s.clearAndCryptedData=[],r=0;r<s.NumberOfEntries;r++)(o={}).BytesOfClearData=this._readData(e,y.fields.FIELD_UINT16),o.BytesOfEncryptedData=this._readData(e,y.fields.FIELD_UINT32),s.clearAndCryptedData.push(o);this.entry.push(s)}return this.localPos},y.boxes.PiffTrackEncryptionBox=function(e){y.boxes.FullBox.call(this,"tepiff",e,[137,116,219,206,123,231,76,81,132,249,113,72,249,136,37,84])},y.boxes.PiffTrackEncryptionBox.prototype=Object.create(y.boxes.FullBox.prototype),y.boxes.PiffTrackEncryptionBox.prototype.constructor=y.boxes.PiffTrackEncryptionBox,y.boxes.PiffProtectionSystemSpecificHeaderBox=function(e){y.boxes.FullBox.call(this,"psshpiff",e,[208,138,79,24,16,243,74,130,182,200,50,216,171,161,131,211])},y.boxes.PiffProtectionSystemSpecificHeaderBox.prototype=Object.create(y.boxes.FullBox.prototype),y.boxes.PiffProtectionSystemSpecificHeaderBox.prototype.constructor=y.boxes.PiffProtectionSystemSpecificHeaderBox,y.boxes.TfxdBox=function(e){y.boxes.FullBox.call(this,"tfxd",e,[109,29,155,5,66,213,68,230,128,226,20,29,175,247,87,178])},y.boxes.TfxdBox.prototype=Object.create(y.boxes.FullBox.prototype),y.boxes.TfxdBox.prototype.constructor=y.boxes.TfxdBox,y.boxes.TfxdBox.prototype.computeLength=function(){y.boxes.FullBox.prototype.computeLength.call(this),1===this.version?this.size+=2*y.fields.FIELD_UINT64.getLength():this.size+=2*y.fields.FIELD_UINT32.getLength()},y.boxes.TfxdBox.prototype.write=function(e,t){return y.boxes.FullBox.prototype.write.call(this,e,t),1===this.version?(this._writeData(e,y.fields.FIELD_UINT64,this.fragment_absolute_time),this._writeData(e,y.fields.FIELD_UINT64,this.fragment_duration)):(this._writeData(e,y.fields.FIELD_UINT32,this.fragment_absolute_time),this._writeData(e,y.fields.FIELD_UINT32,this.fragment_duration)),this.localPos},y.boxes.TfxdBox.prototype.read=function(e,t,i){return y.boxes.FullBox.prototype.read.call(this,e,t,i),1===this.version?(this.fragment_absolute_time=this._readData(e,y.fields.FIELD_UINT64),this.fragment_duration=this._readData(e,y.fields.FIELD_UINT64)):(this.fragment_absolute_time=this._readData(e,y.fields.FIELD_UINT32),this.fragment_duration=this._readData(e,y.fields.FIELD_UINT32)),this.localPos},y.boxes.TfrfBox=function(e){y.boxes.FullBox.call(this,"tfrf",e,[212,128,126,242,202,57,70,149,142,84,38,203,158,70,167,159])},y.boxes.TfrfBox.prototype=Object.create(y.boxes.FullBox.prototype),y.boxes.TfrfBox.prototype.constructor=y.boxes.TfrfBox,y.boxes.TfrfBox.prototype.computeLength=function(){y.boxes.FullBox.prototype.computeLength.call(this),this.size+=y.fields.FIELD_UINT8.getLength(),1===this.version?this.size+=2*y.fields.FIELD_UINT64.getLength()*this.fragment_count:this.size+=2*y.fields.FIELD_UINT32.getLength()*this.fragment_count},y.boxes.TfrfBox.prototype.write=function(e,t){y.boxes.FullBox.prototype.write.call(this,e,t);var i=0;for(this._writeData(e,y.fields.FIELD_UINT8,this.fragment_count),i=0;i<this.fragment_count;i++)1===this.version?(this._writeData(e,y.fields.FIELD_UINT64,this.entry[i].fragment_absolute_time),this._writeData(e,y.fields.FIELD_UINT64,this.entry[i].fragment_duration)):(this._writeData(e,y.fields.FIELD_UINT32,this.entry[i].fragment_absolute_time),this._writeData(e,y.fields.FIELD_UINT32,this.entry[i].fragment_duration));return this.localPos},y.boxes.TfrfBox.prototype.read=function(e,t,i){y.boxes.FullBox.prototype.read.call(this,e,t,i);var n=0,r={};for(this.fragment_count=this._readData(e,y.fields.FIELD_UINT8),this.entry=[],n=0;n<this.fragment_count;n++)r={},1===this.version?(r.fragment_absolute_time=this._readData(e,y.fields.FIELD_UINT64),r.fragment_duration=this._readData(e,y.fields.FIELD_UINT64)):(r.fragment_absolute_time=this._readData(e,y.fields.FIELD_UINT32),r.fragment_duration=this._readData(e,y.fields.FIELD_UINT32)),this.entry.push(r);return this.localPos},y.boxes.SubSampleInformationBox=function(e){y.boxes.FullBox.call(this,"subs",e)},y.boxes.SubSampleInformationBox.prototype=Object.create(y.boxes.FullBox.prototype),y.boxes.SubSampleInformationBox.prototype.constructor=y.boxes.SubSampleInformationBox,y.boxes.SubSampleInformationBox.prototype.computeLength=function(){y.boxes.FullBox.prototype.computeLength.call(this)},y.boxes.SubSampleInformationBox.prototype.read=function(e,t,i){y.boxes.FullBox.prototype.read.call(this,e,t,i);var n=0,r=0,o={},s={};for(this.entry_count=this._readData(e,y.fields.FIELD_UINT32),this.entry=[],n=0;n<this.entry_count;n++){if(o={},o.sample_delta=this._readData(e,y.fields.FIELD_UINT32),o.subsample_count=this._readData(e,y.fields.FIELD_UINT16),o.subsample_count>0)for(o.subSampleEntries=[],r=0;r<o.subsample_count;r++)s={},1===this.version?s.subsample_size=this._readData(e,y.fields.FIELD_UINT32):s.subsample_size=this._readData(e,y.fields.FIELD_UINT16),s.subsample_priority=this._readData(e,y.fields.FIELD_UINT8),s.discardable=this._readData(e,y.fields.FIELD_UINT8),s.reserved=this._readData(e,y.fields.FIELD_UINT32),o.subSampleEntries.push(s);this.entry.push(o)}return this.localPos},y.boxes.SubSampleInformationBox.prototype.write=function(e,t){y.boxes.FullBox.prototype.write.call(this,e,t)},y.registerTypeBoxes();var _={pes:{},si:{},binary:{},ts:{},Pts:{},aac:{},h264:{}};return"undefined"!=typeof module&&void 0!==module.exports?module.exports=_:window.mpegts=_,_.si.PSISection=function(e){this.m_table_id=e,this.m_section_syntax_indicator=1,this.m_section_length=_.si.PSISection.prototype.SECTION_LENGTH,this.m_transport_stream_id=0,this.m_version_number=0,this.m_current_next_indicator=!0,this.m_section_number=0,this.m_last_section_number=0,this.m_bValid=null},_.si.PSISection.prototype.parse=function(e){this.m_bValid=!1;var t=0,i=e[t];return t=0===i?t+1:t+i,this.m_table_id=e[t],t++,this.m_section_syntax_indicator=_.binary.getBitFromByte(e[t],0),this.m_section_length=_.binary.getValueFrom2Bytes(e.subarray(t,t+2),4),t+=2,this.m_transport_stream_id=_.binary.getValueFrom2Bytes(e.subarray(t,t+2)),t+=2,this.m_version_number=_.binary.getValueFromByte(e[t],2,5),this.m_current_next_indicator=_.binary.getBitFromByte(e[t],7),t++,this.m_section_number=e[t],t++,this.m_last_section_number=e[t],this.m_bValid=!0,t},_.si.PSISection.prototype.getSectionLength=function(){return this.m_section_length},_.si.PSISection.prototype.SECTION_LENGTH=9,_.si.PSISection.prototype.HEADER_LENGTH=8,_.aac.SAMPLING_FREQUENCY=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350],_.aac.getAudioSpecificConfig=function(e){var t=_.binary.getValueFromByte(e[2],0,2),i=_.binary.getValueFromByte(e[2],2,4),n=_.binary.getValueFrom2Bytes(e.subarray(2,5),7,3),r=new Uint8Array(2);return r[0]=t+1<<3,r[0]|=(14&i)>>1,r[1]|=(1&i)<<7,r[1]|=n<<3,r},_.aac.parseADTS=function(e,t){for(var i,n,r=[],o={},s=0;s<e.length;)n=s,o.syncword=(e[s]<<4)+((240&e[s+1])>>4),o.protection_absent=1&e[s+1],o.sampling_frequency_index=(60&e[s+2])>>2,o.channel_configuration=((1&e[s+2])<<1)+((192&e[s+3])>>6),o.aac_frame_length=((3&e[s+3])<<11)+(e[s+4]<<3)+((224&e[s+5])>>5),o.number_of_raw_data_blocks_in_frame=(3&e[s+6])>>2,s+=7,0===o.number_of_raw_data_blocks_in_frame&&(0===o.protection_absent&&(s+=2),(i={}).offset=s,i.length=o.aac_frame_length-(s-n),t&&t[n]&&(i.cts=t[n]),r.push(i),s+=i.length);return r},_.ts.AdaptationField=function(){this.m_cAFLength=null,this.m_bDiscontinuityInd=null,this.m_bRAI=null,this.m_bESPriority=null,this.m_bPCRFlag=null,this.m_bOPCRFlag=null,this.m_bSplicingPointFlag=null,this.m_bPrivateDataFlag=null,this.m_bAdaptationFieldExtFlag=null},_.ts.AdaptationField.prototype.getLength=function(){return this.m_cAFLength+1},_.ts.AdaptationField.prototype.parse=function(e){if(this.m_cAFLength=e[0],0!==this.m_cAFLength){this.m_bDiscontinuityInd=_.binary.getBitFromByte(e[1],0),this.m_bRAI=_.binary.getBitFromByte(e[1],1),this.m_bESPriority=_.binary.getBitFromByte(e[1],2),this.m_bPCRFlag=_.binary.getBitFromByte(e[1],3),this.m_bOPCRFlag=_.binary.getBitFromByte(e[1],4),this.m_bSplicingPointFlag=_.binary.getBitFromByte(e[1],5),this.m_bPrivateDataFlag=_.binary.getBitFromByte(e[1],6),this.m_bAdaptationFieldExtFlag=_.binary.getBitFromByte(e[1],7)}},_.binary.readBytes=function(e,t,i){for(var n=0,r=0;r<i;r++)n<<=8,n+=e[t],t++;return n},_.binary.getBitFromByte=function(e,t){var i=0;return i+=1<<7-t,0!=(e&i)},_.binary.getValueFrom3Bytes=function(e,t,i){void 0===i&&(i=-1),void 0===t&&(t=0);var n=-1==i?-1:i-(16-t),r=-1==i?0:8-n;return(_.binary.getValueFromByte(e[0],t)<<16&16711680|_.binary.getValueFromByte(e[1])<<8&65280|255&_.binary.getValueFromByte(e[2],0,n,!1))>>r},_.binary.getValueFrom2Bytes=function(e,t,i){void 0===i&&(i=-1),void 0===t&&(t=0);var n=-1==i?-1:i-(8-t),r=-1==i?0:8-n;return(_.binary.getValueFromByte(e[0],t)<<8&65280|255&_.binary.getValueFromByte(e[1],0,n,!1))>>r},_.binary.getValueFromByte=function(e,t,i,n){var r=0,o=0;void 0===i&&(i=-1),void 0===t&&(t=0);var s=-1==i?7:t+i-1;for(o=t;o<=s;o++)r+=1<<7-o;var a=e&r;return(n||void 0===n)&&(a>>=7-s),a},_.h264.getSequenceHeader=function(e){for(var t,i=-1,n=-1,r=0,o=null,s=0,a=0;r<e.length;)if(0===e[r]&&0===e[r+1]&&0===e[r+2]&&1===e[r+3]){if((t=31&e[r+4])>=_.h264.NALUTYPE_SPS&&t<=_.h264.NALUTYPE_PPS){if(-1===i&&(i=r),t===_.h264.NALUTYPE_SPS){var l=_.h264.parseSPS(e.subarray(r+5));s=l.pic_width_in_mbs_minus1+1<<4,a=l.pic_height_in_map_units_minus1+1<<4}}else i>0&&(n=r-i);if(t===_.h264.NALUTYPE_IDR||t===_.h264.NALUTYPE_NONIDR)break;r+=4}else{if(0===e[r]&&0===e[r+1]&&1===e[r+2]){i>0&&(n=r-i);break}r++}return-1===i||-1===n?null:((o=new Uint8Array(n)).set(e.subarray(i,i+n)),{bytes:o,width:s,height:a})},_.h264.read_ue=function(e,t){var i=1,n=0,r=0;for(t._bit=t._byte>>t._bitPos&1,t._bitPos--,t._bitPos<0&&(t._byte=e[t._bytePos],t._bytePos++,t._bitPos=7);0===t._bit;)r++,i<<=1,t._bit=t._byte>>t._bitPos&1,t._bitPos--,t._bitPos<0&&(t._byte=e[t._bytePos],t._bytePos++,t._bitPos=7);if(i-=1,n=0,r)for(;r>0;)t._bit=t._byte>>t._bitPos&1,t._bitPos--,n=(n<<1)+t._bit,r--,t._bitPos<0&&(t._byte=e[t._bytePos],t._bytePos++,t._bitPos=7);return i+=n},_.h264.read_flag=function(e,t){return t._bit=t._byte>>t._bitPos&1,t._bitPos--,t._bitPos<0&&(t._byte=e[t._bytePos],t._bytePos++,t._bitPos=7),t._bit},_.h264.parseSPS=function(e){var t={profile_idc:0,constraint_set0_flag:0,constraint_set1_flag:0,constraint_set2_flag:0,constraint_set3_flag:0,level_idc:0,seq_parameter_set_id:0,chroma_format_idc:0,separate_colour_plane_flag:0,bit_depth_luma_minus8:0,bit_depth_chroma_minus8:0,qpprime_y_zero_transform_bypass_flag:0,seq_scaling_matrix_present_flag:0,log2_max_frame_num_minus4:0,pic_order_cnt_type:0,log2_max_pic_order_cnt_lsb_minus4:0,num_ref_frames:0,gaps_in_frame_num_value_allowed_flag:0,pic_width_in_mbs_minus1:0,pic_height_in_map_units_minus1:0},i={_byte:0,_bit:0,_bytePos:0,_bitPos:0};return i._bytePos=i._bitPos=0,i._byte=e[i._bytePos],i._bytePos++,t.profile_idc=i._byte,i._byte=e[i._bytePos],i._bytePos++,t.constraint_set0_flag=(128&i._byte)>>7,t.constraint_set1_flag=(64&i._byte)>>6,t.constraint_set2_flag=(32&i._byte)>>5,t.constraint_set3_flag=(16&i._byte)>>4,i._byte=e[i._bytePos],i._bytePos++,t.level_idc=i._byte,i._byte=e[i._bytePos],i._bytePos++,i._bitPos=7,t.seq_parameter_set_id=_.h264.read_ue(e,i),100!==t.profile_idc&&110!==t.profile_idc&&122!==t.profile_idc&&244!==t.profile_idc&&44!==t.profile_idc&&83!==t.profile_idc&&86!==t.profile_idc||(t.chroma_format_idc=_.h264.read_ue(e,i),3===t.chroma_format_idc&&(t.separate_colour_plane_flag=_.h264.read_flag(e,i)),t.bit_depth_luma_minus8=_.h264.read_ue(e,i),t.bit_depth_chroma_minus8=_.h264.read_ue(e,i),t.qpprime_y_zero_transform_bypass_flag=_.h264.read_flag(e,i),t.seq_scaling_matrix_present_flag=_.h264.read_flag(e,i),t.seq_scaling_matrix_present_flag),t.log2_max_frame_num_minus4=_.h264.read_ue(e,i),t.pic_order_cnt_type=_.h264.read_ue(e,i),0===t.pic_order_cnt_type?t.log2_max_pic_order_cnt_lsb_minus4=_.h264.read_ue(e,i):t.pic_order_cnt_type,t.num_ref_frames=_.h264.read_ue(e,i),t.gaps_in_frame_num_value_allowed_flag=_.h264.read_flag(e,i),t.pic_width_in_mbs_minus1=_.h264.read_ue(e,i),t.pic_height_in_map_units_minus1=_.h264.read_ue(e,i),t},_.h264.parseNALUs=function(e){for(var t,i=0,n=e.length,r=0,o=[];i<n;)0===e[i]&&r++,1===e[i]&&r>=2&&(i++,o.length>0&&(o[o.length-1].size=i-(r+1)-o[o.length-1].offset),(t={}).type=31&e[i],t.offset=i,o.push(t),r=0),e[i]&&(r=0),i++;return o.length>0&&(o[o.length-1].size=i-o[o.length-1].offset),o},_.h264.bytestreamToMp4=function(e){for(var t=0,i=e.length,n=-1,r=0;t<i;)0===e[t]&&0===e[t+1]&&0===e[t+2]&&1===e[t+3]?(n>=0&&(r=t-n-4,e[n]=(4278190080&r)>>24,e[n+1]=(16711680&r)>>16,e[n+2]=(65280&r)>>8,e[n+3]=255&r),n=t,t+=4):t++;r=t-n-4,e[n]=(4278190080&r)>>24,e[n+1]=(16711680&r)>>16,e[n+2]=(65280&r)>>8,e[n+3]=255&r},_.h264.isIDR=function(e){for(var t=0;t<e.length;)if(0===e[t]&&0===e[t+1]&&1===e[t+2]){if((31&e[t+3])===_.h264.NALUTYPE_IDR)return!0;t+=3}else t++;return!1},_.h264.NALUTYPE_NONIDR=1,_.h264.NALUTYPE_IDR=5,_.h264.NALUTYPE_SEI=6,_.h264.NALUTYPE_SPS=7,_.h264.NALUTYPE_PPS=8,_.h264.NALUTYPE_AU_DELIMITER=9,_.si.PAT=function(){_.si.PSISection.call(this,_.si.PAT.prototype.TABLE_ID),this.m_listOfProgramAssociation=[],this.m_network_pid=null},_.si.PAT.prototype=Object.create(_.si.PSISection.prototype),_.si.PAT.prototype.constructor=_.si.PAT,_.si.PAT.prototype.parse=function(e){var t=_.si.PSISection.prototype.parse.call(this,e);if(t++,this.m_bValid&&(this.m_bValid=!1,this.m_table_id===this.TABLE_ID)){for(var i=this.getSectionLength()-this.SECTION_LENGTH;i>=4;){var n=new _.si.ProgramAssociation(e.subarray(t,t+4));0===n.getProgramNumber()?this.m_network_pid=n.getProgramMapPid():this.m_listOfProgramAssociation.push(n),i-=4,t+=4}this.m_bValid=!0}},_.si.PAT.prototype.getPmtPid=function(){var e=_.ts.TsPacket.prototype.UNDEFINED_PID;if(this.m_listOfProgramAssociation.length>=1){e=this.m_listOfProgramAssociation[0].getProgramMapPid()}return e},_.si.PAT.prototype.TABLE_ID=0,_.si.PAT.prototype.PID=0,_.si.ProgramAssociation=function(e){this.m_program_number=0,this.m_program_map_pid=0,this.parse(e)},_.si.ProgramAssociation.prototype.getProgramNumber=function(){return this.m_program_number},_.si.ProgramAssociation.prototype.getProgramMapPid=function(){return this.m_program_map_pid},_.si.ProgramAssociation.prototype.getLength=function(){return 4},_.si.ProgramAssociation.prototype.parse=function(e){this.m_program_number=_.binary.getValueFrom2Bytes(e.subarray(0,2)),this.m_program_map_pid=_.binary.getValueFrom2Bytes(e.subarray(2,4),3,13)},_.pes.PesPacket=function(){this.m_cStreamID=null,this.m_nPESPacketLength=null,this.m_cPESScramblingCtrl=null,this.m_bPESpriority=null,this.m_bDataAlignement=null,this.m_bCopyright=null,this.m_bOriginalOrCopy=null,this.m_cPES_header_data_length=null,this.m_cPTS_DTS_flags=null,this.m_bESCR_flag=null,this.m_bES_rate_flag=null,this.m_bDSM_trick_mode_flag=null,this.m_bAdditional_copy_info_flag=null,this.m_bPES_CRC_flag=null,this.m_bPES_extension_flag=null,this.m_pPTS=null,this.m_pDTS=null,this.m_pESCR=null,this.m_ES_rate=null,this.m_DSM_trick_mode=null,this.m_Additional_copy_info=null,this.m_PES_CRC=null,this.m_cNbStuffingBytes=null,this.m_pPESExtension=null,this.m_pPrivateData=null,this.m_payloadArray=null,this.m_nPayloadLength=null,this.m_bDirty=null,this.m_bValid=!1},_.pes.PesPacket.prototype.parse=function(e){var t=0;this.m_nLength=e.length;if(_.binary.getValueFrom3Bytes(e.subarray(t,t+3))===this.START_CODE_PREFIX)if(t=3,this.m_cStreamID=e[t],t++,this.m_nPESPacketLength=_.binary.getValueFrom2Bytes(e.subarray(t,t+2)),t+=2,this.m_cStreamID!==_.ts.TsPacket.prototype.STREAM_ID_PADDING_STREAM){if(!this.hasOptionalPESHeader())return this.m_payloadArray=e.subarray(t+_.pes.PesPacket.prototype.FIXED_HEADER_LENGTH),this.m_nPayloadLength=this.m_nLength-_.pes.PesPacket.prototype.FIXED_HEADER_LENGTH,void(this.m_bValid=!0);if(2===_.binary.getValueFromByte(e[t],0,2)){this.m_cPESScramblingCtrl=_.binary.getValueFromByte(e[t],2,2),this.m_bPESpriority=_.binary.getBitFromByte(e[t],4),this.m_bDataAlignement=_.binary.getBitFromByte(e[t],5),this.m_bCopyright=_.binary.getBitFromByte(e[t],6),this.m_bOriginalOrCopy=_.binary.getBitFromByte(e[t],7),t++,this.m_cPTS_DTS_flags=_.binary.getValueFromByte(e[t],0,2),this.m_bESCR_flag=_.binary.getBitFromByte(e[t],2),this.m_bES_rate_flag=_.binary.getBitFromByte(e[t],3),this.m_bDSM_trick_mode_flag=_.binary.getBitFromByte(e[t],4),this.m_bAdditional_copy_info_flag=_.binary.getBitFromByte(e[t],5),this.m_bPES_CRC_flag=_.binary.getBitFromByte(e[t],6),this.m_bPES_extension_flag=_.binary.getBitFromByte(e[t],7),t++,this.m_cPES_header_data_length=255&e[t],t++,(this.m_cPTS_DTS_flags&_.pes.PesPacket.prototype.FLAG_PTS)==_.pes.PesPacket.prototype.FLAG_PTS&&(this.m_pPTS=new _.Pts(e.subarray(t,t+5)),t+=5),(this.m_cPTS_DTS_flags&_.pes.PesPacket.prototype.FLAG_DTS)==_.pes.PesPacket.prototype.FLAG_DTS&&(this.m_pDTS=new _.Pts(e.subarray(t,t+5)),t+=5),this.m_bESCR_flag&&(t+=6),this.m_bES_rate_flag&&(this.m_ES_rate=_.binary.getValueFrom3Bytes(e.subarray(t,t+3),1,22),t+=3),this.m_bDSM_trick_mode_flag&&(this.m_DSM_trick_mode=e[t],t++),this.m_bAdditional_copy_info_flag&&(this.m_Additional_copy_info=e[t],t++),this.m_bPES_CRC_flag&&(this.m_PES_CRC=_.binary.getValueFrom2Bytes(e.subarray(t,t+2)),t+=2),this.m_bPES_extension_flag;var i=_.pes.PesPacket.prototype.FIXED_HEADER_LENGTH+_.pes.PesPacket.prototype.FIXED_OPTIONAL_HEADER_LENGTH+this.m_cPES_header_data_length;this.m_cNbStuffingBytes=i-t,t+=this.m_cNbStuffingBytes,this.m_nPayloadLength=this.m_nLength-i,this.m_payloadArray=e.subarray(i,i+this.m_nPayloadLength),this.m_bValid=!0}}else this.m_bValid=!0},_.pes.PesPacket.prototype.hasOptionalPESHeader=function(){return this.m_cStreamID!==_.ts.TsPacket.prototype.STREAM_ID_PROGRAM_STREAM_MAP&&this.m_cStreamID!==_.ts.TsPacket.prototype.STREAM_ID_PADDING_STREAM&&this.m_cStreamID!==_.ts.TsPacket.prototype.STREAM_ID_PRIVATE_STREAM_2&&this.m_cStreamID!==_.ts.TsPacket.prototype.STREAM_ID_ECM_STREAM&&this.m_cStreamID!==_.ts.TsPacket.prototype.STREAM_ID_EMM_STREAM&&this.m_cStreamID!==_.ts.TsPacket.prototype.STREAM_ID_PROGRAM_STREAM_DIRECTORY&&this.m_cStreamID!==_.ts.TsPacket.prototype.STREAM_ID_DSMCC_STREAM&&this.m_cStreamID!==_.ts.TsPacket.prototype.STREAM_ID_H2221_TYPE_E_STREAM},_.pes.PesPacket.prototype.getHeaderLength=function(){return _.pes.PesPacket.prototype.FIXED_HEADER_LENGTH+_.pes.PesPacket.prototype.FIXED_OPTIONAL_HEADER_LENGTH+this.m_cPES_header_data_length},_.pes.PesPacket.prototype.getPayload=function(){return this.m_payloadArray},_.pes.PesPacket.prototype.getPts=function(){return this.m_pPTS},_.pes.PesPacket.prototype.getDts=function(){return this.m_pDTS},_.pes.PesPacket.prototype.START_CODE_PREFIX=1,_.pes.PesPacket.prototype.FIXED_HEADER_LENGTH=6,_.pes.PesPacket.prototype.FIXED_OPTIONAL_HEADER_LENGTH=3,_.pes.PesPacket.prototype.FLAG_DTS=1,_.pes.PesPacket.prototype.FLAG_PTS=2,_.si.PMT=function(){_.si.PSISection.call(this,_.si.PMT.prototype.TABLE_ID),this.m_listOfComponents=[],this.m_PCR_PID=null,this.m_program_info_length=null},_.si.PMT.prototype=Object.create(_.si.PSISection.prototype),_.si.PMT.prototype.constructor=_.si.PMT,_.si.PMT.prototype.parse=function(e){var t=_.si.PSISection.prototype.parse.call(this,e);if(t++,this.m_bValid&&(this.m_bValid=!1,this.m_table_id===this.TABLE_ID)){var i=this.getSectionLength()-this.SECTION_LENGTH;if(!(i<4)){this.m_PCR_PID=_.binary.getValueFrom2Bytes(e.subarray(t,t+2),3),t+=2,this.m_program_info_length=_.binary.getValueFrom2Bytes(e.subarray(t,t+2),4),t+=2,t+=this.m_program_info_length,i=this.m_section_length-this.SECTION_LENGTH-4-this.m_program_info_length;for(var n=null;i>0;)n=new _.si.ESDescription(e.subarray(t,t+i)),this.m_listOfComponents.push(n),i-=n.getLength(),t+=n.getLength();this.m_bValid=!0}}},_.si.PMT.prototype.TABLE_ID=2,_.si.PMT.prototype.gStreamTypes=[{name:"Reserved",value:0,desc:"ITU-T | ISO/IEC Reserved"},{name:"MPEG1-Video",value:224,desc:"ISO/IEC 11172-2 Video"},{name:"MPEG2-Video",value:224,desc:"ITU-T Rec. H.262 | ISO/IEC 13818-2 Video or ISO/IEC 11172-2 constrained parameter video stream"},{name:"MPEG1-Audio",value:192,desc:"ISO/IEC 11172-3 Audio"},{name:"MPEG2-Audio",value:192,desc:"ISO/IEC 13818-3 Audio"},{name:"PRIVATE_SECTIONS",value:189,desc:"ITU-T Rec. H.222.0 | ISO/IEC 13818-1 private_sections"},{name:"PRIVATE",value:189,desc:"ITU-T Rec. H.222.0 | ISO/IEC 13818-1 PES packets containing private data"},{name:"MHEG",value:243,desc:"ISO/IEC 13522 MHEG"},{name:"MPEG1-DSM-CC",value:242,desc:"ITU-T Rec. H.222.0 | ISO/IEC 13818-1 Annex A DSM-CC"},{name:"H.222.1",value:244,desc:"ITU-T Rec. H.222.1"},{name:"DSM-CC_A",value:244,desc:"ISO/IEC 13818-6 type A"},{name:"DSM-CC_B",value:245,desc:"ISO/IEC 13818-6 type B"},{name:"DSM-CC_C",value:246,desc:"ISO/IEC 13818-6 type C"},{name:"DSM-CC_D",value:247,desc:"ISO/IEC 13818-6 type D"},{name:"Auxiliary",value:0,desc:"ITU-T Rec. H.222.0 | ISO/IEC 13818-1 auxiliary"},{name:"MPEG2-AAC-ADTS",value:192,desc:"ISO/IEC 13818-7 Audio with ADTS transport syntax"},{name:"MPEG4-Video",value:224,desc:"ISO/IEC 14496-2 Visual"},{name:"MPEG4-AAC-LATM",value:192,desc:"ISO/IEC 14496-3 Audio with the LATM transport syntax as defined in ISO/IEC 14496-3/AMD-1"},{name:"MPEG4-SL",value:250,desc:"ISO/IEC 14496-1 SL-packetized stream or FlexMux stream carried in PES packets"},{name:"MPEG4-SL",value:250,desc:"ISO/IEC 14496-1 SL-packetized stream or FlexMux stream carried in ISO/IEC14496_sections"},{name:"DSM-CC_SDP",value:0,desc:"ISO/IEC 13818-6 Synchronized Download Protocol"},{name:"META_PES",value:252,desc:"Metadata carried in PES packets"},{name:"META_SECTIONS",value:252,desc:"Metadata carried in metadata_sections"},{name:"META_DSM-CC",value:252,desc:"Metadata carried in ISO/IEC 13818-6 Data Carousel"},{name:"META_DSM-CC",value:252,desc:"Metadata carried in ISO/IEC 13818-6 Object Carousel"},{name:"META_DSM-CC",value:252,desc:"Metadata carried in ISO/IEC 13818-6 Synchronized Download Protocol"},{name:"MPEG2-IPMP",value:0,desc:"IPMP stream (defined in ISO/IEC 13818-11, MPEG-2 IPMP)"},{name:"H.264",value:224,desc:"AVC video stream as defined in ITU-T Rec. H.264 | ISO/IEC 14496-10 Video"},{name:"MPEG4AAC",value:192,desc:"ISO/IEC 14496-3 Audio, without using any additional transport syntax, such as DST, ALS and SLS"},{name:"MPEG4Text",value:0,desc:"ISO/IEC 14496-17 Text"},{name:"Aux. Video (23002-3)",value:30,desc:"Auxiliary video stream as defined in ISO/IEC 23002-3"},{name:"H.264-SVC",value:224,desc:"SVC video sub-bitstream of a video stream as defined in the Annex G of ITU-T Rec. H.264 | ISO/IEC 14496-10 Video"},{name:"H.264-MVC",value:224,desc:"MVC video sub-bitstream of a video stream as defined in the Annex H of ITU-T Rec. H.264 | ISO/IEC 14496-10 Video"},{name:"Reserved1",value:0,desc:"TBC Reserved"},{name:"Reserved2",value:0,desc:"TBC Reserved"},{name:"Reserved3",value:0,desc:"TBC Reserved"},{name:"HEVC",value:224,desc:"ITU.-T Rec H.26x | ISO/IEC 23008-2 video stream"}],_.si.PMT.prototype.MPEG2_VIDEO_STREAM_TYPE=2,_.si.PMT.prototype.AVC_VIDEO_STREAM_TYPE=27,_.si.PMT.prototype.MPEG1_AUDIO_STREAM_TYPE=3,_.si.PMT.prototype.MPEG2_AUDIO_STREAM_TYPE=4,_.si.PMT.prototype.AAC_AUDIO_STREAM_TYPE=17,_.si.PMT.prototype.AC3_AUDIO_STREAM_TYPE=6,_.si.PMT.prototype.SUB_STREAM_TYPE=6,_.si.PMT.prototype.STREAM_TYPE_MP1V=1,_.si.PMT.prototype.STREAM_TYPE_MP2V=2,_.si.PMT.prototype.STREAM_TYPE_MP1A=3,_.si.PMT.prototype.STREAM_TYPE_MP2A=4,_.si.PMT.prototype.STREAM_TYPE_PRIVATE=6,_.si.PMT.prototype.STREAM_TYPE_TELETEXT=6,_.si.PMT.prototype.STREAM_TYPE_DVBSUBTITLE=6,_.si.PMT.prototype.STREAM_TYPE_AC3=6,_.si.PMT.prototype.STREAM_TYPE_MP2AAC_ADTS=15,_.si.PMT.prototype.STREAM_TYPE_MP4AAC_LATM=17,_.si.PMT.prototype.STREAM_TYPE_H264=27,_.si.PMT.prototype.STREAM_TYPE_MP4AAC=28,_.si.PMT.prototype.STREAM_TYPE_AUX_23002_3=30,_.si.PMT.prototype.STREAM_TYPE_SVC=31,_.si.PMT.prototype.STREAM_TYPE_MVC=32,_.si.PMT.prototype.STREAM_TYPE_HEVC=36,_.si.ESDescription=function(e){this.m_stream_type=null,this.m_elementary_PID=null,this.m_ES_info_length=null,this.parse(e)},_.si.ESDescription.prototype.getStreamType=function(){return this.m_stream_type},_.si.ESDescription.prototype.getPID=function(){return this.m_elementary_PID},_.si.ESDescription.prototype.getLength=function(){return 5+this.m_ES_info_length},_.si.ESDescription.prototype.parse=function(e){this.m_stream_type=e[0],this.m_elementary_PID=_.binary.getValueFrom2Bytes(e.subarray(1,3),3),this.m_ES_info_length=_.binary.getValueFrom2Bytes(e.subarray(3,5),4)},_.Pts=function(e){var t,i,n=e[0]>>1&7;i=n>>2;t=((t=((t=((t=((t=(3&n)<<30>>>0)|e[1]<<22)>>>0)|e[2]>>1<<15)>>>0)|e[3]<<7)>>>0)|e[4]>>1)>>>0,this.m_lPTS=r.math.Long.fromBits(t,i).toNumber(),this.m_fPTS=this.m_lPTS/_.Pts.prototype.SYSTEM_CLOCK_FREQUENCY},_.Pts.prototype.getValue=function(){return this.m_lPTS},_.Pts.prototype.getValueInSeconds=function(){return this.m_fPTS},_.Pts.prototype.SYSTEM_CLOCK_FREQUENCY=9e4,_.ts.TsPacket=function(){this.m_cSync=null,this.m_bTransportError=null,this.m_bPUSI=null,this.m_bTransportPriority=null,this.m_nPID=null,this.m_cTransportScramblingCtrl=null,this.m_cAdaptationFieldCtrl=null,this.m_cContinuityCounter=null,this.m_pAdaptationField=null,this.m_payloadArray=null,this.m_cPayloadLength=null,this.m_bDirty=null,this.m_time=null,this.m_arrivalTime=null,this.m_bIgnored=null},_.ts.TsPacket.prototype.parse=function(e){var t=0;if(this.m_cSync=e[t],this.m_cSync===this.SYNC_WORD){if(t++,this.m_bTransportError=_.binary.getBitFromByte(e[t],0),this.m_bPUSI=_.binary.getBitFromByte(e[t],1),this.m_bTransportPriority=_.binary.getBitFromByte(e[t],2),this.m_nPID=_.binary.getValueFrom2Bytes(e.subarray(t,t+2),3,13),t+=2,this.m_cTransportScramblingCtrl=_.binary.getValueFromByte(e[t],0,2),this.m_cAdaptationFieldCtrl=_.binary.getValueFromByte(e[t],2,2),this.m_cContinuityCounter=_.binary.getValueFromByte(e[t],4,4),t++,2&this.m_cAdaptationFieldCtrl){if(e[t]+t>=this.TS_PACKET_SIZE)return;this.m_pAdaptationField=new _.ts.AdaptationField,this.m_pAdaptationField.parse(e.subarray(t)),t+=this.m_pAdaptationField.getLength()}0!==this.m_cAdaptationFieldCtrl&&1&this.m_cAdaptationFieldCtrl&&(this.m_cPayloadLength=this.TS_PACKET_SIZE-t,this.m_payloadArray=e.subarray(t,t+this.m_cPayloadLength))}},_.ts.TsPacket.prototype.checkSyncWord=function(e){return e[0]===this.SYNC_WORD},_.ts.TsPacket.prototype.getPid=function(){return this.m_nPID},_.ts.TsPacket.prototype.getPayload=function(){return this.m_payloadArray},_.ts.TsPacket.prototype.getPayloadLength=function(){return this.m_cPayloadLength},_.ts.TsPacket.prototype.getPusi=function(){return this.m_bPUSI},_.ts.TsPacket.prototype.hasAdaptationFieldOnly=function(){return 2===this.m_cAdaptationFieldCtrl},_.ts.TsPacket.prototype.SYNC_WORD=71,_.ts.TsPacket.prototype.TS_PACKET_SIZE=188,_.ts.TsPacket.prototype.UNDEFINED_PID=65535,_.ts.TsPacket.prototype.PAT_PID=0,_.ts.TsPacket.prototype.STREAM_ID_PROGRAM_STREAM_MAP=188,_.ts.TsPacket.prototype.STREAM_ID_PADDING_STREAM=190,_.ts.TsPacket.prototype.STREAM_ID_PADDING_STREAM=190,_.ts.TsPacket.prototype.STREAM_ID_PRIVATE_STREAM_2=191,_.ts.TsPacket.prototype.STREAM_ID_ECM_STREAM=240,_.ts.TsPacket.prototype.STREAM_ID_EMM_STREAM=241,_.ts.TsPacket.prototype.STREAM_ID_DSMCC_STREAM=242,_.ts.TsPacket.prototype.STREAM_ID_H2221_TYPE_E_STREAM=248,_.ts.TsPacket.prototype.STREAM_ID_PROGRAM_STREAM_DIRECTORY=255,o=this.dijon,c});
/* jshint ignore:end */
//# sourceMappingURL=hasplayer.min.js.map
